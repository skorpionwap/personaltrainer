<!DOCTYPE html>
<html>
<head>
    <title>Aplica»õie Introspec»õie - Jurnal & Fi»ôe</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, deleteField, doc, getDoc, updateDoc, arrayUnion, query, where, setDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // --- CONFIGURARE FIREBASE & GEMINI (UNICƒÇ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng";
    const GEMINI_MODEL_NAME_FEEDBACK_FISA = "gemini-2.5-flash-preview-05-20";
    const GEMINI_MODEL_NAME_FEEDBACK_JURNAL = "gemini-2.5-flash-preview-05-20";
    const GEMINI_MODEL_NAME_CHAT = "gemini-2.5-flash-preview-05-20";

    let genAI, geminiModelFisaFeedback, geminiModelJurnalFeedback, geminiModelChat;

    if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            geminiModelFisaFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_FISA });
            geminiModelJurnalFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_JURNAL });
            geminiModelChat = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_CHAT });
            console.log("SDK Gemini ini»õializat. Modele: Fi»ôƒÉ Feedback:", GEMINI_MODEL_NAME_FEEDBACK_FISA, "Jurnal Feedback:", GEMINI_MODEL_NAME_FEEDBACK_JURNAL, "Chat:", GEMINI_MODEL_NAME_CHAT);
        } catch (e) {
            console.error("Eroare criticƒÉ la ini»õializarea SDK Gemini:", e);
            alert("Eroare la ini»õializarea serviciului AI. Func»õionalitatea AI va fi limitatƒÉ.");
            geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
        }
    } else {
        console.warn("Cheia API Gemini nu este configuratƒÉ. Func»õionalitatea AI va fi dezactivatƒÉ.");
        geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
    }

    // --- VARIABILE GLOBALE »òI STƒÇRI ---
    let currentUserId = null;
    let dataAlreadyLoaded = false;
    let currentFisaStep = 1;
    let totalFisaSteps = 0;
    let selectedJurnalPrompt = null;
    const jurnalPromptsList = [
            {
                label: "üå°Ô∏è ExploreazƒÉ o emo»õie", id: "explorare_emotie",
                text: "üå°Ô∏è *AstƒÉzi simt...*\nNume»ôte emo»õia dominantƒÉ: ________________\n\nüîç *Unde o simt √Æn corp?*\nDescrie senza»õiile (tensiune, greutate, pulsa»õie etc.): ________________\n\nüí≠ *Ce g√¢nduri vin cu aceastƒÉ emo»õie?*\nNoteazƒÉ g√¢ndurile automate, chiar dacƒÉ par ‚Äûexagerate‚Äù: ________________\n\nüìö *√én ce context a apƒÉrut?*\nCe s-a √Ænt√¢mplat exact? Ce a declan»ôat-o? ________________\n\nüíß *Ce nevoie ar putea semnala?*\nDe ce are nevoie aceastƒÉ parte din tine? Ce lipse»ôte? ________________\n\nüíå *DacƒÉ a»ô avea compasiune pentru mine acum...*\nCe mi-a»ô spune? Ce gest a»ô face pentru mine? ________________\n"
            },
            {
                label: "üìù AnalizeazƒÉ o situa»õie", id: "analiza_situatie",
                text: "Situa»õia care mƒÉ preocupƒÉ este: ________________\n\nCe s-a √Ænt√¢mplat exact? (Fapte): ________________\nInterpretarea mea ini»õialƒÉ (G√¢nduri automate): ________________\nEmo»õiile principale: ________________\nO altƒÉ perspectivƒÉ (Reframing): ________________\nCe am √ÆnvƒÉ»õat/pot √ÆnvƒÉ»õa? (Lec»õii): ________________\n"
            },
            {
                label: "üó£Ô∏è Dialog Voce CriticƒÉ", id: "dialog_voce_critica",
                text: "üó£Ô∏è *Vocea mea interioarƒÉ √Æmi spune...*\n(\"E»ôti slab\", \"Nu faci destul\", \"O sƒÉ fii respins\"...): ________________\n\nüòî *C√¢nd aud acest mesaj, mƒÉ simt...*\n(emo»õii »ôi senza»õii fizice): ________________\n\nüßí *AceastƒÉ voce seamƒÉnƒÉ cu...*\n(E o voce veche? un pƒÉrinte? un profesor? un fost partener?): ________________\n\nüß† *Ce nevoie ne√ÆmplinitƒÉ e √Æn spatele acestui mesaj?*\n(Poate recunoa»ôtere, protec»õie, control, apartenen»õƒÉ?): ________________\n\nüßò *RƒÉspunsul meu ca Adult SƒÉnƒÉtos ar fi...*\n(\"Apreciez cƒÉ vrei sƒÉ mƒÉ protejezi, dar acum aleg altceva.\"): ________________\n"
            },
            {
                label: "üíñ Recuno»ôtin»õƒÉ & Resurse", id: "recunostinta_resurse",
                text: "üíñ *AstƒÉzi aleg sƒÉ vƒÉd ce e bun...*\nSunt recunoscƒÉtor/oare pentru:\n1. ________________\n2. ________________\n3. ________________\n\nüå± *O resursƒÉ interioarƒÉ pe care mƒÉ pot baza astƒÉzi este...*\n(ex: curaj, bl√¢nde»õe, claritate, capacitatea de a sim»õi): ________________\n\nüõÅ *Un gest de auto-√Ængrijire pe care √Æl pot face azi...*\n(chiar dacƒÉ e mic): ________________\n"
            },
            {
                label: "üåÄ Ritual Reconstruc»õie InterioarƒÉ", id: "ritual_reconstructie",
                text: `üß≠ MASTER TEMPLATE ‚Äì Scriere TerapeuticƒÉ de Integrare »ôi Vindecare\nDenumire: ‚ÄûRitual de reconstruc»õie interioarƒÉ‚Äù\nScop: Eliberare, Clarificare, Con»õinere, √én»õelepciune, Direc»õie\n\nI. üîç INVITA»öIE LA AUTENTICITATE\n‚ÄûCe parte din mine cere aten»õie acum?‚Äù\n   * Ce trƒÉiesc cu adevƒÉrat, fƒÉrƒÉ filtru, fƒÉrƒÉ poveste cosmetizatƒÉ?\n   * Ce mi-e ru»ôine sƒÉ simt sau sƒÉ recunosc chiar »ôi √Æn scris?\n   * Ce parte din mine se simte exclusƒÉ, neauzitƒÉ, ignoratƒÉ?\nRƒÉspuns: ________________\n\nII. üåä CONTAINERE EMO»öIONALE\n‚ÄûCe simte corpul meu? Unde locuie»ôte durerea?‚Äù\n   * Unde simt emo»õia √Æn corp? Cum se manifestƒÉ? (Tensiune, √Æn»õepƒÉturi, etc.)\n   * DacƒÉ ar avea o culoare, formƒÉ, texturƒÉ ‚Äì cum ar arƒÉta?\n   * Pot respira √Æn acea zonƒÉ 3 minute, fƒÉrƒÉ sƒÉ fug?\nRƒÉspuns: ________________\n\nIII. üß† DECODIFICARE NARATIVƒÇ\n‚ÄûCe poveste √Æmi spun? Este √ÆntreagƒÉ?‚Äù\n   * Ce nara»õiune incon»ôtientƒÉ guverneazƒÉ trƒÉirea mea? (ex: ‚ÄûNu sunt dorit.‚Äù)\n   * De unde vine aceastƒÉ nara»õiune? C√¢nd am mai trƒÉit ceva similar?\n   * Ce parte din mine (copil rƒÉnit, etc.) scrie aceastƒÉ poveste?\nRƒÉspuns: ________________\n\nIV. üß© INTEGRARE EXPLICATIVƒÇ\n‚ÄûCe √Æn»õeleg nou despre mine din aceastƒÉ durere?‚Äù\n   * Ce nevoi profunde au fost ignorate sau negate?\n   * Ce am protejat, de fapt, prin reac»õia mea?\n   * Ce emo»õii contradictorii coexistƒÉ √Æn mine »ôi ce spun ele?\nRƒÉspuns: ________________\n\nV. ü™û COMPASIUNE »òI BL√ÇNDE»öE\n‚ÄûCum pot fi pƒÉrinte pentru mine acum?‚Äù\n   * DacƒÉ mi-a»ô »õine partea rƒÉnitƒÉ √Æn bra»õe, ce i-a»ô spune?\n   * Ce a»ô vrea sƒÉ aud din partea unei figuri ideale de sus»õinere?\n   * Pot lƒÉsa iubirea, nu logica, sƒÉ conducƒÉ acest moment?\nRƒÉspuns: ________________\n\nVI. üîÆ RECONFIGURARE IDENTITARƒÇ\n‚ÄûCine sunt eu dincolo de aceastƒÉ ranƒÉ?‚Äù\n   * Ce adevƒÉr despre mine rƒÉm√¢ne valabil, chiar »ôi √Æn durere?\n   * Cine devin dacƒÉ √ÆnvƒÉ»õ sƒÉ stau cu mine √Æn acest spa»õiu?\n   * DacƒÉ a»ô fi un personaj simbolic acum, cine a»ô fi?\nRƒÉspuns: ________________\n\nVII. ‚úçÔ∏è ACTUL SACRU DE ALEGERE\n‚ÄûCe aleg de azi, pentru mine?‚Äù\n   * Ce meritƒÉ sƒÉ las sƒÉ plece?\n   * Ce √Æmi iau ca √ÆnvƒÉ»õƒÉturƒÉ de √Æncredere √Æn via»õƒÉ?\n   * Ce ritual zilnic/mic obicei pot √Æncepe pentru a onora aceastƒÉ transformare?\nRƒÉspuns: ________________\n\nVIII. (Op»õional) üìú SCRISOARE-RITUAL\nScrie o scrisoare cƒÉtre... (persoana, partea din tine, situa»õia):\nRƒÉspuns: ________________\n`
            }
        ];
    let chatSession = null;
    const CHAT_HISTORY_DOC_ID_PREFIX = "chatHistory_";
    let isChatInitialized = false;

    // -----------------------------------------------------------------
    // DEFINI»öIILE FUNC»öIILOR
    // -----------------------------------------------------------------

    function showTab(tabName) {
        document.getElementById('jurnalFormContainer').style.display = (tabName === 'jurnal' ? 'block' : 'none');
        document.getElementById('fisaFormContainer').style.display = (tabName === 'fisa' ? 'block' : 'none');
        document.getElementById('tabButtonJurnal').classList.toggle('active', tabName === 'jurnal');
        document.getElementById('tabButtonFisa').classList.toggle('active', tabName === 'fisa');
        document.getElementById('jurnalConfirmationMessage').style.display = 'none';
        document.getElementById('fisaConfirmationMessage').style.display = 'none';
    }

    function updateFisaProgressBar() {
        const progress = document.getElementById('fisaProgress');
        if (progress && totalFisaSteps > 0) {
            progress.style.width = (currentFisaStep / totalFisaSteps) * 100 + '%';
        }
    }

    function fisaNextStep() {
        if (currentFisaStep < totalFisaSteps) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep++;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function fisaPreviousStep() {
        if (currentFisaStep > 1) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep--;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function initializeFisaFormFunctionality() {
        const formSteps = document.querySelectorAll('form#fisaExercitiuForm div.question-card.form-step');
        if (formSteps.length > 0) {
            totalFisaSteps = formSteps.length;
            formSteps.forEach((step, index) => {
                step.classList.toggle('form-step-active', index === 0);
            });
            currentFisaStep = 1;
            updateFisaProgressBar();
        } else {
            totalFisaSteps = 0;
        }
        document.getElementById("fisaNextButton")?.addEventListener("click", fisaNextStep);
        document.getElementById("fisaPrevButton")?.addEventListener("click", fisaPreviousStep);
        document.getElementById("fisaAddButton")?.addEventListener("click", salveazaIntrospectieFisa);
    }

    function toggleActiveJurnalPrompt(show, promptData = null) {
        const box = document.getElementById('activeJurnalPromptBox');
        const titleEl = document.getElementById('activeJurnalPromptTitle');
        const contentEl = document.getElementById('activeJurnalPromptContent');
        const journalTextarea = document.getElementById("journalContent");

        if (show && promptData) {
            selectedJurnalPrompt = promptData;
            if(titleEl) titleEl.textContent = `Ghid activ: ${promptData.label}`;
            if(contentEl) contentEl.textContent = promptData.text;
            if(box) box.style.display = 'block';
            if (contentEl) contentEl.scrollTop = 0;
            
            if (journalTextarea && journalTextarea.value.trim() !== "" && promptData.id !== (selectedJurnalPrompt?.previousIdForClearCheck)) {
                if (confirm("Dore»ôti sƒÉ »ôtergi con»õinutul actual al jurnalului pentru a √Æncepe cu acest nou ghid?")) {
                   journalTextarea.value = "";
                }
            }
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = promptData.id;
        } else {
            selectedJurnalPrompt = null;
            if(box) box.style.display = 'none';
        }
    }

    window.hideActiveJurnalPromptManual = function() { // RƒÉm√¢ne globalƒÉ pentru onclick din HTML
        const box = document.getElementById('activeJurnalPromptBox');
        if(box) box.style.display = 'none';
    }

       async function salveazaIntrospectieFisa() {
        const form = document.getElementById("fisaExercitiuForm");
        const confirmationMessage = document.getElementById('fisaConfirmationMessage');

        if (form && !form.checkValidity()) {
            form.reportValidity();
            const currentStepElement = form.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid:not(fieldset)');
            if (firstInvalidField) {
                firstInvalidField.focus();
                alert("VƒÉ rugƒÉm completa»õi toate c√¢mpurile obligatorii din pasul curent √Ænainte de a salva.");
            } else {
                alert("VƒÉ rugƒÉm completa»õi toate c√¢mpurile obligatorii.");
            }
            return;
        }

        const continutFisa = {};
        if (form) {
            const formData = new FormData(form);
            formData.forEach((value, key) => { continutFisa[key] = value.trim(); });
        } else {
            console.error("Formularul 'fisaExercitiuForm' nu a fost gƒÉsit.");
            return;
        }

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'fisa',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutFisa
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sƒÉ fi»õi autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const addButton = document.getElementById("fisaAddButton");
        let originalAddButtonText = "";
        if (addButton) {
            originalAddButtonText = addButton.textContent;
            addButton.textContent = "Se salveazƒÉ »ôi se genereazƒÉ...";
            addButton.disabled = true;
        }
        if (confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id; // AdaugƒÉ ID-ul pentru generarea feedback-ului
            if (addButton) addButton.textContent = "Se genereazƒÉ AI...";

            const feedbackGenerat = await genereazaFeedbackPentruIntrospectie(introspectieData);
            
            const docSnapshot = await getDoc(docRef); // Re-fetch pentru a avea »ôi feedback-ul salvat
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                // Fallback dacƒÉ doc-ul nu e imediat vizibil (pu»õin probabil)
                introspectieData.feedbackAI_history = feedbackGenerat && !feedbackGenerat.error ? [feedbackGenerat] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            if (form) {
                form.reset(); currentFisaStep = 1;
                form.querySelectorAll('.form-step').forEach(step => step.classList.remove('form-step-active'));
                const firstStepEl = document.getElementById('fisa-step-1');
                if (firstStepEl) firstStepEl.classList.add('form-step-active');
                updateFisaProgressBar();
            }

            if (confirmationMessage) {
                if (feedbackGenerat && !feedbackGenerat.error && !feedbackGenerat.error_parsing) {
                    confirmationMessage.textContent = 'Fi»ôa a fost salvatƒÉ »ôi feedback-ul AI generat cu succes!';
                    confirmationMessage.className = 'confirmation-message success';
                } else if (feedbackGenerat && (feedbackGenerat.error || feedbackGenerat.error_parsing)) {
                    confirmationMessage.textContent = `Fi»ôa salvatƒÉ. Feedback AI: ${feedbackGenerat.rawText || 'ProblemƒÉ la generare/parsare.'}`;
                    confirmationMessage.className = (feedbackGenerat.rawText && feedbackGenerat.rawText.toLowerCase().includes("limit")) ? 'confirmation-message warning' : 'confirmation-message error';
                } else {
                    confirmationMessage.textContent = 'Fi»ôa salvatƒÉ, dar feedback-ul AI nu a putut fi generat/procesat.';
                    confirmationMessage.className = 'confirmation-message error';
                }
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if (confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea fi»ôei sau generare feedback:", error);
            if (confirmationMessage) {
                confirmationMessage.textContent = 'Eroare la salvarea fi»ôei. √éncerca»õi din nou.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            if (addButton) {
                addButton.textContent = originalAddButtonText;
                addButton.disabled = false;
            }
        }
    }

    function initializeJurnalFormFunctionality() {
        const promptsContainerEl = document.getElementById("reflectionPrompts");
        const journalTextarea = document.getElementById("journalContent");
        if (!promptsContainerEl || !journalTextarea) return;

        promptsContainerEl.innerHTML = '';
        jurnalPromptsList.forEach(prompt => {
            const button = document.createElement("button");
            button.textContent = prompt.label;
            button.className = "prompt-button";
            button.type = "button";
            button.title = "Afi»ôeazƒÉ acest ghid »ôi folose»ôte-l ca referin»õƒÉ";
            button.onclick = () => {
                toggleActiveJurnalPrompt(true, prompt);
                journalTextarea.focus();
            };
            promptsContainerEl.appendChild(button);
        });
        document.getElementById("saveJournalEntryButton")?.addEventListener("click", salveazaIntrospectieJurnal);
    }

        async function salveazaIntrospectieJurnal() {
        const journalTextarea = document.getElementById("journalContent");
        const journalTitleInput = document.getElementById("journalTitle");
        const confirmationMessage = document.getElementById('jurnalConfirmationMessage');

        if (!journalTextarea || journalTextarea.value.trim() === "") {
            alert("VƒÉ rugƒÉm sƒÉ scrie»õi ceva √Æn jurnal √Ænainte de a salva.");
            return;
        }

        const tipPromptFolosit = selectedJurnalPrompt ? selectedJurnalPrompt.id : "prompt_personalizat";

        const continutJurnal = {
            titluJurnal: (journalTitleInput?.value.trim() !== "") ? journalTitleInput.value.trim() : `Intrare din ${new Date().toLocaleDateString("ro-RO")}`,
            textJurnal: journalTextarea.value,
            promptUtilizatJurnal: tipPromptFolosit
        };

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'jurnal',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutJurnal
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sƒÉ fi»õi autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const saveButton = document.getElementById("saveJournalEntryButton");
        const originalButtonText = saveButton.textContent;
        saveButton.textContent = "Se salveazƒÉ..."; saveButton.disabled = true;
        if(confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id;
            saveButton.textContent = "Se genereazƒÉ AI...";

            const parsedFeedback = await genereazaFeedbackPentruIntrospectie(introspectieData);

            const docSnapshot = await getDoc(docRef);
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                introspectieData.feedbackAI_history = parsedFeedback && !parsedFeedback.error ? [parsedFeedback] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            journalTextarea.value = "";
            if (journalTitleInput) journalTitleInput.value = "";
            toggleActiveJurnalPrompt(false); // Ascunde ghidul activ
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = null;

            if(confirmationMessage) {
                confirmationMessage.textContent = parsedFeedback.error ? `Intrare salvatƒÉ. Feedback AI: ${parsedFeedback.rawText}` : 'Intrare salvatƒÉ »ôi feedback AI generat!';
                confirmationMessage.className = `confirmation-message ${parsedFeedback.error ? 'error' : 'success'}`;
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if(confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea intrƒÉrii de jurnal sau generare feedback:", error);
            if(confirmationMessage){
                confirmationMessage.textContent = 'Eroare la salvare sau la generarea feedback-ului AI.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            saveButton.textContent = originalButtonText;
            saveButton.disabled = false;
        }
    }

    async function callGeminiAPI(promptText, modelToUse, generationConfigOptions = {}) {
        if (!modelToUse) {
            console.error("Modelul Gemini specificat este invalid sau neini»õializat.");
            return "EROARE: Model AI neini»õializat. VerificƒÉ cheia API.";
        }
        try {
            console.log(`Trimitem la Gemini (${modelToUse === geminiModelChat ? "Chat" : (modelToUse === geminiModelFisaFeedback ? "Fi»ôƒÉ" : "Jurnal") }, primele 200 caractere):`, promptText.substring(0, 20000));
            const requestPayload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }],
                generationConfig: { temperature: 0.6, maxOutputTokens: 80000, ...generationConfigOptions }
            };
            const result = await modelToUse.generateContent(requestPayload);
            const response = result.response;

            if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                if (response.candidates[0].finishReason && !["STOP", "MAX_TOKENS"].includes(response.candidates[0].finishReason)) {
                    console.warn("Gemini a oprit generarea prematur:", response.candidates[0].finishReason, response.candidates[0].safetyRatings);
                    return `EROARE Gemini: Generare opritƒÉ (Motiv: ${response.candidates[0].finishReason}). Detalii: ${JSON.stringify(response.candidates[0].safetyRatings || 'N/A')}`;
                }
                return response.candidates[0].content.parts[0].text;
            } else if (response?.promptFeedback?.blockReason) {
                console.error("Prompt blocat de Gemini:", response.promptFeedback.blockReasonDetail || response.promptFeedback.blockReason);
                 return `EROARE Gemini: Prompt blocat (Motiv: ${response.promptFeedback.blockReason}). Detalii: ${JSON.stringify(response.promptFeedback.blockReasonDetail || response.promptFeedback.safetyRatings || 'N/A')}`;
            } else {
                console.error("RƒÉspuns Gemini nea»ôteptat sau gol:", JSON.stringify(response, null, 2));
                return "EROARE Gemini: RƒÉspuns invalid sau gol de la API.";
            }
        } catch (error) {
            console.error("Eroare detaliatƒÉ la callGeminiAPI:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare API necunoscutƒÉ"}`;
             if (error.toString().toLowerCase().includes("api key not valid") ||
                (error.message && error.message.toLowerCase().includes("permission denied")) ||
                (error.message && error.message.toLowerCase().includes("api_key_invalid")) ||
                (error.status && error.status === 403)) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validƒÉ sau nu are permisiuni.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare API Gemini a fost depƒÉ»ôitƒÉ.";
            } else if (error.message && (error.message.toLowerCase().includes("candidate.finish_reason") || error.message.toLowerCase().includes("safety") || error.message.toLowerCase().includes("blocked due to safety_settings"))) {
                errorMessage = "EROARE Gemini: Generarea opritƒÉ (motive de siguran»õƒÉ/con»õinut).";
            }  else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 let modelName = "necunoscut";
                 if (modelToUse === geminiModelFisaFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_FISA;
                 else if (modelToUse === geminiModelJurnalFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_JURNAL;
                 else if (modelToUse === geminiModelChat) modelName = GEMINI_MODEL_NAME_CHAT;
                 errorMessage = `EROARE Gemini: Modelul ${modelName} nu a fost gƒÉsit.`;
            }
            return errorMessage;
         }
    }

    function buildAdaptiveAIPromptFisa(introspectieData) {
        const rowData = introspectieData.continut;
        return `
AnalizeazƒÉ √Æn profunzime aceastƒÉ fi»ôƒÉ completƒÉ de auto-reflec»õie. Utilizatorul a parcurs un exerci»õiu detaliat pentru a-»ôi √Æn»õelege o situa»õie specificƒÉ. OferƒÉ feedback psihologic structurat, empatic »ôi ac»õionabil. RespectƒÉ cu stricte»õe formatul »ôi ordinea sec»õiunilor de mai jos, folosind exact prefixele indicate (ex: \`EmpatieIni»õialƒÉ:\`, \`PuncteForteObservate:\`). Folose»ôte Markdown pentru formatarea textului √Æn interiorul fiecƒÉrei sec»õiuni (ex: \`**Text bold**\`, \`*Text italic*\`, liste cu \`* Element\`).

**Datele Complete din Fi»ôa de Reflec»õie a Utilizatorului:**

**Sec»õiunea 1: Explorarea Situa»õiei »ôi a Nevoilor**
*   Care este situa»õia?: ${rowData.situatie || 'N/A'}
*   Ce √Æmi trece prin minte (g√¢nduri automate)?: ${rowData.ganduri || 'N/A'}
*   Cum mƒÉ face acel g√¢nd sƒÉ mƒÉ simt (emo»õii)?: ${rowData.emotii || 'N/A'}
*   Ce mod este activ?: ${rowData.mod_activ || 'N/A'}
*   Ce comportament sim»õi cƒÉ adop»õi?: ${rowData.comportament || 'N/A'}
*   Care sunt nevoile tale mai profunde?: ${rowData.nevoi_profunde || 'N/A'}
*   MƒÉ ajutƒÉ comportamentul meu sƒÉ √Ændeplinesc aceste nevoi?: ${rowData.ajutor_comportament || 'N/A'}
*   Cum ar g√¢ndi »ôi cum s-ar comporta Adultul SƒÉnƒÉtos (perspectiva utilizatorului)?: ${rowData.adult_sanatos || 'N/A'}

**Sec»õiunea 2: Analiza G√¢ndurilor »ôi a Percep»õiilor**
*   Ce mƒÉ face sƒÉ cred cƒÉ g√¢ndul automat este adevƒÉrat?: ${rowData.dovezi_adevar || 'N/A'}
*   Ce mƒÉ face sƒÉ cred cƒÉ nu este adevƒÉrat?: ${rowData.dovezi_fals || 'N/A'}
*   ExistƒÉ o explica»õie alternativƒÉ?: ${rowData.explicatie_alternativa || 'N/A'}
*   Care este cel mai rƒÉu lucru care s-ar putea √Ænt√¢mpla?: ${rowData.scenariu_negativ || 'N/A'}
*   Care este cel mai bun lucru care s-ar putea √Ænt√¢mpla?: ${rowData.scenariu_optimist || 'N/A'}
*   Care este cel mai realist rezultat?: ${rowData.rezultat_realist || 'N/A'}
*   Ce s-ar √Ænt√¢mpla dacƒÉ mi-a»ô schimba modul de g√¢ndire?: ${rowData.schimbare_gandire || 'N/A'}
*   Ce i-a»ô spune unui prieten dacƒÉ ar fi √Æn aceea»ôi situa»õie?: ${rowData.sfat_prieten || 'N/A'}

**Sec»õiunea 3: √éntrebƒÉri pentru Claritate »ôi Reflec»õie SuplimentarƒÉ**
*   VƒÉd doar partea rea a lucrurilor?: ${rowData.partea_rea || 'N/A'}
*   √émi asum responsabilitatea pentru lucruri care nu au stat √Æn puterea mea?: ${rowData.responsabilitate || 'N/A'}
*   MƒÉ condamn √Æn baza unui singur eveniment?: ${rowData.condamnare || 'N/A'}
*   Privesc situa»õia √Æn termeni extremi (alb/negru)?: ${rowData.termeni_extremi || 'N/A'}
*   Exagerez situa»õia?: ${rowData.exagerare || 'N/A'}
*   ExistƒÉ »ôi al»õi factori responsabili?: ${rowData.factori_responsabili || 'N/A'}
*   Am sƒÉrit direct la concluzii?: ${rowData.concluzii || 'N/A'}
*   √émi pun √ÆntrebƒÉri fƒÉrƒÉ rƒÉspuns?: ${rowData.intrebari_fara_raspuns || 'N/A'}
*   MƒÉ concentrez doar asupra slƒÉbiciunilor mele?: ${rowData.slabiciuni || 'N/A'}
*   MƒÉ zbat prea mult g√¢ndind la cum ar trebui sƒÉ fie lucrurile?: ${rowData.cum_ar_trebui || 'N/A'}
*   MƒÉ a»ôtept sƒÉ fiu perfect?: ${rowData.perfectiune || 'N/A'}

**CERIN»öE PENTRU FEEDBACK-UL AI (folose»ôte prefixele EXACT a»ôa cum sunt scrise »ôi formatarea Markdown √Æn interiorul rƒÉspunsurilor):**

EmpatieIni»õialƒÉ: (1-2 propozi»õii empatice scurte, recunosc√¢nd efortul utilizatorului.)
PuncteForteObservate: (IdentificƒÉ 1-2 aspecte pozitive sau de auto-con»ôtientizare observate √Æn rƒÉspunsurile utilizatorului.)
TiparePrincipale: (Descrie succint 1-3 tipare de g√¢ndire/emo»õionale/comportamentale centrale care reies din fi»ôƒÉ.)
ConexiuniCheie: (SintetizeazƒÉ legƒÉtura S-G-E-C-N (Situa»õie-G√¢nd-Emo»õie-Comportament-Nevoie) specificƒÉ acestei fi»ôe, baz√¢ndu-te pe rƒÉspunsurile la '${rowData.ganduri}', '${rowData.emotii}', '${rowData.comportament}', '${rowData.nevoi_profunde}'.)
DistorsiuniIdentificate: (IdentificƒÉ 2-3 distorsiuni cognitive principale din rƒÉspunsuri. Pentru fiecare:
*   Numele Distorsiunii (ex: \`**Catastrofizare**\`)
*   O scurtƒÉ explica»õie a distorsiunii (1 propozi»õie).
*   Un exemplu specific din rƒÉspunsurile utilizatorului care ilustreazƒÉ distorsiunea.
*   O √Æntrebare de contestare sau reflec»õie pentru acea distorsiune (ex: "*Cum ar arƒÉta o perspectivƒÉ mai echilibratƒÉ asupra X?*").
ListeazƒÉ fiecare distorsiune ca un sub-punct separat.)
SchemeActivate: (SugereazƒÉ 1-2 scheme cognitive maladaptative timpurii care par a fi activate de situa»õia descrisƒÉ (ex: Defectivitate/Ru»ôine, Abandon, Deprivare Emo»õionalƒÉ etc.). Pentru fiecare:
*   Numele Schemei (ex: \`**Schema de E»ôec**\`)
*   O scurtƒÉ descriere a cum se manifestƒÉ √Æn general acea schemƒÉ (1-2 propozi»õii).
*   Cum ar putea rƒÉspunsurile utilizatorului din aceastƒÉ fi»ôƒÉ (g√¢nduri, emo»õii, comportamente) sƒÉ reflecte activarea acestei scheme?
Fii speculativ »ôi empatic, nu conclusiv. PrezintƒÉ ca sub-puncte.)
ModuriImplicate: (SugereazƒÉ pe scurt ce moduri din Terapia Schemelor ar putea fi active sau implicate, pe l√¢ngƒÉ cel men»õionat de utilizator, dacƒÉ este cazul. Ex: Copil Vulnerabil, PƒÉrinte Punitiv, Protector Deta»ôat. Fii concis.)
PerspectivaAdultSƒÉnƒÉtos: (ComenteazƒÉ rƒÉspunsul utilizatorului despre cum ar ac»õiona Adultul SƒÉnƒÉtos ('${rowData.adult_sanatos}'). Este realist? Compasional? OferƒÉ sugestii pentru a √ÆntƒÉri »ôi mai mult aceastƒÉ perspectivƒÉ, incluz√¢nd:
    *   Cum ar putea Adultul SƒÉnƒÉtos sƒÉ interpreteze situa»õia diferit?
    *   Ce g√¢nduri alternative ar putea cultiva?
    *   Cum ar gestiona emo»õiile √Æntr-un mod adaptativ?
    *   Ce comportamente constructive ar adopta pentru a-»ôi √Æmplini nevoile?
    *   Cum ar putea contracara activ schemele sau modurile disfunc»õionale?)
√éntrebareFinalƒÉReflec»õie: (O √Æntrebare generalƒÉ, puternicƒÉ »ôi deschisƒÉ, care sƒÉ √Æncurajeze utilizatorul sƒÉ integreze √ÆnvƒÉ»õƒÉmintele din aceastƒÉ fi»ôƒÉ √Æn via»õa sa de zi cu zi sau sƒÉ reflecteze la un aspect mai larg.)
SugestieMicPas: (O sugestie concretƒÉ, micƒÉ »ôi realizabilƒÉ, pentru un pas pe care utilizatorul l-ar putea face √Æn urmƒÉtoarele zile pentru a exersa o abilitate nouƒÉ, a contesta un g√¢nd, sau a ac»õiona din perspectiva Adultului SƒÉnƒÉtos, bazat pe analiza fi»ôei.)
√éncurajareFinalƒÉ: (1-2 propozi»õii de √Æncurajare, validare »ôi speran»õƒÉ.)

RƒÉspunde doar cu textul cerut conform structurii, fƒÉrƒÉ introduceri ("IatƒÉ feedback-ul...") sau concluzii suplimentare ("Sper cƒÉ acest feedback..."), √Æn afara celor specificate. AsigurƒÉ-te cƒÉ fiecare sec»õiune √Æncepe exact cu prefixul dat (ex: \`EmpatieIni»õialƒÉ:\`).`;
    }

    function buildAdaptiveAIPromptJurnal(introspectieData) {
        const { titluJurnal, textJurnal, promptUtilizatJurnal } = introspectieData.continut;
        let specificInstructions = "";
        let modelFocus = "feedback general »ôi reflec»õie";
        let guideText = null;

        const ghidGasit = jurnalPromptsList.find(p => p.id === promptUtilizatJurnal);
        if (ghidGasit) {
            guideText = ghidGasit.text;
        }

        let basePrompt = `E»ôti PsihoGPT ‚Äì un terapeut AI avansat, extrem de empatic, cu o profundƒÉ √Æn»õelegere a psihologiei umane, antrenat √Æn Terapie Cognitiv-ComportamentalƒÉ (TCC), Terapia Schemelor, Terapia prin Acceptare »ôi Angajament (ACT), Scrierea ExpresivƒÉ »ôi principii de mindfulness. ComunicƒÉ √Æntr-un limbaj cald, validant »ôi u»ôor de √Æn»õeles, dar pƒÉstreazƒÉ profunzimea analiticƒÉ. Folose»ôte formatare Markdown pentru structurare (titluri principale cu \`**Titlu Principal**\`, subtitluri dacƒÉ e cazul cu \`### Subtitlu\`, liste cu \`* Element listƒÉ\`, text bold cu \`**text bold**\` »ôi italic cu \`*text italic*\` unde e cazul). EvitƒÉ citatele direct din literaturƒÉ dacƒÉ nu sunt absolut esen»õiale, concentreazƒÉ-te pe limbajul tƒÉu.

Obiectivul tƒÉu este sƒÉ oferi un feedback personalizat, constructiv »ôi profund pentru urmƒÉtoarea intrare √Æn jurnal. Nu oferi sfaturi medicale sau diagnostice. ConcentreazƒÉ-te pe facilitarea auto-√Æn»õelegerii »ôi a cre»ôterii personale. Utilizatorul a avut la dispozi»õie un ghid vizual (tipul: "${promptUtilizatJurnal}") pentru a-»ôi structura g√¢ndurile, iar textul de mai jos reprezintƒÉ rƒÉspunsurile sale la acel ghid sau o reflec»õie liberƒÉ inspiratƒÉ de el.`;

        switch (promptUtilizatJurnal) {
            case "ritual_reconstructie":
                specificInstructions = `Utilizatorul a folosit ghidul "Ritual de Reconstruc»õie InterioarƒÉ", care are 7 sec»õiuni principale (I. Invita»õie la Autenticitate, II. Containere Emo»õionale, III. Decodificare NarativƒÉ, IV. Integrare ExplicativƒÉ, V. Compasiune »ôi Bl√¢nde»õe, VI. Reconfigurare IdentitarƒÉ, VII. Actul Sacru de Alegere) »ôi poate o sec»õiune VIII (Scrisoare-Ritual). Feedback-ul tƒÉu AR TREBUI SƒÇ URMEZE ACEASTƒÇ STRUCTURƒÇ. Pentru FIECARE sec»õiune a ritualului (I-VII »ôi op»õional VIII):
1.  **Nume»ôte sec»õiunea clar** (ex: \`**I. Invita»õie la Autenticitate:**\`).
2.  Pe baza textului utilizatorului (\`Text Complet Jurnal Utilizator\` de mai jos), **extrage »ôi reflectƒÉ** ce a scris sau ce pare sƒÉ fi explorat pentru ACEASTƒÇ sec»õiune specificƒÉ. Fii concis »ôi la obiect. DacƒÉ utilizatorul nu pare sƒÉ fi adresat o sec»õiune, men»õioneazƒÉ scurt sau sari peste ea.
3.  **OferƒÉ o scurtƒÉ validare empaticƒÉ** dacƒÉ a completat ceva relevant pentru sec»õiune.
4.  **Pune 1-2 √ÆntrebƒÉri de aprofundare SPECIFICE** pentru acea sec»õiune.
DupƒÉ ce ai parcurs sec»õiunile individuale, adaugƒÉ o sec»õiune de \`**### Concluzii »ôi Reflec»õii Finale:**\`
*   **Sinteza Conexiunilor:** IdentificƒÉ 1-2 conexiuni sau teme generale.
*   **√éncurajare »ôi Pa»ôi UrmƒÉtori:** √éncurajeazƒÉ procesul de transformare.`;
                modelFocus = "analizƒÉ structuratƒÉ a ritualului de reconstruc»õie.";
                break;
            case "dialog_voce_critica":
                specificInstructions = `Utilizatorul a folosit ghidul "Dialog Voce CriticƒÉ". AnalizeazƒÉ rƒÉspunsurile »ôi structureazƒÉ feedback-ul:
1.  **\`**Validare EmpaticƒÉ Ini»õialƒÉ:\`**
2.  **\`**Analiza Mesajului Critic:\`**
3.  **\`**Impactul Emo»õional »ôi Corporal:\`**
4.  **\`**Originea Vocii (dacƒÉ e exploratƒÉ):\`**
5.  **\`**Nevoia Ne√ÆmplinitƒÉ:\`**
6.  **\`**For»õa Adultului SƒÉnƒÉtos:\`**
7.  **\`**### √éntrebƒÉri de Aprofundare »ôi Direc»õii:\`** (1-2 √ÆntrebƒÉri)
8.  **\`**NotƒÉ despre Scheme (op»õional):\`**`;
                modelFocus = "analizƒÉ dialog voce criticƒÉ, cultivarea Adultului SƒÉnƒÉtos.";
                break;
            case "explorare_emotie":
                specificInstructions = `Utilizatorul a folosit ghidul "ExploreazƒÉ o emo»õie". Feedback-ul parcurge pa»ôii:
1.  **\`**Validarea Emo»õiei Denumite:\`**
2.  **\`**Conexiunea Corp-Emo»õie:\`**
3.  **\`**Rela»õia G√¢nduri-Emo»õie:\`**
4.  **\`**Contextul »ôi Declan»ôatorul:\`**
5.  **\`**Nevoia FundamentalƒÉ SemnalatƒÉ:\`**
6.  **\`**Gestul de Auto-Compasiune:\`**
7.  **\`**### Reflec»õii Suplimentare »ôi √éntrebƒÉri:\`** (1-2 √ÆntrebƒÉri)`;
                modelFocus = "analizƒÉ explorare emo»õie, √Æn»õelegere profundƒÉ.";
                break;
            case "recunostinta_resurse":
                specificInstructions = `Utilizatorul a folosit "Recuno»ôtin»õƒÉ & Resurse". StructureazƒÉ:
1.  **\`**Aprecierea Practicii Recuno»ôtin»õei:\`**
2.  **\`**Observa»õii asupra Elementelor de Recuno»ôtin»õƒÉ:\`**
3.  **\`**Explorarea Resursei Interioare:\`**
4.  **\`**Impactul Gestului de Auto-√éngrijire:\`**
5.  **\`**### √éntrebƒÉri pentru Consolidare:\`** (1-2 √ÆntrebƒÉri)`;
                modelFocus = "√Æncurajare recuno»ôtin»õƒÉ, conectare resurse.";
                break;
            case "analiza_situatie":
                specificInstructions = `Utilizatorul a folosit "AnalizeazƒÉ o situa»õie". ReflectƒÉ structura:
1.  **\`**Recunoa»ôterea Efortului Analitic:\`**
2.  **\`**Situa»õia »ôi Faptele:\`**
3.  **\`**Interpretarea Ini»õialƒÉ »ôi Emo»õiile:\`**
4.  **\`**Puterea Re√ÆncadrƒÉrii (Reframing):\`**
5.  **\`**Lec»õii √énvƒÉ»õate:\`**
6.  **\`**### √éntrebƒÉri pentru Ac»õiune »ôi Integrare:\`** (1-2 √ÆntrebƒÉri)`;
                modelFocus = "sus»õinere analizƒÉ situa»õie, re√Æncadrare, ac»õiuni.";
                break;
            default: // prompt_personalizat
                specificInstructions = `Utilizatorul a scris o intrare liberƒÉ. Feedback empatic:
1.  **\`**Validare EmpaticƒÉ GeneralƒÉ:\`**
2.  **\`**Identificarea Temelor Centrale (1-2):\`**
3.  **\`**Reflec»õie OglindƒÉ:\`**
4.  **\`**### √éntrebƒÉri Deschise »ôi Evocatoare (2-3):\`**
5.  **\`**√éncurajare FinalƒÉ:\`**`;
                modelFocus = "reflec»õie empaticƒÉ text liber, identificare teme, √ÆntrebƒÉri deschise.";
                break;
        }

        const ghidReferintaText = guideText ? `\n\n--- TEXTUL GHIDULUI DE REFERIN»öƒÇ (NU RƒÇSPUNSURILE UTILIZATORULUI) ---\n\`\`\`\n${guideText}\n\`\`\`\nUtilizatorul a avut acest ghid afi»ôat »ôi a scris rƒÉspunsurile √Æn sec»õiunea "Text Complet Jurnal Utilizator" de mai jos.` : "\n\nUtilizatorul a scris liber sau detaliile specifice ale ghidului nu sunt furnizate aici; concentreazƒÉ-te pe rƒÉspunsurile utilizatorului »ôi tipul de ghid general.";

        return `${basePrompt}
${ghidReferintaText}

**Focusul specific pentru aceastƒÉ intrare de jurnal (bazat pe ghidul "${promptUtilizatJurnal}") este: ${modelFocus}.**

**Instruc»õiuni specifice pentru feedback bazat pe tipul de ghid ("${promptUtilizatJurnal}"):**
${specificInstructions}
---
**INFORMA»öII DESPRE INTRAREA UTILIZATORULUI:**
Titlu Jurnal: ${titluJurnal || "FƒÉrƒÉ titlu"}
Tipul de Ghid Utilizat (selectat de utilizator / detectat): ${promptUtilizatJurnal}

**TEXT COMPLET JURNAL UTILIZATOR (RƒÇSPUNSURILE SALE):**
\`\`\`
${textJurnal}
\`\`\`
---
Te rog sƒÉ generezi un feedback AI detaliat, empatic »ôi structurat conform instruc»õiunilor de mai sus, personalizat pe baza textului furnizat de utilizator. AsigurƒÉ-te cƒÉ respec»õi formatarea Markdown cerutƒÉ pentru lizibilitate. Mul»õumesc!`;
    }

    async function genereazaFeedbackPentruIntrospectie(introspectieData) {
        if (!introspectieData || !introspectieData.id || !introspectieData.type || !introspectieData.continut) {
            return { rawText: "EROARE: Date incomplete.", error: true, timestamp: new Date().toISOString() };
        }
        let promptText = "";
        let modelToUse = null;
        let modelNameForLog = "";

        if (introspectieData.type === 'fisa') {
            if (!geminiModelFisaFeedback) return { rawText: "EROARE: Model AI fi»ôe indisponibil.", error: true, timestamp: new Date().toISOString() };
            promptText = buildAdaptiveAIPromptFisa(introspectieData);
            modelToUse = geminiModelFisaFeedback;
            modelNameForLog = GEMINI_MODEL_NAME_FEEDBACK_FISA;
        } else if (introspectieData.type === 'jurnal') {
            if (!geminiModelJurnalFeedback) return { rawText: "EROARE: Model AI jurnal indisponibil.", error: true, timestamp: new Date().toISOString() };
            promptText = buildAdaptiveAIPromptJurnal(introspectieData);
            modelToUse = geminiModelJurnalFeedback;
            modelNameForLog = GEMINI_MODEL_NAME_FEEDBACK_JURNAL;
        } else {
            return { rawText: "EROARE: Tip introspec»õie necunoscut.", error: true, timestamp: new Date().toISOString() };
        }

        const feedbackRawText = await callGeminiAPI(promptText, modelToUse);
        const parsedFeedback = {
            rawText: feedbackRawText,
            model: `Gemini (${modelNameForLog})`,
            timestamp: new Date().toISOString(),
            error: typeof feedbackRawText === 'string' && feedbackRawText.toUpperCase().startsWith("EROARE:"),
            error_parsing: false
        };
        
        if (introspectieData.type === 'fisa' && !parsedFeedback.error) {
            const feedbackStructure = {
                empatie_initiala: /^EmpatieIni»õialƒÉ:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                puncte_forte: /^PuncteForteObservate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                tipare_principale: /^TiparePrincipale:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                conexiuni_cheie: /^ConexiuniCheie:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                distorsiuni_identificate: /^DistorsiuniIdentificate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                scheme_activate: /^SchemeActivate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                moduri_implicate: /^ModuriImplicate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                perspectiva_adult_sanatos: /^PerspectivaAdultSƒÉnƒÉtos:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                intrebare_finala_reflectie: /^√éntrebareFinalƒÉReflec»õie:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                sugestie_mic_pas: /^SugestieMicPas:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                incurajare_finala: /^√éncurajareFinalƒÉ:\s*([\s\S]*?$)/im,
            };
            let allParsingOk = true;
            for (const key in feedbackStructure) {
                const match = feedbackRawText.match(feedbackStructure[key]);
                if (match && match[1] && match[1].trim() !== "") {
                     parsedFeedback[key] = match[1].trim();
                } else {
                    parsedFeedback[key] = `(Sec»õiune neextrasƒÉ: ${key})`; allParsingOk = false;
                }
            }
            if (!allParsingOk) parsedFeedback.error_parsing = true;
        } else if (introspectieData.type === 'jurnal' && !parsedFeedback.error) {
            parsedFeedback.promptTypeAtGeneration = introspectieData.continut.promptUtilizatJurnal || "necunoscut";
        }

        const docRef = doc(db, "introspectii", introspectieData.id);
        try {
            await updateDoc(docRef, { feedbackAI_history: arrayUnion(parsedFeedback) });
            console.log(`Feedback AI (tip: ${introspectieData.type}) salvat pentru ${introspectieData.id}`);
        } catch (updateError) {
            console.error(`Eroare update feedback pentru ${introspectieData.id}:`, updateError);
        }
        return parsedFeedback;
    }

    async function incarcaToateIntrospectiile(userId) {
        const container = document.getElementById("introspectiiCardContainer");
        if (!container || !userId) return;
        let loadingMsg = container.querySelector(".loading-message");
        if (!container.querySelector('.introspectie-card') && !loadingMsg) {
            loadingMsg = document.createElement("p");
            loadingMsg.className = "loading-message";
            loadingMsg.textContent = "Se √ÆncarcƒÉ introspec»õiile...";
            container.appendChild(loadingMsg);
        }
        try {
            const q = query(collection(db, "introspectii"), where("ownerUid", "==", userId), orderBy("timestampCreare", "desc"));
            const querySnapshot = await getDocs(q);
            if (loadingMsg) loadingMsg.remove();
            container.innerHTML = ''; 
            if (querySnapshot.empty) {
                container.innerHTML = "<p class='no-entries-message'>Nicio introspec»õie salvatƒÉ.</p>";
            } else {
                querySnapshot.forEach((docSnap) => {
                    afiseazaCardIntrospectie({ id: docSnap.id, ...docSnap.data() });
                });
            }
        } catch (error) {
            console.error("Eroare √ÆncƒÉrcare introspec»õii:", error);
            if (loadingMsg) loadingMsg.remove();
            if (!container.querySelector('.introspectie-card')) {
                 container.innerHTML = "<p class='error-loading-message'>Eroare la √ÆncƒÉrcarea introspec»õiilor.</p>";
            }
        }
    }
    
    function afiseazaIstoricFeedbackIntrospectie(containerEl, feedbackHistory) {
        containerEl.innerHTML = '';
        if (!feedbackHistory || !Array.isArray(feedbackHistory) || feedbackHistory.length === 0) {
            containerEl.innerHTML = "<p class='no-feedback-message'>Niciun feedback AI generat.</p>"; return;
        }
        feedbackHistory.slice().reverse().forEach((entry, index) => {
            const itemContainer = document.createElement("div");
            itemContainer.className = "feedback-entry-card";
            const modelInfo = entry.model || 'N/A';
            let promptTypeInfo = '';
            if (entry.promptTypeAtGeneration && entry.promptTypeAtGeneration !== "necunoscut" && entry.promptTypeAtGeneration !== "prompt_personalizat") {
                 const promptLabelFound = jurnalPromptsList.find(p => p.id === entry.promptTypeAtGeneration)?.label || entry.promptTypeAtGeneration.replace(/_/g, ' ');
                 promptTypeInfo = ` (Ghid: ${promptLabelFound})`;
            } else if (entry.promptTypeAtGeneration === "prompt_personalizat") {
                 promptTypeInfo = ` (Scriere liberƒÉ)`;
            }

            itemContainer.innerHTML = `<p class="feedback-timestamp"><strong>Feedback #${feedbackHistory.length - index}</strong> (${new Date(entry.timestamp).toLocaleString("ro-RO")}) - ${modelInfo}${promptTypeInfo}</p>`;
            
            const contentWrapper = document.createElement("div");
            contentWrapper.className = "content-ai";

            if (entry.error) {
                contentWrapper.innerHTML = `<p class="ai-text-error">${(entry.rawText || "Eroare generare.").replace(/\n/g, '<br>')}</p>`;
            } else if (entry.error_parsing && entry.rawText) { // Afi»ôƒÉm textul brut dacƒÉ parsarea a e»ôuat (pt fi»ôe)
                contentWrapper.innerHTML = `<p style="color:orange;font-style:italic;">Aten»õie: Unele sec»õiuni din acest feedback (pentru fi»ôƒÉ) nu au putut fi parsate corect. Se afi»ôeazƒÉ textul brut:</p><div class="raw-feedback-display">${entry.rawText.replace(/\n/g, '<br>')}</div>`;
            } else if (typeof entry.empatie_initiala === 'string') { // Format nou fi»ôƒÉ, parsat corect
                 const newFormatSections = [
                    { title: "üí¨ Empatie Ini»õialƒÉ", key: "empatie_initiala" }, { title: "üåü Puncte Forte", key: "puncte_forte" },
                    { title: "üîÑ Tipare Principale", key: "tipare_principale" }, { title: "üîó Conexiuni Cheie", key: "conexiuni_cheie" },
                    { title: "üîç Distorsiuni", key: "distorsiuni_identificate", isList: true }, { title: "üß† Scheme", key: "scheme_activate", isList: true },
                    { title: "üé≠ Moduri Implicate", key: "moduri_implicate" }, { title: "üí™ Adult SƒÉnƒÉtos", key: "perspectiva_adult_sanatos" },
                    { title: "‚ùì Reflec»õie FinalƒÉ", key: "intrebare_finala_reflectie" }, { title: "üëü Mic Pas", key: "sugestie_mic_pas" },
                    { title: "üíñ √éncurajare", key: "incurajare_finala" }
                ];
                newFormatSections.forEach(sc => {
                    let contentText = entry[sc.key];
                    if (typeof contentText === 'string' && contentText.trim() !== "" && !contentText.startsWith("(Sec»õiune neextrasƒÉ")) {
                        const titleNoEmoji = sc.title.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+\s*/gu, '').trim();
                        contentText = contentText.replace(new RegExp(`^${titleNoEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im"), "").trim();
                        let html = contentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                        
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'feedback-section-item';
                        const titleH5 = document.createElement('h5');
                        titleH5.innerHTML = sc.title + ":"; // AdƒÉugƒÉm : aici
                        sectionDiv.appendChild(titleH5);

                        if (sc.isList) {
                            const list = document.createElement('ul');
                            // O √Æncercare mai robustƒÉ de a parsa listele Markdown
                            const items = contentText.split('\n').map(line => line.trim()).filter(line => line.startsWith('* ') || line.startsWith('- '));
                            if (items.length > 0) {
                                items.forEach(item => {
                                    const li = document.createElement('li');
                                    li.innerHTML = item.substring(2).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                                    list.appendChild(li);
                                });
                                sectionDiv.appendChild(list);
                            } else if (contentText.trim()) { // Fallback dacƒÉ nu e format de listƒÉ dar are con»õinut
                                const p = document.createElement('p');
                                p.innerHTML = html.replace(/\n/g, '<br>');
                                sectionDiv.appendChild(p);
                            }
                        } else {
                            const p = document.createElement('p');
                            p.innerHTML = html.replace(/\n/g, '<br>');
                            sectionDiv.appendChild(p);
                        }
                        contentWrapper.appendChild(sectionDiv);

                    } else if (contentText && contentText.startsWith("(Sec»õiune neextrasƒÉ")) {
                         contentWrapper.innerHTML += `<h5>${sc.title}:</h5><p style="font-style:italic;">${contentText}</p>`;
                    }
                });
            } else { // Jurnal sau format vechi/neparsat, afi»ôƒÉm rawText formatat cu Markdown simplu
                let html = entry.rawText || 'Con»õinut indisponibil.';
                // AplicƒÉ formatare Markdown pentru titluri Hx, liste, bold, italic
                html = html.replace(/^#{1,6}\s+(.*)/gm, (match, p1) => `<h6>${p1.trim()}</h6>`); // Simplificat la h6 pentru consisten»õƒÉ
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/__(.*?)__/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/_(.*?)_/g, '<em>$1</em>');
                
                const lines = html.split('\n');
                let inList = false;
                let listHtml = "";
                lines.forEach(line => {
                    if (line.match(/^\s*[\*\-\+]\s+/)) {
                        if (!inList) { listHtml += '<ul>'; inList = true; }
                        listHtml += `<li>${line.replace(/^\s*[\*\-\+]\s+/, '')}</li>`;
                    } else {
                        if (inList) { listHtml += '</ul>'; inList = false; }
                        listHtml += `<p>${line}</p>`; // Fiecare linie devine un paragraf dacƒÉ nu e listƒÉ
                    }
                });
                if (inList) listHtml += '</ul>'; // √énchide lista dacƒÉ e ultima
                contentWrapper.innerHTML = listHtml.replace(/<p><\/p>/g, ''); // EliminƒÉ paragrafele goale

            }
            itemContainer.appendChild(contentWrapper);
            containerEl.appendChild(itemContainer);
        });
    }

    function afiseazaCardIntrospectie(docData) {
        const container = document.getElementById("introspectiiCardContainer");
        const entryDate = docData.dateAfisare || (docData.timestampCreare?.toDate ? new Date(docData.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'DatƒÉ necunoscutƒÉ');
        let cardTitle = "";
        let detailsContentHtml = "";

        if (docData.type === 'fisa') {
            cardTitle = `Fi»ôƒÉ ${entryDate} - ${(docData.continut.situatie || 'Situa»õie nedefinitƒÉ').substring(0, 35)}...`;
            const c = docData.continut;
            detailsContentHtml = `
                <h4>Explorarea situa»õiei »ôi a nevoilor</h4>
                <p><strong>Situa»õia:</strong> ${c.situatie || 'N/A'}</p>
                <p><strong>G√¢nduri:</strong> ${c.ganduri || 'N/A'}</p>
                <p><strong>Emo»õii:</strong> ${c.emotii || 'N/A'}</p>
                <p><strong>Mod activ:</strong> ${c.mod_activ || 'N/A'}</p>
                <p><strong>Comportament:</strong> ${c.comportament || 'N/A'}</p>
                <p><strong>Nevoile profunde:</strong> ${c.nevoi_profunde || 'N/A'}</p>
                <p><strong>Ajutor comportament:</strong> ${c.ajutor_comportament || 'N/A'}</p>
                <p><strong>Adultul SƒÉnƒÉtos:</strong> ${c.adult_sanatos || 'N/A'}</p>
                <hr>
                <h4>Analiza g√¢ndurilor »ôi a percep»õiilor</h4>
                <p><strong>Dovezi adevƒÉr:</strong> ${c.dovezi_adevar || 'N/A'}</p>
                <p><strong>Dovezi fals:</strong> ${c.dovezi_fals || 'N/A'}</p>
                <p><strong>Explica»õie alternativƒÉ:</strong> ${c.explicatie_alternativa || 'N/A'}</p>
                <p><strong>Scenariu negativ:</strong> ${c.scenariu_negativ || 'N/A'}</p>
                <p><strong>Scenariu optimist:</strong> ${c.scenariu_optimist || 'N/A'}</p>
                <p><strong>Rezultat realist:</strong> ${c.rezultat_realist || 'N/A'}</p>
                <p><strong>Schimbare g√¢ndire:</strong> ${c.schimbare_gandire || 'N/A'}</p>
                <p><strong>Sfat prieten:</strong> ${c.sfat_prieten || 'N/A'}</p>
                <hr>
                <h4>√éntrebƒÉri pentru claritate</h4>
                <p><strong>Partea rea:</strong> ${c.partea_rea || 'N/A'}</p>
                <p><strong>Responsabilitate:</strong> ${c.responsabilitate || 'N/A'}</p>
                <p><strong>Condamnare:</strong> ${c.condamnare || 'N/A'}</p>
                <p><strong>Termeni extremi:</strong> ${c.termeni_extremi || 'N/A'}</p>
                <p><strong>Exagerare:</strong> ${c.exagerare || 'N/A'}</p>
                <p><strong>Factori responsabili:</strong> ${c.factori_responsabili || 'N/A'}</p>
                <p><strong>Concluzii:</strong> ${c.concluzii || 'N/A'}</p>
                <p><strong>√éntrebƒÉri fƒÉrƒÉ rƒÉspuns:</strong> ${c.intrebari_fara_raspuns || 'N/A'}</p>
                <p><strong>SlƒÉbiciuni:</strong> ${c.slabiciuni || 'N/A'}</p>
                <p><strong>Cum ar trebui:</strong> ${c.cum_ar_trebui || 'N/A'}</p>
                <p><strong>Perfec»õiune:</strong> ${c.perfectiune || 'N/A'}</p>`;
        } else if (docData.type === 'jurnal') {
            let promptLabel = '(Scriere liberƒÉ)';
            if (docData.continut.promptUtilizatJurnal && docData.continut.promptUtilizatJurnal !== 'prompt_personalizat') {
                 const foundPrompt = jurnalPromptsList.find(p => p.id === docData.continut.promptUtilizatJurnal);
                 if (foundPrompt) promptLabel = `(${foundPrompt.label.substring(0, foundPrompt.label.indexOf(" "))}...)`; // PrescurtƒÉm eticheta
                 else promptLabel = `(${docData.continut.promptUtilizatJurnal.replace(/_/g, ' ')})`;
            }
            cardTitle = `${docData.continut.titluJurnal || `Jurnal ${entryDate}`} ${promptLabel}`;
            detailsContentHtml = `<p class="journal-entry-content-text-unified">${(docData.continut.textJurnal || 'Con»õinut indisponibil.').replace(/\n/g, '<br>')}</p>`;
        }

        const card = document.createElement("div");
        card.className = "response-card introspectie-card";
        card.setAttribute("data-id", docData.id);
        card.setAttribute("data-type", docData.type);

        const discussButtonHtml = docData.type === 'fisa' ?
            `<button class="discuss-entry-with-chat-button" title="DiscutƒÉ aceastƒÉ fi»ôƒÉ cu PsihoGPT">DiscutƒÉ cu AI</button>` : '';

        card.innerHTML = `
            <div class="card-header">
                <span>${cardTitle}</span>
                <span class="card-date">${entryDate}</span>
            </div>
            <div class="card-content">
                <details class="introspectie-entry-details">
                    <summary>Vezi/Ascunde detaliile intrƒÉrii</summary>
                    <div class="introspectie-entry-content-text">${detailsContentHtml}</div>
                </details>
                <h4 class="ai-feedback-title">Feedback AI <span style="font-weight:300; font-style:italic; font-size:0.85em;">(PsihoGPT)</span></h4>
                <div class="ai-feedback-history-container"></div>
                <div class="card-actions">
                    <button class="regenerate-feedback-button" title="RegenereazƒÉ Feedback AI">RegenereazƒÉ</button>
                    ${discussButtonHtml}
                    <button class="delete-last-feedback-button" title="»òterge Ultimul Feedback AI">»òterge Ultimul</button>
                    <button class="delete-all-feedback-button" title="»òterge Tot Istoricul Feedback AI">»òterge Istoric AI</button>
                    <button class="delete-introspectie-button" title="»òterge AceastƒÉ Intrare">»òterge Intrarea</button>
                </div>
            </div>`;

        card.querySelector('.card-header').addEventListener('click', (e) => {
            if (!e.target.closest('button') && !e.target.closest('details')) card.classList.toggle('open');
        });
        card.querySelector('.regenerate-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); regenereazaFeedbackPentruIntrospectieCard(docData.id); });
        if (docData.type === 'fisa') {
            card.querySelector('.discuss-entry-with-chat-button')?.addEventListener('click', async (e) => {
                e.stopPropagation();
                const fullEntryDataSnap = await getDoc(doc(db, "introspectii", docData.id));
                if (fullEntryDataSnap.exists()) {
                     await discussFisaWithChat(fullEntryDataSnap.data());
                } else { alert("Nu s-au putut √ÆncƒÉrca detaliile fi»ôei."); }
            });
        }
        card.querySelector('.delete-last-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); stergeUltimulFeedbackIntrospectie(docData.id); });
        card.querySelector('.delete-all-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); stergeTotIstoriculFeedbackIntrospectie(docData.id); });
        card.querySelector('.delete-introspectie-button').addEventListener('click', (e) => { e.stopPropagation(); stergeIntrospectie(docData.id, card); });
        
        const noEntriesMsg = container.querySelector('.no-entries-message');
        if (noEntriesMsg) noEntriesMsg.remove();

        if (container.firstChild && container.firstChild.nodeName !== 'P') {
            container.insertBefore(card, container.firstChild);
        } else {
            if (container.firstChild && container.firstChild.nodeName === 'P') container.innerHTML = '';
            container.appendChild(card);
        }
        const feedbackContainer = card.querySelector('.ai-feedback-history-container');
        if (feedbackContainer) {
            afiseazaIstoricFeedbackIntrospectie(feedbackContainer, docData.feedbackAI_history || []);
        }
    }
    
    async function regenereazaFeedbackPentruIntrospectieCard(introspectieId) {
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.regenerate-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se genereazƒÉ..."; btn.disabled = true; }
        
        const type = card?.dataset.type;
        const confirmationElementId = type === 'fisa' ? 'fisaConfirmationMessage' : (type === 'jurnal' ? 'jurnalConfirmationMessage' : null);
        const confirmationMsg = confirmationElementId ? document.getElementById(confirmationElementId) : null;

        if(confirmationMsg) confirmationMsg.style.display = 'none';

        try {
            const entryDocSnap = await getDoc(doc(db, "introspectii", introspectieId));
            if (!entryDocSnap.exists()) {
                if(confirmationMsg) { confirmationMsg.textContent = 'Eroare: Intrarea nu mai existƒÉ.'; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
                return;
            }
            const entryData = { id: entryDocSnap.id, ...entryDocSnap.data() };
            const newFeedback = await genereazaFeedbackPentruIntrospectie(entryData);

            const updatedDoc = await getDoc(doc(db, "introspectii", introspectieId));
            if (updatedDoc.exists() && card) {
                afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedbackAI_history || []);
            }
             const message = newFeedback && !newFeedback.error && !newFeedback.error_parsing ? "Noul feedback AI a fost generat!" : `Feedback AI: ${newFeedback.rawText || 'ProblemƒÉ.'}`;
             if(confirmationMsg) { confirmationMsg.textContent = message; confirmationMsg.className = `confirmation-message ${newFeedback && !newFeedback.error && !newFeedback.error_parsing ? 'success' : 'error'}`; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);}
        } catch (error) {
            console.error("Eroare regenerare feedback:", error);
             if(confirmationMsg) { confirmationMsg.textContent = 'Eroare la regenerare.'; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
        }
    }

    async function stergeUltimulFeedbackIntrospectie(introspectieId) {
        if (!confirm("»òterge»õi ultimul feedback AI?")) return;
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.delete-last-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se »ôterge..."; btn.disabled = true; }

        const type = card?.dataset.type;
        const confirmationElementId = type === 'fisa' ? 'fisaConfirmationMessage' : (type === 'jurnal' ? 'jurnalConfirmationMessage' : null);
        const confirmationMsg = confirmationElementId ? document.getElementById(confirmationElementId) : null;
        if(confirmationMsg) confirmationMsg.style.display = 'none';

        try {
            const entryDocRef = doc(db, "introspectii", introspectieId);
            const entrySnap = await getDoc(entryDocRef);
            if (!entrySnap.exists() || !entrySnap.data().feedbackAI_history?.length) {
                if(confirmationMsg) {confirmationMsg.textContent = "Nu existƒÉ feedback."; confirmationMsg.className = 'confirmation-message warning'; confirmationMsg.style.display = 'block';}
                return;
            }
            const history = entrySnap.data().feedbackAI_history;
            history.pop();
            await updateDoc(entryDocRef, { feedbackAI_history: history });
            if(card) afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), history);
            if(confirmationMsg) {confirmationMsg.textContent = "Ultimul feedback »ôters."; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block';}
        } catch (err) {
            if(confirmationMsg) {confirmationMsg.textContent = "Eroare »ôtergere."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
            if(confirmationMsg) setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);
        }
    }

    async function stergeTotIstoriculFeedbackIntrospectie(introspectieId) {
        if (!confirm("Sigur »ôterge»õi TOT istoricul feedback AI?")) return;
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.delete-all-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se »ôterge..."; btn.disabled = true; }

        const type = card?.dataset.type;
        const confirmationElementId = type === 'fisa' ? 'fisaConfirmationMessage' : (type === 'jurnal' ? 'jurnalConfirmationMessage' : null);
        const confirmationMsg = confirmationElementId ? document.getElementById(confirmationElementId) : null;
        if(confirmationMsg) confirmationMsg.style.display = 'none';
        
        try {
            const docRef = doc(db, "introspectii", introspectieId);
            await updateDoc(docRef, { feedbackAI_history: [] });
            if(card) afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), []);
            if(confirmationMsg) {confirmationMsg.textContent = "Istoric feedback AI »ôters!"; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block';}
        } catch (error) {
            if(confirmationMsg) {confirmationMsg.textContent = "Eroare »ôtergere istoric."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
             if(confirmationMsg) setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);
        }
    }

    async function stergeIntrospectie(id, cardElement) {
        if (confirm("»òterge»õi aceastƒÉ intrare »ôi tot feedback-ul asociat?")) {
            const type = cardElement?.dataset.type;
            const confirmationElementId = type === 'fisa' ? 'fisaConfirmationMessage' : (type === 'jurnal' ? 'jurnalConfirmationMessage' : null);
            const confirmationMsg = confirmationElementId ? document.getElementById(confirmationElementId) : null;
            if(confirmationMsg) confirmationMsg.style.display = 'none';

            try {
                await deleteDoc(doc(db, "introspectii", id));
                cardElement.remove();
                const container = document.getElementById("introspectiiCardContainer");
                if (container && !container.querySelector('.introspectie-card') && !container.querySelector('.no-entries-message')) {
                    const noEntriesMsgElement = document.createElement("p");
                    noEntriesMsgElement.className = "no-entries-message";
                    noEntriesMsgElement.textContent = "Nicio introspec»õie.";
                    container.appendChild(noEntriesMsgElement);
                }
                 if(confirmationMsg) {confirmationMsg.textContent = "Intrarea a fost »ôtearsƒÉ!"; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 5000);}
            } catch (error) {
                if(confirmationMsg) {confirmationMsg.textContent = "Eroare »ôtergere intrare."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 5000);}
            }
        }
    }

   // --- FUNC»öII PENTRU CHAT ---

    function formatStreamingMessage(message) {
        if (!message) return "";
        let htmlContent = message
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/__(.*?)__/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/_(.*?)_/g, '<em>$1</em>')
            .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre class="code-block-chat">${p1.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`)
            .replace(/`([^`]+)`/g, '<code class="inline-code-chat">$1</code>');

        htmlContent = htmlContent.replace(/^#{1,6}\s+(.*)/gm, (match, p1) => `<h6>${p1.trim()}</h6>`);

        const lines = htmlContent.split('\n');
        let inList = false;
        let listType = '';
        let processedHtml = "";

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            const trimmedLine = line.trim();
            let currentListType = '';
            let listItemContent = '';

            const isBlock = line.startsWith("<pre") || line.startsWith("<h") || line.startsWith("<ul") || line.startsWith("<ol") || line.startsWith("</ul") || line.startsWith("</ol") || line.startsWith("<li") || line.startsWith("<p");

            if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ') || trimmedLine.startsWith('+ ')) {
                currentListType = 'ul';
                listItemContent = trimmedLine.substring(trimmedLine.indexOf(' ') + 1);
            } else if (trimmedLine.match(/^\d+\.\s+/)) {
                currentListType = 'ol';
                listItemContent = trimmedLine.substring(trimmedLine.indexOf('.') + 2);
            }

            if (currentListType) {
                if (!inList || listType !== currentListType) {
                    if (inList) processedHtml += `</${listType}>\n`;
                    processedHtml += `<${currentListType}>\n`;
                    inList = true;
                    listType = currentListType;
                }
                processedHtml += `  <li>${listItemContent}</li>\n`;
            } else {
                if (inList) {
                    processedHtml += `</${listType}>\n`;
                    inList = false;
                    listType = '';
                }
                if (line.trim() !== "" && !isBlock) {
                    processedHtml += `<p>${line}</p>\n`;
                } else if (line.trim() !== "") {
                     processedHtml += line + '\n';
                }
            }
        }
        if (inList) {
            processedHtml += `</${listType}>\n`;
        }
        return processedHtml.replace(/<p><\/p>/g, '');
    }

    function displayChatMessage(messageContent, role) { // Am eliminat thoughtsContent
        const messagesDiv = document.getElementById("chatMessages");
        if (!messagesDiv) return;

        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");
        messageElement.style.whiteSpace = "pre-wrap";

        let messageClass = "";
        if (role === "user") {
            messageClass = "user-message";
        } else if (role === "AI-error" || (typeof messageContent === 'string' && messageContent.startsWith("EROARE"))) {
            messageClass = "ai-message ai-error";
        } else {
            messageClass = "ai-message";
        }
        messageClass.split(' ').forEach(cls => messageElement.classList.add(cls));


        if (role === "user") {
            messageElement.textContent = messageContent;
        } else {
            messageElement.innerHTML = formatStreamingMessage(messageContent);
        }

        // Am eliminat blocul care afi»ôa thoughtsContent

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function loadChatHistory(userId) {
        if (!userId) return [];
        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        try {
            const docSnap = await getDoc(historyDocRef);
            if (docSnap.exists() && docSnap.data().messages && Array.isArray(docSnap.data().messages)) {
                const messages = docSnap.data().messages;
                return messages.sort((a, b) => {
                    const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (new Date(a.timestamp).getTime() || 0);
                    const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (new Date(b.timestamp).getTime() || 0);
                    return timeA - timeB;
                });
            }
            return [];
        } catch (error) { console.error("Eroare √ÆncƒÉrcare istoric chat:", error); return []; }
    }

    async function saveChatMessage(userId, messageObject) {
        if (!userId || !messageObject ) {
             console.warn("Attempted to save chat message without userId or messageObject.", messageObject);
             return;
        }
        // Permitem salvarea chiar dacƒÉ content e gol, √Æn caz de eroare
        if (typeof messageObject.content !== 'string' && !messageObject.error) {
            console.warn("Attempted to save chat message without content and not an error.", messageObject);
            // return; // Decidem dacƒÉ e eroare sau permis
        }

        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        const saveData = { ...messageObject };
        // EliminƒÉm c√¢mpul 'thoughts' dacƒÉ existƒÉ, deoarece nu-l mai folosim
        delete saveData.thoughts;

        if (saveData.timestamp && !(saveData.timestamp instanceof Timestamp)) {
            saveData.timestamp = Timestamp.fromDate(new Date(saveData.timestamp));
        }

        try {
            const docSnap = await getDoc(historyDocRef);
            if (docSnap.exists()) {
                await updateDoc(historyDocRef, { messages: arrayUnion(saveData) });
            } else {
                await setDoc(historyDocRef, { messages: [saveData] });
            }
        } catch (error) {
            console.error("Eroare salvare mesaj chat:", error);
        }
    }

    async function initializeAndStartChatSession(userId) {
        const chatStatus = document.getElementById("chatStatus");
        const sendButton = document.getElementById("sendChatMessageButton");
        const messagesDiv = document.getElementById("chatMessages");

        if (sendButton) sendButton.disabled = true;
        if (chatStatus) chatStatus.textContent = "Ini»õializare chat AI...";

        if (!geminiModelChat) {
            if (chatStatus) chatStatus.textContent = "EROARE: Model AI Chat indisponibil.";
            displayChatMessage("Serviciul de chat AI nu este disponibil.", "AI-error");
            return null;
        }
        isChatInitialized = false;
        let initialContextSummary = "REZUMAT DIN INTROSPEC»öIILE ANTERIOARE (ULTIMELE 3, FƒÇRƒÇ DISTINC»öIE FI»òƒÇ/JURNAL):\n";
        try {
            if (userId) {
                const q = query(collection(db, "introspectii"), where("ownerUid", "==", userId), orderBy("timestampCreare", "desc"), limit(3));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const entryDate = data.dateAfisare || (data.timestampCreare ? new Date(data.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'N/A');
                        if (data.type === 'fisa') {
                            initialContextSummary += ` - Fi»ôƒÉ (${entryDate}): Situatia - ${(data.continut.situatie || "").substring(0, 50)}...; Ganduri - ${(data.continut.ganduri || "").substring(0,50)}...\n`;
                        } else if (data.type === 'jurnal') {
                            initialContextSummary += ` - Jurnal (${entryDate}): Titlu - ${(data.continut.titluJurnal || "FƒÉrƒÉ titlu").substring(0,50)}...; Text (primele cuvinte) - ${(data.continut.textJurnal || "").substring(0,50)}...\n`;
                        }
                    });
                } else { initialContextSummary += "Nicio introspec»õie recentƒÉ gƒÉsitƒÉ.\n"; }
            }
        } catch(e) {
            console.error("Eroare √ÆncƒÉrcare context introspec»õii pentru chat:", e);
            initialContextSummary += "Eroare la √ÆncƒÉrcarea contextului.\n";
        }

        const systemInstructionText = `# ROL PRINCIPAL »òI PERSONA:
Tu e»ôti PsihoGPT ...
# PRIORITATE:
...
Context din ultimele introspec»õii (fi»ôe/jurnal) completate de utilizator:
${initialContextSummary}---`; // Am prescurtat System Prompt pentru claritate, e la fel ca √Ænainte

        const aiGreeting = "Salut! Sunt PsihoGPT. Cum te sim»õi astƒÉzi »ôi despre ce ai dori sƒÉ reflectƒÉm √ÆmpreunƒÉ?";
        let historyForGeminiInitialization = [];

        if (messagesDiv) messagesDiv.innerHTML = '';
        let loadedHistoryFromDB = await loadChatHistory(userId);
        loadedHistoryFromDB.forEach(msg => {
            const roleForGemini = (msg.role === "AI" || msg.role === "model") ? "model" : "user";
            historyForGeminiInitialization.push({
                role: roleForGemini,
                parts: [{ text: msg.content || "" }]
            });
            displayChatMessage(msg.content, roleForGemini); // Afi»ôƒÉm fƒÉrƒÉ thoughts
        });

        try {
            const chatConfig = {
                history: [
                    { role: "user", parts: [{ text: systemInstructionText }] },
                     ...historyForGeminiInitialization
                ],
                generationConfig: {
                    temperature: 0.75
                    // Am eliminat thinking_config
                },
                // safetySettings: [ ... ] // Op»õional
            };
            chatSession = geminiModelChat.startChat(chatConfig);
            console.log("Sesiune chat Gemini ini»õializatƒÉ FƒÇRƒÇ thinking_config. Istoric trimis:", chatConfig.history.length);

            if (chatStatus) chatStatus.textContent = "Janet - Psihoterapeut Cognitiv-Comportamental Integrativ";

            if (loadedHistoryFromDB.length === 0) {
                const firstAiResponseResult = await chatSession.sendMessageStream("Salut!");
                const firstAiResponseStream = firstAiResponseResult.stream;
                let firstAiText = "";
                // Am eliminat firstAiThoughts
                const firstAiMessageElement = document.createElement("div");
                firstAiMessageElement.classList.add("chat-message", "ai-message");
                firstAiMessageElement.style.whiteSpace = "pre-wrap";
                if(messagesDiv) messagesDiv.appendChild(firstAiMessageElement);

                for await (const chunk of firstAiResponseStream) {
                    if (chunk.response?.candidates?.[0]?.content?.parts) {
                        for (const part of chunk.response.candidates[0].content.parts) {
                            if (part.text) {
                                // Nu mai verificƒÉm part.thought
                                firstAiText += part.text;
                                firstAiMessageElement.innerHTML = formatStreamingMessage(firstAiText);
                            }
                        }
                    }
                     if(messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }

                // Am eliminat blocul care adƒÉuga thoughtsDetails pentru salut

                if (firstAiText.trim() === "") firstAiText = aiGreeting;
                firstAiMessageElement.innerHTML = formatStreamingMessage(firstAiText);

                await saveChatMessage(userId, { role: "model", content: firstAiText, timestamp: new Date().toISOString() }); // SalvƒÉm fƒÉrƒÉ thoughts
            }
            isChatInitialized = true;
            if (sendButton) sendButton.disabled = false;
        } catch(initError) {
            console.error("Eroare ini»õializare sesiune chat Gemini:", initError, initError.stack);
            if (chatStatus) chatStatus.textContent = "Eroare AI Chat.";
            displayChatMessage("ProblemƒÉ tehnicƒÉ la pornirea chat-ului: " + initError.message, "AI-error");
            isChatInitialized = false; chatSession = null;
            if (sendButton) sendButton.disabled = true; return null;
        }
        return chatSession;
    }

  async function handleSendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatStatus = document.getElementById("chatStatus");
        const messagesDiv = document.getElementById("chatMessages");

        if (!chatInput || !sendButton || !chatStatus || !messagesDiv) {
            console.error("handleSendChatMessage: Eroare - Unul sau mai multe elemente HTML pentru chat lipsesc.");
            // Po»õi afi»ôa o alertƒÉ utilizatorului aici dacƒÉ dore»ôti
            return;
        }

        const messageText = chatInput.value.trim();
        if (messageText === "") {
            return; // Nu trimite mesaje goale
        }

        const user = auth.currentUser;
        if (!user) {
            alert("Autentificare necesarƒÉ pentru a trimite mesaje.");
            window.location.href = "login.html"; // AsigurƒÉ-te cƒÉ este calea corectƒÉ
            return;
        }

        // Afi»ôeazƒÉ mesajul utilizatorului »ôi salveazƒÉ-l
        displayChatMessage(messageText, "user");
        await saveChatMessage(user.uid, { role: "user", content: messageText, timestamp: new Date().toISOString() });

        // ReseteazƒÉ input-ul »ôi actualizeazƒÉ starea UI
        chatInput.value = "";
        sendButton.disabled = true;
        chatStatus.textContent = "Psihoterapeut Janet analizeazƒÉ...";

        // CreeazƒÉ elementul pentru rƒÉspunsul AI
        const aiMessageElement = document.createElement("div");
        aiMessageElement.classList.add("chat-message", "ai-message");
        aiMessageElement.style.whiteSpace = "pre-wrap"; // Important pentru formatarea cu <pre> sau \n
        messagesDiv.appendChild(aiMessageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll la noul element gol

        // VerificƒÉ »ôi (re)ini»õializeazƒÉ sesiunea de chat dacƒÉ este necesar
        if (!chatSession || !isChatInitialized) {
            console.log("handleSendChatMessage: Sesiunea de chat nu este ini»õializatƒÉ sau este invalidƒÉ, se √ÆncearcƒÉ re-ini»õializarea.");
            chatSession = await initializeAndStartChatSession(user.uid);
            if (!chatSession) {
                chatStatus.textContent = "Eroare re-ini»õializare chat.";
                const initErrorMsg = "EROARE: Nu s-a putut (re)ini»õializa sesiunea de chat.";
                aiMessageElement.innerHTML = formatStreamingMessage(initErrorMsg);
                aiMessageElement.classList.add("ai-error");
                sendButton.disabled = true; // PƒÉstrƒÉm butonul dezactivat
                await saveChatMessage(user.uid, { role: "model", content: initErrorMsg, error: true, timestamp: new Date().toISOString() });
                return;
            }
        }

        let fullAiResponseText = "";
        let anErrorOccurredInStream = false; // Flag specific pentru erori din API √Æn timpul stream-ului
        let receivedActualTextInStream = false; // Flag pentru a urmƒÉri dacƒÉ am primit text non-gol

        try {
            const result = await chatSession.sendMessageStream(messageText);
            const stream = result.stream; // Extragem corect stream-ul

            for await (const chunk of stream) {
                console.log("RAW CHUNK RECEIVED (handleSendChatMessage):", JSON.stringify(chunk, null, 2));

                let textFromThisChunk = "";
                if (chunk.response?.candidates?.[0]?.content?.parts) {
                    for (const part of chunk.response.candidates[0].content.parts) {
                        if (part.text && typeof part.text === 'string') {
                            textFromThisChunk += part.text;
                            if (part.text.trim() !== "") { // VerificƒÉm dacƒÉ textul nu e doar spa»õiu alb
                                receivedActualTextInStream = true;
                            }
                        }
                    }
                }

                if (textFromThisChunk) {
                    fullAiResponseText += textFromThisChunk;
                    aiMessageElement.innerHTML = formatStreamingMessage(fullAiResponseText); // Actualizare progresivƒÉ
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll dupƒÉ fiecare actualizare

                // VerificƒÉri de eroare DUPƒÇ procesarea pƒÉr»õilor de text din chunk
                const candidate = chunk.response?.candidates?.[0];
                if (candidate?.finishReason && !["STOP", "MAX_TOKENS", "MODEL_LENGTH"].includes(candidate.finishReason)) {
                    const blockMessage = `AI oprit prematur (Motiv: ${candidate.finishReason}). Detalii: ${JSON.stringify(candidate.safetyRatings || 'N/A')}`;
                    // AdaugƒÉ mesajul de eroare la elementul existent, evit√¢nd duplicarea
                    if (!aiMessageElement.innerHTML.includes(blockMessage.substring(0, 50))) {
                        aiMessageElement.innerHTML += `<br><p class="ai-error-inline">${formatStreamingMessage(blockMessage)}</p>`;
                    }
                    fullAiResponseText += `\n${blockMessage}`; // AdƒÉugƒÉm la textul complet pentru salvare
                    anErrorOccurredInStream = true;
                    console.warn("handleSendChatMessage: Stream oprit prematur - ", blockMessage);
                    break; // Ie»ôim din bucla stream-ului
                }

                if (chunk.response?.promptFeedback?.blockReason) {
                    const blockMessage = `Mesaj/RƒÉspuns blocat (Motiv: ${chunk.response.promptFeedback.blockReason}). Detalii: ${JSON.stringify(chunk.response.promptFeedback.blockReasonDetail || chunk.response.promptFeedback.safetyRatings || 'N/A')}`;
                    if (!aiMessageElement.innerHTML.includes(blockMessage.substring(0, 50))) {
                        aiMessageElement.innerHTML += `<br><p class="ai-error-inline">${formatStreamingMessage(blockMessage)}</p>`;
                    }
                    fullAiResponseText += `\n${blockMessage}`;
                    anErrorOccurredInStream = true;
                    console.warn("handleSendChatMessage: Stream blocat - ", blockMessage);
                    break;
                }
            } // Sf√¢r»ôitul buclei for await

            // Logica de dupƒÉ finalizarea stream-ului
            console.log("handleSendChatMessage: Stream FINISHED.");
            console.log("  Final fullAiResponseText:", JSON.stringify(fullAiResponseText));
            console.log("  Final receivedActualTextInStream:", receivedActualTextInStream);
            console.log("  Final anErrorOccurredInStream:", anErrorOccurredInStream);

            if (!anErrorOccurredInStream && !receivedActualTextInStream) {
                // Nu a fost o eroare din API »òI nu s-a primit deloc text inteligibil
                const fallbackMsg = "Nu am putut genera un rƒÉspuns sau rƒÉspunsul a fost gol (stream gol, fƒÉrƒÉ eroare API).";
                aiMessageElement.innerHTML = formatStreamingMessage(fallbackMsg);
                fullAiResponseText = fallbackMsg; // ActualizƒÉm pentru salvare
                console.log("handleSendChatMessage: AFI»òAT FALLBACK - Stream gol, fƒÉrƒÉ eroare API.");
            } else if (!anErrorOccurredInStream && receivedActualTextInStream && fullAiResponseText.trim() === "") {
                // S-a primit text, dar dupƒÉ trim este gol (ex: doar spa»õii albe)
                const fallbackMsg = "RƒÉspunsul primit a fost gol dupƒÉ procesare (stream non-gol, dar text vid).";
                aiMessageElement.innerHTML = formatStreamingMessage(fallbackMsg);
                fullAiResponseText = fallbackMsg; // ActualizƒÉm pentru salvare
                console.log("handleSendChatMessage: AFI»òAT FALLBACK - Stream non-gol, dar text vid.");
            }
            // Altfel (dacƒÉ anErrorOccurredInStream e true SAU receivedActualTextInStream e true »ôi fullAiResponseText are con»õinut):
            // - Mesajul de eroare este deja √Æn aiMessageElement »ôi fullAiResponseText.
            // - Sau rƒÉspunsul valid este deja √Æn aiMessageElement »ôi fullAiResponseText.
            // Nu mai este nevoie sƒÉ actualizƒÉm aiMessageElement.innerHTML aici dacƒÉ nu suntem √Æntr-un caz de fallback.

            // Salvarea √Æn Firestore (include »ôi mesajele de eroare inline sau fallback-uri)
            await saveChatMessage(user.uid, {
                role: "model",
                content: fullAiResponseText,
                error: anErrorOccurredInStream, // ReflectƒÉ doar erorile din API din timpul stream-ului
                timestamp: new Date().toISOString()
            });
            chatStatus.textContent = "Janet - Psihoterapeut Cognitiv-Comportamental Integrativ";

        } catch (error) { // Acest catch prinde erori mai mari (ex: probleme de re»õea, erori SDK nea»ôteptate)
            console.error("handleSendChatMessage: Eroare CRITICƒÇ √Æn sendMessageStream sau procesare:", error, error.stack);
            chatStatus.textContent = "Eroare criticƒÉ comunicare AI.";
            const criticalErrorMsg = `EROARE CRITICƒÇ (catch): ${error.message || "Eroare necunoscutƒÉ"}`;

            aiMessageElement.innerHTML = formatStreamingMessage(criticalErrorMsg);
            aiMessageElement.classList.add("ai-error");
            // anErrorOccurredInStream ar putea fi false aici dacƒÉ eroarea a apƒÉrut √Ænainte de buclƒÉ
            // sau true dacƒÉ a apƒÉrut o eroare √Æn buclƒÉ care a aruncat excep»õia mai departe.

            await saveChatMessage(user.uid, {
                role: "model",
                content: criticalErrorMsg,
                error: true, // SetƒÉm error la true pentru erori critice
                timestamp: new Date().toISOString()
            });
            isChatInitialized = false; // ConsiderƒÉm sesiunea invalidƒÉ
            chatSession = null;
        } finally {
            // ReactivƒÉm butonul de send doar dacƒÉ sesiunea este √ÆncƒÉ validƒÉ »ôi modelul existƒÉ
            if (geminiModelChat && isChatInitialized && sendButton) {
                sendButton.disabled = false;
            } else if (sendButton) {
                sendButton.disabled = true; // RƒÉm√¢ne dezactivat dacƒÉ sesiunea e invalidƒÉ
                if (chatStatus && (!isChatInitialized || !geminiModelChat)) {
                     chatStatus.textContent = "Chat AI indisponibil.";
                }
            }
            if (chatInput) {
                chatInput.focus(); // Focus pe input pentru urmƒÉtorul mesaj
            }
        }
    }

    async function handleToggleChat() {
        const user = auth.currentUser;
        if (!user) {
            alert("Autentificare necesarƒÉ pentru a folosi chat-ul.");
            window.location.href = "login.html";
            return;
        }

        const chatContainer = document.getElementById("chatContainer");
        const originalToggleButton = document.getElementById("toggleChatButton");
        const minimizeButtonInHeader = document.getElementById("minimizeChatButton");
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatInput = document.getElementById("chatInput");

        if (!chatContainer || !originalToggleButton || !minimizeButtonInHeader) {
            console.error("Eroare: Unul sau mai multe elemente HTML esen»õiale pentru chat nu au fost gƒÉsite!");
            return;
        }

        const isChatCurrentlyOpen = chatContainer.style.display === "flex";

        if (isChatCurrentlyOpen) {
            chatContainer.style.display = "none";
            originalToggleButton.style.display = 'flex';
            originalToggleButton.innerHTML = "üí¨";
        } else {
            chatContainer.style.display = "flex";
            originalToggleButton.style.display = 'none';

            if (!isChatInitialized || !chatSession) {
                const sessionOK = await initializeAndStartChatSession(user.uid);
                if (sendButton) sendButton.disabled = !sessionOK;

            } else if (sendButton && geminiModelChat) {
                sendButton.disabled = false;
            } else if (sendButton) {
                sendButton.disabled = true;
            }

            if (chatInput) {
                chatInput.focus();
            }
        }
    }

    async function discussFisaWithChat(fisaData) {
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarƒÉ."); window.location.href = "login.html"; return; }
        const chatContainer = document.getElementById("chatContainer");
        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            await handleToggleChat();
        }
        if (!chatSession || !isChatInitialized) {
            displayChatMessage("Eroare: Sesiunea de chat nu e pregƒÉtitƒÉ.", "AI-error"); return;
        }
        const c = fisaData.continut;
        let message = `Salut PsihoGPT,\n\nA»ô dori sƒÉ discutƒÉm despre urmƒÉtoarea fi»ôƒÉ de monitorizare (datatƒÉ ${fisaData.dateAfisare || 'N/A'}):\n\n`;
        message += `**Situa»õia:** ${c.situatie || 'N/A'}\n**G√¢nduri automate:** ${c.ganduri || 'N/A'}\n**Emo»õii:** ${c.emotii || 'N/A'}\n`;
        message += `**Mod activ:** ${c.mod_activ || 'N/A'}\n**Comportament:** ${c.comportament || 'N/A'}\n**Nevoile profunde:** ${c.nevoi_profunde || 'N/A'}\n`;
        message += `**AjutƒÉ comportamentul?:** ${c.ajutor_comportament || 'N/A'}\n**Adult SƒÉnƒÉtos (perspectivƒÉ):** ${c.adult_sanatos || 'N/A'}\n\n`;
        message += "**Analiza g√¢ndurilor:**\n";
        message += `  *Dovezi adevƒÉr:* ${c.dovezi_adevar || 'N/A'}\n  *Dovezi fals:* ${c.dovezi_fals || 'N/A'}\n`;
        message += `  *Expl. alt.:* ${c.explicatie_alternativa || 'N/A'}\n  *Cel mai rƒÉu:* ${c.scenariu_negativ || 'N/A'}\n`;
        message += `  *Cel mai bun:* ${c.scenariu_optimist || 'N/A'}\n  *Realist:* ${c.rezultat_realist || 'N/A'}\n`;
        message += `  *Schimbare g√¢ndire:* ${c.schimbare_gandire || 'N/A'}\n  *Sfat prieten:* ${c.sfat_prieten || 'N/A'}\n\n`;
        message += "**ClarificƒÉri:**\n";
        message += `  *Partea rea?:* ${c.partea_rea || 'N/A'}\n  *Responsabilitate excesivƒÉ?:* ${c.responsabilitate || 'N/A'}\n`;
        message += `  *Condamnare eveniment unic?:* ${c.condamnare || 'N/A'}\n  *Termeni extremi?:* ${c.termeni_extremi || 'N/A'}\n`;
        message += `  *Exagerare?:* ${c.exagerare || 'N/A'}\n  *Al»õi factori?:* ${c.factori_responsabili || 'N/A'}\n`;
        message += `  *Concluzii pripite?:* ${c.concluzii || 'N/A'}\n  *√éntrebƒÉri fƒÉrƒÉ rƒÉspuns?:* ${c.intrebari_fara_raspuns || 'N/A'}\n`;
        message += `  *Focus pe slƒÉbiciuni?:* ${c.slabiciuni || 'N/A'}\n  *Cum ar trebui?:* ${c.cum_ar_trebui || 'N/A'}\n`;
        message += `  *Perfec»õionism?:* ${c.perfectiune || 'N/A'}\n\n`;
        message += "Ce √ÆntrebƒÉri sau reflec»õii ai pentru mine pe baza acestei fi»ôe?";
        const chatInput = document.getElementById("chatInput");
        if(chatInput) {
            chatInput.value = message;
            handleSendChatMessage();
        }
    }

    // --- FUNC»öIA PRINCIPALƒÇ DE INTRARE (ONLOAD) ---
    // Este definitƒÉ mai jos, dupƒÉ ce toate func»õiile pe care le apeleazƒÉ sunt definite.
    // Acest lucru asigurƒÉ cƒÉ nu vor exista ReferenceError pentru func»õiile apelate din onload.

    window.onload = function () {
        // Ini»õializare tab-uri
        document.getElementById('tabButtonJurnal').addEventListener('click', () => showTab('jurnal'));
        document.getElementById('tabButtonFisa').addEventListener('click', () => showTab('fisa'));
        showTab('jurnal');

        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            const mainContentArea = document.getElementById('mainContentArea');
            const cardsContainerArea = document.getElementById('cardsContainerArea');
            const toggleChatBtn = document.getElementById("toggleChatButton");
            const chatContainer = document.getElementById("chatContainer");

            if (user) {
                if (mainContentArea) mainContentArea.style.display = '';
                if (cardsContainerArea) cardsContainerArea.style.display = '';
                if (toggleChatBtn) toggleChatBtn.style.display = 'flex';
                
                console.log("Utilizator autentificat:", user.uid);
                initializeFisaFormFunctionality();
                initializeJurnalFormFunctionality();

                if (!dataAlreadyLoaded) {
                    incarcaToateIntrospectiile(user.uid);
                    dataAlreadyLoaded = true;
                }
            } else {
                console.log("Utilizator neautentificat, redirec»õionare...");
                if (mainContentArea) mainContentArea.style.display = 'none';
                if (cardsContainerArea) cardsContainerArea.style.display = 'none';
                if (toggleChatBtn) toggleChatBtn.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'none';
                isChatInitialized = false;
                chatSession = null;
                window.location.href = "login.html";
            }
        });
       
        document.getElementById("minimizeChatButton")?.addEventListener("click", handleToggleChat); 
        document.getElementById("toggleChatButton")?.addEventListener("click", handleToggleChat);
        document.getElementById("sendChatMessageButton")?.addEventListener("click", handleSendChatMessage);
        document.getElementById("chatInput")?.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                handleSendChatMessage();
            }
        });
    };
</script>
    <style>
  /* --- MODERN FRESH STYLES START --- */
:root {
    --font-primary: 'Ubuntu', 'Roboto', 'Montserrat', sans-serif;
    --font-secondary: 'Roboto', sans-serif;

    --color-bg-main: #F8F9FA;
    --color-bg-content: #FFFFFF;
    --color-bg-alt: #E9ECEF;
    --color-bg-chat-alt: #F1F3F5;

    --color-primary: #4A90E2;
    --color-primary-dark: #3A7BC8;
    --color-primary-light: #EAF2FD;

    --color-secondary: #50E3C2;
    --color-secondary-dark: #38B2AC;

    --color-accent: #F5A623;

    --color-text-dark: #212529;
    --color-text-medium: #495057;
    --color-text-light: #6C757D;
    --color-text-inverted: #FFFFFF;

    --color-success: #28A745;
    --color-success-bg: #E9F7EA;
    --color-error: #DC3545;
    --color-error-bg: #FAE8EA;
    --color-warning: #FFC107;
    --color-warning-bg: #FFF9E6;

    --border-radius-small: 4px;
    --border-radius-medium: 8px;
    --border-radius-large: 16px;

    --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-strong: 0 8px 24px rgba(0,0,0,0.12);

    --spacing-unit: 8px;
}

*, *::before, *::after { box-sizing: border-box; }

body {
    font-family: var(--font-primary);
    margin: 0; padding: calc(var(--spacing-unit) * 3);
    background: var(--color-bg-main);
    color: var(--color-text-medium);
    line-height: 1.65; font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.app-header { text-align: center; margin-bottom: calc(var(--spacing-unit) * 5); }
.app-header h1 {
    font-size: 2.25em;
    color: var(--color-text-dark);
    margin-bottom: var(--spacing-unit);
    font-weight: 700;
    letter-spacing: -0.5px;
}
.app-header p { font-size: 1.1em; color: var(--color-text-light); margin-top: 0; font-weight: 300; }

.tab-navigation {
    display: flex;
    justify-content: center;
    margin-bottom: calc(var(--spacing-unit) * 4);
    gap: 0;
    border-bottom: 1px solid #dee2e6;
}
.tab-button {
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 3);
    font-size: 1.05em; font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    background: none;
    color: var(--color-text-light);
    cursor: pointer;
    transition: color 0.25s ease, border-color 0.25s ease;
    border-radius: 0;
    margin-bottom: -1px;
}
.tab-button:hover { color: var(--color-primary); }
.tab-button.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    font-weight: 600;
}

.form-section-container {
    max-width: 760px;
    margin: 0 auto calc(var(--spacing-unit) * 5) auto;
    background: var(--color-bg-content);
    padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4.5);
    box-shadow: var(--shadow-medium);
    border-radius: var(--border-radius-large);
    border: 1px solid #e0e0e0;
}
.form-section-container h2 {
     font-size: 1.75em; margin-bottom: calc(var(--spacing-unit) * 1.5);
     text-align: center; color: var(--color-text-dark); font-weight: 600;
}
.form-section-container > p:not(.confirmation-message) {
    text-align: center; margin-top: calc(var(--spacing-unit) * -0.5);
    margin-bottom: calc(var(--spacing-unit) * 3);
    font-size: 1em; color: var(--color-text-light); font-weight: 300; max-width: 90%; margin-left: auto; margin-right: auto;
}

label {
    display:block; margin-bottom: var(--spacing-unit); font-weight: 500;
    color: var(--color-text-medium); font-size: 0.9em;
}
input[type="text"], textarea {
    width: 100%; padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 1.75);
    font-size: 1em; font-family: var(--font-secondary);
    border-radius: var(--border-radius-medium); border: 1px solid #CED4DA;
    transition: border-color 0.2s, box-shadow 0.2s;
    background-color: var(--color-bg-content);
    color: var(--color-text-dark);
}
input[type="text"]::placeholder, textarea::placeholder { color: #adb5bd; font-weight: 300; }
input[type="text"]:focus, textarea:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
    outline: none;
}
textarea { resize: vertical; min-height: 100px; line-height: 1.6; }

.progress-bar {
    width: 100%; background-color: var(--color-bg-alt); border-radius: var(--border-radius-small);
    overflow: hidden; margin-bottom: calc(var(--spacing-unit) * 3); height: 10px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.07);
}
.progress {
    height: 100%; width: 0; background: linear-gradient(90deg, var(--color-secondary-dark), var(--color-secondary));
    transition: width 0.4s ease; border-radius: var(--border-radius-small);
}
.question-card {
    margin-bottom: calc(var(--spacing-unit) * 3);
    padding: calc(var(--spacing-unit) * 2.5);
    background: #FDFEFF;
    border-radius: var(--border-radius-medium);
    border: 1px solid #E7F0F9;
}
.question-card h3 {
    font-weight: 600; font-size: 1.1em; margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 0.75);
    color: var(--color-primary);
}
.question-card p {
    font-weight: 400; font-size: 0.95em; margin-bottom: calc(var(--spacing-unit) * 1.5);
    color: var(--color-text-medium); line-height: 1.6;
}
.form-step {display: none;}
.form-step-active {display: block; animation: fadeInFormStep 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);}
@keyframes fadeInFormStep { 0% {opacity: 0; transform: translateY(15px);} 100% {opacity: 1; transform: translateY(0);} }

.step-navigation {
    text-align: center; margin-top: calc(var(--spacing-unit) * 3.5);
    display: flex; justify-content: space-between; gap:calc(var(--spacing-unit) * 2);
}
.step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {
    padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 2.5);
    font-family: var(--font-primary); font-size: 0.95em; font-weight: 500;
    color: var(--color-text-inverted); border: none; border-radius: var(--border-radius-medium);
    cursor: pointer; transition: background-color 0.2s, transform 0.15s ease-out, box-shadow 0.2s ease;
    box-shadow: var(--shadow-light);
    letter-spacing: 0.3px;
}
.step-navigation button:hover:not(:disabled), button#fisaAddButton:hover:not(:disabled), button#saveJournalEntryButton:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}
.step-navigation button#fisaPrevButton { background-color: var(--color-text-light); }
.step-navigation button#fisaPrevButton:hover:not(:disabled) { background-color: #5a6268; }
.step-navigation button#fisaNextButton { background-color: var(--color-primary); }
.step-navigation button#fisaNextButton:hover:not(:disabled) { background-color: var(--color-primary-dark); }

button#fisaAddButton {
    background-color: var(--color-success); display:block; width:100%;
    margin-top:calc(var(--spacing-unit) * 2.5); font-size: 1em;
}
button#fisaAddButton:hover:not(:disabled) { background-color: #218838; }

.step-navigation button:disabled, button#fisaAddButton:disabled, button#saveJournalEntryButton:disabled {
    background: #ced4da !important; color: #6c757d !important;
    cursor: not-allowed !important; box-shadow: none !important; transform: translateY(0) !important;
}

input#journalTitle { margin-bottom: calc(var(--spacing-unit) * 2); }
textarea#journalContent { min-height: 220px; line-height: 1.7; margin-top: var(--spacing-unit); }

.prompt-box {
    background: var(--color-primary-light); border: 1px solid #B9D7F8;
    border-left: 4px solid var(--color-primary);
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
    margin-bottom: calc(var(--spacing-unit) * 2);
    font-size: 0.9em; border-radius: var(--border-radius-medium);
}
.prompt-box-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: var(--spacing-unit);
}
.prompt-box-header strong { color: var(--color-primary-dark); font-size: 1.1em; font-weight: 600;}
.hide-prompt-button {
    background: none; border: none; color: var(--color-primary);
    font-size: 1.8em; font-weight: bold; cursor: pointer;
    padding: 0 calc(var(--spacing-unit) * 0.5);
    line-height: 0.8; opacity: 0.7; transition: opacity 0.2s;
}
.hide-prompt-button:hover { opacity: 1; }

.prompt-content-display {
    white-space: pre-wrap; max-height: 200px; overflow-y: auto;
    background-color: var(--color-bg-content);
    padding: calc(var(--spacing-unit) * 1.25);
    border-radius: var(--border-radius-small); border: 1px solid #DDE8F5;
    font-family: 'Menlo', 'Monaco', monospace; font-size:0.9em; line-height: 1.5;
    color: var(--color-text-medium);
}
.prompt-content-display::-webkit-scrollbar { width: 6px; }
.prompt-content-display::-webkit-scrollbar-track { background: #f1f1f1; }
.prompt-content-display::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius:3px; }
.prompt-content-display::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

#reflectionPromptsContainer {
    margin: calc(var(--spacing-unit) * 2.5) 0;
    padding: calc(var(--spacing-unit) * 2);
    background-color: var(--color-bg-main);
    border-radius: var(--border-radius-medium);
    border: 1px solid #E0E6ED;
}
#reflectionPromptsContainer p {
    margin-top: 0; margin-bottom: var(--spacing-unit); font-weight: 500;
    color: var(--color-text-dark); font-size: 0.95em;
}
.prompt-button-group { display: flex; flex-wrap: wrap; gap: var(--spacing-unit); }
button.prompt-button {
    background-color: transparent;
    color: var(--color-primary); border: 1px solid var(--color-primary);
    padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.75);
    font-size: 0.85em; font-weight: 500; border-radius: 20px;
    cursor: pointer; transition: all 0.2s;
}
button.prompt-button:hover {
    background-color: var(--color-primary); color: var(--color-text-inverted);
    transform: translateY(-1px);
}

button#saveJournalEntryButton {
    display: block; width: 100%;
    margin-top: calc(var(--spacing-unit) * 2.5);
    padding: calc(var(--spacing-unit) * 1.5);
    font-size: 1em; font-weight: 500;
    background-color: var(--color-primary); color: var(--color-text-inverted);
    letter-spacing: 0.5px;
}
button#saveJournalEntryButton:hover:not(:disabled) { background-color: var(--color-primary-dark); }

.confirmation-message {
    display: none; text-align: center;
    padding: calc(var(--spacing-unit) * 1.5);
    border: 1px solid transparent; border-radius: var(--border-radius-medium);
    margin-top: calc(var(--spacing-unit) * 2.5);
    animation: fadeInConfirm 0.4s; font-weight: 500; font-size: 0.95em;
}
.confirmation-message.success { background-color: var(--color-success-bg); color: var(--color-success); border-color: #A3D9B1; }
.confirmation-message.error   { background-color: var(--color-error-bg); color: var(--color-error); border-color: #F1B9BF; }
.confirmation-message.warning { background-color: var(--color-warning-bg); color: #B08800; border-color: #FFE58C; }
@keyframes fadeInConfirm { 0% {opacity: 0; transform: translateY(10px);} 100% {opacity: 1; transform: translateY(0);} }

#cardsContainerArea h3 {
    color: var(--color-text-dark); text-align: center;
    margin-bottom: calc(var(--spacing-unit) * 3);
    font-weight: 600; font-size: 1.6em;
    margin-top: calc(var(--spacing-unit) * 6);
}
.card-view-unified {
    display: flex; flex-direction: column; gap: calc(var(--spacing-unit) * 3);
    max-width: 760px; margin: calc(var(--spacing-unit) * 3) auto;
}
.response-card {
    background: var(--color-bg-content);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-medium);
    overflow: hidden; border: 1px solid #E9ECEF;
    transition: box-shadow 0.3s ease;
}
.response-card:hover { box-shadow: var(--shadow-strong); }

.response-card .card-header {
    font-weight: 600; font-size: 1.05em; cursor: pointer;
    background: #FCFDFE;
    padding: calc(var(--spacing-unit) * 1.75) calc(var(--spacing-unit) * 2.5);
    color: var(--color-text-dark); border-bottom: 1px solid #F0F3F5;
    display: flex; justify-content: space-between; align-items: center;
    transition: background-color 0.2s ease;
}
.response-card .card-header:hover { background: #F5F8FB; }
.response-card .card-header span:first-child { flex-grow: 1; margin-right: var(--spacing-unit); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
.response-card .card-header .card-date { font-size: 0.8em; color: var(--color-text-light); white-space: nowrap; font-weight: 400;}
.response-card .card-header::after {
    content: '‚Ä∫'; font-size: 1.5em; transition: transform 0.3s ease;
    color: var(--color-primary); margin-left: var(--spacing-unit); line-height: 1;
    font-weight: bold;
}
.response-card.open .card-header::after {transform: rotate(90deg);}

.response-card .card-content { max-height: 0; padding: 0 calc(var(--spacing-unit) * 2.5); overflow-y: hidden; transition: max-height 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), padding-top 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), padding-bottom 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
.response-card.open .card-content { max-height: 10000px; padding: calc(var(--spacing-unit) * 2.5) calc(var(--spacing-unit) * 2.5); }

.introspectie-entry-details {
    margin-bottom: calc(var(--spacing-unit) * 2.5);
    border: 1px solid #F0F3F5; border-radius: var(--border-radius-medium);
    background: #FBFCFD;
}
.introspectie-entry-details summary {
    cursor: pointer; padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
    font-weight: 500; color: var(--color-primary-dark);
    background-color: #F5F8FB; border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
    list-style-position: inside;
    transition: background-color 0.2s ease;
}
.introspectie-entry-details summary:hover { background-color: #EDF2F9; }
.introspectie-entry-details[open] summary { border-bottom: 1px solid #F0F3F5; }
.introspectie-entry-content-text {
    padding: calc(var(--spacing-unit) * 1.5);
    font-size: 0.95em; line-height: 1.7; color: var(--color-text-medium);
    max-height: 500px; overflow-y: auto; white-space: pre-wrap;
}
.introspectie-entry-content-text hr {margin: calc(var(--spacing-unit) * 2) 0; border: 0; border-top: 1px dashed #DDE2E7;}
.introspectie-entry-content-text h4 { font-size: 1em; color: var(--color-primary); margin-top: calc(var(--spacing-unit) * 2); margin-bottom:var(--spacing-unit); font-weight: 600;}
.introspectie-entry-content-text p { margin-bottom: calc(var(--spacing-unit) * 1.25); }
.introspectie-entry-content-text p strong { font-weight: 600; color: var(--color-text-dark); margin-right: calc(var(--spacing-unit)*0.5); }
.introspectie-entry-content-text::-webkit-scrollbar { width: 6px; }
.introspectie-entry-content-text::-webkit-scrollbar-thumb { background: #D1D9E2; border-radius:3px; }

.journal-entry-content-text-unified { white-space: pre-wrap; font-size: 1em; line-height: 1.75; color: var(--color-text-medium); }

.response-card > .card-content > h4.ai-feedback-title {
    color: var(--color-secondary-dark); font-weight: 600; margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 2);
    font-size: 1.2em;
    border-bottom: 1px solid #E7F0F9; padding-bottom: var(--spacing-unit);
}
.no-feedback-message { text-align: center; font-style: italic; color: var(--color-text-light); padding: calc(var(--spacing-unit) * 2) 0; }
.ai-feedback-history-container { margin-top: calc(var(--spacing-unit) * 1.5); }
.feedback-entry-card {
    background: #FDFEFF; padding: calc(var(--spacing-unit) * 2);
    border: 1px solid #E7F0F9;
    border-left: 4px solid var(--color-secondary); border-radius: var(--border-radius-medium); margin-bottom:calc(var(--spacing-unit) * 2);
    font-size:0.95em; line-height:1.65; box-shadow: var(--shadow-light);
}
.feedback-timestamp { color: var(--color-text-light); font-size:0.8em; margin-bottom:var(--spacing-unit); font-style: italic; }
.feedback-section-item { margin-bottom: var(--spacing-unit); }
.feedback-section-item h5 {
    font-size: 1em; color: var(--color-secondary-dark); margin-top:0;
    margin-bottom: calc(var(--spacing-unit)*0.5); font-weight:600;
}
.feedback-section-item p, .feedback-section-item ul { margin-left: var(--spacing-unit); font-size: 0.95em; }
.feedback-section-item ul { padding-left: calc(var(--spacing-unit)*2); }
.feedback-section-item li { margin-bottom: calc(var(--spacing-unit)*0.5); }


.card-actions {
    margin-top: calc(var(--spacing-unit) * 2.5);
    padding-top: calc(var(--spacing-unit) * 2);
    border-top: 1px solid #F0F3F5;
    display: flex; flex-wrap: wrap; gap: var(--spacing-unit);
    justify-content: flex-end;
}
.card-actions button {
    padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.5);
    font-size: 0.8em; font-weight:500; border-radius: var(--border-radius-medium);
    transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
    background-color: #F8F9FA;
    color: var(--color-text-medium);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.card-actions button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
button.delete-introspectie-button { color: var(--color-error); border-color: var(--color-error-bg); }
button.delete-introspectie-button:hover { background-color: var(--color-error); color: white; }
button.regenerate-feedback-button { color: var(--color-success); border-color: var(--color-success-bg); }
button.regenerate-feedback-button:hover { background-color: var(--color-success); color: white;}
button.discuss-entry-with-chat-button { color: var(--color-primary); border-color: var(--color-primary-light); }
button.discuss-entry-with-chat-button:hover { background-color: var(--color-primary); color: white;}
button.delete-last-feedback-button { color: var(--color-accent); border-color: var(--color-warning-bg); }
button.delete-last-feedback-button:hover { background-color: var(--color-accent); color: #493709;}
button.delete-all-feedback-button { color: #AB240C; border-color: #FEE9E5;}
button.delete-all-feedback-button:hover { background-color: #AB240C; color: white;}

.content-ai { font-size: 1em; line-height: 1.75; color: var(--color-text-medium); }
.content-ai h1, .content-ai h2, .content-ai h3, .content-ai h4, .content-ai .ai-main-section-title {
    font-weight: 600; color: var(--color-secondary-dark);
    margin-top: 1.4em; margin-bottom: 0.7em;
    font-size: 1.1em; padding-bottom: calc(var(--spacing-unit)*0.5);
}
.content-ai h1:first-child, .content-ai .ai-main-section-title:first-child { margin-top: 0.5em; }
.content-ai p, .content-ai p.ai-text-paragraph { margin-bottom: 1em; }
.content-ai strong, .content-ai p.ai-text-paragraph strong { font-weight: 600; color: var(--color-text-dark); }
.content-ai em, .content-ai p.ai-text-paragraph em { font-style: italic; color: var(--color-text-medium); }
.content-ai ul, .content-ai ol, .content-ai ul.ai-list, .content-ai ol.ai-list {
    margin-left: calc(var(--spacing-unit)*0.5); padding-left: calc(var(--spacing-unit)*2.5);
    margin-bottom: 1em; list-style-position: outside;
}
.content-ai li, .content-ai .ai-list-item { margin-bottom: 0.6em; }
.content-ai li::marker, .content-ai .ai-list-item::marker { color: var(--color-secondary); font-weight: bold; }

.content-ai .ai-text-error {
    color: var(--color-error); font-weight: 500; background-color: var(--color-error-bg);
    padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); border-radius: var(--border-radius-small);
    border: 1px solid #F1B9BF; border-left: 4px solid var(--color-error);
    white-space: pre-wrap; font-size: 0.9em;
}
.raw-feedback-display { white-space: pre-wrap; font-family: monospace; font-size: 0.9em; padding: 10px; background: #f0f0f0; border-radius: 4px; max-height: 300px; overflow-y: auto;}

.no-entries-message, .loading-message, .error-loading-message { text-align: center; margin-top:calc(var(--spacing-unit)*3); font-style: italic; color: var(--color-text-light); font-size: 1.05em; padding:var(--spacing-unit)*2;}
.error-loading-message { color: var(--color-error); font-weight: 500;}
.loading-message { color: var(--color-primary); font-weight: 500; }

/* CHAT INTERFACE */
.chat-container {
    display: none; flex-direction: column; position: fixed; bottom: 20px; right: 20px;
    width: clamp(360px, 30vw, 420px);
    max-height: calc(100vh - 100px);
    background: var(--color-bg-content);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-strong);
    z-index: 1000; padding: 0; box-sizing: border-box; overflow: hidden;
    border: 1px solid #DEE2E6;
}
.chat-container h3 {
    text-align: center; color: var(--color-text-dark); margin: 0;
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
    font-size: 1.05em; font-weight: 600;
    background-color: #F8F9FA;
    border-bottom: 1px solid #E9ECEF; flex-shrink: 0;
    display: flex; justify-content: space-between; align-items: center;
}
#chatMessages {
    flex-grow: 1; overflow-y: auto; padding: calc(var(--spacing-unit)*1.5);
    background: var(--color-bg-content);
    display: flex; flex-direction: column; gap: calc(var(--spacing-unit)*1.25);
}
#chatMessages::-webkit-scrollbar { width: 7px; }
#chatMessages::-webkit-scrollbar-track { background: transparent; }
#chatMessages::-webkit-scrollbar-thumb { background: #CED4DA; border-radius: 10px; }
#chatMessages::-webkit-scrollbar-thumb:hover { background: #ADB5BD; }

.chat-message {
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*2);
    border-radius: var(--border-radius-large);
    max-width: 80%;
    word-wrap: break-word; line-height: 1.5;
    box-shadow: var(--shadow-light);
    font-size: 0.95em; font-weight: 400; position: relative;
}
.user-message {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    align-self: flex-end; margin-left: auto;
    border-bottom-right-radius: var(--border-radius-small);
}
.ai-message {
    background: var(--color-bg-chat-alt);
    color: var(--color-text-dark);
    align-self: flex-start; margin-right: auto;
    border-bottom-left-radius: var(--border-radius-small);
    font-family: var(--font-primary);
}
.ai-message em, .ai-message i { font-family: var(--font-primary), inherit; font-style: italic; }
.ai-message strong, .ai-message b { font-family: var(--font-primary), inherit; font-weight: 600; }
.ai-message.ai-error {
    background-color: var(--color-error-bg); color: var(--color-error);
    border: 1px solid #F5C6CB;
    font-family: var(--font-primary), sans-serif;
}
.ai-message pre.code-block-chat { background:#eef; padding:5px; border-radius:4px; white-space:pre-wrap; word-break:break-all; font-size: 0.9em; }
.ai-message code.inline-code-chat { background:#eef; padding:1px 3px; border-radius:3px; font-size: 0.9em; }
.ai-message h6 { margin-top: 0.8em; margin-bottom: 0.4em; font-size: 1.05em; font-weight: 600; color: var(--color-text-dark);}
.ai-message ul, .ai-message ol { margin-top: 0.5em; margin-bottom: 0.5em; padding-left: 20px;}
.ai-message li { margin-bottom: 0.25em;}

.chat-input-area {
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*1.5);
    border-top: 1px solid #E9ECEF; background-color: #F8F9FA;
    flex-shrink: 0;
    display: flex;
    align-items: flex-end;
    gap: calc(var(--spacing-unit)*1);
}

#chatInput {
    flex-grow: 1;
    border-radius: 20px;
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*1.75);
    min-height: 40px;
    max-height: 100px;
    font-size: 0.95em;
    line-height: 1.4;
    resize: none;
    margin-bottom: 0;
    border: 1px solid #CED4DA;
}

#sendChatMessageButton {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    padding: 0;
    font-family: var(--font-primary);
    font-size: 1.2em;
    font-weight: 500;
    background-color: transparent;
    color: var(--color-primary);
    border: none;
    border-radius: 50%;
    transition: background-color 0.2s, color 0.2s;
    cursor: pointer;
    margin-top:0;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}
#sendChatMessageButton::before { content: "‚û¢"; }

#sendChatMessageButton:hover:not(:disabled) {
    background-color: var(--color-primary-light);
    color: var(--color-primary-dark);
    transform: none;
    box-shadow: none;
}
#sendChatMessageButton:disabled {
    background-color: transparent !important;
    color: #CED4DA !important;
    transform: translateY(0) !important;
    cursor: not-allowed !important;
}
#chatStatus {
    font-size: 0.9em; color: var(--color-text-light); text-align: center;
    min-height: 1.2em;
    font-weight: 300;
    background-color: #F8F9FA;
    margin:0;
}
#toggleChatButton {
    position: fixed; bottom: calc(var(--spacing-unit)*2); right: calc(var(--spacing-unit)*2);
    padding: 0; z-index: 1001;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(145deg, var(--color-secondary) 0%, var(--color-primary) 100%);
    color: var(--color-text-inverted); border: none; border-radius: 50%;
    width: 44px; height: 44px;
    font-size: 20px;
    line-height: 44px;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.25);
    cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
#toggleChatButton:hover {
    transform: scale(1.05) rotate(10deg);
    box-shadow: 0 6px 18px rgba(74, 144, 226, 0.3);
}

.ai-error-inline {
    color: var(--color-error);
    font-style: italic;
    font-size: 0.9em;
    display: block;
    margin-top: 5px;
}

@media (max-width: 820px) {
     .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*3);
        margin-left:calc(var(--spacing-unit)*2); margin-right:calc(var(--spacing-unit)*2);
        max-width:calc(100% - (var(--spacing-unit)*4));
     }
}
@media (max-width: 768px) {
    body {padding:calc(var(--spacing-unit)*2); font-size: 15px;}
    .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*2.5);
        margin-left:var(--spacing-unit); margin-right:var(--spacing-unit);
        max-width:calc(100% - (var(--spacing-unit)*2));
    }
    .app-header h1 { font-size: 2em; }
    .tab-button { padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*2.5); font-size: 1em;}
    .form-section-container h2 {font-size:1.6em;}
    #cardsContainerArea h3 {font-size: 1.5em;}
    .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.9em; padding:var(--spacing-unit) calc(var(--spacing-unit)*2);}
    .card-actions button {font-size:0.75em; padding:calc(var(--spacing-unit)*0.75) var(--spacing-unit);}

    .chat-container {
        width: calc(100% - var(--spacing-unit)*2);
        max-height: calc(100vh - 60px);
        bottom: var(--spacing-unit);
        left: var(--spacing-unit);
        right: var(--spacing-unit);
        border-radius: var(--border-radius-medium);
    }
    #toggleChatButton {
        width: 40px; height: 40px; font-size: 18px; line-height: 40px;
        bottom: calc(var(--spacing-unit)*1.5); right: calc(var(--spacing-unit)*1.5);
    }
    #chatInput {
        padding: calc(var(--spacing-unit)*1) calc(var(--spacing-unit)*1.5);
        min-height: 38px;
        font-size: 0.9em;
    }
    #sendChatMessageButton { width: 38px; height: 38px; font-size: 1.1em; }
    .chat-input-area { padding: var(--spacing-unit); }
}
@media (max-width: 480px) {
    body {padding:var(--spacing-unit); font-size: 14px;}
    .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*1.5);
        margin-left:calc(var(--spacing-unit)*0.5); margin-right:calc(var(--spacing-unit)*0.5);
        max-width:calc(100% - var(--spacing-unit));
        border-radius: var(--border-radius-medium);
    }
    .app-header h1 {font-size:1.7em;}
    .tab-button { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 0.9em;}
    .form-section-container h2 {font-size:1.4em;} #cardsContainerArea h3 {font-size: 1.3em;}
    textarea#journalContent { min-height: 160px; }
    .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.85em; padding:var(--spacing-unit) calc(var(--spacing-unit)*1.5);}
    .card-actions button {
        font-size:0.7em; padding:calc(var(--spacing-unit)*0.75) var(--spacing-unit);
        flex-basis: calc(50% - (var(--spacing-unit)*0.5) );
    }
    .response-card .card-header {
        padding:var(--spacing-unit) calc(var(--spacing-unit)*1.5);
        flex-direction: column; align-items: flex-start; gap: calc(var(--spacing-unit)*0.5);
    }
    .response-card .card-header::after { align-self: flex-end; margin-top: -1.5em; font-size: 1.3em;}

    .chat-container {
        width: calc(100% - var(--spacing-unit)*2);
        max-height: calc(100vh - var(--spacing-unit)*2 - 50px);
        bottom: var(--spacing-unit);
        left: var(--spacing-unit);
        right: var(--spacing-unit);
        border-radius: var(--border-radius-medium);
    }
    .chat-container h3 { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 1em;}
    #chatMessages { padding: var(--spacing-unit); gap: var(--spacing-unit);}
    .chat-message { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 0.9em;}

    #chatInput { min-height: 36px; font-size: 0.9em; }
    #sendChatMessageButton { width: 36px; height: 36px; }
    #toggleChatButton {
        width: 38px; height: 38px; font-size: 16px; line-height: 38px;
        bottom: var(--spacing-unit); right: var(--spacing-unit);
    }
}
#minimizeChatButton {
    background: none; border: none; color: var(--color-text-medium);
    cursor: pointer; padding: 0 var(--spacing-unit); line-height: 1;
    font-size: 1.2em; font-weight: bold;
}
#minimizeChatButton::after {
    content: ''; display: inline-block; width: 6px; height: 6px;
    border-left: 2px solid currentColor; border-bottom: 2px solid currentColor;
    transform: rotate(-45deg); margin-left: 5px;
}
#minimizeChatButton:hover { color: var(--color-primary); }
.chat-container h3 .chat-title-text {
    flex-grow: 1; text-align: center;
    margin-right: auto; margin-left: auto;
}
#minimizeChatButton { margin-left: var(--spacing-unit); }
 /* --- MODERN FRESH STYLES END --- */
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Introspec»õie GhidatƒÉ</h1>
        <p>Jurnal personal »ôi fi»ôe de monitorizare √Æntr-un singur loc.</p>
    </header>

    <nav class="tab-navigation">
        <button id="tabButtonJurnal" class="tab-button active" type="button">Jurnal Ghidat</button>
        <button id="tabButtonFisa" class="tab-button" type="button">Fi»ôƒÉ TerapeuticƒÉ</button>
    </nav>

    <main id="mainContentArea">
        <!-- Con»õinutul Jurnalului Ghidat -->
        <div id="jurnalFormContainer" class="tab-content active">
            <section class="form-section-container">
                <h2>Jurnal Terapeutic Personal</h2>
                <p>Spa»õiul tƒÉu pentru reflec»õie ghidatƒÉ, auto-descoperire »ôi integrare emo»õionalƒÉ.</p>

                <form id="therapeuticJournalForm" onsubmit="return false;">
                    <label for="journalTitle">Titlu (Op»õional):</label>
                    <input type="text" id="journalTitle" name="journalTitle" placeholder="Ex: Reflec»õii despre ziua de azi...">

                    <div id="reflectionPromptsContainer" style="margin-top: 20px;">
                        <p>Puncte de start pentru reflec»õie (alege un ghid):</p>
                        <div class="prompt-button-group" id="reflectionPrompts">
                            <!-- Butoanele vor fi generate de JavaScript -->
                        </div>
                    </div>

                    <div id="activeJurnalPromptBox" class="prompt-box" style="display: none;">
                        <div class="prompt-box-header">
                            <strong id="activeJurnalPromptTitle">Ghid activ:</strong>
                            <button type="button" onclick="window.hideActiveJurnalPromptManual()" class="hide-prompt-button" title="Ascunde ghidul">√ó</button>
                        </div>
                        <div id="activeJurnalPromptContent" class="prompt-content-display"></div>
                        <p style="font-size:0.85em; text-align:right; margin-top:8px; color: #64748B;"><em>Acest ghid este pentru inspira»õie. Scrie √Æn c√¢mpul de mai jos.</em></p>
                    </div>

                    <label for="journalContent" style="margin-top: 15px;">Intrarea ta √Æn jurnal:</label>
                    <textarea id="journalContent" name="journalContent" rows="12" placeholder="Scrie liber aici sau completeazƒÉ rƒÉspunz√¢nd la √ÆntrebƒÉrile din ghidul afi»ôat..."></textarea>

                    <button type="button" id="saveJournalEntryButton">SalveazƒÉ Jurnal »ôi Cere Feedback AI</button>
                </form>
                <div id="jurnalConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>

        <!-- Con»õinutul Fi»ôei Terapeutice -->
        <div id="fisaFormContainer" class="tab-content">
            <section class="form-section-container">
                <h2>Fi»ôƒÉ de Monitorizare TerapeuticƒÉ</h2>
                <p>CompleteazƒÉ fiecare √Æntrebare pentru a √Æn»õelege mai bine situa»õiile tale. Fiecare sec»õiune reprezintƒÉ o parte importantƒÉ a reflec»õiei tale. √én acest exerci»õiu, √Æ»õi voi ghida fiecare pas, astfel √Ænc√¢t sƒÉ po»õi explora √Æn profunzime g√¢ndurile, emo»õiile »ôi comportamentele tale.</p>
    
                <div class="progress-bar">
                    <div class="progress" id="fisaProgress"></div>
                </div>

                <form id="fisaExercitiuForm" novalidate>
    <!-- PASUL 1 -->
            <div class="question-card form-step form-step-active" id="fisa-step-1">
                <h3>Care este situa»õia?</h3>
                <p>Te rog sƒÉ descrii contextul care a declan»ôat emo»õiile sau comportamentul tƒÉu. √éncearcƒÉ sƒÉ fii c√¢t mai specific »ôi detaliat. Aceasta poate fi o situa»õie concretƒÉ din via»õa de zi cu zi √Æn care te-ai sim»õit cople»ôit, stresat sau √Æntr-o altƒÉ stare emo»õionalƒÉ intensƒÉ.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-2">
                <h3>Ce √Æmi trece prin minte?</h3>
                <p>√é»õi cer sƒÉ identifici g√¢ndurile automate care au apƒÉrut √Æn aceastƒÉ situa»õie. Acestea sunt g√¢nduri rapide, involuntare, care √Æ»õi trec prin minte √Æn momentele de stres. Ce √Æ»õi spui √Æn acel moment? Este un g√¢nd critic sau √ÆngrijorƒÉtor?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-3">
                <h3>Cum mƒÉ face acel g√¢nd sƒÉ mƒÉ simt?</h3>
                <p>Te rog sƒÉ notezi emo»õiile pe care le sim»õi √Æn urma acelui g√¢nd. Ce sim»õi? FricƒÉ, triste»õe, furie? DƒÉ o intensitate emo»õiei (de la 0 la 100) pentru a vedea c√¢t de puternicƒÉ este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-4">
                <h3>Ce mod este activ?</h3>
                <p>IdentificƒÉ modul √Æn care te afli √Æn aceastƒÉ situa»õie. Este un mod de copil vulnerabil, critic interior, sau poate adultul sƒÉnƒÉtos? Con»ôtientizarea modului √Æ»õi poate oferi o mai bunƒÉ √Æn»õelegere a reac»õiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-5">
                <h3>Ce comportament sim»õi cƒÉ adop»õi?</h3>
                <p>Descrie comportamentul pe care √Æl manife»ôti √Æn aceastƒÉ situa»õie. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoa»ôterea comportamentului te ajutƒÉ sƒÉ √Æn»õelegi mai bine cum reac»õionezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emo»õii »ôi comportamente? Poate fi nevoia de siguran»õƒÉ, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta sƒÉ gƒÉse»ôti strategii mai sƒÉnƒÉtoase pentru a le √Ændeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-7">
                <h3>MƒÉ ajutƒÉ comportamentul meu sƒÉ √Ændeplinesc aceste nevoi?</h3>
                <p>ReflecteazƒÉ dacƒÉ felul √Æn care reac»õionezi te ajutƒÉ cu adevƒÉrat sƒÉ √Æ»õi √Ændepline»ôti nevoile. Poate fi util sƒÉ te g√¢nde»ôti dacƒÉ existƒÉ alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-8">
                <h3>Cum ar g√¢ndi »ôi cum s-ar comporta Adultul SƒÉnƒÉtos?</h3>
                <p>G√¢nde»ôte-te la cum ar reac»õiona partea ta AdultƒÉ SƒÉnƒÉtoasƒÉ √Æn aceastƒÉ situa»õie. Cum ai putea sƒÉ abordezi diferit pentru a avea grijƒÉ de tine »ôi de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- PASUL 2 -->
            <div class="question-card form-step" id="fisa-step-9">
                <h3>Ce mƒÉ face sƒÉ cred cƒÉ g√¢ndul automat este adevƒÉrat?</h3>
                <p>ExploreazƒÉ motivele pentru care crezi cƒÉ acest g√¢nd este adevƒÉrat. Ce dovezi ai care √Æ»õi confirmƒÉ acest lucru? De multe ori, ne bazƒÉm pe experien»õe trecute sau frici pentru a justifica un g√¢nd.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-10">
                <h3>Ce mƒÉ face sƒÉ cred cƒÉ nu este adevƒÉrat?</h3>
                <p>Acum, sƒÉ ne uitƒÉm la dovezile √Æmpotriva g√¢ndului tƒÉu. ExistƒÉ argumente sau experien»õe care contrazic acest g√¢nd? Poate existƒÉ o altƒÉ perspectivƒÉ pe care nu ai luat-o √Æn considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-11">
                <h3>ExistƒÉ o explica»õie alternativƒÉ?</h3>
                <p>Uneori, existƒÉ mai multe explica»õii pentru ceea ce se √Ænt√¢mplƒÉ. Ce alte interpretƒÉri ai putea avea pentru aceastƒÉ situa»õie? G√¢nde»ôte-te la alte posibilitƒÉ»õi care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-12">
                <h3>Care este cel mai rƒÉu lucru care s-ar putea √Ænt√¢mpla?</h3>
                <p>Ce este cel mai rƒÉu care ar putea avea loc √Æn aceastƒÉ situa»õie? SƒÉ identificƒÉm acele frici catastrofale care adesea ne alimenteazƒÉ g√¢ndurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-13">
                <h3>Care este cel mai bun lucru care s-ar putea √Ænt√¢mpla?</h3>
                <p>Pe de altƒÉ parte, care ar fi cel mai pozitiv scenariu? Uneori uitƒÉm sƒÉ ne g√¢ndim »ôi la posibilitƒÉ»õile bune. Cum ar arƒÉta cel mai bun rezultat al acestei situa»õii?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>DupƒÉ ce am explorat extremele, ce crezi cƒÉ este cel mai probabil sƒÉ se √Ænt√¢mple? Cum ar arƒÉta un rezultat realist, »õin√¢nd cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-15">
                <h3>Ce s-ar √Ænt√¢mpla dacƒÉ mi-a»ô schimba modul de g√¢ndire?</h3>
                <p>√éntreabƒÉ-te cum ar fi dacƒÉ ai aborda situa»õia cu un alt tip de g√¢ndire. Cum ar influen»õa asta emo»õiile »ôi comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-16">
                <h3>Ce i-a»ô spune unui prieten dacƒÉ ar fi √Æn aceea»ôi situa»õie?</h3>
                <p>G√¢nde»ôte-te la cum ai reac»õiona dacƒÉ un prieten drag ar avea acelea»ôi g√¢nduri. Ce i-ai spune pentru a-l sprijini? Cum ai √Æncerca sƒÉ-l √Æncurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- PASUL 3 -->
            <div class="question-card form-step" id="fisa-step-17">
                <h3>VƒÉd doar partea rea a lucrurilor?</h3>
                <p>Este posibil sƒÉ fii prins √Æntr-un tipar negativ de g√¢ndire, concentr√¢ndu-te doar pe aspectele negative. √éncearcƒÉ sƒÉ observi dacƒÉ existƒÉ »ôi aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-18">
                <h3>√émi asum responsabilitatea pentru lucruri care nu au stat √Æn puterea mea?</h3>
                <p>ReflecteazƒÉ dacƒÉ √Æ»õi asumi responsabilitatea pentru situa»õii asupra cƒÉrora nu aveai control. Este important sƒÉ √Æ»õi dai seama de limitele influen»õei tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-19">
                <h3>MƒÉ condamn √Æn baza unui singur eveniment?</h3>
                <p>√é»õi evaluezi valoarea personalƒÉ baz√¢ndu-te pe un singur eveniment negativ? Aminte»ôte-»õi cƒÉ un eveniment nu define»ôte cine e»ôti √Æn totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-20">
                <h3>Privesc situa»õia √Æn termeni extremi?</h3>
                <p>VerificƒÉ dacƒÉ vezi situa»õia doar √Æn alb sau negru, fƒÉrƒÉ nuan»õe de gri. G√¢ndirea extremƒÉ poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-21">
                <h3>Exagerez situa»õia?</h3>
                <p>√é»õi amplifici reac»õiile fa»õƒÉ de o situa»õie? √éncearcƒÉ sƒÉ te g√¢nde»ôti dacƒÉ ceea ce percepi este realist sau dacƒÉ exagerezi impactul situa»õiei.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-22">
                <h3>ExistƒÉ »ôi al»õi factori responsabili?</h3>
                <p>ExistƒÉ al»õi factori care contribuie la aceastƒÉ situa»õie, pe l√¢ngƒÉ tine? Este important sƒÉ ai o perspectivƒÉ completƒÉ asupra cauzelor unei situa»õii.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-23">
                <h3>Am sƒÉrit direct la concluzii?</h3>
                <p>Te-ai grƒÉbit sƒÉ ajungi la o concluzie fƒÉrƒÉ suficiente dovezi? √éncearcƒÉ sƒÉ observi dacƒÉ existƒÉ alte posibilitƒÉ»õi care ar putea explica situa»õia.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-24">
                <h3>√émi pun √ÆntrebƒÉri fƒÉrƒÉ rƒÉspuns?</h3>
                <p>Te frƒÉm√¢ntƒÉ √ÆntrebƒÉri care nu au un rƒÉspuns clar sau realist? Aceste √ÆntrebƒÉri pot fi o sursƒÉ majorƒÉ de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-25">
                <h3>MƒÉ concentrez doar asupra slƒÉbiciunilor mele?</h3>
                <p>Ai tendin»õa sƒÉ te focalizezi doar pe slƒÉbiciuni »ôi sƒÉ ignori punctele tale forte? √éncearcƒÉ sƒÉ √Æ»õi recuno»ôti »ôi punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-26">
                <h3>MƒÉ zbat prea mult g√¢ndind la cum ar trebui sƒÉ fie lucrurile?</h3>
                <p>Ai tendin»õa sƒÉ te g√¢nde»ôti mereu la cum ar trebui sƒÉ fie lucrurile, √Æn loc sƒÉ accep»õi situa»õia a»ôa cum este? Acceptarea poate reduce stresul »ôi anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-27">
                <h3>MƒÉ a»ôtept sƒÉ fiu perfect?</h3>
                <p>√é»õi setezi standarde foarte √Ænalte, imposibil de atins? Perfec»õionismul poate fi o sursƒÉ majorƒÉ de frustrare »ôi descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="fisa-step-28">
                <h3>Completare finalizatƒÉ!</h3>
                <p>FelicitƒÉri pentru parcurgerea acestui exerci»õiu de auto-reflec»õie! ApasƒÉ butonul de mai jos pentru a salva datele »ôi a genera un feedback automatizat, dacƒÉ este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta sƒÉ ob»õii noi perspective. DacƒÉ √Ænt√¢mpini probleme cu generarea (ex: erori de limitƒÉ de utilizare sau cheie API invalidƒÉ), po»õi √Æncerca din nou mai t√¢rziu sau contacta administratorul.</p>
            </div>


                    <div class="step-navigation">
                        <button type="button" id="fisaPrevButton">√énapoi</button>
                        <button type="button" id="fisaNextButton">√énainte</button>
                    </div>
                    <button type="button" id="fisaAddButton">SalveazƒÉ Fi»ôa »ôi GenereazƒÉ Feedback AI</button>
                </form>
                <div id="fisaConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>
    </main>

    <section id="cardsContainerArea">
        <h3 id="introspectiiTitle">Istoricul Introspec»õiilor Tale</h3>
        <!-- Am eliminat #collabViewTitle -->
        <div class="card-view-unified" id="introspectiiCardContainer">
            <!-- Cardurile vor fi adƒÉugate aici -->
        </div>
    </section>

    <!-- Am eliminat collaboration-section »ôi butonul generateLinkButton -->

   <div class="chat-container" id="chatContainer">
   <h3>
    <span class="chat-title-text">DiscutƒÉ cu PsihoGPT</span>
    <button id="minimizeChatButton" title="MinimizeazƒÉ Chat" style="display: none;"></button>
</h3>
    <div id="chatMessages"></div>
    <!-- NOU: Am adƒÉugat div.chat-input-area -->
    <div class="chat-input-area">
        <textarea id="chatInput" rows="2" placeholder="Scrie mesajul tƒÉu... Enter pentru a trimite."></textarea>
        <button id="sendChatMessageButton" disabled title="Trimite Mesaj"></button> <!-- Am adƒÉugat title √Ænapoi -->
    </div>
    <p id="chatStatus">Chatul AI nu este activ.</p>
</div>
<button id="toggleChatButton" style="display: none;">üí¨</button>
</body>
</html>