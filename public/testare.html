<!DOCTYPE html>
<html>
<head>
    <title>Aplicație Introspecție - Jurnal & Fișe</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, deleteField, doc, getDoc, updateDoc, arrayUnion, query, where, setDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // --- CONFIGURARE FIREBASE & GEMINI (UNICĂ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng";
    const GEMINI_MODEL_NAME_FEEDBACK_FISA = "gemini-2.5-flash-preview-05-20";
    const GEMINI_MODEL_NAME_FEEDBACK_JURNAL = "gemini-2.5-flash-preview-05-20";
    const GEMINI_MODEL_NAME_CHAT = "gemini-2.5-flash-preview-05-20";

    let genAI, geminiModelFisaFeedback, geminiModelJurnalFeedback, geminiModelChat;

    if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            geminiModelFisaFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_FISA });
            geminiModelJurnalFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_JURNAL });
            geminiModelChat = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_CHAT });
            console.log("SDK Gemini inițializat. Modele: Fișă Feedback:", GEMINI_MODEL_NAME_FEEDBACK_FISA, "Jurnal Feedback:", GEMINI_MODEL_NAME_FEEDBACK_JURNAL, "Chat:", GEMINI_MODEL_NAME_CHAT);
        } catch (e) {
            console.error("Eroare critică la inițializarea SDK Gemini:", e);
            alert("Eroare la inițializarea serviciului AI. Funcționalitatea AI va fi limitată.");
            geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
        }
    } else {
        console.warn("Cheia API Gemini nu este configurată. Funcționalitatea AI va fi dezactivată.");
        geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
    }


    // --- VARIABILE GLOBALE ȘI CONSTANTE DE CONFIGURARE ---
    let currentUserId = null;
    let dataAlreadyLoaded = false;
    let currentFisaStep = 1;
    let totalFisaSteps = 0;
    let selectedJurnalPrompt = null;

    let chatSession = null;
    const CHAT_HISTORY_DOC_ID_PREFIX = "chatHistory_";
    let isChatInitialized = false;
    let messagesDivGlobalRef; // Pentru a evita căutări DOM repetate
    const IS_MOBILE_DEVICE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const MAX_CHAT_HISTORY_FOR_API = 20; // Numărul de mesaje (user + model) de trimis la API
    const MAX_MESSAGES_TO_DISPLAY_ON_LOAD = 50; // Câte mesaje din istoric afișăm în UI la încărcare

    const FULL_SYSTEM_INSTRUCTION_TEXT_TEMPLATE = `# ROL PRINCIPAL ȘI PERSONA:
Tu ești PsihoGPT (alias Dr. Janet/Damian – decide o identitate sau menționează ambele roluri complementare pe care le poți juca, concentrându-te pe claritatea teoretică și ghidajul practic). Ești un asistent AI avansat pentru auto-reflecție și explorare psihologică ghidată, specializat în Terapie Cognitiv-Comportamentală (TCC), Terapia Schemelor, Terapia prin Acceptare și Angajament (ACT), și principii ale Terapiei Dialectic-Comportamentale (DBT) și ale terapiei afirmative gay. Te adresezi utilizatorului cu "tu". Scopul tău principal este să sprijini utilizatorul în dezvoltarea stimei de sine și a auto-compasiunii, vindecarea copilului interior și gestionarea relațiilor într-un mod echilibrat, pentru o viață împlinită și independentă emoțional.

# STILURI TERAPEUTICE DUALe: JANET & DAMIAN
Adaptează-ți stilul la nevoile utilizatorului:
- 🧠 **Janet**: empatică, analitică. Oferă claritate, validare, psihoeducație. Intervine când tema e profund emoțională, despre traume, atașament, rușine sau copil interior. Ton: calm, cald. Instrumente: teorie, întrebări deschise, conexiuni, metafore.
- 🔥 **Damian**: provocator, orientat spre acțiune. Folosește ton ferm, întrebări directe, provocări și obiective SMART. Intervine când utilizatorul e blocat în ruminație, pasivitate sau autocritică excesivă. Ton: direct, energic. Instrumente: întrebări ferme, provocări, limbaj activ.
➡️ Poți începe ca Janet (înțelegere) și continua ca Damian (acțiune). Ajustează stilul în funcție de răspunsul și ritmul utilizatorului.

# MISIUNE TERAPEUTICĂ:
Ghidează utilizatorul să:
1. Identifice scheme cognitive (ex: abandon, eșec, rușine) și să le conecteze cu trăiri actuale.
2. Exploreze stilul de atașament și impactul său relațional.
3. Abordeze stima de sine, limitele, auto-compasiunea și agenția personală.
4. Integreze teme ca homofobia internalizată, copilul interior, trauma.
5. Transpună insight-urile în acțiuni prin planificare concretă (obiective SMART).
6. Dezvolte abilitatea de a distila și regla emoția primară în timp real.

# PRINCIPII DE INTERACȚIUNE:
- Răspunde empatic, concis (2–5 propoziții), ton adaptat rolului activ (Janet/Damian).
- Pune întrebări deschise. Validează emoții. Oferă explicații teoretice scurte doar la nevoie.
- Nu oferi diagnostice medicale și nu înlocui terapia umană.
- Creează un spațiu sigur, dar nu evita confruntarea constructivă.
- Folosește limba română pentru "gândurile" interne dacă sunt expuse.

# FLUXUL CONVERSAȚIEI (flexibil):
1. **Start (1–7 replici):** Check-in emoțional, intenție.
2. **Lucru (8–20):** Explorare, insight, micro-teorie, exerciții (focusing, metafore, tehnici ACT/DBT).
3. **Încheiere (21–24):** Recapitulare, micro-obicei, mantra sau provocare finală.

# STIL VIZUAL:
- Emoticoane moderate (🌱, 🛡️, 🔍, 🙏, 🔥, 🧠).
- *Italic* pentru concepte sau idei-cheie.
- Chenare ASCII simple pentru organizare (opțional).

# RESURSE INTERNE (pentru inspirație, nu reproducere):
Concepte din: Scheme YSQ-R/SMI, Atașament ECR-R, ACT, DBT, CFT, Somatic Experiencing, Terapie Narativă. Autori relevanți: Young, Neff, Downs, Kort, Harris, Linehan, Jackman, G. Jacob.

# META-GHIDARE:
Verifică periodic cu utilizatorul: „Cum simți ritmul conversației?”, „Acest stil (Janet/Damian) este potrivit acum?”.

# PRIORITATE MAXIMĂ:
Empatie, validare, claritate, ghidare reflexivă, adaptabilitate la nevoile utilizatorului. Menține un spațiu sigur și transformator. Utilizează contextul conversației curente și REZUMATUL FIȘELOR ANTERIOARE.

Context din ultimele introspecții (fișe/jurnal) completate de utilizator:
{{INITIAL_CONTEXT_SUMMARY_PLACEHOLDER}}---`;


    const jurnalPromptsList = [ /* ... Lista ta de prompturi (neschimbată) ... */
            {
                label: "🌡️ Explorează o emoție", id: "explorare_emotie",
                text: "🌡️ *Astăzi simt...*\nNumește emoția dominantă: ________________\n\n🔍 *Unde o simt în corp?*\nDescrie senzațiile (tensiune, greutate, pulsație etc.): ________________\n\n💭 *Ce gânduri vin cu această emoție?*\nNotează gândurile automate, chiar dacă par „exagerate”: ________________\n\n📚 *În ce context a apărut?*\nCe s-a întâmplat exact? Ce a declanșat-o? ________________\n\n💧 *Ce nevoie ar putea semnala?*\nDe ce are nevoie această parte din tine? Ce lipsește? ________________\n\n💌 *Dacă aș avea compasiune pentru mine acum...*\nCe mi-aș spune? Ce gest aș face pentru mine? ________________\n"
            },
            {
                label: "📝 Analizează o situație", id: "analiza_situatie",
                text: "Situația care mă preocupă este: ________________\n\nCe s-a întâmplat exact? (Fapte): ________________\nInterpretarea mea inițială (Gânduri automate): ________________\nEmoțiile principale: ________________\nO altă perspectivă (Reframing): ________________\nCe am învățat/pot învăța? (Lecții): ________________\n"
            },
            {
                label: "🗣️ Dialog Voce Critică", id: "dialog_voce_critica",
                text: "🗣️ *Vocea mea interioară îmi spune...*\n(\"Ești slab\", \"Nu faci destul\", \"O să fii respins\"...): ________________\n\n😔 *Când aud acest mesaj, mă simt...*\n(emoții și senzații fizice): ________________\n\n🧒 *Această voce seamănă cu...*\n(E o voce veche? un părinte? un profesor? un fost partener?): ________________\n\n🧠 *Ce nevoie neîmplinită e în spatele acestui mesaj?*\n(Poate recunoaștere, protecție, control, apartenență?): ________________\n\n🧘 *Răspunsul meu ca Adult Sănătos ar fi...*\n(\"Apreciez că vrei să mă protejezi, dar acum aleg altceva.\"): ________________\n"
            },
            {
                label: "💖 Recunoștință & Resurse", id: "recunostinta_resurse",
                text: "💖 *Astăzi aleg să văd ce e bun...*\nSunt recunoscător/oare pentru:\n1. ________________\n2. ________________\n3. ________________\n\n🌱 *O resursă interioară pe care mă pot baza astăzi este...*\n(ex: curaj, blândețe, claritate, capacitatea de a simți): ________________\n\n🛁 *Un gest de auto-îngrijire pe care îl pot face azi...*\n(chiar dacă e mic): ________________\n"
            },
            {
                label: "🌀 Ritual Reconstrucție Interioară", id: "ritual_reconstructie",
                text: `🧭 MASTER TEMPLATE – Scriere Terapeutică de Integrare și Vindecare\nDenumire: „Ritual de reconstrucție interioară”\nScop: Eliberare, Clarificare, Conținere, Înțelepciune, Direcție\n\nI. 🔍 INVITAȚIE LA AUTENTICITATE\n„Ce parte din mine cere atenție acum?”\n   * Ce trăiesc cu adevărat, fără filtru, fără poveste cosmetizată?\n   * Ce mi-e rușine să simt sau să recunosc chiar și în scris?\n   * Ce parte din mine se simte exclusă, neauzită, ignorată?\nRăspuns: ________________\n\nII. 🌊 CONTAINERE EMOȚIONALE\n„Ce simte corpul meu? Unde locuiește durerea?”\n   * Unde simt emoția în corp? Cum se manifestă? (Tensiune, înțepături, etc.)\n   * Dacă ar avea o culoare, formă, textură – cum ar arăta?\n   * Pot respira în acea zonă 3 minute, fără să fug?\nRăspuns: ________________\n\nIII. 🧠 DECODIFICARE NARATIVĂ\n„Ce poveste îmi spun? Este întreagă?”\n   * Ce narațiune inconștientă guvernează trăirea mea? (ex: „Nu sunt dorit.”)\n   * De unde vine această narațiune? Când am mai trăit ceva similar?\n   * Ce parte din mine (copil rănit, etc.) scrie această poveste?\nRăspuns: ________________\n\nIV. 🧩 INTEGRARE EXPLICATIVĂ\n„Ce înțeleg nou despre mine din această durere?”\n   * Ce nevoi profunde au fost ignorate sau negate?\n   * Ce am protejat, de fapt, prin reacția mea?\n   * Ce emoții contradictorii coexistă în mine și ce spun ele?\nRăspuns: ________________\n\nV. 🪞 COMPASIUNE ȘI BLÂNDEȚE\n„Cum pot fi părinte pentru mine acum?”\n   * Dacă mi-aș ține partea rănită în brațe, ce i-aș spune?\n   * Ce aș vrea să aud din partea unei figuri ideale de susținere?\n   * Pot lăsa iubirea, nu logica, să conducă acest moment?\nRăspuns: ________________\n\nVI. 🔮 RECONFIGURARE IDENTITARĂ\n„Cine sunt eu dincolo de această rană?”\n   * Ce adevăr despre mine rămâne valabil, chiar și în durere?\n   * Cine devin dacă învăț să stau cu mine în acest spațiu?\n   * Dacă aș fi un personaj simbolic acum, cine aș fi?\nRăspuns: ________________\n\nVII. ✍️ ACTUL SACRU DE ALEGERE\n„Ce aleg de azi, pentru mine?”\n   * Ce merită să las să plece?\n   * Ce îmi iau ca învățătură de încredere în viață?\n   * Ce ritual zilnic/mic obicei pot începe pentru a onora această transformare?\nRăspuns: ________________\n\nVIII. (Opțional) 📜 SCRISOARE-RITUAL\nScrie o scrisoare către... (persoana, partea din tine, situația):\nRăspuns: ________________\n`
            }
    ];

    // --- FUNCȚII UTILITARE ȘI DE UI ---
    // ... (showTab, updateFisaProgressBar, fisaNextStep, etc. rămân la fel) ...
    // ... (salveazaIntrospectieFisa, salveazaIntrospectieJurnal, etc. rămân la fel) ...
    // ... (callGeminiAPI, buildAdaptiveAIPromptFisa, buildAdaptiveAIPromptJurnal, etc. rămân la fel) ...
    // ... (genereazaFeedbackPentruIntrospectie, incarcaToateIntrospectiile, etc. rămân la fel) ...

    function formatStreamingMessage(message) {
        console.log("[FORMAT_STREAM] Formatare mesaj (primele 50 char):", message?.substring(0, 50));
        if (typeof message !== 'string' || !message) return "";
        let htmlContent = message
            .replace(/&/g, "&amp;") // Escape & first
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");

        htmlContent = htmlContent
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/__(.*?)__/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/_(.*?)_/g, '<em>$1</em>')
            .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre class="code-block-chat">${p1.trim()}</pre>`) // Text in pre is already escaped
            .replace(/`([^`]+)`/g, '<code class="inline-code-chat">$1</code>');
        htmlContent = htmlContent.replace(/^#{1,6}\s+(.*)/gm, (match, p1) => `<h6>${p1.trim()}</h6>`);

        const lines = htmlContent.split('\n');
        let inList = false; let listType = ''; let processedHtml = "";
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i]; const trimmedLine = line.trim();
            let currentListType = ''; let listItemContent = '';
            const isBlock = line.startsWith("<pre") || line.startsWith("<h") || line.startsWith("<ul") || line.startsWith("<ol") || line.startsWith("</ul") || line.startsWith("</ol") || line.startsWith("<li") || line.startsWith("<p");

            if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ') || trimmedLine.startsWith('+ ')) {
                currentListType = 'ul';
                listItemContent = trimmedLine.substring(trimmedLine.indexOf(' ') + 1);
            } else if (trimmedLine.match(/^\d+\.\s+/)) {
                currentListType = 'ol';
                listItemContent = trimmedLine.substring(trimmedLine.indexOf('.') + 2);
            }

            if (currentListType) {
                if (!inList || listType !== currentListType) {
                    if (inList) processedHtml += `</${listType}>\n`;
                    processedHtml += `<${currentListType}>\n`;
                    inList = true; listType = currentListType;
                }
                processedHtml += `  <li>${listItemContent}</li>\n`; // listItemContent already escaped
            } else {
                if (inList) {
                    processedHtml += `</${listType}>\n`;
                    inList = false; listType = '';
                }
                if (line.trim() !== "" && !isBlock) {
                    processedHtml += `<p>${line}</p>\n`; // line already escaped
                } else if (line.trim() !== "") {
                     processedHtml += line + '\n'; // line already escaped
                }
            }
        }
        if (inList) { processedHtml += `</${listType}>\n`; }
        return processedHtml.replace(/<p><\/p>/g, '');
    }

    function displayChatMessage(messageContent, role, thoughtsContent = null) {
        console.log(`[DISPLAY_CHAT] Afișare mesaj. Rol: ${role}, Conținut (primele 50): '${messageContent?.substring(0, 50)}...', Thoughts: ${thoughtsContent ? 'DA' : 'NU'}`);
        const messagesDiv = messagesDivGlobalRef;
        if (!messagesDiv) {
            console.error("[DISPLAY_CHAT] EROARE: messagesDivGlobalRef nu este definit!");
            return;
        }

        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");
        messageElement.style.whiteSpace = "pre-wrap";

        let messageClass = "";
        if (role === "user") messageClass = "user-message";
        else if (role === "AI-error" || (typeof messageContent === 'string' && messageContent.toUpperCase().startsWith("EROARE"))) messageClass = "ai-message ai-error";
        else messageClass = "ai-message";
        messageClass.split(' ').forEach(cls => messageElement.classList.add(cls));

        if ((role === "AI" || role === "model") && thoughtsContent && thoughtsContent.trim() !== "") {
            console.log("[DISPLAY_CHAT] Adăugare 'thoughts' la elementul mesajului pentru rol:", role);
            const thoughtsDetails = document.createElement("details");
            thoughtsDetails.className = "ai-thoughts-details";
            thoughtsDetails.innerHTML = `
                <summary>Procesul de gândire al PsihoGPT ${role === "model" ? "(live)" : "(istoric)"}</summary>
                <pre class="ai-thoughts-content">${thoughtsContent.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>
            `;
            messageElement.appendChild(thoughtsDetails);
        }

        const mainContentContainer = document.createElement('div');
        mainContentContainer.className = 'main-answer-text';
        if (role === "user") {
            mainContentContainer.textContent = messageContent; // TextContent e sigur pentru input user
        } else {
            mainContentContainer.innerHTML = formatStreamingMessage(messageContent); // AI content e formatat
        }
        messageElement.appendChild(mainContentContainer);

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function loadChatHistory(userId) {
        console.log("[CHAT_HISTORY] Încărcare istoric chat pentru user ID:", userId);
        if (!userId) return [];
        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        try {
            const docSnap = await getDoc(historyDocRef);
            if (docSnap.exists() && docSnap.data().messages && Array.isArray(docSnap.data().messages)) {
                const messages = docSnap.data().messages.sort((a, b) =>
                    (a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp).getTime() || 0) -
                    (b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp).getTime() || 0)
                );
                console.log("[CHAT_HISTORY] Istoric chat încărcat, mesaje:", messages.length);
                return messages;
            }
            console.log("[CHAT_HISTORY] Niciun istoric chat găsit.");
            return [];
        } catch (error) { console.error("[CHAT_HISTORY] Eroare încărcare istoric chat:", error); return []; }
    }

    async function saveChatMessage(userId, messageObject) {
        console.log("[SAVE_CHAT] Salvare mesaj chat. Rol:", messageObject.role, "Conținut (primele 30):", messageObject.content?.substring(0, 30));
        // ... (restul logicii de salvare)
        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        const saveData = { ...messageObject };
        if (saveData.timestamp && !(saveData.timestamp instanceof Timestamp)) {
            saveData.timestamp = Timestamp.fromDate(new Date(saveData.timestamp));
        }
        if (saveData.thoughts && saveData.thoughts.trim() === "") {
            saveData.thoughts = null;
        }
        try {
            const docSnap = await getDoc(historyDocRef);
            if (docSnap.exists()) {
                await updateDoc(historyDocRef, { messages: arrayUnion(saveData) });
            } else {
                await setDoc(historyDocRef, { messages: [saveData] });
            }
            console.log("[SAVE_CHAT] Mesaj chat salvat cu succes.");
        } catch (error) { console.error("[SAVE_CHAT] Eroare salvare mesaj chat în Firestore:", error); }

    }

    async function getInitialContextSummary(userIdForContext) {
        console.log("[CONTEXT_SUMMARY] Generare sumar introspecții pentru:", userIdForContext);
        let contextSummary = "REZUMAT DIN INTROSPECȚIILE ANTERIOARE (ULTIMELE 3):\n";
        if (!userIdForContext) {
            contextSummary += "Niciun utilizator specificat pentru context.\n";
            console.log("[CONTEXT_SUMMARY] Sumar final (fără user ID):", contextSummary.substring(0,100) + "...");
            return contextSummary;
        }
        try {
            const q = query(collection(db, "introspectii"), where("ownerUid", "==", userIdForContext), orderBy("timestampCreare", "desc"), limit(3));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const entryDate = data.dateAfisare || (data.timestampCreare ? new Date(data.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'N/A');
                    if (data.type === 'fisa') {
                        contextSummary += ` - Fișă (${entryDate}): Situatia - ${(data.continut.situatie || "N/A").substring(0, 50)}... Ganduri - ${(data.continut.ganduri || "N/A").substring(0,50)}...\n`;
                    } else if (data.type === 'jurnal') {
                        contextSummary += ` - Jurnal (${entryDate}): Titlu - ${(data.continut.titluJurnal || "Fără titlu").substring(0,50)}... Text (primele cuvinte) - ${(data.continut.textJurnal || "N/A").substring(0,50)}...\n`;
                    }
                });
            } else {
                contextSummary += "Nicio introspecție recentă găsită.\n";
            }
        } catch (e) {
            console.error("[CONTEXT_SUMMARY] Eroare încărcare context introspecții:", e);
            contextSummary += "Eroare la încărcarea contextului introspecțiilor.\n";
        }
        console.log("[CONTEXT_SUMMARY] Sumar final (primele 100 char):", contextSummary.substring(0,100) + "...");
        return contextSummary;
    }


    async function initializeAndStartChatSession(userId) {
        console.log("[CHAT_INIT] Inițializare COMPLETĂ sesiune chat pentru user ID:", userId);
        const chatStatus = document.getElementById("chatStatus");
        const sendButton = document.getElementById("sendChatMessageButton");

        if (sendButton) sendButton.disabled = true;
        if (chatStatus) chatStatus.textContent = "Inițializare chat AI...";
        if (!geminiModelChat) {
             console.error("[CHAT_INIT] Modelul AI Chat (geminiModelChat) nu este disponibil!");
             if (chatStatus) chatStatus.textContent = "EROARE: Model AI Chat indisponibil.";
             displayChatMessage("Serviciul de chat AI nu este disponibil (model neinițializat).", "AI-error", null);
             return null;
        }
        isChatInitialized = false;
        chatSession = null;

        const dynamicContextSummary = await getInitialContextSummary(userId);
        const completeSystemInstruction = FULL_SYSTEM_INSTRUCTION_TEXT_TEMPLATE.replace
            ("{{INITIAL_CONTEXT_SUMMARY_PLACEHOLDER}}", dynamicContextSummary);
        console.log("[CHAT_INIT] Prompt sistem COMPLET generat pentru prima inițializare.");

        let historyForGeminiAPI = [];
        if (messagesDivGlobalRef) messagesDivGlobalRef.innerHTML = '';
        let fullLoadedHistoryFromDB = await loadChatHistory(userId);

        if (fullLoadedHistoryFromDB.length > 0) {
            const displayHistory = fullLoadedHistoryFromDB.slice(-MAX_MESSAGES_TO_DISPLAY_ON_LOAD);
            console.log(`[CHAT_INIT] Se afișează în UI ${displayHistory.length} din ${fullLoadedHistoryFromDB.length} mesaje.`);
            displayHistory.forEach(msg => {
                const roleForDisplay = (msg.role === "AI" || msg.role === "model") ? "model" : "user";
                displayChatMessage(msg.content, roleForDisplay, msg.thoughts);
            });

            // Trunchiere pentru API (ultimele MAX_CHAT_HISTORY_FOR_API mesaje din istoricul complet)
            const startIndexForApi = Math.max(0, fullLoadedHistoryFromDB.length - MAX_CHAT_HISTORY_FOR_API);
            const truncatedHistoryForApi = fullLoadedHistoryFromDB.slice(startIndexForApi);
             console.log(`[CHAT_INIT] Istoric trunchiat pentru API la prima inițializare: ${truncatedHistoryForApi.length}.`);
            truncatedHistoryForApi.forEach(msg => {
                if (msg.content && msg.content.trim() !== "") {
                    historyForGeminiAPI.push({
                        role: (msg.role === "AI" || msg.role === "model") ? "model" : "user",
                        parts: [{ text: msg.content }]
                    });
                }
            });
        }
        console.log("[CHAT_INIT] Istoric formatat pentru API (după trunchiere inițială):", historyForGeminiAPI.length, "mesaje.");

        try {
            const chatConfig = {
                history: [
                    { role: "user", parts: [{ text: completeSystemInstruction }] },
                    ...historyForGeminiAPI
                ],
                generationConfig: {
                    temperature: 0.75,
                    thinking_config: { include_thoughts: true }
                }
            };
            chatSession = geminiModelChat.startChat(chatConfig);
            console.log("[CHAT_INIT] Sesiune chat inițializată CU prompt sistem COMPLET și istoric trunchiat. Model:", GEMINI_MODEL_NAME_CHAT);

            if (chatStatus) chatStatus.textContent = "Janet - Psihoterapeut Cognitiv-Comportamental Integrativ";

            if (fullLoadedHistoryFromDB.length === 0) {
                console.log("[CHAT_INIT_GREETING] Niciun istoric, se trimite salutul AI.");
                const aiGreeting = "Salut! Eu sunt PsihoGPT. Cum te simți astăzi și despre ce ai dori să reflectăm împreună? ✨";
                const firstAiResponseResult = await chatSession.sendMessageStream("Salut!");
                const firstAiResponseStream = firstAiResponseResult.stream;
                let firstAiText = ""; let firstAiThoughts = ""; let receivedGreetingText = false;
                const firstAiMessageElement = document.createElement("div");
                firstAiMessageElement.classList.add("chat-message", "ai-message");
                firstAiMessageElement.style.whiteSpace = "pre-wrap";

                const mainAnswerSpanGreeting = document.createElement('span'); // Span pentru textul principal al salutului
                mainAnswerSpanGreeting.className = 'main-answer-text';
                firstAiMessageElement.appendChild(mainAnswerSpanGreeting); // Adaugă span-ul la elementul principal

                if (messagesDivGlobalRef) messagesDivGlobalRef.appendChild(firstAiMessageElement);

                for await (const chunk of firstAiResponseStream) {
                    const candidate = chunk.candidates?.[0];
                    if (candidate?.content?.parts) {
                        for (const part of candidate.content.parts) {
                            if (part && typeof part.text === 'string') {
                                if (part.thought === true) {
                                    firstAiThoughts += part.text + "\n";
                                } else {
                                    firstAiText += part.text;
                                    mainAnswerSpanGreeting.innerHTML = formatStreamingMessage(firstAiText); // Typewriter simplu pentru salut
                                    if (part.text.trim() !== "") receivedGreetingText = true;
                                }
                            }
                        }
                    }
                    if (messagesDivGlobalRef) messagesDivGlobalRef.scrollTop = messagesDivGlobalRef.scrollHeight;
                    if (candidate?.finishReason) break;
                }
                if (!receivedGreetingText && firstAiText.trim() === "") firstAiText = aiGreeting;
                mainAnswerSpanGreeting.innerHTML = formatStreamingMessage(firstAiText); // Asigură formatarea finală

                if (firstAiThoughts.trim() !== "") {
                    const thoughtsDetails = document.createElement("details");
                    thoughtsDetails.className = "ai-thoughts-details";
                    thoughtsDetails.innerHTML = `<summary>Proces de gândire (Salut)</summary><pre class="ai-thoughts-content">${firstAiThoughts.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`;
                    firstAiMessageElement.insertBefore(thoughtsDetails, mainAnswerSpanGreeting);
                }
                if (messagesDivGlobalRef) messagesDivGlobalRef.scrollTop = messagesDivGlobalRef.scrollHeight;

                await saveChatMessage(userId, { role: "model", content: firstAiText, thoughts: firstAiThoughts.trim() || null, error: false, timestamp: new Date().toISOString() });
                console.log("[CHAT_INIT_GREETING] Salut AI salvat.");
            }
            isChatInitialized = true;
            if (sendButton) sendButton.disabled = false;
            console.log("[CHAT_INIT] Sesiune chat AI inițializată și gata.");

        } catch(initError) {
            console.error("[CHAT_INIT] Eroare MAJORĂ la inițializarea sesiunii de chat:", initError, initError.stack);
            if (chatStatus) chatStatus.textContent = "Eroare critică AI Chat.";
            displayChatMessage(`Problemă tehnică gravă la pornirea chat-ului: ${initError.message}. Verificați consola.`, "AI-error", null);
            isChatInitialized = false; chatSession = null;
            if (sendButton) sendButton.disabled = true;
            return null;
        }
        return chatSession;
    }


    async function handleSendChatMessage() {
        console.log("handleSendChatMessage: Funcție apelată.");
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatStatus = document.getElementById("chatStatus");
        const messagesDiv = messagesDivGlobalRef;

        if (!chatInput || !sendButton || !chatStatus || !messagesDiv) {
            console.error("[HANDLE_SEND] Eroare critică - Elemente HTML esențiale lipsesc.");
            return;
        }

        const messageText = chatInput.value.trim();
        console.log("→ [USER_MSG_SEND] Mesaj utilizator pentru trimitere:", JSON.stringify(messageText));
        if (!messageText) {
            console.log("→ [USER_MSG_SEND] Mesaj utilizator gol, nu se procesează.");
            return;
        }

        displayChatMessage(messageText, "user", null);

        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.error("‼️ [AUTH_ERROR] Utilizatorul nu este autentificat.");
            if (chatStatus) chatStatus.textContent = "Eroare: utilizator neautentificat.";
            return;
        }

        try {
            await saveChatMessage(currentUser.uid, {
                role: "user",
                content: messageText,
                timestamp: new Date().toISOString()
            });
            console.log("→ [DB_SAVE_USER] Mesajul utilizatorului a fost salvat în Firestore.");
        } catch (firestoreErr) {
            console.error("‼️ [DB_ERROR] Eroare la salvarea mesajului utilizatorului în Firestore:", firestoreErr);
            if (chatStatus) chatStatus.textContent = "Eroare salvare mesaj utilizator.";
        }

        chatInput.value = "";
        sendButton.disabled = true;
        if (chatStatus) chatStatus.textContent = "PsihoGPT analizează și tastează...";

        const aiMessageElement = document.createElement("div");
        aiMessageElement.classList.add("chat-message", "ai-message");
        aiMessageElement.style.whiteSpace = "pre-wrap";
        messagesDiv.appendChild(aiMessageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        let fullAiResponseText = "";
        let collectedThoughtsThisTurn = "";
        let anErrorOccurredInStream = false;
        let apiErrorMessageFromStream = "";

        const TYPING_CHUNK_SIZE = IS_MOBILE_DEVICE ? 50 : 30;
        const TYPING_CHUNK_DELAY_MS = IS_MOBILE_DEVICE ? 30 : 20;
        console.log(`[TYPEWRITER_CONFIG] Mobil: ${IS_MOBILE_DEVICE}, ChunkSize: ${TYPING_CHUNK_SIZE}, Delay: ${TYPING_CHUNK_DELAY_MS}`);

        try {
            console.log("[CHAT_SESSION_REINIT] Se pregătește re-inițializarea sesiunii pentru noul mesaj.");
            let currentFullHistoryFromDB = await loadChatHistory(currentUser.uid);
            console.log(`[CHAT_SESSION_REINIT] Istoric complet din DB: ${currentFullHistoryFromDB.length} mesaje.`);

            let historyForNewApiSession = [];
            if (currentFullHistoryFromDB.length > 0) {
                const historyBeforeCurrentMessage = currentFullHistoryFromDB.slice(0, -1);
                const startIndex = Math.max(0, historyBeforeCurrentMessage.length - MAX_CHAT_HISTORY_FOR_API);
                const truncatedHistory = historyBeforeCurrentMessage.slice(startIndex);
                console.log(`[CHAT_SESSION_REINIT] Istoric trunchiat la ${truncatedHistory.length} mesaje pentru context API.`);
                truncatedHistory.forEach(msg => {
                    if (msg.content && msg.content.trim() !== "") {
                        historyForNewApiSession.push({
                            role: (msg.role === "AI" || msg.role === "model") ? "model" : "user",
                            parts: [{ text: msg.content }]
                        });
                    }
                });
            }
            console.log(`[CHAT_SESSION_REINIT] Istoric final formatat pentru API: ${historyForNewApiSession.length} mesaje.`);

            const dynamicContextSummaryForSend = await getInitialContextSummary(currentUser.uid); // Obține contextul actualizat
            const currentSystemInstruction = FULL_SYSTEM_INSTRUCTION_TEXT_TEMPLATE.replace(
                "{{INITIAL_CONTEXT_SUMMARY_PLACEHOLDER}}",
                dynamicContextSummaryForSend
            );
            console.log("[CHAT_SESSION_REINIT] Prompt sistem REGENERAT pentru acest call.");


            const systemInstructionObject = { role: "user", parts: [{ text: currentSystemInstruction }] };

            const newChatConfig = {
                history: [
                    systemInstructionObject,
                    ...historyForNewApiSession
                ],
                generationConfig: {
                    temperature: 0.75,
                    thinking_config: { include_thoughts: true }
                }
            };

            if (!geminiModelChat) throw new Error("geminiModelChat nu este definit pentru re-inițializare în handleSendChatMessage.");
            chatSession = geminiModelChat.startChat(newChatConfig);
            isChatInitialized = true; // S-ar putea să fie deja true, dar reconfirmăm
            console.log("[CHAT_SESSION_REINIT] Sesiune chat re-inițializată cu istoric trunchiat și mesaj sistem (din handleSend).");

            console.log("→ [AI_STREAM] Trimitere mesaj la sendMessageStream:", JSON.stringify(messageText));
            const result = await chatSession.sendMessageStream(messageText);
            const stream = result.stream;
            console.log("→ [AI_STREAM] Stream primit. Începem procesarea chunk-urilor.");

            for await (const chunk of stream) {
                console.log("╔══════════ CHUNK (handleSend) ══════════╗");
                console.log(JSON.stringify(chunk, null, 2).substring(0, 500) + "...");
                console.log("╚══════════════════════════════════════╝");

                if (chunk.promptFeedback?.blockReason) {
                    apiErrorMessageFromStream = `Mesaj/Răspuns blocat (Motiv Prompt: ${chunk.promptFeedback.blockReason}). Detalii: ${JSON.stringify(chunk.promptFeedback.blockReasonDetail || 'N/A')}`;
                    anErrorOccurredInStream = true;
                    console.warn("[AI_STREAM] Stream blocat (promptFeedback):", apiErrorMessageFromStream);
                    break;
                }
                const candidate = chunk.candidates?.[0];
                if (!candidate) {
                    console.warn("  [AI_STREAM_CHUNK] Candidate inexistent. Se continuă.");
                    continue;
                }

                if (candidate.content?.parts && Array.isArray(candidate.content.parts)) {
                    for (const part of candidate.content.parts) {
                        if (part && typeof part.text === "string") {
                            if (part.thought === true) {
                                console.log("      THOUGHT Part:", JSON.stringify(part.text.substring(0, 50) + "..."));
                                collectedThoughtsThisTurn += part.text + "\n";
                            } else {
                                console.log("      MAIN ANSWER Part:", JSON.stringify(part.text.substring(0, 50) + "..."));
                                fullAiResponseText += part.text;
                            }
                        }
                    }
                }

                if (candidate.finishReason) {
                    console.log("  [AI_STREAM_CHUNK] finishReason:", candidate.finishReason);
                    const errorReasons = ["SAFETY", "RECITATION", "OTHER"];
                    if (errorReasons.includes(candidate.finishReason)) {
                        apiErrorMessageFromStream = `Generare oprită (API Motiv: ${candidate.finishReason}). Detalii: ${JSON.stringify(candidate.safetyRatings || 'N/A')}`;
                        anErrorOccurredInStream = true;
                        console.error("  [AI_STREAM_CHUNK] finishReason problematic:", apiErrorMessageFromStream);
                    }
                    break;
                }
                if (anErrorOccurredInStream) break;
            }
            console.log("[AI_STREAM] Bucla principală a stream-ului s-a încheiat.");

            aiMessageElement.innerHTML = '';
            let mainAnswerSpan = document.createElement('span');
            mainAnswerSpan.className = 'main-answer-text';

            if (anErrorOccurredInStream) {
                const finalErrorMessage = apiErrorMessageFromStream || "Eroare generare răspuns.";
                aiMessageElement.innerHTML = formatStreamingMessage(finalErrorMessage);
                aiMessageElement.classList.add("ai-error");
                fullAiResponseText = finalErrorMessage;
                console.warn("[AI_DISPLAY] Eroare din stream afișată:", finalErrorMessage);
            } else {
                if (collectedThoughtsThisTurn.trim() !== "") {
                    const thoughtsDetails = document.createElement("details");
                    thoughtsDetails.className = "ai-thoughts-details";
                    thoughtsDetails.innerHTML = `<summary>Procesul de gândire...</summary><pre class="ai-thoughts-content">${collectedThoughtsThisTurn.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}</pre>`;
                    aiMessageElement.appendChild(thoughtsDetails);
                    await new Promise(resolve => setTimeout(resolve, IS_MOBILE_DEVICE ? 50 : 20));
                    console.log("[AI_DISPLAY] Gânduri adăugate în DOM.");
                }
                aiMessageElement.appendChild(mainAnswerSpan);

                if (fullAiResponseText.trim() !== "") {
                    let formattedHTML = formatStreamingMessage(fullAiResponseText);
                    console.log("[AI_DISPLAY] Text principal pre-formatat. Lungime HTML:", formattedHTML.length);
                    let currentIndex = 0;
                    while (currentIndex < formattedHTML.length) {
                        const nextChunkEnd = Math.min(currentIndex + TYPING_CHUNK_SIZE, formattedHTML.length);
                        mainAnswerSpan.innerHTML = formattedHTML.substring(0, nextChunkEnd);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        await new Promise(resolve => setTimeout(resolve, TYPING_CHUNK_DELAY_MS));
                        currentIndex = nextChunkEnd;
                    }
                    mainAnswerSpan.innerHTML = formattedHTML;
                    console.log("[AI_DISPLAY] Efect typewriter finalizat.");
                } else if (!collectedThoughtsThisTurn.trim()) {
                    const fallbackMsg = "Nu am putut genera un răspuns sau a fost gol.";
                    mainAnswerSpan.innerHTML = formatStreamingMessage(fallbackMsg);
                    fullAiResponseText = fallbackMsg;
                    console.log("[AI_DISPLAY] AFIȘAT FALLBACK: Text principal și thoughts goale.");
                }
            }
        } catch (err) {
            const criticalErrorMsg = `Eroare CRITICĂ în handleSendChatMessage: ${err.message}`;
            console.error("‼️ [CRITICAL_ERROR_HSM] Catch principal:", err, criticalErrorMsg);
            aiMessageElement.innerHTML = formatStreamingMessage(criticalErrorMsg);
            aiMessageElement.classList.add("ai-error");
            fullAiResponseText = criticalErrorMsg;
            anErrorOccurredInStream = true;
        } finally {
            console.log("------------------------------------------------------");
            console.log("[FINALLY_HSM] Bloc finally atins.");
            console.log("  Final fullAiResponseText:", JSON.stringify(fullAiResponseText.substring(0,100) + "..."));
            console.log("  Final collectedThoughtsThisTurn:", JSON.stringify(collectedThoughtsThisTurn.substring(0,100) + "..."));
            console.log("  Final anErrorOccurredInStream:", anErrorOccurredInStream);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (currentUser) {
                try {
                    await saveChatMessage(currentUser.uid, {
                        role: "model",
                        content: fullAiResponseText.trim(),
                        thoughts: collectedThoughtsThisTurn.trim() || null,
                        error: anErrorOccurredInStream,
                        timestamp: new Date().toISOString()
                    });
                    console.log("→ [DB_SAVE_MODEL_HSM] Răspuns/Eroare AI salvat(ă).");
                } catch (firestoreSaveErr) {
                    console.error("‼️ [DB_ERROR] Eroare salvare răspuns model (finally):", firestoreSaveErr);
                    if(chatStatus) chatStatus.textContent = "Eroare salvare răspuns AI.";
                 }
            }

            if (chatStatus) {
                if (anErrorOccurredInStream || fullAiResponseText.toLowerCase().includes("eroare")) {
                    chatStatus.textContent = "Eroare comunicare AI.";
                } else if (fullAiResponseText.trim() === "" && collectedThoughtsThisTurn.trim() === "") {
                    chatStatus.textContent = "Problemă generare răspuns.";
                } else {
                    chatStatus.textContent = "Janet - Psihoterapeut Cognitiv-Comportamental Integrativ";
                }
            }

            if (geminiModelChat && isChatInitialized && sendButton) {
                sendButton.disabled = false;
            } else if (sendButton) {
                sendButton.disabled = true;
                if (chatStatus && (!isChatInitialized || !geminiModelChat)) {
                     chatStatus.textContent = "Chat AI indisponibil.";
                }
            }
            if (chatInput) chatInput.focus();
            console.log("[FINALLY_HSM] Execuție handleSendChatMessage completă.");
        }
    }


    async function handleToggleChat() {
        console.log("[UI_CHAT_TOGGLE] Apel handleToggleChat.");
        // ... (la fel ca înainte)
        const user = auth.currentUser;
        if (!user) {
            alert("Autentificare necesară pentru a folosi chat-ul.");
            window.location.href = "login.html";
            return;
        }

        const chatContainer = document.getElementById("chatContainer");
        const originalToggleButton = document.getElementById("toggleChatButton");
        const minimizeButtonInHeader = document.getElementById("minimizeChatButton"); // Asigură-te că există
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatInput = document.getElementById("chatInput");

        if (!chatContainer || !originalToggleButton || !minimizeButtonInHeader) {
            console.error("[UI_CHAT_TOGGLE] Eroare: Unul sau mai multe elemente HTML esențiale pentru chat nu au fost găsite!");
            return;
        }

        const isChatCurrentlyOpen = chatContainer.style.display === "flex";
        console.log("[UI_CHAT_TOGGLE] Stare chat curentă (deschis):", isChatCurrentlyOpen);


        if (isChatCurrentlyOpen) {
            chatContainer.style.display = "none";
            originalToggleButton.style.display = 'flex';
            originalToggleButton.innerHTML = "💬";
            console.log("[UI_CHAT_TOGGLE] Chat închis.");
        } else {
            chatContainer.style.display = "flex";
            originalToggleButton.style.display = 'none';
            console.log("[UI_CHAT_TOGGLE] Chat deschis. Se verifică inițializarea sesiunii...");


            if (!isChatInitialized || !chatSession) {
                console.log("[UI_CHAT_TOGGLE] Sesiune neinițializată, se apelează initializeAndStartChatSession.");
                const sessionOK = await initializeAndStartChatSession(user.uid);
                if (sendButton) sendButton.disabled = !sessionOK;
                 console.log("[UI_CHAT_TOGGLE] Rezultat inițializare sesiune:", sessionOK);
            } else if (sendButton && geminiModelChat) {
                sendButton.disabled = false; // Chatul era deja inițializat, reactivăm butonul
                console.log("[UI_CHAT_TOGGLE] Sesiune deja inițializată, buton send activat.");
            } else if (sendButton) { // Model AI indisponibil
                sendButton.disabled = true;
                console.warn("[UI_CHAT_TOGGLE] Model AI indisponibil, buton send dezactivat.");
            }

            if (chatInput) {
                chatInput.focus();
            }
        }
    }

      async function discussFisaWithChat(fisaData) {
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesară."); window.location.href = "login.html"; return; }
        const chatContainer = document.getElementById("chatContainer");
        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            await handleToggleChat();
        }
        if (!chatSession || !isChatInitialized) {
            displayChatMessage("Eroare: Sesiunea de chat nu e pregătită.", "AI-error"); return;
        }
        const c = fisaData.continut;
        let message = `Salut PsihoGPT,\n\nAș dori să discutăm despre următoarea fișă de monitorizare (datată ${fisaData.dateAfisare || 'N/A'}):\n\n`;
        message += `**Situația:** ${c.situatie || 'N/A'}\n**Gânduri automate:** ${c.ganduri || 'N/A'}\n**Emoții:** ${c.emotii || 'N/A'}\n`;
        message += `**Mod activ:** ${c.mod_activ || 'N/A'}\n**Comportament:** ${c.comportament || 'N/A'}\n**Nevoile profunde:** ${c.nevoi_profunde || 'N/A'}\n`;
        message += `**Ajută comportamentul?:** ${c.ajutor_comportament || 'N/A'}\n**Adult Sănătos (perspectivă):** ${c.adult_sanatos || 'N/A'}\n\n`;
        message += "**Analiza gândurilor:**\n";
        message += `  *Dovezi adevăr:* ${c.dovezi_adevar || 'N/A'}\n  *Dovezi fals:* ${c.dovezi_fals || 'N/A'}\n`;
        message += `  *Expl. alt.:* ${c.explicatie_alternativa || 'N/A'}\n  *Cel mai rău:* ${c.scenariu_negativ || 'N/A'}\n`;
        message += `  *Cel mai bun:* ${c.scenariu_optimist || 'N/A'}\n  *Realist:* ${c.rezultat_realist || 'N/A'}\n`;
        message += `  *Schimbare gândire:* ${c.schimbare_gandire || 'N/A'}\n  *Sfat prieten:* ${c.sfat_prieten || 'N/A'}\n\n`;
        message += "**Clarificări:**\n";
        message += `  *Partea rea?:* ${c.partea_rea || 'N/A'}\n  *Responsabilitate excesivă?:* ${c.responsabilitate || 'N/A'}\n`;
        message += `  *Condamnare eveniment unic?:* ${c.condamnare || 'N/A'}\n  *Termeni extremi?:* ${c.termeni_extremi || 'N/A'}\n`;
        message += `  *Exagerare?:* ${c.exagerare || 'N/A'}\n  *Alți factori?:* ${c.factori_responsabili || 'N/A'}\n`;
        message += `  *Concluzii pripite?:* ${c.concluzii || 'N/A'}\n  *Întrebări fără răspuns?:* ${c.intrebari_fara_raspuns || 'N/A'}\n`;
        message += `  *Focus pe slăbiciuni?:* ${c.slabiciuni || 'N/A'}\n  *Cum ar trebui?:* ${c.cum_ar_trebui || 'N/A'}\n`;
        message += `  *Perfecționism?:* ${c.perfectiune || 'N/A'}\n\n`;
        message += "Ce întrebări sau reflecții ai pentru mine pe baza acestei fișe?";
        const chatInput = document.getElementById("chatInput");
        if(chatInput) {
            chatInput.value = message;
            handleSendChatMessage();
        }
    }
    

    // --- FUNCȚIA PRINCIPALĂ DE INTRARE (ONLOAD) ---
    window.onload = function () {
        console.log("DOM complet încărcat. Se inițializează aplicația...");
        messagesDivGlobalRef = document.getElementById("chatMessages"); // Inițializează referința globală
        if (!messagesDivGlobalRef) {
            console.error("CRITICAL: Elementul #chatMessages nu a fost găsit la onload!");
        }


        document.getElementById('tabButtonJurnal').addEventListener('click', () => showTab('jurnal'));
        document.getElementById('tabButtonFisa').addEventListener('click', () => showTab('fisa'));
        showTab('jurnal'); // Afișează tab-ul implicit

        onAuthStateChanged(auth, async (user) => {
            console.log("[AUTH_CHANGE] Starea de autentificare s-a schimbat. User:", user ? user.uid : "NULL");
            currentUserId = user ? user.uid : null;
            const mainContentArea = document.getElementById('mainContentArea');
            const cardsContainerArea = document.getElementById('cardsContainerArea');
            const toggleChatBtn = document.getElementById("toggleChatButton");
            const chatContainer = document.getElementById("chatContainer");
            const chatStatus = document.getElementById("chatStatus"); // Adăugat pentru a reseta statusul

            if (user) {
                console.log(`[AUTH_CHANGE] Utilizator AUTENTIFICAT: ${user.uid}. Se afișează conținutul principal.`);
                if (mainContentArea) mainContentArea.style.display = '';
                if (cardsContainerArea) cardsContainerArea.style.display = '';
                if (toggleChatBtn) toggleChatBtn.style.display = 'flex';

                initializeFisaFormFunctionality();
                initializeJurnalFormFunctionality();

                if (!dataAlreadyLoaded) {
                    await incarcaToateIntrospectiile(user.uid);
                    dataAlreadyLoaded = true;
                }
                // Nu mai inițializăm chat-ul aici; se face la primul toggle sau la 'Discută Fișa'
            } else {
                console.log("[AUTH_CHANGE] Utilizator NEAUTENTIFICAT. Redirecționare către login.html...");
                if (mainContentArea) mainContentArea.style.display = 'none';
                if (cardsContainerArea) cardsContainerArea.style.display = 'none';
                if (toggleChatBtn) toggleChatBtn.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'none'; // Ascunde și containerul chat
                if (chatStatus) chatStatus.textContent = "Chatul AI nu este activ."; // Resetează status

                isChatInitialized = false; // Resetează starea chat-ului
                chatSession = null;
                if (messagesDivGlobalRef) messagesDivGlobalRef.innerHTML = ""; // Golește mesajele din chat la logout

                window.location.href = "login.html";
            }
        });

        document.getElementById("minimizeChatButton")?.addEventListener("click", handleToggleChat);
        document.getElementById("toggleChatButton")?.addEventListener("click", handleToggleChat);
        document.getElementById("sendChatMessageButton")?.addEventListener("click", handleSendChatMessage);
        document.getElementById("chatInput")?.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                console.log("[UI_EVENT] Enter apăsat în chatInput, se trimite mesajul.");
                handleSendChatMessage();
            }
        });
        console.log("Aplicație inițializată și event listeners atașați.");
    };
</script>
    <style>

 /* --- MODERN FRESH STYLES START --- */
:root {
    --font-primary: 'Ubuntu', 'Roboto', 'Montserrat', sans-serif;
    --font-secondary: 'Roboto', sans-serif; /* For body text if needed */

    --color-bg-main: #F8F9FA; /* Off-white, very light gray */
    --color-bg-content: #FFFFFF; /* White for cards, forms */
    --color-bg-alt: #E9ECEF; /* Slightly darker gray for accents, inputs */
    --color-bg-chat-alt: #F1F3F5; /* Background for chat input area and AI messages */

    --color-primary: #4A90E2; /* A vibrant, yet calm blue */
    --color-primary-dark: #3A7BC8;
    --color-primary-light: #EAF2FD;

    --color-secondary: #50E3C2; /* A fresh teal/mint */
    --color-secondary-dark: #38B2AC;

    --color-accent: #F5A623; /* A warm accent, e.g., for warnings or highlights */

    --color-text-dark: #212529; /* Very dark gray, near black */
    --color-text-medium: #495057; /* Medium gray */
    --color-text-light: #6C757D; /* Light gray */
    --color-text-inverted: #FFFFFF;

    --color-success: #28A745;
    --color-success-bg: #E9F7EA;
    --color-error: #DC3545;
    --color-error-bg: #FAE8EA;
    --color-warning: #FFC107;
    --color-warning-bg: #FFF9E6;

    --border-radius-small: 4px;
    --border-radius-medium: 8px;
    --border-radius-large: 16px; /* For chat container, main form sections */

    --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-strong: 0 8px 24px rgba(0,0,0,0.12);

    --spacing-unit: 8px;
}

*, *::before, *::after { box-sizing: border-box; }

body {
    font-family: var(--font-primary);
    margin: 0; padding: calc(var(--spacing-unit) * 3); /* 24px */
    background: var(--color-bg-main);
    color: var(--color-text-medium);
    line-height: 1.65; font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* APP HEADER */
.app-header { text-align: center; margin-bottom: calc(var(--spacing-unit) * 5); /* 40px */ }
.app-header h1 {
    font-size: 2.25em; /* Slightly larger */
    color: var(--color-text-dark);
    margin-bottom: var(--spacing-unit);
    font-weight: 700; /* Bolder */
    letter-spacing: -0.5px;
}
.app-header p { font-size: 1.1em; color: var(--color-text-light); margin-top: 0; font-weight: 300; }

/* TAB NAVIGATION */
.tab-navigation {
    display: flex;
    justify-content: center;
    margin-bottom: calc(var(--spacing-unit) * 4); /* 32px */
    gap: 0; /* Remove gap, use borders for separation */
    border-bottom: 1px solid #dee2e6;
}
.tab-button {
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 3); /* 12px 24px */
    font-size: 1.05em; font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    background: none;
    color: var(--color-text-light);
    cursor: pointer;
    transition: color 0.25s ease, border-color 0.25s ease;
    border-radius: 0; /* Remove individual radius */
    margin-bottom: -1px; /* Overlap border-bottom of nav */
}
.tab-button:hover {
    color: var(--color-primary);
}
.tab-button.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    font-weight: 600;
}

/* TAB CONTENT - active handled by JS */

/* FORM SECTION CONTAINER */
.form-section-container {
    max-width: 760px;
    margin: 0 auto calc(var(--spacing-unit) * 5) auto; /* 40px bottom margin */
    background: var(--color-bg-content);
    padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4.5); /* 32px 36px */
    box-shadow: var(--shadow-medium);
    border-radius: var(--border-radius-large);
    border: 1px solid #e0e0e0; /* Subtle border */
}
.form-section-container h2 {
     font-size: 1.75em; margin-bottom: calc(var(--spacing-unit) * 1.5); /* 12px */
     text-align: center; color: var(--color-text-dark); font-weight: 600;
}
.form-section-container > p:not(.confirmation-message) {
    text-align: center; margin-top: calc(var(--spacing-unit) * -0.5); /* -4px */
    margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */
    font-size: 1em; color: var(--color-text-light); font-weight: 300; max-width: 90%; margin-left: auto; margin-right: auto;
}

/* GENERAL FORM ELEMENTS */
label {
    display:block; margin-bottom: var(--spacing-unit); font-weight: 500;
    color: var(--color-text-medium); font-size: 0.9em;
}
input[type="text"], textarea {
    width: 100%; padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 1.75); /* 12px 14px */
    font-size: 1em; font-family: var(--font-secondary);
    border-radius: var(--border-radius-medium); border: 1px solid #CED4DA; /* Lighter border */
    transition: border-color 0.2s, box-shadow 0.2s;
    background-color: var(--color-bg-content); /* White background */
    color: var(--color-text-dark);
}
input[type="text"]::placeholder, textarea::placeholder {
    color: #adb5bd;
    font-weight: 300;
}
input[type="text"]:focus, textarea:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15); /* Softer focus ring */
    outline: none;
}
textarea {
    resize: vertical; min-height: 100px; line-height: 1.6;
}

/* FIȘĂ FORM */
.progress-bar {
    width: 100%; background-color: var(--color-bg-alt); border-radius: var(--border-radius-small);
    overflow: hidden; margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */ height: 10px; /* Slimmer */
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.07);
}
.progress {
    height: 100%; width: 0; background: linear-gradient(90deg, var(--color-secondary-dark), var(--color-secondary));
    transition: width 0.4s ease; border-radius: var(--border-radius-small);
}
.question-card {
    margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */
    padding: calc(var(--spacing-unit) * 2.5); /* 20px */
    background: #FDFEFF; /* Slightly off-white, lighter than form container */
    border-radius: var(--border-radius-medium);
    border: 1px solid #E7F0F9; /* Very light blueish border */
}
.question-card h3 {
    font-weight: 600; font-size: 1.1em; margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 0.75); /* 6px */
    color: var(--color-primary); /* Primary color for titles */
}
.question-card p {
    font-weight: 400; font-size: 0.95em; margin-bottom: calc(var(--spacing-unit) * 1.5); /* 12px */
    color: var(--color-text-medium); line-height: 1.6;
}
.form-step {display: none;} /* JS handles active */
.form-step-active {display: block; animation: fadeInFormStep 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);}
@keyframes fadeInFormStep { 0% {opacity: 0; transform: translateY(15px);} 100% {opacity: 1; transform: translateY(0);} }

.step-navigation {
    text-align: center; margin-top: calc(var(--spacing-unit) * 3.5); /* 28px */
    display: flex; justify-content: space-between; gap:calc(var(--spacing-unit) * 2); /* 16px */
}
.step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {
    padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 2.5); /* 10px 20px */
    font-family: var(--font-primary); font-size: 0.95em; font-weight: 500;
    color: var(--color-text-inverted); border: none; border-radius: var(--border-radius-medium);
    cursor: pointer; transition: background-color 0.2s, transform 0.15s ease-out, box-shadow 0.2s ease;
    box-shadow: var(--shadow-light);
    letter-spacing: 0.3px;
}
.step-navigation button:hover:not(:disabled), button#fisaAddButton:hover:not(:disabled), button#saveJournalEntryButton:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}
.step-navigation button#fisaPrevButton { background-color: var(--color-text-light); }
.step-navigation button#fisaPrevButton:hover:not(:disabled) { background-color: #5a6268; }
.step-navigation button#fisaNextButton { background-color: var(--color-primary); }
.step-navigation button#fisaNextButton:hover:not(:disabled) { background-color: var(--color-primary-dark); }

button#fisaAddButton {
    background-color: var(--color-success); display:block; width:100%;
    margin-top:calc(var(--spacing-unit) * 2.5); /* 20px */ font-size: 1em;
}
button#fisaAddButton:hover:not(:disabled) { background-color: #218838; }

.step-navigation button:disabled, button#fisaAddButton:disabled, button#saveJournalEntryButton:disabled {
    background: #ced4da !important; color: #6c757d !important;
    cursor: not-allowed !important; box-shadow: none !important; transform: translateY(0) !important;
}

/* JURNAL FORM */
input#journalTitle {
    margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */
}
textarea#journalContent {
    min-height: 220px; line-height: 1.7; margin-top: var(--spacing-unit);
}

.prompt-box {
    background: var(--color-primary-light); border: 1px solid #B9D7F8;
    border-left: 4px solid var(--color-primary);
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2); /* 12px 16px */
    margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */
    font-size: 0.9em; border-radius: var(--border-radius-medium);
}
.prompt-box-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: var(--spacing-unit);
}
.prompt-box-header strong { color: var(--color-primary-dark); font-size: 1.1em; font-weight: 600;}
.hide-prompt-button {
    background: none; border: none; color: var(--color-primary);
    font-size: 1.8em; font-weight: bold; cursor: pointer;
    padding: 0 calc(var(--spacing-unit) * 0.5); /* 0 4px */
    line-height: 0.8; opacity: 0.7; transition: opacity 0.2s;
}
.hide-prompt-button:hover { opacity: 1; }

.prompt-content-display {
    white-space: pre-wrap; max-height: 200px; overflow-y: auto;
    background-color: var(--color-bg-content);
    padding: calc(var(--spacing-unit) * 1.25); /* 10px */
    border-radius: var(--border-radius-small); border: 1px solid #DDE8F5;
    font-family: 'Menlo', 'Monaco', monospace; font-size:0.9em; line-height: 1.5;
    color: var(--color-text-medium);
}
.prompt-content-display::-webkit-scrollbar { width: 6px; }
.prompt-content-display::-webkit-scrollbar-track { background: #f1f1f1; }
.prompt-content-display::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius:3px; }
.prompt-content-display::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

#reflectionPromptsContainer {
    margin: calc(var(--spacing-unit) * 2.5) 0; /* 20px 0 */
    padding: calc(var(--spacing-unit) * 2); /* 16px */
    background-color: var(--color-bg-main); /* Match body BG for less contrast here */
    border-radius: var(--border-radius-medium);
    border: 1px solid #E0E6ED;
}
#reflectionPromptsContainer p {
    margin-top: 0; margin-bottom: var(--spacing-unit); font-weight: 500;
    color: var(--color-text-dark); font-size: 0.95em;
}
.prompt-button-group { display: flex; flex-wrap: wrap; gap: var(--spacing-unit); /* 8px */ }
button.prompt-button {
    background-color: transparent; /* Changed */
    color: var(--color-primary); border: 1px solid var(--color-primary); /* Changed */
    padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.75); /* 6px 14px */
    font-size: 0.85em; font-weight: 500; border-radius: 20px; /* More pill-like */
    cursor: pointer; transition: all 0.2s;
}
button.prompt-button:hover {
    background-color: var(--color-primary); color: var(--color-text-inverted);
    transform: translateY(-1px);
}

button#saveJournalEntryButton {
    display: block; width: 100%;
    margin-top: calc(var(--spacing-unit) * 2.5); /* 20px */
    padding: calc(var(--spacing-unit) * 1.5); /* 12px */
    font-size: 1em; font-weight: 500;
    background-color: var(--color-primary); color: var(--color-text-inverted);
    letter-spacing: 0.5px;
}
button#saveJournalEntryButton:hover:not(:disabled) {
    background-color: var(--color-primary-dark);
}

/* CONFIRMATION MESSAGES */
.confirmation-message {
    display: none; text-align: center;
    padding: calc(var(--spacing-unit) * 1.5); /* 12px */
    border: 1px solid transparent; border-radius: var(--border-radius-medium);
    margin-top: calc(var(--spacing-unit) * 2.5); /* 20px */
    animation: fadeInConfirm 0.4s; font-weight: 500; font-size: 0.95em;
}
.confirmation-message.success { background-color: var(--color-success-bg); color: var(--color-success); border-color: #A3D9B1; }
.confirmation-message.error   { background-color: var(--color-error-bg); color: var(--color-error); border-color: #F1B9BF; }
.confirmation-message.warning { background-color: var(--color-warning-bg); color: #B08800; border-color: #FFE58C; }
@keyframes fadeInConfirm { 0% {opacity: 0; transform: translateY(10px);} 100% {opacity: 1; transform: translateY(0);} }

/* CARDS CONTAINER */
#cardsContainerArea h3 {
    color: var(--color-text-dark); text-align: center;
    margin-bottom: calc(var(--spacing-unit) * 3); /* 24px */
    font-weight: 600; font-size: 1.6em;
    margin-top: calc(var(--spacing-unit) * 6); /* 48px */
}
.card-view-unified {
    display: flex; flex-direction: column; gap: calc(var(--spacing-unit) * 3); /* 24px */
    max-width: 760px; margin: calc(var(--spacing-unit) * 3) auto; /* 24px auto */
}
.response-card {
    background: var(--color-bg-content);
    border-radius: var(--border-radius-large); /* More rounded cards */
    box-shadow: var(--shadow-medium);
    overflow: hidden; border: 1px solid #E9ECEF; /* Softer border */
    transition: box-shadow 0.3s ease;
}
.response-card:hover {
    box-shadow: var(--shadow-strong);
}

.response-card .card-header {
    font-weight: 600; font-size: 1.05em; cursor: pointer;
    background: #FCFDFE; /* Very light, almost white */
    padding: calc(var(--spacing-unit) * 1.75) calc(var(--spacing-unit) * 2.5); /* 14px 20px */
    color: var(--color-text-dark); border-bottom: 1px solid #F0F3F5;
    display: flex; justify-content: space-between; align-items: center;
    transition: background-color 0.2s ease;
}
.response-card .card-header:hover {
    background: #F5F8FB;
}
.response-card .card-header span:first-child { flex-grow: 1; margin-right: var(--spacing-unit); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
.response-card .card-header .card-date { font-size: 0.8em; color: var(--color-text-light); white-space: nowrap; font-weight: 400;}
.response-card .card-header::after {
    content: '›'; font-size: 1.5em; transition: transform 0.3s ease;
    color: var(--color-primary); margin-left: var(--spacing-unit); line-height: 1;
    font-weight: bold;
}
.response-card.open .card-header::after {transform: rotate(90deg);}

.response-card .card-content { max-height: 0; padding: 0 calc(var(--spacing-unit) * 2.5); overflow-y: hidden; transition: max-height 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), padding-top 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), padding-bottom 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
.response-card.open .card-content { max-height: 10000px; padding: calc(var(--spacing-unit) * 2.5) calc(var(--spacing-unit) * 2.5); /* 20px */}

.introspectie-entry-details {
    margin-bottom: calc(var(--spacing-unit) * 2.5); /* 20px */
    border: 1px solid #F0F3F5; border-radius: var(--border-radius-medium);
    background: #FBFCFD;
}
.introspectie-entry-details summary {
    cursor: pointer; padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5); /* 8px 12px */
    font-weight: 500; color: var(--color-primary-dark);
    background-color: #F5F8FB; border-radius: var(--border-radius-medium) var(--border-radius-medium) 0 0;
    list-style-position: inside;
    transition: background-color 0.2s ease;
}
.introspectie-entry-details summary:hover { background-color: #EDF2F9; }
.introspectie-entry-details[open] summary { border-bottom: 1px solid #F0F3F5; }
.introspectie-entry-content-text {
    padding: calc(var(--spacing-unit) * 1.5); /* 12px */
    font-size: 0.95em; line-height: 1.7; color: var(--color-text-medium);
    max-height: 500px; overflow-y: auto; white-space: pre-wrap;
}
.introspectie-entry-content-text hr {margin: calc(var(--spacing-unit) * 2) 0; border: 0; border-top: 1px dashed #DDE2E7;}
.introspectie-entry-content-text h4 { font-size: 1em; color: var(--color-primary); margin-top: calc(var(--spacing-unit) * 2); margin-bottom:var(--spacing-unit); font-weight: 600;}
.introspectie-entry-content-text p { margin-bottom: calc(var(--spacing-unit) * 1.25); }
.introspectie-entry-content-text p strong { font-weight: 600; color: var(--color-text-dark); margin-right: calc(var(--spacing-unit)*0.5); }
.introspectie-entry-content-text::-webkit-scrollbar { width: 6px; }
.introspectie-entry-content-text::-webkit-scrollbar-thumb { background: #D1D9E2; border-radius:3px; }

.journal-entry-content-text-unified { white-space: pre-wrap; font-size: 1em; line-height: 1.75; color: var(--color-text-medium); }

.response-card > .card-content > h4.ai-feedback-title {
    color: var(--color-secondary-dark); font-weight: 600; margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 2); /* 16px */
    font-size: 1.2em;
    border-bottom: 1px solid #E7F0F9; padding-bottom: var(--spacing-unit);
}
.no-feedback-message { text-align: center; font-style: italic; color: var(--color-text-light); padding: calc(var(--spacing-unit) * 2) 0; }
.ai-feedback-history-container { margin-top: calc(var(--spacing-unit) * 1.5); /* 12px */ }
.feedback-entry-card {
    background: #FDFEFF; padding: calc(var(--spacing-unit) * 2); /* 16px */
    border: 1px solid #E7F0F9;
    border-left: 4px solid var(--color-secondary); border-radius: var(--border-radius-medium); margin-bottom:calc(var(--spacing-unit) * 2);
    font-size:0.95em; line-height:1.65; box-shadow: var(--shadow-light);
}
.feedback-timestamp { color: var(--color-text-light); font-size:0.8em; margin-bottom:var(--spacing-unit); font-style: italic; }
.feedback-section-item { margin-bottom: var(--spacing-unit); }
.feedback-section-item h5 {
    font-size: 1em; color: var(--color-secondary-dark); margin-top:0;
    margin-bottom: calc(var(--spacing-unit)*0.5); font-weight:600;
}
.feedback-section-item p, .feedback-section-item ul { margin-left: var(--spacing-unit); font-size: 0.95em; }
.feedback-section-item ul { padding-left: calc(var(--spacing-unit)*2); }
.feedback-section-item li { margin-bottom: calc(var(--spacing-unit)*0.5); }


.card-actions {
    margin-top: calc(var(--spacing-unit) * 2.5); /* 20px */
    padding-top: calc(var(--spacing-unit) * 2); /* 16px */
    border-top: 1px solid #F0F3F5;
    display: flex; flex-wrap: wrap; gap: var(--spacing-unit); /* 8px */
    justify-content: flex-end;
}
.card-actions button {
    padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.5); /* 6px 12px */
    font-size: 0.8em; font-weight:500; border-radius: var(--border-radius-medium); /* Increased */
    transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
    background-color: #F8F9FA; /* Light gray background for all */
    color: var(--color-text-medium);
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.card-actions button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}
button.delete-introspectie-button { color: var(--color-error); border-color: var(--color-error-bg); }
button.delete-introspectie-button:hover { background-color: var(--color-error); color: white; }
button.regenerate-feedback-button { color: var(--color-success); border-color: var(--color-success-bg); }
button.regenerate-feedback-button:hover { background-color: var(--color-success); color: white;}
button.discuss-entry-with-chat-button { color: var(--color-primary); border-color: var(--color-primary-light); }
button.discuss-entry-with-chat-button:hover { background-color: var(--color-primary); color: white;}
button.delete-last-feedback-button { color: var(--color-accent); border-color: var(--color-warning-bg); }
button.delete-last-feedback-button:hover { background-color: var(--color-accent); color: #493709;} /* Darker text for contrast on orange */
button.delete-all-feedback-button { color: #AB240C; border-color: #FEE9E5;}
button.delete-all-feedback-button:hover { background-color: #AB240C; color: white;}


/* AI GENERATED CONTENT (inside cards) */
.content-ai { font-size: 1em; line-height: 1.75; color: var(--color-text-medium); }
.content-ai h1, .content-ai h2, .content-ai h3, .content-ai h4, .content-ai .ai-main-section-title {
    font-weight: 600; color: var(--color-secondary-dark); /* Minty for AI content headers */
    margin-top: 1.4em; margin-bottom: 0.7em;
    font-size: 1.1em; padding-bottom: calc(var(--spacing-unit)*0.5);
}
.content-ai h1:first-child, /* etc. */ .content-ai .ai-main-section-title:first-child { margin-top: 0.5em; }
.content-ai p, .content-ai p.ai-text-paragraph { margin-bottom: 1em; }
.content-ai strong, .content-ai p.ai-text-paragraph strong { font-weight: 600; color: var(--color-text-dark); }
.content-ai em, .content-ai p.ai-text-paragraph em { font-style: italic; color: var(--color-text-medium); }
.content-ai ul, .content-ai ol, .content-ai ul.ai-list, .content-ai ol.ai-list {
    margin-left: calc(var(--spacing-unit)*0.5); padding-left: calc(var(--spacing-unit)*2.5);
    margin-bottom: 1em; list-style-position: outside;
}
.content-ai li, .content-ai .ai-list-item { margin-bottom: 0.6em; }
.content-ai li::marker, .content-ai .ai-list-item::marker { color: var(--color-secondary); font-weight: bold; }

.content-ai .ai-text-error {
    color: var(--color-error); font-weight: 500; background-color: var(--color-error-bg);
    padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); border-radius: var(--border-radius-small);
    border: 1px solid #F1B9BF; border-left: 4px solid var(--color-error);
    white-space: pre-wrap; font-size: 0.9em;
}
.raw-feedback-display { white-space: pre-wrap; font-family: monospace; font-size: 0.9em; padding: 10px; background: #f0f0f0; border-radius: 4px; max-height: 300px; overflow-y: auto;}

.no-entries-message, .loading-message, .error-loading-message { text-align: center; margin-top:calc(var(--spacing-unit)*3); font-style: italic; color: var(--color-text-light); font-size: 1.05em; padding:var(--spacing-unit)*2;}
.error-loading-message { color: var(--color-error); font-weight: 500;}
.loading-message { color: var(--color-primary); font-weight: 500; }

/* CHAT INTERFACE */
.chat-container {
    display: none; flex-direction: column; position: fixed; bottom: 20px; right: 20px;
    width: clamp(360px, 30vw, 420px);
    max-height: calc(100vh - 100px); /* Va fi ajustat in media query */
    background: var(--color-bg-content);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-strong);
    z-index: 1000; padding: 0; box-sizing: border-box; overflow: hidden;
    border: 1px solid #DEE2E6;
}
.chat-container h3 { /* Titlu Chat */
    text-align: center; color: var(--color-text-dark); margin: 0;
    padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2); /* 12px 16px | Redus usor */
    font-size: 1.05em; font-weight: 600; /* Redus usor */
    background-color: #F8F9FA;
    border-bottom: 1px solid #E9ECEF; flex-shrink: 0;
    display: flex; justify-content: space-between; align-items: center; /* For minimize button */
}
#chatMessages {
    flex-grow: 1; overflow-y: auto; padding: calc(var(--spacing-unit)*1.5); /* 12px | Redus padding */
    background: var(--color-bg-content);
    display: flex; flex-direction: column; gap: calc(var(--spacing-unit)*1.25);
}
#chatMessages::-webkit-scrollbar { width: 7px; }
#chatMessages::-webkit-scrollbar-track { background: transparent; }
#chatMessages::-webkit-scrollbar-thumb { background: #CED4DA; border-radius: 10px; }
#chatMessages::-webkit-scrollbar-thumb:hover { background: #ADB5BD; }

.chat-message {
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*2);
    border-radius: var(--border-radius-large);
    max-width: 80%;
    word-wrap: break-word; line-height: 1.5;
    box-shadow: var(--shadow-light);
    font-size: 0.95em; font-weight: 400; position: relative;
    display: flex; /* Adăugat pentru a alinia <details> și conținutul principal */
    flex-direction: column; /* Gândurile deasupra, conținutul principal dedesubt */
}
.user-message {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    align-self: flex-end; margin-left: auto;
    border-bottom-right-radius: var(--border-radius-small);
}
.ai-message {
    background: var(--color-bg-chat-alt);
    color: var(--color-text-dark);
    align-self: flex-start; margin-right: auto;
    border-bottom-left-radius: var(--border-radius-small);
    font-family: var(--font-primary);
}
.ai-message em, .ai-message i { font-family: var(--font-primary), inherit; font-style: italic; }
.ai-message strong, .ai-message b { font-family: var(--font-primary), inherit; font-weight: 600; }
.ai-message.ai-error {
    background-color: var(--color-error-bg); color: var(--color-error);
    border: 1px solid #F5C6CB;
    font-family: var(--font-primary), sans-serif;
}
.ai-message pre.code-block-chat { background:#eef; padding:5px; border-radius:4px; white-space:pre-wrap; word-break:break-all; font-size: 0.9em; }
.ai-message code.inline-code-chat { background:#eef; padding:1px 3px; border-radius:3px; font-size: 0.9em; }
.ai-message h6 { margin-top: 0.8em; margin-bottom: 0.4em; font-size: 1.05em; font-weight: 600; color: var(--color-text-dark);}
.ai-message ul, .ai-message ol { margin-top: 0.5em; margin-bottom: 0.5em; padding-left: 20px;}
.ai-message li { margin-bottom: 0.25em;}

.ai-message .main-answer-text { /* Stil pentru textul principal, după thoughts */
    margin-top: 5px; /* Adaugă un mic spațiu dacă există thoughts deasupra */
}
.ai-message .main-answer-text:first-child { /* Dacă nu există thoughts, nu e nevoie de spațiu sus */
    margin-top: 0;
}


/* NOU: Zona de input și buton reproiectată */
.chat-input-area {
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*1.5); /* 10px 12px */
    border-top: 1px solid #E9ECEF; background-color: #F8F9FA;
    flex-shrink: 0;
    display: flex; /* NOU: Facem flexibil pentru aliniere input și buton */
    align-items: flex-end; /* NOU: Aliniază elementele la bază, util dacă textarea crește */
    gap: calc(var(--spacing-unit)*1); /* 8px NOU: Spațiu între input și buton */
}

#chatInput {
    flex-grow: 1; /* NOU: Input-ul ocupă spațiul disponibil */
    border-radius: 20px; /* Mai rotunjit */
    padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*1.75); /* 10px 14px */
    min-height: 40px; /* Ajustat pentru a se potrivi mai bine cu butonul */
    max-height: 100px;
    font-size: 0.95em;
    line-height: 1.4; /* Îmbunătățește lizibilitatea textului pe mai multe rânduri */
    resize: none; /* Oprește redimensionarea manuală care poate strica layout-ul */
    margin-bottom: 0; /* Elimină marginea de jos dacă exista din stilurile generale */
    border: 1px solid #CED4DA; /* Asigură un chenar vizibil */
}

#sendChatMessageButton {
    flex-shrink: 0; /* NOU: Butonul nu se micșorează */
    width: 40px;    /* NOU: Lățime fixă */
    height: 40px;   /* NOU: Înălțime fixă (potrivită cu min-height al inputului) */
    padding: 0;     /* NOU: Eliminăm padding-ul intern dacă setăm dimensiuni fixe */
    font-family: var(--font-primary);
    font-size: 1.2em; /* Mărime potrivită pentru un icon/simbol */
    font-weight: 500; /* Păstrăm consistența */
    background-color: transparent;
    color: var(--color-primary); /* Culoare pentru icon/text */
    border: none; /* NOU: Fără chenar */
    border-radius: 50%; /* NOU: Buton rotund */
    transition: background-color 0.2s, color 0.2s; /* Tranzitie pentru hover */
    cursor: pointer;
    margin-top:0;
    display: flex; /* NOU: Pentru centrarea iconului */
    align-items: center; /* NOU: Pentru centrarea iconului */
    justify-content: center; /* NOU: Pentru centrarea iconului */
    line-height: 1; /* Asigură centrarea corectă a textului/iconului */
}
#sendChatMessageButton::before { /* Folosim un pseudo-element pentru icon */
    content: "➢"; /* Sau alt icon. Ex: "➤", "▶", "✓" */
}

#sendChatMessageButton:hover:not(:disabled) {
    background-color: var(--color-primary-light); /* Fundal subtil la hover */
    color: var(--color-primary-dark);
    transform: none; /* Eliminăm transformarea de pe butonul general */
    box-shadow: none;
}
#sendChatMessageButton:disabled {
    background-color: transparent !important;
    color: #CED4DA !important; /* Culoare gri pentru starea disabled */
    transform: translateY(0) !important;
    cursor: not-allowed !important;
}
#chatStatus {
    font-size: 0.9em; color: var(--color-text-light); text-align: center;
    min-height: 1.2em;
    font-weight: 300;
    background-color: #F8F9FA; /* Același fundal ca input area */
    margin:0; /* Elimină orice margine default */

}
#toggleChatButton {
    position: fixed; bottom: calc(var(--spacing-unit)*2); right: calc(var(--spacing-unit)*2); /* 16px | Redus pozitionarea */
    padding: 0; z-index: 1001;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(145deg, var(--color-secondary) 0%, var(--color-primary) 100%);
    color: var(--color-text-inverted); border: none; border-radius: 50%;
    width: 44px; height: 44px; /* Redus | Original 56x56, apoi 20x20 care era prea mic */
    font-size: 20px; /* Redus | Original 28px */
    line-height: 44px; /* Aliniat cu înălțimea */
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.25); /* Redus umbra */
    cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
#toggleChatButton:hover {
    transform: scale(1.05) rotate(10deg); /* Redus transformarea */
    box-shadow: 0 6px 18px rgba(74, 144, 226, 0.3);
}

/* Styles for AI Thoughts */
.ai-thoughts-details {
    margin-bottom: 8px; /* Spațiu între gânduri și răspunsul principal */
    background-color: #f0f0f085; /* Fundal ușor diferit, cu transparență */
    border: 1px solid #ddd;
    border-radius: var(--border-radius-small);
    font-size: 0.85em; /* Puțin mai mic */
    opacity: 0.9;
    width: 100%; /* Ocupă lățimea containerului .ai-message */
}
.ai-thoughts-details summary {
    padding: 5px 8px;
    cursor: pointer;
    font-weight: 500;
    color: var(--color-text-medium);
    background-color: #e9ecefbd;
    border-radius: var(--border-radius-small) var(--border-radius-small) 0 0;
    list-style-position: inside; /* Sau none dacă preferi să stilizezi altfel săgeata */
    outline: none; /* Elimină outline-ul la focus pe summary */
}
.ai-thoughts-details summary:hover {
    background-color: #dfe3e6;
}
.ai-thoughts-details[open] summary {
    border-bottom: 1px solid #d5d9dc;
}
.ai-thoughts-content {
    padding: 8px 10px;
    white-space: pre-wrap; /* Esențial pentru \n */
    word-break: break-word; /* Pentru cuvinte lungi */
    font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
    font-size: 0.95em; /* Relativ la .ai-thoughts-details */
    color: #2c3e50; /* O culoare mai închisă pentru lizibilitate */
    max-height: 180px;
    overflow-y: auto;
    background-color: #fdfdfee3;
    border-radius: 0 0 var(--border-radius-small) var(--border-radius-small);
}
.ai-thoughts-content::-webkit-scrollbar { width: 5px; }
.ai-thoughts-content::-webkit-scrollbar-thumb { background: #bababa; border-radius:3px; }
.ai-thoughts-content::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }


.ai-error-inline { /* For errors appearing within a streamed message */
    color: var(--color-error);
    font-style: italic;
    font-size: 0.9em;
    display: block; /* Make it a block to take full width */
    margin-top: 5px;
    padding: 5px;
    background-color: var(--color-error-bg);
    border-left: 3px solid var(--color-error);
}


/* RESPONSIVENESS */
@media (max-width: 820px) {
     .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*3);
        margin-left:calc(var(--spacing-unit)*2); margin-right:calc(var(--spacing-unit)*2);
        max-width:calc(100% - (var(--spacing-unit)*4));
     }
}
@media (max-width: 768px) {
    body {padding:calc(var(--spacing-unit)*2); font-size: 15px;}
    .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*2.5);
        margin-left:var(--spacing-unit); margin-right:var(--spacing-unit);
        max-width:calc(100% - (var(--spacing-unit)*2));
    }
    .app-header h1 { font-size: 2em; }
    .tab-button { padding: calc(var(--spacing-unit)*1.25) calc(var(--spacing-unit)*2.5); font-size: 1em;}
    .form-section-container h2 {font-size:1.6em;}
    #cardsContainerArea h3 {font-size: 1.5em;}
    .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.9em; padding:var(--spacing-unit) calc(var(--spacing-unit)*2);}
    .card-actions button {font-size:0.75em; padding:calc(var(--spacing-unit)*0.75) var(--spacing-unit);}

    .chat-container {
        width: calc(100% - var(--spacing-unit)*2); /* Lățime aproape completă, cu margini mici */
        max-height: calc(100vh - 60px); /* Mai mult spațiu vertical, mai aproape de marginea de sus */
        bottom: var(--spacing-unit); /* Mai aproape de marginea de jos */
        left: var(--spacing-unit); /* Mai aproape de marginea din stânga */
        right: var(--spacing-unit); /* Adaugat pentru a centra pe ecrane mici, dacă left/width nu sunt suficiente */
        border-radius: var(--border-radius-medium); /* Raze mai mici pe mobil */
    }
    #toggleChatButton {
        width: 40px; height: 40px; font-size: 18px; line-height: 40px;
        bottom: calc(var(--spacing-unit)*1.5); right: calc(var(--spacing-unit)*1.5); /* 12px */
    }
    #chatInput {
        padding: calc(var(--spacing-unit)*1) calc(var(--spacing-unit)*1.5); /* 8px 12px */
        min-height: 38px;
        font-size: 0.9em;
    }
    #sendChatMessageButton {
        width: 38px; height: 38px;
        font-size: 1.1em;
    }
    .chat-input-area {
        padding: var(--spacing-unit); /* 8px */
    }
}
@media (max-width: 480px) {
    body {padding:var(--spacing-unit); font-size: 14px;}
    .form-section-container, .card-view-unified {
        padding:calc(var(--spacing-unit)*1.5);
        margin-left:calc(var(--spacing-unit)*0.5); margin-right:calc(var(--spacing-unit)*0.5);
        max-width:calc(100% - var(--spacing-unit));
        border-radius: var(--border-radius-medium);
    }
    .app-header h1 {font-size:1.7em;}
    .tab-button { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 0.9em;}
    .form-section-container h2 {font-size:1.4em;} #cardsContainerArea h3 {font-size: 1.3em;}
    textarea#journalContent { min-height: 160px; }
    .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.85em; padding:var(--spacing-unit) calc(var(--spacing-unit)*1.5);}
    .card-actions button {
        font-size:0.7em; padding:calc(var(--spacing-unit)*0.75) var(--spacing-unit);
        flex-basis: calc(50% - (var(--spacing-unit)*0.5) );
    }
    .response-card .card-header {
        padding:var(--spacing-unit) calc(var(--spacing-unit)*1.5);
        flex-direction: column; align-items: flex-start; gap: calc(var(--spacing-unit)*0.5);
    }
    .response-card .card-header::after { align-self: flex-end; margin-top: -1.5em; font-size: 1.3em;}

    .chat-container {
        width: calc(100% - var(--spacing-unit)*2);
        max-height: calc(100vh - var(--spacing-unit)*2 - 50px); /* 50px for browser UI */
        bottom: var(--spacing-unit);
        left: var(--spacing-unit);
        right: var(--spacing-unit);
        border-radius: var(--border-radius-medium);
    }
    .chat-container h3 { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 1em;}
    #chatMessages { padding: var(--spacing-unit); gap: var(--spacing-unit);}
    .chat-message { padding: var(--spacing-unit) calc(var(--spacing-unit)*1.5); font-size: 0.9em;}

    #chatInput {
        min-height: 36px;
        font-size: 0.9em;
    }
    #sendChatMessageButton {
        width: 36px; height: 36px;
    }
    #toggleChatButton {
        width: 38px; height: 38px; font-size: 16px; line-height: 38px;
        bottom: var(--spacing-unit); right: var(--spacing-unit);
    }
}
#minimizeChatButton {
    background: none;
    border: none;
    color: var(--color-text-medium);
    cursor: pointer;
    padding: 0 var(--spacing-unit);
    line-height: 1;
    font-size: 1.2em; /* Adjust size of chevron */
    font-weight: bold;
}
#minimizeChatButton::after { /* CSS Chevron */
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-left: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(-45deg);
    margin-left: 5px; /* Optional: space from title text */
}

#minimizeChatButton:hover {
    color: var(--color-primary);
}

.chat-container h3 .chat-title-text {
    flex-grow: 1; /* Allow title to take available space */
    text-align: center; /* Center title if desired, or remove for left align */
    margin-right: auto; /* Push minimize button to the right */
    margin-left: auto; /* If centered */
}
#minimizeChatButton {
    margin-left: var(--spacing-unit); /* Space it from the edge or title */
}

 /* --- MODERN FRESH STYLES END --- */
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Introspecție Ghidată</h1>
        <p>Jurnal personal și fișe de monitorizare într-un singur loc.</p>
    </header>

    <nav class="tab-navigation">
        <button id="tabButtonJurnal" class="tab-button active" type="button">Jurnal Ghidat</button>
        <button id="tabButtonFisa" class="tab-button" type="button">Fișă Terapeutică</button>
    </nav>

    <main id="mainContentArea">
        <!-- Conținutul Jurnalului Ghidat -->
        <div id="jurnalFormContainer" class="tab-content active">
            <section class="form-section-container">
                <h2>Jurnal Terapeutic Personal</h2>
                <p>Spațiul tău pentru reflecție ghidată, auto-descoperire și integrare emoțională.</p>

                <form id="therapeuticJournalForm" onsubmit="return false;">
                    <label for="journalTitle">Titlu (Opțional):</label>
                    <input type="text" id="journalTitle" name="journalTitle" placeholder="Ex: Reflecții despre ziua de azi...">

                    <div id="reflectionPromptsContainer" style="margin-top: 20px;">
                        <p>Puncte de start pentru reflecție (alege un ghid):</p>
                        <div class="prompt-button-group" id="reflectionPrompts">
                            <!-- Butoanele vor fi generate de JavaScript -->
                        </div>
                    </div>

                    <div id="activeJurnalPromptBox" class="prompt-box" style="display: none;">
                        <div class="prompt-box-header">
                            <strong id="activeJurnalPromptTitle">Ghid activ:</strong>
                            <button type="button" onclick="window.hideActiveJurnalPromptManual()" class="hide-prompt-button" title="Ascunde ghidul">×</button>
                        </div>
                        <div id="activeJurnalPromptContent" class="prompt-content-display"></div>
                        <p style="font-size:0.85em; text-align:right; margin-top:8px; color: #64748B;"><em>Acest ghid este pentru inspirație. Scrie în câmpul de mai jos.</em></p>
                    </div>

                    <label for="journalContent" style="margin-top: 15px;">Intrarea ta în jurnal:</label>
                    <textarea id="journalContent" name="journalContent" rows="12" placeholder="Scrie liber aici sau completează răspunzând la întrebările din ghidul afișat..."></textarea>

                    <button type="button" id="saveJournalEntryButton">Salvează Jurnal și Cere Feedback AI</button>
                </form>
                <div id="jurnalConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>

       <!-- Conținutul Fișei Terapeutice -->
        <div id="fisaFormContainer" class="tab-content">
            <section class="form-section-container">
                <h2>Fișă de Monitorizare Terapeutică</h2>
                <p>Completează fiecare întrebare pentru a înțelege mai bine situațiile tale. Fiecare secțiune reprezintă o parte importantă a reflecției tale. În acest exercițiu, îți voi ghida fiecare pas, astfel încât să poți explora în profunzime gândurile, emoțiile și comportamentele tale.</p>
    
                <div class="progress-bar">
                    <div class="progress" id="fisaProgress"></div>
                </div>

                <form id="fisaExercitiuForm" novalidate>
    <!-- PASUL 1 -->
            <div class="question-card form-step form-step-active" id="fisa-step-1">
                <h3>Care este situația?</h3>
                <p>Te rog să descrii contextul care a declanșat emoțiile sau comportamentul tău. Încearcă să fii cât mai specific și detaliat. Aceasta poate fi o situație concretă din viața de zi cu zi în care te-ai simțit copleșit, stresat sau într-o altă stare emoțională intensă.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-2">
                <h3>Ce îmi trece prin minte?</h3>
                <p>Îți cer să identifici gândurile automate care au apărut în această situație. Acestea sunt gânduri rapide, involuntare, care îți trec prin minte în momentele de stres. Ce îți spui în acel moment? Este un gând critic sau îngrijorător?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-3">
                <h3>Cum mă face acel gând să mă simt?</h3>
                <p>Te rog să notezi emoțiile pe care le simți în urma acelui gând. Ce simți? Frică, tristețe, furie? Dă o intensitate emoției (de la 0 la 100) pentru a vedea cât de puternică este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-4">
                <h3>Ce mod este activ?</h3>
                <p>Identifică modul în care te afli în această situație. Este un mod de copil vulnerabil, critic interior, sau poate adultul sănătos? Conștientizarea modului îți poate oferi o mai bună înțelegere a reacțiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-5">
                <h3>Ce comportament simți că adopți?</h3>
                <p>Descrie comportamentul pe care îl manifești în această situație. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoașterea comportamentului te ajută să înțelegi mai bine cum reacționezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoții și comportamente? Poate fi nevoia de siguranță, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta să găsești strategii mai sănătoase pentru a le îndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-7">
                <h3>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</h3>
                <p>Reflectează dacă felul în care reacționezi te ajută cu adevărat să îți îndeplinești nevoile. Poate fi util să te gândești dacă există alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-8">
                <h3>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</h3>
                <p>Gândește-te la cum ar reacționa partea ta Adultă Sănătoasă în această situație. Cum ai putea să abordezi diferit pentru a avea grijă de tine și de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- PASUL 2 -->
            <div class="question-card form-step" id="fisa-step-9">
                <h3>Ce mă face să cred că gândul automat este adevărat?</h3>
                <p>Explorează motivele pentru care crezi că acest gând este adevărat. Ce dovezi ai care îți confirmă acest lucru? De multe ori, ne bazăm pe experiențe trecute sau frici pentru a justifica un gând.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-10">
                <h3>Ce mă face să cred că nu este adevărat?</h3>
                <p>Acum, să ne uităm la dovezile împotriva gândului tău. Există argumente sau experiențe care contrazic acest gând? Poate există o altă perspectivă pe care nu ai luat-o în considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-11">
                <h3>Există o explicație alternativă?</h3>
                <p>Uneori, există mai multe explicații pentru ceea ce se întâmplă. Ce alte interpretări ai putea avea pentru această situație? Gândește-te la alte posibilități care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-12">
                <h3>Care este cel mai rău lucru care s-ar putea întâmpla?</h3>
                <p>Ce este cel mai rău care ar putea avea loc în această situație? Să identificăm acele frici catastrofale care adesea ne alimentează gândurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-13">
                <h3>Care este cel mai bun lucru care s-ar putea întâmpla?</h3>
                <p>Pe de altă parte, care ar fi cel mai pozitiv scenariu? Uneori uităm să ne gândim și la posibilitățile bune. Cum ar arăta cel mai bun rezultat al acestei situații?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>După ce am explorat extremele, ce crezi că este cel mai probabil să se întâmple? Cum ar arăta un rezultat realist, ținând cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-15">
                <h3>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</h3>
                <p>Întreabă-te cum ar fi dacă ai aborda situația cu un alt tip de gândire. Cum ar influența asta emoțiile și comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-16">
                <h3>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</h3>
                <p>Gândește-te la cum ai reacționa dacă un prieten drag ar avea aceleași gânduri. Ce i-ai spune pentru a-l sprijini? Cum ai încerca să-l încurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- PASUL 3 -->
            <div class="question-card form-step" id="fisa-step-17">
                <h3>Văd doar partea rea a lucrurilor?</h3>
                <p>Este posibil să fii prins într-un tipar negativ de gândire, concentrându-te doar pe aspectele negative. Încearcă să observi dacă există și aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-18">
                <h3>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</h3>
                <p>Reflectează dacă îți asumi responsabilitatea pentru situații asupra cărora nu aveai control. Este important să îți dai seama de limitele influenței tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-19">
                <h3>Mă condamn în baza unui singur eveniment?</h3>
                <p>Îți evaluezi valoarea personală bazându-te pe un singur eveniment negativ? Amintește-ți că un eveniment nu definește cine ești în totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-20">
                <h3>Privesc situația în termeni extremi?</h3>
                <p>Verifică dacă vezi situația doar în alb sau negru, fără nuanțe de gri. Gândirea extremă poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-21">
                <h3>Exagerez situația?</h3>
                <p>Îți amplifici reacțiile față de o situație? Încearcă să te gândești dacă ceea ce percepi este realist sau dacă exagerezi impactul situației.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-22">
                <h3>Există și alți factori responsabili?</h3>
                <p>Există alți factori care contribuie la această situație, pe lângă tine? Este important să ai o perspectivă completă asupra cauzelor unei situații.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-23">
                <h3>Am sărit direct la concluzii?</h3>
                <p>Te-ai grăbit să ajungi la o concluzie fără suficiente dovezi? Încearcă să observi dacă există alte posibilități care ar putea explica situația.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-24">
                <h3>Îmi pun întrebări fără răspuns?</h3>
                <p>Te frământă întrebări care nu au un răspuns clar sau realist? Aceste întrebări pot fi o sursă majoră de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-25">
                <h3>Mă concentrez doar asupra slăbiciunilor mele?</h3>
                <p>Ai tendința să te focalizezi doar pe slăbiciuni și să ignori punctele tale forte? Încearcă să îți recunoști și punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-26">
                <h3>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</h3>
                <p>Ai tendința să te gândești mereu la cum ar trebui să fie lucrurile, în loc să accepți situația așa cum este? Acceptarea poate reduce stresul și anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-27">
                <h3>Mă aștept să fiu perfect?</h3>
                <p>Îți setezi standarde foarte înalte, imposibil de atins? Perfecționismul poate fi o sursă majoră de frustrare și descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="fisa-step-28">
                <h3>Completare finalizată!</h3>
                <p>Felicitări pentru parcurgerea acestui exercițiu de auto-reflecție! Apasă butonul de mai jos pentru a salva datele și a genera un feedback automatizat, dacă este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta să obții noi perspective. Dacă întâmpini probleme cu generarea (ex: erori de limită de utilizare sau cheie API invalidă), poți încerca din nou mai târziu sau contacta administratorul.</p>
            </div>


                    <div class="step-navigation">
                        <button type="button" id="fisaPrevButton">Înapoi</button>
                        <button type="button" id="fisaNextButton">Înainte</button>
                    </div>
                    <button type="button" id="fisaAddButton">Salvează Fișa și Generează Feedback AI</button>
                </form>
                <div id="fisaConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>
    </main>

    <section id="cardsContainerArea">
        <h3 id="introspectiiTitle">Istoricul Introspecțiilor Tale</h3>
        <div class="card-view-unified" id="introspectiiCardContainer">
            <!-- Cardurile vor fi adăugate aici -->
        </div>
    </section>


   <div class="chat-container" id="chatContainer">
       <h3>
           <span class="chat-title-text">Discută cu PsihoGPT</span>
           <button id="minimizeChatButton" title="Minimizează Chat"></button>
       </h3>
       <div id="chatMessages"></div> <!-- Aici vor fi mesajele -->
       <div class="chat-input-area">
           <textarea id="chatInput" rows="1" placeholder="Scrie mesajul tău... Enter pentru a trimite."></textarea>
           <button id="sendChatMessageButton" disabled title="Trimite Mesaj"></button>
       </div>
       <p id="chatStatus">Chatul AI nu este activ.</p>
   </div>
   <button id="toggleChatButton" style="display: none;">💬</button>
</body>
</html>
