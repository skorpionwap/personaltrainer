<!DOCTYPE html>
<html>
<head>
    <title>AplicaÈ›ie IntrospecÈ›ie - Jurnal & FiÈ™e</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, deleteField, doc, getDoc, updateDoc, arrayUnion, query, where, setDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // --- CONFIGURARE FIREBASE & GEMINI (UNICÄ‚) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng";
    const GEMINI_MODEL_NAME_FEEDBACK_FISA = "gemini-2.5-flash-preview-04-17"; // Model pentru fiÈ™e
    const GEMINI_MODEL_NAME_FEEDBACK_JURNAL = "gemini-2.5-flash-preview-04-17"; // Model pentru jurnal (poate fi acelaÈ™i sau diferit)
    const GEMINI_MODEL_NAME_CHAT = "gemini-2.5-flash-preview-04-17"; // Model pentru chat

    let genAI, geminiModelFisaFeedback, geminiModelJurnalFeedback, geminiModelChat;

    if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            geminiModelFisaFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_FISA });
            geminiModelJurnalFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_JURNAL });
            geminiModelChat = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_CHAT });
            console.log("SDK Gemini iniÈ›ializat. Modele: FiÈ™Äƒ Feedback:", GEMINI_MODEL_NAME_FEEDBACK_FISA, "Jurnal Feedback:", GEMINI_MODEL_NAME_FEEDBACK_JURNAL, "Chat:", GEMINI_MODEL_NAME_CHAT);
        } catch (e) {
            console.error("Eroare criticÄƒ la iniÈ›ializarea SDK Gemini:", e);
            alert("Eroare la iniÈ›ializarea serviciului AI. VerificaÈ›i cheia API Gemini È™i configuraÈ›ia din Google Cloud. FuncÈ›ionalitatea AI va fi limitatÄƒ.");
            geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
        }
    } else {
        console.warn("Cheia API Gemini nu este configuratÄƒ sau este un placeholder. FuncÈ›ionalitatea AI va fi dezactivatÄƒ.");
        geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
    }

    // --- VARIABILE GLOBALE È˜I STÄ‚RI ---
    let currentUserId = null;
    let dataAlreadyLoaded = false; // Pentru Ã®ncÄƒrcarea iniÈ›ialÄƒ a introspecÈ›iilor

    // StÄƒri specifice pentru formularul de FiÈ™Äƒ
    let currentFisaStep = 1;
    let totalFisaSteps = 0;

    // StÄƒri specifice pentru formularul de Jurnal
    let selectedJurnalPrompt = null;
    const jurnalPromptsList = [ // Structura ID-urilor e importantÄƒ pentru buildAdaptiveAIPromptJurnal
            {
                label: "ğŸŒ¡ï¸ ExploreazÄƒ o emoÈ›ie", id: "explorare_emotie",
                text: "ğŸŒ¡ï¸ *AstÄƒzi simt...*\nNumeÈ™te emoÈ›ia dominantÄƒ: ________________\n\nğŸ” *Unde o simt Ã®n corp?*\nDescrie senzaÈ›iile (tensiune, greutate, pulsaÈ›ie etc.): ________________\n\nğŸ’­ *Ce gÃ¢nduri vin cu aceastÄƒ emoÈ›ie?*\nNoteazÄƒ gÃ¢ndurile automate, chiar dacÄƒ par â€exagerateâ€: ________________\n\nğŸ“š *Ãn ce context a apÄƒrut?*\nCe s-a Ã®ntÃ¢mplat exact? Ce a declanÈ™at-o? ________________\n\nğŸ’§ *Ce nevoie ar putea semnala?*\nDe ce are nevoie aceastÄƒ parte din tine? Ce lipseÈ™te? ________________\n\nğŸ’Œ *DacÄƒ aÈ™ avea compasiune pentru mine acum...*\nCe mi-aÈ™ spune? Ce gest aÈ™ face pentru mine? ________________\n"
            },
            {
                label: "ğŸ“ AnalizeazÄƒ o situaÈ›ie", id: "analiza_situatie",
                text: "SituaÈ›ia care mÄƒ preocupÄƒ este: ________________\n\nCe s-a Ã®ntÃ¢mplat exact? (Fapte): ________________\nInterpretarea mea iniÈ›ialÄƒ (GÃ¢nduri automate): ________________\nEmoÈ›iile principale: ________________\nO altÄƒ perspectivÄƒ (Reframing): ________________\nCe am Ã®nvÄƒÈ›at/pot Ã®nvÄƒÈ›a? (LecÈ›ii): ________________\n"
            },
            {
                label: "ğŸ—£ï¸ Dialog Voce CriticÄƒ", id: "dialog_voce_critica",
                text: "ğŸ—£ï¸ *Vocea mea interioarÄƒ Ã®mi spune...*\n(\"EÈ™ti slab\", \"Nu faci destul\", \"O sÄƒ fii respins\"...): ________________\n\nğŸ˜” *CÃ¢nd aud acest mesaj, mÄƒ simt...*\n(emoÈ›ii È™i senzaÈ›ii fizice): ________________\n\nğŸ§’ *AceastÄƒ voce seamÄƒnÄƒ cu...*\n(E o voce veche? un pÄƒrinte? un profesor? un fost partener?): ________________\n\nğŸ§  *Ce nevoie neÃ®mplinitÄƒ e Ã®n spatele acestui mesaj?*\n(Poate recunoaÈ™tere, protecÈ›ie, control, apartenenÈ›Äƒ?): ________________\n\nğŸ§˜ *RÄƒspunsul meu ca Adult SÄƒnÄƒtos ar fi...*\n(\"Apreciez cÄƒ vrei sÄƒ mÄƒ protejezi, dar acum aleg altceva.\"): ________________\n"
            },
            {
                label: "ğŸ’– RecunoÈ™tinÈ›Äƒ & Resurse", id: "recunostinta_resurse",
                text: "ğŸ’– *AstÄƒzi aleg sÄƒ vÄƒd ce e bun...*\nSunt recunoscÄƒtor/oare pentru:\n1. ________________\n2. ________________\n3. ________________\n\nğŸŒ± *O resursÄƒ interioarÄƒ pe care mÄƒ pot baza astÄƒzi este...*\n(ex: curaj, blÃ¢ndeÈ›e, claritate, capacitatea de a simÈ›i): ________________\n\nğŸ› *Un gest de auto-Ã®ngrijire pe care Ã®l pot face azi...*\n(chiar dacÄƒ e mic): ________________\n"
            },
            {
                label: "ğŸŒ€ Ritual ReconstrucÈ›ie InterioarÄƒ", id: "ritual_reconstructie",
                text: `ğŸ§­ MASTER TEMPLATE â€“ Scriere TerapeuticÄƒ de Integrare È™i Vindecare\nDenumire: â€Ritual de reconstrucÈ›ie interioarÄƒâ€\nScop: Eliberare, Clarificare, ConÈ›inere, ÃnÈ›elepciune, DirecÈ›ie\n\nI. ğŸ” INVITAÈšIE LA AUTENTICITATE\nâ€Ce parte din mine cere atenÈ›ie acum?â€\n   * Ce trÄƒiesc cu adevÄƒrat, fÄƒrÄƒ filtru, fÄƒrÄƒ poveste cosmetizatÄƒ?\n   * Ce mi-e ruÈ™ine sÄƒ simt sau sÄƒ recunosc chiar È™i Ã®n scris?\n   * Ce parte din mine se simte exclusÄƒ, neauzitÄƒ, ignoratÄƒ?\nRÄƒspuns: ________________\n\nII. ğŸŒŠ CONTAINERE EMOÈšIONALE\nâ€Ce simte corpul meu? Unde locuieÈ™te durerea?â€\n   * Unde simt emoÈ›ia Ã®n corp? Cum se manifestÄƒ? (Tensiune, Ã®nÈ›epÄƒturi, etc.)\n   * DacÄƒ ar avea o culoare, formÄƒ, texturÄƒ â€“ cum ar arÄƒta?\n   * Pot respira Ã®n acea zonÄƒ 3 minute, fÄƒrÄƒ sÄƒ fug?\nRÄƒspuns: ________________\n\nIII. ğŸ§  DECODIFICARE NARATIVÄ‚\nâ€Ce poveste Ã®mi spun? Este Ã®ntreagÄƒ?â€\n   * Ce naraÈ›iune inconÈ™tientÄƒ guverneazÄƒ trÄƒirea mea? (ex: â€Nu sunt dorit.â€)\n   * De unde vine aceastÄƒ naraÈ›iune? CÃ¢nd am mai trÄƒit ceva similar?\n   * Ce parte din mine (copil rÄƒnit, etc.) scrie aceastÄƒ poveste?\nRÄƒspuns: ________________\n\nIV. ğŸ§© INTEGRARE EXPLICATIVÄ‚\nâ€Ce Ã®nÈ›eleg nou despre mine din aceastÄƒ durere?â€\n   * Ce nevoi profunde au fost ignorate sau negate?\n   * Ce am protejat, de fapt, prin reacÈ›ia mea?\n   * Ce emoÈ›ii contradictorii coexistÄƒ Ã®n mine È™i ce spun ele?\nRÄƒspuns: ________________\n\nV. ğŸª COMPASIUNE È˜I BLÃ‚NDEÈšE\nâ€Cum pot fi pÄƒrinte pentru mine acum?â€\n   * DacÄƒ mi-aÈ™ È›ine partea rÄƒnitÄƒ Ã®n braÈ›e, ce i-aÈ™ spune?\n   * Ce aÈ™ vrea sÄƒ aud din partea unei figuri ideale de susÈ›inere?\n   * Pot lÄƒsa iubirea, nu logica, sÄƒ conducÄƒ acest moment?\nRÄƒspuns: ________________\n\nVI. ğŸ”® RECONFIGURARE IDENTITARÄ‚\nâ€Cine sunt eu dincolo de aceastÄƒ ranÄƒ?â€\n   * Ce adevÄƒr despre mine rÄƒmÃ¢ne valabil, chiar È™i Ã®n durere?\n   * Cine devin dacÄƒ Ã®nvÄƒÈ› sÄƒ stau cu mine Ã®n acest spaÈ›iu?\n   * DacÄƒ aÈ™ fi un personaj simbolic acum, cine aÈ™ fi?\nRÄƒspuns: ________________\n\nVII. âœï¸ ACTUL SACRU DE ALEGERE\nâ€Ce aleg de azi, pentru mine?â€\n   * Ce meritÄƒ sÄƒ las sÄƒ plece?\n   * Ce Ã®mi iau ca Ã®nvÄƒÈ›ÄƒturÄƒ de Ã®ncredere Ã®n viaÈ›Äƒ?\n   * Ce ritual zilnic/mic obicei pot Ã®ncepe pentru a onora aceastÄƒ transformare?\nRÄƒspuns: ________________\n\nVIII. (OpÈ›ional) ğŸ“œ SCRISOARE-RITUAL\nScrie o scrisoare cÄƒtre... (persoana, partea din tine, situaÈ›ia):\nRÄƒspuns: ________________\n`
            }
        ];


    // StÄƒri pentru Chat
    let chatSession = null;
    const CHAT_HISTORY_DOC_ID_PREFIX = "chatHistory_"; // PÄƒstrÄƒm prefixul pentru compatibilitate dacÄƒ e nevoie
    let isChatInitialized = false;

    // --- FUNCÈšIA PRINCIPALÄ‚ DE INTRARE (ONLOAD) ---
    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        // IniÈ›ializare tab-uri
        document.getElementById('tabButtonJurnal').addEventListener('click', () => showTab('jurnal'));
        document.getElementById('tabButtonFisa').addEventListener('click', () => showTab('fisa'));
        showTab('jurnal'); // AfiÈ™eazÄƒ jurnalul ca default

        if (!collabId) {
            onAuthStateChanged(auth, async (user) => {
                currentUserId = user ? user.uid : null;
                const mainContentArea = document.getElementById('mainContentArea');
                const cardsContainerArea = document.getElementById('cardsContainerArea');
                const toggleChatBtn = document.getElementById("toggleChatButton"); // Unificat
                const chatContainer = document.getElementById("chatContainer"); // Unificat

                if (user) {
                    if (mainContentArea) mainContentArea.style.display = '';
                    if (cardsContainerArea) cardsContainerArea.style.display = '';
                    if (toggleChatBtn) toggleChatBtn.style.display = 'flex';
                    
                    console.log("Utilizator autentificat (aplicaÈ›ie unificatÄƒ):", user.uid);
                    initializeFisaFormFunctionality();
                    initializeJurnalFormFunctionality();

                    if (!dataAlreadyLoaded) {
                        incarcaToateIntrospectiile(user.uid);
                        dataAlreadyLoaded = true;
                    }
                } else {
                    console.log("Utilizator neautentificat, redirecÈ›ionare...");
                    if (mainContentArea) mainContentArea.style.display = 'none';
                    if (cardsContainerArea) cardsContainerArea.style.display = 'none';
                    if (toggleChatBtn) toggleChatBtn.style.display = 'none';
                    if (chatContainer) chatContainer.style.display = 'none';
                    isChatInitialized = false;
                    chatSession = null;
                    window.location.href = "login.html"; // AsigurÄƒ-te cÄƒ ai o paginÄƒ de login
                }
            });
   //     } else { // Mod Colaborare
   //         document.body.classList.add("collab-view");
   //         document.getElementById('mainContentArea').style.display = 'none'; // Ascunde formularele
   //         document.getElementById('cardsContainerArea').style.display = ''; // AfiÈ™eazÄƒ cardurile
   //         document.getElementById('generateLinkButton')?.style.display = 'none';
   //         document.getElementById('toggleChatButton').style.display = 'none';
   //         document.getElementById('chatContainer').style.display = 'none';
   //         const collabTitle = document.getElementById('collabViewTitle');
   //         if(collabTitle) collabTitle.style.display = 'block';


            setTimeout(async () => {
                const pin = prompt("IntroduceÈ›i codul PIN pentru a vizualiza introspecÈ›iile partajate:");
                if (!pin) { alert("PIN-ul este necesar. RedirecÈ›ionare."); window.location.href = "login.html"; return; }
                try {
                    const collabDocRef = doc(db, "collaborations", collabId); // ColecÈ›ia 'collaborations' rÄƒmÃ¢ne aceeaÈ™i
                    const collabSnapshot = await getDoc(collabDocRef);
                    if (collabSnapshot.exists()) {
                        const collabData = collabSnapshot.data();
                        if (collabData.pin === pin) {
                            document.title = "Vizualizare PartajatÄƒ - IntrospecÈ›ii";
                             if(collabTitle) collabTitle.textContent = `IntrospecÈ›ii Partajate (Vizualizare)`;
                            await incarcaToateIntrospectiile(collabData.owner, collabId); // Trimitem collabId pentru context
                        } else { alert("PIN incorect. RedirecÈ›ionare."); window.location.href = "login.html"; }
                    } else { alert("Link invalid/expirat. RedirecÈ›ionare."); window.location.href = "login.html"; }
                } catch (error) {
                    console.error("Eroare accesare date colaborare:", error);
                    alert("Eroare accesare date. VerificaÈ›i link/PIN. RedirecÈ›ionare."); window.location.href = "login.html";
                }
            }, 100);
        }

        // Event listenere globale (chat, generare link)
        document.getElementById("toggleChatButton")?.addEventListener("click", handleToggleChat);
        document.getElementById("sendChatMessageButton")?.addEventListener("click", handleSendChatMessage);
        document.getElementById("chatInput")?.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                handleSendChatMessage();
            }
        });
        document.getElementById("generateLinkButton")?.addEventListener("click", generateCollaborationLink);
    };

    // --- FUNCÈšII DE NAVIGARE TAB-URI ---
    function showTab(tabName) {
        document.getElementById('jurnalFormContainer').style.display = (tabName === 'jurnal' ? 'block' : 'none');
        document.getElementById('fisaFormContainer').style.display = (tabName === 'fisa' ? 'block' : 'none');

        document.getElementById('tabButtonJurnal').classList.toggle('active', tabName === 'jurnal');
        document.getElementById('tabButtonFisa').classList.toggle('active', tabName === 'fisa');
        
        // Ascunde mesajele de confirmare la schimbarea tab-ului
        document.getElementById('jurnalConfirmationMessage').style.display = 'none';
        document.getElementById('fisaConfirmationMessage').style.display = 'none';
    }

    // --- FUNCÈšII SPECIFICE FIÈ˜EI TERAPEUTICE ---
    function initializeFisaFormFunctionality() {
        const formSteps = document.querySelectorAll('form#fisaExercitiuForm div.question-card.form-step');
        if (formSteps.length > 0) {
            totalFisaSteps = formSteps.length;
            formSteps.forEach((step, index) => {
                step.classList.toggle('form-step-active', index === 0);
            });
            currentFisaStep = 1;
            updateFisaProgressBar();
        } else {
            totalFisaSteps = 0;
        }
        document.getElementById("fisaNextButton")?.addEventListener("click", fisaNextStep);
        document.getElementById("fisaPrevButton")?.addEventListener("click", fisaPreviousStep);
        document.getElementById("fisaAddButton")?.addEventListener("click", salveazaIntrospectieFisa);
    }

    function fisaNextStep() {
        if (currentFisaStep < totalFisaSteps) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep++;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function fisaPreviousStep() {
        if (currentFisaStep > 1) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep--;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function updateFisaProgressBar() {
        const progress = document.getElementById('fisaProgress');
        if (progress && totalFisaSteps > 0) {
            progress.style.width = (currentFisaStep / totalFisaSteps) * 100 + '%';
        }
    }

    async function salveazaIntrospectieFisa() {
        const form = document.getElementById("fisaExercitiuForm");
        const confirmationMessage = document.getElementById('fisaConfirmationMessage');

        if (form && !form.checkValidity()) {
            form.reportValidity();
            const currentStepElement = form.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid:not(fieldset)');
            if (firstInvalidField) {
                firstInvalidField.focus();
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii din pasul curent Ã®nainte de a salva.");
            } else {
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii.");
            }
            return;
        }

        const continutFisa = {};
        if (form) {
            const formData = new FormData(form);
            formData.forEach((value, key) => { continutFisa[key] = value.trim(); });
        } else {
            console.error("Formularul 'fisaExercitiuForm' nu a fost gÄƒsit.");
            return;
        }

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'fisa',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutFisa
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sÄƒ fiÈ›i autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const addButton = document.getElementById("fisaAddButton");
        let originalAddButtonText = "";
        if (addButton) {
            originalAddButtonText = addButton.textContent;
            addButton.textContent = "Se salveazÄƒ È™i se genereazÄƒ...";
            addButton.disabled = true;
        }
        if (confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id; // AdaugÄƒ ID-ul pentru generarea feedback-ului
            if (addButton) addButton.textContent = "Se genereazÄƒ AI...";

            const feedbackGenerat = await genereazaFeedbackPentruIntrospectie(introspectieData);
            
            const docSnapshot = await getDoc(docRef); // Re-fetch pentru a avea È™i feedback-ul salvat
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                // Fallback dacÄƒ doc-ul nu e imediat vizibil (puÈ›in probabil)
                introspectieData.feedbackAI_history = feedbackGenerat && !feedbackGenerat.error ? [feedbackGenerat] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            if (form) {
                form.reset(); currentFisaStep = 1;
                form.querySelectorAll('.form-step').forEach(step => step.classList.remove('form-step-active'));
                const firstStepEl = document.getElementById('fisa-step-1');
                if (firstStepEl) firstStepEl.classList.add('form-step-active');
                updateFisaProgressBar();
            }

            if (confirmationMessage) {
                if (feedbackGenerat && !feedbackGenerat.error && !feedbackGenerat.error_parsing) {
                    confirmationMessage.textContent = 'FiÈ™a a fost salvatÄƒ È™i feedback-ul AI generat cu succes!';
                    confirmationMessage.className = 'confirmation-message success';
                } else if (feedbackGenerat && (feedbackGenerat.error || feedbackGenerat.error_parsing)) {
                    confirmationMessage.textContent = `FiÈ™a salvatÄƒ. Feedback AI: ${feedbackGenerat.rawText || 'ProblemÄƒ la generare/parsare.'}`;
                    confirmationMessage.className = (feedbackGenerat.rawText && feedbackGenerat.rawText.toLowerCase().includes("limit")) ? 'confirmation-message warning' : 'confirmation-message error';
                } else {
                    confirmationMessage.textContent = 'FiÈ™a salvatÄƒ, dar feedback-ul AI nu a putut fi generat/procesat.';
                    confirmationMessage.className = 'confirmation-message error';
                }
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if (confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea fiÈ™ei sau generare feedback:", error);
            if (confirmationMessage) {
                confirmationMessage.textContent = 'Eroare la salvarea fiÈ™ei. ÃncercaÈ›i din nou.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            if (addButton) {
                addButton.textContent = originalAddButtonText;
                addButton.disabled = false;
            }
        }
    }

    // --- FUNCÈšII SPECIFICE JURNALULUI GHIDAT ---
    function initializeJurnalFormFunctionality() {
        const promptsContainerEl = document.getElementById("reflectionPrompts");
        const journalTextarea = document.getElementById("journalContent");
        if (!promptsContainerEl || !journalTextarea) return;

        promptsContainerEl.innerHTML = '';
        jurnalPromptsList.forEach(prompt => {
            const button = document.createElement("button");
            button.textContent = prompt.label;
            button.className = "prompt-button";
            button.type = "button";
            button.title = "AfiÈ™eazÄƒ acest ghid È™i foloseÈ™te-l ca referinÈ›Äƒ";
            button.onclick = () => {
                toggleActiveJurnalPrompt(true, prompt);
                journalTextarea.focus();
            };
            promptsContainerEl.appendChild(button);
        });
        document.getElementById("saveJournalEntryButton")?.addEventListener("click", salveazaIntrospectieJurnal);
    }

    function toggleActiveJurnalPrompt(show, promptData = null) {
        const box = document.getElementById('activeJurnalPromptBox');
        const titleEl = document.getElementById('activeJurnalPromptTitle');
        const contentEl = document.getElementById('activeJurnalPromptContent');
        const journalTextarea = document.getElementById("journalContent");

        if (show && promptData) {
            selectedJurnalPrompt = promptData;
            if(titleEl) titleEl.textContent = `Ghid activ: ${promptData.label}`;
            if(contentEl) contentEl.textContent = promptData.text;
            if(box) box.style.display = 'block';
            if (contentEl) contentEl.scrollTop = 0;
            
            if (journalTextarea && journalTextarea.value.trim() !== "" && promptData.id !== (selectedJurnalPrompt?.previousIdForClearCheck)) {
                if (confirm("DoreÈ™ti sÄƒ È™tergi conÈ›inutul actual al jurnalului pentru a Ã®ncepe cu acest nou ghid?")) {
                   journalTextarea.value = "";
                }
            }
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = promptData.id;

        } else {
            selectedJurnalPrompt = null;
            if(box) box.style.display = 'none';
        }
    }
    
    // FuncÈ›ie globalÄƒ pentru butonul de Ã®nchidere al prompt boxului de jurnal
    window.hideActiveJurnalPromptManual = function() {
        const box = document.getElementById('activeJurnalPromptBox');
        if(box) box.style.display = 'none';
        // Nu resetÄƒm selectedJurnalPrompt aici, utilizatorul poate doar ascunde temporar.
    }

    async function salveazaIntrospectieJurnal() {
        const journalTextarea = document.getElementById("journalContent");
        const journalTitleInput = document.getElementById("journalTitle");
        const confirmationMessage = document.getElementById('jurnalConfirmationMessage');

        if (!journalTextarea || journalTextarea.value.trim() === "") {
            alert("VÄƒ rugÄƒm sÄƒ scrieÈ›i ceva Ã®n jurnal Ã®nainte de a salva.");
            return;
        }

        const tipPromptFolosit = selectedJurnalPrompt ? selectedJurnalPrompt.id : "prompt_personalizat";

        const continutJurnal = {
            titluJurnal: (journalTitleInput?.value.trim() !== "") ? journalTitleInput.value.trim() : `Intrare din ${new Date().toLocaleDateString("ro-RO")}`,
            textJurnal: journalTextarea.value,
            promptUtilizatJurnal: tipPromptFolosit
        };

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'jurnal',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutJurnal
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sÄƒ fiÈ›i autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const saveButton = document.getElementById("saveJournalEntryButton");
        const originalButtonText = saveButton.textContent;
        saveButton.textContent = "Se salveazÄƒ..."; saveButton.disabled = true;
        if(confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id;
            saveButton.textContent = "Se genereazÄƒ AI...";

            const parsedFeedback = await genereazaFeedbackPentruIntrospectie(introspectieData);

            const docSnapshot = await getDoc(docRef);
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                introspectieData.feedbackAI_history = parsedFeedback && !parsedFeedback.error ? [parsedFeedback] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            journalTextarea.value = "";
            if (journalTitleInput) journalTitleInput.value = "";
            toggleActiveJurnalPrompt(false); // Ascunde ghidul activ
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = null;

            if(confirmationMessage) {
                confirmationMessage.textContent = parsedFeedback.error ? `Intrare salvatÄƒ. Feedback AI: ${parsedFeedback.rawText}` : 'Intrare salvatÄƒ È™i feedback AI generat!';
                confirmationMessage.className = `confirmation-message ${parsedFeedback.error ? 'error' : 'success'}`;
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if(confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea intrÄƒrii de jurnal sau generare feedback:", error);
            if(confirmationMessage){
                confirmationMessage.textContent = 'Eroare la salvare sau la generarea feedback-ului AI.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            saveButton.textContent = originalButtonText;
            saveButton.disabled = false;
        }
    }


    // --- FUNCÈšII COMUNE PENTRU FEEDBACK AI ---
    async function callGeminiAPI(promptText, modelToUse, generationConfigOptions = {}) {
        if (!modelToUse) {
            console.error("Modelul Gemini specificat este invalid sau neiniÈ›ializat.");
            return "EROARE: Model AI neiniÈ›ializat. VerificÄƒ cheia API.";
        }
        try {
            console.log(`Trimitem la Gemini (${modelToUse === geminiModelChat ? "Chat" : (modelToUse === geminiModelFisaFeedback ? "FiÈ™Äƒ" : "Jurnal") }, primele 200 caractere):`, promptText.substring(0, 200));
            const requestPayload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }],
                generationConfig: { temperature: 0.6, maxOutputTokens: 4000, ...generationConfigOptions } // Temp ajustatÄƒ
            };
            const result = await modelToUse.generateContent(requestPayload);
            const response = result.response;

            if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                if (response.candidates[0].finishReason && !["STOP", "MAX_TOKENS"].includes(response.candidates[0].finishReason)) {
                    console.warn("Gemini a oprit generarea prematur:", response.candidates[0].finishReason, response.candidates[0].safetyRatings);
                    return `EROARE Gemini: Generare opritÄƒ (Motiv: ${response.candidates[0].finishReason}). Detalii: ${JSON.stringify(response.candidates[0].safetyRatings || 'N/A')}`;
                }
                return response.candidates[0].content.parts[0].text;
            } else if (response?.promptFeedback?.blockReason) {
                console.error("Prompt blocat de Gemini:", response.promptFeedback.blockReasonDetail || response.promptFeedback.blockReason);
                 return `EROARE Gemini: Prompt blocat (Motiv: ${response.promptFeedback.blockReason}). Detalii: ${JSON.stringify(response.promptFeedback.blockReasonDetail || response.promptFeedback.safetyRatings || 'N/A')}`;
            } else {
                console.error("RÄƒspuns Gemini neaÈ™teptat sau gol:", JSON.stringify(response, null, 2));
                return "EROARE Gemini: RÄƒspuns invalid sau gol de la API.";
            }
        } catch (error) {
            console.error("Eroare detaliatÄƒ la callGeminiAPI:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare API necunoscutÄƒ"}`;
             if (error.toString().toLowerCase().includes("api key not valid") ||
                (error.message && error.message.toLowerCase().includes("permission denied")) ||
                (error.message && error.message.toLowerCase().includes("api_key_invalid")) ||
                (error.status && error.status === 403)) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validÄƒ sau nu are permisiuni. VerificÄƒ restricÈ›iile din Google Cloud Console È™i cheia din cod. AsigurÄƒ-te cÄƒ domeniul " + (typeof window !== 'undefined' ? window.location.hostname : '') + " este permis.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare (posibil gratuitÄƒ) a API-ului Gemini a fost depÄƒÈ™itÄƒ. ÃncearcÄƒ mai tÃ¢rziu.";
            } else if (error.message && (error.message.toLowerCase().includes("candidate.finish_reason") || error.message.toLowerCase().includes("safety") || error.message.toLowerCase().includes("blocked due to safety_settings"))) {
                errorMessage = "EROARE Gemini: Generarea a fost opritÄƒ (posibil din motive de siguranÈ›Äƒ, conÈ›inut inadecvat, sau alte restricÈ›ii ale modelului). ÃncercaÈ›i un prompt diferit sau ajustaÈ›i setÄƒrile de siguranÈ›Äƒ dacÄƒ aveÈ›i acces.";
            }  else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 let modelName = "necunoscut";
                 if (modelToUse === geminiModelFisaFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_FISA;
                 else if (modelToUse === geminiModelJurnalFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_JURNAL;
                 else if (modelToUse === geminiModelChat) modelName = GEMINI_MODEL_NAME_CHAT;
                 errorMessage = `EROARE Gemini: Modelul specificat (${modelName}) nu a fost gÄƒsit sau nu este suportat. VerificÄƒ numele modelului.`;
            }
            return errorMessage;
         }
    }

    function buildAdaptiveAIPromptFisa(introspectieData) {
        const rowData = introspectieData.continut; // ConÈ›inutul fiÈ™ei
        // PÄƒstrÄƒm promptul original pentru fiÈ™e
        return `
AnalizeazÄƒ Ã®n profunzime aceastÄƒ fiÈ™Äƒ completÄƒ de auto-reflecÈ›ie. Utilizatorul a parcurs un exerciÈ›iu detaliat pentru a-È™i Ã®nÈ›elege o situaÈ›ie specificÄƒ. OferÄƒ feedback psihologic structurat, empatic È™i acÈ›ionabil. RespectÄƒ cu stricteÈ›e formatul È™i ordinea secÈ›iunilor de mai jos, folosind exact prefixele indicate (ex: \`EmpatieIniÈ›ialÄƒ:\`, \`PuncteForteObservate:\`). FoloseÈ™te Markdown pentru formatarea textului Ã®n interiorul fiecÄƒrei secÈ›iuni (ex: \`**Text bold**\`, \`*Text italic*\`, liste cu \`* Element\`).

**Datele Complete din FiÈ™a de ReflecÈ›ie a Utilizatorului:**

**SecÈ›iunea 1: Explorarea SituaÈ›iei È™i a Nevoilor**
*   Care este situaÈ›ia?: ${rowData.situatie || 'N/A'}
*   Ce Ã®mi trece prin minte (gÃ¢nduri automate)?: ${rowData.ganduri || 'N/A'}
*   Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt (emoÈ›ii)?: ${rowData.emotii || 'N/A'}
*   Ce mod este activ?: ${rowData.mod_activ || 'N/A'}
*   Ce comportament simÈ›i cÄƒ adopÈ›i?: ${rowData.comportament || 'N/A'}
*   Care sunt nevoile tale mai profunde?: ${rowData.nevoi_profunde || 'N/A'}
*   MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?: ${rowData.ajutor_comportament || 'N/A'}
*   Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos (perspectiva utilizatorului)?: ${rowData.adult_sanatos || 'N/A'}

**SecÈ›iunea 2: Analiza GÃ¢ndurilor È™i a PercepÈ›iilor**
*   Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?: ${rowData.dovezi_adevar || 'N/A'}
*   Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?: ${rowData.dovezi_fals || 'N/A'}
*   ExistÄƒ o explicaÈ›ie alternativÄƒ?: ${rowData.explicatie_alternativa || 'N/A'}
*   Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?: ${rowData.scenariu_negativ || 'N/A'}
*   Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?: ${rowData.scenariu_optimist || 'N/A'}
*   Care este cel mai realist rezultat?: ${rowData.rezultat_realist || 'N/A'}
*   Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?: ${rowData.schimbare_gandire || 'N/A'}
*   Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?: ${rowData.sfat_prieten || 'N/A'}

**SecÈ›iunea 3: ÃntrebÄƒri pentru Claritate È™i ReflecÈ›ie SuplimentarÄƒ**
*   VÄƒd doar partea rea a lucrurilor?: ${rowData.partea_rea || 'N/A'}
*   Ãmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?: ${rowData.responsabilitate || 'N/A'}
*   MÄƒ condamn Ã®n baza unui singur eveniment?: ${rowData.condamnare || 'N/A'}
*   Privesc situaÈ›ia Ã®n termeni extremi (alb/negru)?: ${rowData.termeni_extremi || 'N/A'}
*   Exagerez situaÈ›ia?: ${rowData.exagerare || 'N/A'}
*   ExistÄƒ È™i alÈ›i factori responsabili?: ${rowData.factori_responsabili || 'N/A'}
*   Am sÄƒrit direct la concluzii?: ${rowData.concluzii || 'N/A'}
*   Ãmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?: ${rowData.intrebari_fara_raspuns || 'N/A'}
*   MÄƒ concentrez doar asupra slÄƒbiciunilor mele?: ${rowData.slabiciuni || 'N/A'}
*   MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?: ${rowData.cum_ar_trebui || 'N/A'}
*   MÄƒ aÈ™tept sÄƒ fiu perfect?: ${rowData.perfectiune || 'N/A'}

**CERINÈšE PENTRU FEEDBACK-UL AI (foloseÈ™te prefixele EXACT aÈ™a cum sunt scrise È™i formatarea Markdown Ã®n interiorul rÄƒspunsurilor):**

EmpatieIniÈ›ialÄƒ: (1-2 propoziÈ›ii empatice scurte, recunoscÃ¢nd efortul utilizatorului.)
PuncteForteObservate: (IdentificÄƒ 1-2 aspecte pozitive sau de auto-conÈ™tientizare observate Ã®n rÄƒspunsurile utilizatorului.)
TiparePrincipale: (Descrie succint 1-3 tipare de gÃ¢ndire/emoÈ›ionale/comportamentale centrale care reies din fiÈ™Äƒ.)
ConexiuniCheie: (SintetizeazÄƒ legÄƒtura S-G-E-C-N (SituaÈ›ie-GÃ¢nd-EmoÈ›ie-Comportament-Nevoie) specificÄƒ acestei fiÈ™e, bazÃ¢ndu-te pe rÄƒspunsurile la '${rowData.ganduri}', '${rowData.emotii}', '${rowData.comportament}', '${rowData.nevoi_profunde}'.)
DistorsiuniIdentificate: (IdentificÄƒ 2-3 distorsiuni cognitive principale din rÄƒspunsuri. Pentru fiecare:
*   Numele Distorsiunii (ex: \`**Catastrofizare**\`)
*   O scurtÄƒ explicaÈ›ie a distorsiunii (1 propoziÈ›ie).
*   Un exemplu specific din rÄƒspunsurile utilizatorului care ilustreazÄƒ distorsiunea.
*   O Ã®ntrebare de contestare sau reflecÈ›ie pentru acea distorsiune (ex: "*Cum ar arÄƒta o perspectivÄƒ mai echilibratÄƒ asupra X?*").
ListeazÄƒ fiecare distorsiune ca un sub-punct separat.)
SchemeActivate: (SugereazÄƒ 1-2 scheme cognitive maladaptative timpurii care par a fi activate de situaÈ›ia descrisÄƒ (ex: Defectivitate/RuÈ™ine, Abandon, Deprivare EmoÈ›ionalÄƒ etc.). Pentru fiecare:
*   Numele Schemei (ex: \`**Schema de EÈ™ec**\`)
*   O scurtÄƒ descriere a cum se manifestÄƒ Ã®n general acea schemÄƒ (1-2 propoziÈ›ii).
*   Cum ar putea rÄƒspunsurile utilizatorului din aceastÄƒ fiÈ™Äƒ (gÃ¢nduri, emoÈ›ii, comportamente) sÄƒ reflecte activarea acestei scheme?
Fii speculativ È™i empatic, nu conclusiv. PrezintÄƒ ca sub-puncte.)
ModuriImplicate: (SugereazÄƒ pe scurt ce moduri din Terapia Schemelor ar putea fi active sau implicate, pe lÃ¢ngÄƒ cel menÈ›ionat de utilizator, dacÄƒ este cazul. Ex: Copil Vulnerabil, PÄƒrinte Punitiv, Protector DetaÈ™at. Fii concis.)
PerspectivaAdultSÄƒnÄƒtos: (ComenteazÄƒ rÄƒspunsul utilizatorului despre cum ar acÈ›iona Adultul SÄƒnÄƒtos ('${rowData.adult_sanatos}'). Este realist? Compasional? OferÄƒ sugestii pentru a Ã®ntÄƒri È™i mai mult aceastÄƒ perspectivÄƒ, incluzÃ¢nd:
    *   Cum ar putea Adultul SÄƒnÄƒtos sÄƒ interpreteze situaÈ›ia diferit?
    *   Ce gÃ¢nduri alternative ar putea cultiva?
    *   Cum ar gestiona emoÈ›iile Ã®ntr-un mod adaptativ?
    *   Ce comportamente constructive ar adopta pentru a-È™i Ã®mplini nevoile?
    *   Cum ar putea contracara activ schemele sau modurile disfuncÈ›ionale?)
ÃntrebareFinalÄƒReflecÈ›ie: (O Ã®ntrebare generalÄƒ, puternicÄƒ È™i deschisÄƒ, care sÄƒ Ã®ncurajeze utilizatorul sÄƒ integreze Ã®nvÄƒÈ›Äƒmintele din aceastÄƒ fiÈ™Äƒ Ã®n viaÈ›a sa de zi cu zi sau sÄƒ reflecteze la un aspect mai larg.)
SugestieMicPas: (O sugestie concretÄƒ, micÄƒ È™i realizabilÄƒ, pentru un pas pe care utilizatorul l-ar putea face Ã®n urmÄƒtoarele zile pentru a exersa o abilitate nouÄƒ, a contesta un gÃ¢nd, sau a acÈ›iona din perspectiva Adultului SÄƒnÄƒtos, bazat pe analiza fiÈ™ei.)
ÃncurajareFinalÄƒ: (1-2 propoziÈ›ii de Ã®ncurajare, validare È™i speranÈ›Äƒ.)

RÄƒspunde doar cu textul cerut conform structurii, fÄƒrÄƒ introduceri ("IatÄƒ feedback-ul...") sau concluzii suplimentare ("Sper cÄƒ acest feedback..."), Ã®n afara celor specificate. AsigurÄƒ-te cÄƒ fiecare secÈ›iune Ã®ncepe exact cu prefixul dat (ex: \`EmpatieIniÈ›ialÄƒ:\`).`;
    }

    function buildAdaptiveAIPromptJurnal(introspectieData) {
        const { titluJurnal, textJurnal, promptUtilizatJurnal } = introspectieData.continut;
        let specificInstructions = "";
        let modelFocus = "feedback general È™i reflecÈ›ie";
        let guideText = null;

        const ghidGasit = jurnalPromptsList.find(p => p.id === promptUtilizatJurnal);
        if (ghidGasit) {
            guideText = ghidGasit.text;
        }

        let basePrompt = `EÈ™ti PsihoGPT â€“ un terapeut AI avansat, extrem de empatic, cu o profundÄƒ Ã®nÈ›elegere a psihologiei umane, antrenat Ã®n Terapie Cognitiv-ComportamentalÄƒ (TCC), Terapia Schemelor, Terapia prin Acceptare È™i Angajament (ACT), Scrierea ExpresivÄƒ È™i principii de mindfulness. ComunicÄƒ Ã®ntr-un limbaj cald, validant È™i uÈ™or de Ã®nÈ›eles, dar pÄƒstreazÄƒ profunzimea analiticÄƒ. FoloseÈ™te formatare Markdown pentru structurare (titluri principale cu \`**Titlu Principal**\`, subtitluri dacÄƒ e cazul cu \`### Subtitlu\`, liste cu \`* Element listÄƒ\`, text bold cu \`**text bold**\` È™i italic cu \`*text italic*\` unde e cazul). EvitÄƒ citatele direct din literaturÄƒ dacÄƒ nu sunt absolut esenÈ›iale, concentreazÄƒ-te pe limbajul tÄƒu.

Obiectivul tÄƒu este sÄƒ oferi un feedback personalizat, constructiv È™i profund pentru urmÄƒtoarea intrare Ã®n jurnal. Nu oferi sfaturi medicale sau diagnostice. ConcentreazÄƒ-te pe facilitarea auto-Ã®nÈ›elegerii È™i a creÈ™terii personale. Utilizatorul a avut la dispoziÈ›ie un ghid vizual (tipul: "${promptUtilizatJurnal}") pentru a-È™i structura gÃ¢ndurile, iar textul de mai jos reprezintÄƒ rÄƒspunsurile sale la acel ghid sau o reflecÈ›ie liberÄƒ inspiratÄƒ de el.`;

        switch (promptUtilizatJurnal) {
            case "ritual_reconstructie":
                specificInstructions = `Utilizatorul a folosit ghidul "Ritual de ReconstrucÈ›ie InterioarÄƒ", care are 7 secÈ›iuni principale (I. InvitaÈ›ie la Autenticitate, II. Containere EmoÈ›ionale, III. Decodificare NarativÄƒ, IV. Integrare ExplicativÄƒ, V. Compasiune È™i BlÃ¢ndeÈ›e, VI. Reconfigurare IdentitarÄƒ, VII. Actul Sacru de Alegere) È™i poate o secÈ›iune VIII (Scrisoare-Ritual). Feedback-ul tÄƒu AR TREBUI SÄ‚ URMEZE ACEASTÄ‚ STRUCTURÄ‚. Pentru FIECARE secÈ›iune a ritualului (I-VII È™i opÈ›ional VIII):
1.  **NumeÈ™te secÈ›iunea clar** (ex: \`**I. InvitaÈ›ie la Autenticitate:**\`).
2.  Pe baza textului utilizatorului (\`Text Complet Jurnal Utilizator\` de mai jos), **extrage È™i reflectÄƒ** ce a scris sau ce pare sÄƒ fi explorat pentru ACEASTÄ‚ secÈ›iune specificÄƒ. Fii concis È™i la obiect. DacÄƒ utilizatorul nu pare sÄƒ fi adresat o secÈ›iune, menÈ›ioneazÄƒ scurt sau sari peste ea.
3.  **OferÄƒ o scurtÄƒ validare empaticÄƒ** dacÄƒ a completat ceva relevant pentru secÈ›iune.
4.  **Pune 1-2 Ã®ntrebÄƒri de aprofundare SPECIFICE** pentru acea secÈ›iune.
DupÄƒ ce ai parcurs secÈ›iunile individuale, adaugÄƒ o secÈ›iune de \`**### Concluzii È™i ReflecÈ›ii Finale:**\`
*   **Sinteza Conexiunilor:** IdentificÄƒ 1-2 conexiuni sau teme generale.
*   **Ãncurajare È™i PaÈ™i UrmÄƒtori:** ÃncurajeazÄƒ procesul de transformare.`;
                modelFocus = "analizÄƒ structuratÄƒ a ritualului de reconstrucÈ›ie.";
                break;
            case "dialog_voce_critica":
                specificInstructions = `Utilizatorul a folosit ghidul "Dialog Voce CriticÄƒ". AnalizeazÄƒ rÄƒspunsurile È™i structureazÄƒ feedback-ul:
1.  **\`**Validare EmpaticÄƒ IniÈ›ialÄƒ:\`**
2.  **\`**Analiza Mesajului Critic:\`**
3.  **\`**Impactul EmoÈ›ional È™i Corporal:\`**
4.  **\`**Originea Vocii (dacÄƒ e exploratÄƒ):\`**
5.  **\`**Nevoia NeÃ®mplinitÄƒ:\`**
6.  **\`**ForÈ›a Adultului SÄƒnÄƒtos:\`**
7.  **\`**### ÃntrebÄƒri de Aprofundare È™i DirecÈ›ii:\`** (1-2 Ã®ntrebÄƒri)
8.  **\`**NotÄƒ despre Scheme (opÈ›ional):\`**`;
                modelFocus = "analizÄƒ dialog voce criticÄƒ, cultivarea Adultului SÄƒnÄƒtos.";
                break;
            case "explorare_emotie":
                specificInstructions = `Utilizatorul a folosit ghidul "ExploreazÄƒ o emoÈ›ie". Feedback-ul parcurge paÈ™ii:
1.  **\`**Validarea EmoÈ›iei Denumite:\`**
2.  **\`**Conexiunea Corp-EmoÈ›ie:\`**
3.  **\`**RelaÈ›ia GÃ¢nduri-EmoÈ›ie:\`**
4.  **\`**Contextul È™i DeclanÈ™atorul:\`**
5.  **\`**Nevoia FundamentalÄƒ SemnalatÄƒ:\`**
6.  **\`**Gestul de Auto-Compasiune:\`**
7.  **\`**### ReflecÈ›ii Suplimentare È™i ÃntrebÄƒri:\`** (1-2 Ã®ntrebÄƒri)`;
                modelFocus = "analizÄƒ explorare emoÈ›ie, Ã®nÈ›elegere profundÄƒ.";
                break;
            case "recunostinta_resurse":
                specificInstructions = `Utilizatorul a folosit "RecunoÈ™tinÈ›Äƒ & Resurse". StructureazÄƒ:
1.  **\`**Aprecierea Practicii RecunoÈ™tinÈ›ei:\`**
2.  **\`**ObservaÈ›ii asupra Elementelor de RecunoÈ™tinÈ›Äƒ:\`**
3.  **\`**Explorarea Resursei Interioare:\`**
4.  **\`**Impactul Gestului de Auto-Ãngrijire:\`**
5.  **\`**### ÃntrebÄƒri pentru Consolidare:\`** (1-2 Ã®ntrebÄƒri)`;
                modelFocus = "Ã®ncurajare recunoÈ™tinÈ›Äƒ, conectare resurse.";
                break;
            case "analiza_situatie":
                specificInstructions = `Utilizatorul a folosit "AnalizeazÄƒ o situaÈ›ie". ReflectÄƒ structura:
1.  **\`**RecunoaÈ™terea Efortului Analitic:\`**
2.  **\`**SituaÈ›ia È™i Faptele:\`**
3.  **\`**Interpretarea IniÈ›ialÄƒ È™i EmoÈ›iile:\`**
4.  **\`**Puterea ReÃ®ncadrÄƒrii (Reframing):\`**
5.  **\`**LecÈ›ii ÃnvÄƒÈ›ate:\`**
6.  **\`**### ÃntrebÄƒri pentru AcÈ›iune È™i Integrare:\`** (1-2 Ã®ntrebÄƒri)`;
                modelFocus = "susÈ›inere analizÄƒ situaÈ›ie, reÃ®ncadrare, acÈ›iuni.";
                break;
            default: // prompt_personalizat
                specificInstructions = `Utilizatorul a scris o intrare liberÄƒ. Feedback empatic:
1.  **\`**Validare EmpaticÄƒ GeneralÄƒ:\`**
2.  **\`**Identificarea Temelor Centrale (1-2):\`**
3.  **\`**ReflecÈ›ie OglindÄƒ:\`**
4.  **\`**### ÃntrebÄƒri Deschise È™i Evocatoare (2-3):\`**
5.  **\`**Ãncurajare FinalÄƒ:\`**`;
                modelFocus = "reflecÈ›ie empaticÄƒ text liber, identificare teme, Ã®ntrebÄƒri deschise.";
                break;
        }

        const ghidReferintaText = guideText ? `\n\n--- TEXTUL GHIDULUI DE REFERINÈšÄ‚ (NU RÄ‚SPUNSURILE UTILIZATORULUI) ---\n\`\`\`\n${guideText}\n\`\`\`\nUtilizatorul a avut acest ghid afiÈ™at È™i a scris rÄƒspunsurile Ã®n secÈ›iunea "Text Complet Jurnal Utilizator" de mai jos.` : "\n\nUtilizatorul a scris liber sau detaliile specifice ale ghidului nu sunt furnizate aici; concentreazÄƒ-te pe rÄƒspunsurile utilizatorului È™i tipul de ghid general.";

        return `${basePrompt}
${ghidReferintaText}

**Focusul specific pentru aceastÄƒ intrare de jurnal (bazat pe ghidul "${promptUtilizatJurnal}") este: ${modelFocus}.**

**InstrucÈ›iuni specifice pentru feedback bazat pe tipul de ghid ("${promptUtilizatJurnal}"):**
${specificInstructions}
---
**INFORMAÈšII DESPRE INTRAREA UTILIZATORULUI:**
Titlu Jurnal: ${titluJurnal || "FÄƒrÄƒ titlu"}
Tipul de Ghid Utilizat (selectat de utilizator / detectat): ${promptUtilizatJurnal}

**TEXT COMPLET JURNAL UTILIZATOR (RÄ‚SPUNSURILE SALE):**
\`\`\`
${textJurnal}
\`\`\`
---
Te rog sÄƒ generezi un feedback AI detaliat, empatic È™i structurat conform instrucÈ›iunilor de mai sus, personalizat pe baza textului furnizat de utilizator. AsigurÄƒ-te cÄƒ respecÈ›i formatarea Markdown cerutÄƒ pentru lizibilitate. MulÈ›umesc!`;
    }

    async function genereazaFeedbackPentruIntrospectie(introspectieData) {
        if (!introspectieData || !introspectieData.id || !introspectieData.type || !introspectieData.continut) {
            console.error("Date incomplete pentru generarea feedback-ului:", introspectieData);
            return { rawText: "EROARE: Date incomplete pentru generare.", error: true, timestamp: new Date().toISOString() };
        }

        let promptText = "";
        let modelToUse = null;
        let modelNameForLog = "";

        if (introspectieData.type === 'fisa') {
            if (!geminiModelFisaFeedback) return { rawText: "EROARE: Modelul AI pentru fiÈ™e nu este disponibil.", error: true, timestamp: new Date().toISOString() };
            promptText = buildAdaptiveAIPromptFisa(introspectieData);
            modelToUse = geminiModelFisaFeedback;
            modelNameForLog = GEMINI_MODEL_NAME_FEEDBACK_FISA;
        } else if (introspectieData.type === 'jurnal') {
            if (!geminiModelJurnalFeedback) return { rawText: "EROARE: Modelul AI pentru jurnal nu este disponibil.", error: true, timestamp: new Date().toISOString() };
            promptText = buildAdaptiveAIPromptJurnal(introspectieData);
            modelToUse = geminiModelJurnalFeedback;
            modelNameForLog = GEMINI_MODEL_NAME_FEEDBACK_JURNAL;
        } else {
            return { rawText: "EROARE: Tip de introspecÈ›ie necunoscut.", error: true, timestamp: new Date().toISOString() };
        }

        const feedbackRawText = await callGeminiAPI(promptText, modelToUse);
        const parsedFeedback = {
            rawText: feedbackRawText,
            model: `Gemini (${modelNameForLog})`,
            timestamp: new Date().toISOString(),
            error: typeof feedbackRawText === 'string' && feedbackRawText.toUpperCase().startsWith("EROARE:"),
            error_parsing: false // IniÈ›ializÄƒm cu false
        };
        
        // Parsare specificÄƒ pentru fiÈ™e (dacÄƒ e cazul È™i nu e eroare)
        if (introspectieData.type === 'fisa' && !parsedFeedback.error) {
            const feedbackStructure = {
                empatie_initiala: /^EmpatieIniÈ›ialÄƒ:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                puncte_forte: /^PuncteForteObservate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                tipare_principale: /^TiparePrincipale:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                conexiuni_cheie: /^ConexiuniCheie:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                distorsiuni_identificate: /^DistorsiuniIdentificate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                scheme_activate: /^SchemeActivate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                moduri_implicate: /^ModuriImplicate:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                perspectiva_adult_sanatos: /^PerspectivaAdultSÄƒnÄƒtos:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                intrebare_finala_reflectie: /^ÃntrebareFinalÄƒReflecÈ›ie:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                sugestie_mic_pas: /^SugestieMicPas:\s*([\s\S]*?)(?=\n\S*?:|$)/im,
                incurajare_finala: /^ÃncurajareFinalÄƒ:\s*([\s\S]*?$)/im,
            };
            let allParsingOk = true;
            for (const key in feedbackStructure) {
                const match = feedbackRawText.match(feedbackStructure[key]);
                if (match && match[1] && match[1].trim() !== "") {
                     parsedFeedback[key] = match[1].trim(); // AdaugÄƒ cÃ¢mpurile parsate direct la obiectul parsedFeedback
                } else {
                    console.warn(`Feedback FiÈ™Äƒ: Nu s-a putut extrage sau este gol conÈ›inutul pentru: '${key}'`);
                    parsedFeedback[key] = `(SecÈ›iune neextrasÄƒ sau goalÄƒ: ${key})`;
                    allParsingOk = false;
                }
            }
            if (!allParsingOk) parsedFeedback.error_parsing = true;
        } else if (introspectieData.type === 'jurnal' && !parsedFeedback.error) {
            // Jurnalul nu are o structurÄƒ fixÄƒ de parsare a feedback-ului, aÈ™a cÄƒ `rawText` e suficient.
            // Poate fi adÄƒugat aici un cÃ¢mp 'promptTypeAtGeneration' dacÄƒ e relevant.
            parsedFeedback.promptTypeAtGeneration = introspectieData.continut.promptUtilizatJurnal || "necunoscut";
        }


        const docRef = doc(db, "introspectii", introspectieData.id);
        try {
            // SalvÄƒm Ã®ntregul obiect parsedFeedback Ã®n istoric
            await updateDoc(docRef, {
                feedbackAI_history: arrayUnion(parsedFeedback)
                // Nu mai salvÄƒm cÃ¢mpuri individuale `feedback_...` la rÄƒdÄƒcina documentului
                // `feedbackAI_latest` nu mai este necesar dacÄƒ citim mereu ultimul din history.
            });
            console.log(`Feedback AI (tip: ${introspectieData.type}) salvat pentru ${introspectieData.id}`);
        } catch (updateError) {
            console.error(`Eroare update Firestore feedback pentru ${introspectieData.id}:`, updateError);
        }
        return parsedFeedback;
    }


    // --- FUNCÈšII PENTRU GESTIONAREA CARDURILOR DE INTROSPECÈšIE ---
    async function incarcaToateIntrospectiile(userId, collabIdForLoad = null) {
        const container = document.getElementById("introspectiiCardContainer");
        if (!container || !userId) return;

        let loadingMsg = container.querySelector(".loading-message");
        if (!container.querySelector('.introspectie-card') && !loadingMsg && !collabIdForLoad) { // Nu afiÈ™a loading dacÄƒ e collab È™i deja are titlu
            loadingMsg = document.createElement("p");
            loadingMsg.className = "loading-message";
            loadingMsg.textContent = "Se Ã®ncarcÄƒ introspecÈ›iile...";
            container.appendChild(loadingMsg);
        }

        try {
            const q = query(collection(db, "introspectii"), where("ownerUid", "==", userId), orderBy("timestampCreare", "desc"));
            const querySnapshot = await getDocs(q);

            if (loadingMsg) loadingMsg.remove();
            container.innerHTML = ''; // CurÄƒÈ›Äƒm containerul Ã®nainte de a adÄƒuga/reÃ®ncÄƒrca

            if (querySnapshot.empty) {
                const noEntriesMsg = document.createElement("p");
                noEntriesMsg.className = "no-entries-message";
                noEntriesMsg.textContent = collabIdForLoad ? "Acest utilizator nu are Ã®ncÄƒ introspecÈ›ii partajate." : "Nicio introspecÈ›ie salvatÄƒ. Alege 'Jurnal' sau 'FiÈ™Äƒ' pentru a Ã®ncepe!";
                container.appendChild(noEntriesMsg);
            } else {
                querySnapshot.forEach((docSnap) => {
                    afiseazaCardIntrospectie({ id: docSnap.id, ...docSnap.data() });
                });
            }
             if (collabIdForLoad) {
                dataAlreadyLoaded = true; // MarcÄƒm cÄƒ datele de colaborare au fost Ã®ncÄƒrcate
                document.body.classList.add('collab-view-loaded');
            }

        } catch (error) {
            console.error("Eroare Ã®ncÄƒrcare introspecÈ›ii:", error);
            if (loadingMsg) loadingMsg.remove();
            if (!container.querySelector('.introspectie-card') && !container.querySelector('.error-loading-message')) {
                const errorMsgElement = document.createElement("p");
                errorMsgElement.className = "error-loading-message";
                errorMsgElement.textContent = "Eroare la Ã®ncÄƒrcarea introspecÈ›iilor.";
                container.appendChild(errorMsgElement);
            }
        }
    }

    function afiseazaCardIntrospectie(docData) {
        const container = document.getElementById("introspectiiCardContainer");
        let card = container.querySelector(`.introspectie-card[data-id="${docData.id}"]`);

        const entryDate = docData.dateAfisare || (docData.timestampCreare?.toDate ? new Date(docData.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'DatÄƒ necunoscutÄƒ');
        let cardTitle = "";
        let detailsContentHtml = "";

        if (docData.type === 'fisa') {
            cardTitle = `FiÈ™Äƒ ${entryDate} - ${(docData.continut.situatie || 'SituaÈ›ie nedefinitÄƒ').substring(0, 35)}...`;
            const c = docData.continut; // prescurtare
            detailsContentHtml = `
                <h4>Explorarea situaÈ›iei È™i a nevoilor</h4>
                <p><strong>SituaÈ›ia:</strong> ${c.situatie || 'N/A'}</p>
                <p><strong>GÃ¢nduri:</strong> ${c.ganduri || 'N/A'}</p>
                <p><strong>EmoÈ›ii:</strong> ${c.emotii || 'N/A'}</p>
                <p><strong>Mod activ:</strong> ${c.mod_activ || 'N/A'}</p>
                <p><strong>Comportament:</strong> ${c.comportament || 'N/A'}</p>
                <p><strong>Nevoile profunde:</strong> ${c.nevoi_profunde || 'N/A'}</p>
                <p><strong>Ajutor comportament:</strong> ${c.ajutor_comportament || 'N/A'}</p>
                <p><strong>Adultul SÄƒnÄƒtos:</strong> ${c.adult_sanatos || 'N/A'}</p>
                <hr>
                <h4>Analiza gÃ¢ndurilor È™i a percepÈ›iilor</h4>
                <p><strong>Dovezi adevÄƒr:</strong> ${c.dovezi_adevar || 'N/A'}</p>
                <p><strong>Dovezi fals:</strong> ${c.dovezi_fals || 'N/A'}</p>
                <p><strong>ExplicaÈ›ie alternativÄƒ:</strong> ${c.explicatie_alternativa || 'N/A'}</p>
                <p><strong>Scenariu negativ:</strong> ${c.scenariu_negativ || 'N/A'}</p>
                <p><strong>Scenariu optimist:</strong> ${c.scenariu_optimist || 'N/A'}</p>
                <p><strong>Rezultat realist:</strong> ${c.rezultat_realist || 'N/A'}</p>
                <p><strong>Schimbare gÃ¢ndire:</strong> ${c.schimbare_gandire || 'N/A'}</p>
                <p><strong>Sfat prieten:</strong> ${c.sfat_prieten || 'N/A'}</p>
                <hr>
                <h4>ÃntrebÄƒri pentru claritate</h4>
                <p><strong>Partea rea:</strong> ${c.partea_rea || 'N/A'}</p>
                <p><strong>Responsabilitate:</strong> ${c.responsabilitate || 'N/A'}</p>
                <p><strong>Condamnare:</strong> ${c.condamnare || 'N/A'}</p>
                <p><strong>Termeni extremi:</strong> ${c.termeni_extremi || 'N/A'}</p>
                <p><strong>Exagerare:</strong> ${c.exagerare || 'N/A'}</p>
                <p><strong>Factori responsabili:</strong> ${c.factori_responsabili || 'N/A'}</p>
                <p><strong>Concluzii:</strong> ${c.concluzii || 'N/A'}</p>
                <p><strong>ÃntrebÄƒri fÄƒrÄƒ rÄƒspuns:</strong> ${c.intrebari_fara_raspuns || 'N/A'}</p>
                <p><strong>SlÄƒbiciuni:</strong> ${c.slabiciuni || 'N/A'}</p>
                <p><strong>Cum ar trebui:</strong> ${c.cum_ar_trebui || 'N/A'}</p>
                <p><strong>PerfecÈ›iune:</strong> ${c.perfectiune || 'N/A'}</p>`;
        } else if (docData.type === 'jurnal') {
            cardTitle = `${docData.continut.titluJurnal || `Jurnal ${entryDate}`} ${(docData.continut.promptUtilizatJurnal && docData.continut.promptUtilizatJurnal !== 'prompt_personalizat' ? `(${docData.continut.promptUtilizatJurnal.replace(/_/g, ' ')})` : '(Scriere liberÄƒ)')}`;
            detailsContentHtml = `<p class="journal-entry-content-text-unified">${(docData.continut.textJurnal || 'ConÈ›inut indisponibil.').replace(/\n/g, '<br>')}</p>`;
        }

        if (!card) {
            card = document.createElement("div");
            card.className = "response-card introspectie-card"; // Clasa genericÄƒ + specificÄƒ tipului
            card.setAttribute("data-id", docData.id);
            card.setAttribute("data-type", docData.type);

            // Butonul "DiscutÄƒ cu AI" va fi adÄƒugat doar pentru fiÈ™e
            const discussButtonHtml = docData.type === 'fisa' ?
                `<button class="discuss-entry-with-chat-button" title="DiscutÄƒ aceastÄƒ fiÈ™Äƒ cu PsihoGPT">DiscutÄƒ cu AI</button>` : '';

            card.innerHTML = `
                <div class="card-header">
                    <span>${cardTitle}</span>
                    <span class="card-date">${entryDate}</span>
                </div>
                <div class="card-content">
                    <details class="introspectie-entry-details">
                        <summary>Vezi/Ascunde detaliile intrÄƒrii</summary>
                        <div class="introspectie-entry-content-text">${detailsContentHtml}</div>
                    </details>
                    <h4 class="ai-feedback-title">Feedback AI <span style="font-weight:300; font-style:italic; font-size:0.85em;">(PsihoGPT)</span></h4>
                    <div class="ai-feedback-history-container"></div>
                    <div class="card-actions">
                        <button class="regenerate-feedback-button" title="RegenereazÄƒ Feedback AI">RegenereazÄƒ</button>
                        ${discussButtonHtml}
                        <button class="delete-last-feedback-button" title="È˜terge Ultimul Feedback AI">È˜terge Ultimul</button>
                        <button class="delete-all-feedback-button" title="È˜terge Tot Istoricul Feedback AI">È˜terge Istoric AI</button>
                        <button class="delete-introspectie-button" title="È˜terge AceastÄƒ Intrare">È˜terge Intrarea</button>
                    </div>
                </div>`;

            card.querySelector('.card-header').addEventListener('click', (e) => {
                if (!e.target.closest('button') && !e.target.closest('details')) card.classList.toggle('open');
            });

            card.querySelector('.regenerate-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); regenereazaFeedbackPentruIntrospectieCard(docData.id); });
            if (docData.type === 'fisa') {
                card.querySelector('.discuss-entry-with-chat-button')?.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    // Trebuie sÄƒ preluÄƒm datele complete ale fiÈ™ei pentru a le trimite Ã®n chat
                    const fullEntryData = await getDoc(doc(db, "introspectii", docData.id));
                    if (fullEntryData.exists()) {
                         await discussFisaWithChat(fullEntryData.data()); // Trimitem datele complete, inclusiv `continut`
                    } else {
                        alert("Nu s-au putut Ã®ncÄƒrca detaliile complete ale fiÈ™ei pentru discuÈ›ie.");
                    }
                });
            }
            card.querySelector('.delete-last-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); stergeUltimulFeedbackIntrospectie(docData.id); });
            card.querySelector('.delete-all-feedback-button').addEventListener('click', (e) => { e.stopPropagation(); stergeTotIstoriculFeedbackIntrospectie(docData.id); });
            card.querySelector('.delete-introspectie-button').addEventListener('click', (e) => { e.stopPropagation(); stergeIntrospectie(docData.id, card); });
            
            const noEntriesMsg = container.querySelector('.no-entries-message');
            if (noEntriesMsg) noEntriesMsg.remove();

            // AdaugÄƒ cardul Ã®n container, sortat (deÈ™i Firestore deja sorteazÄƒ la Ã®ncÄƒrcare)
            // Simplu: adaugÄƒ la Ã®nceput pentru cele mai noi
            if (container.firstChild && container.firstChild.nodeName !== 'P') {
                container.insertBefore(card, container.firstChild);
            } else {
                if (container.firstChild && container.firstChild.nodeName === 'P') container.innerHTML = '';
                container.appendChild(card);
            }
        } else { // ActualizeazÄƒ cardul existent (puÈ›in probabil Ã®n acest flux dacÄƒ reÃ®ncÄƒrcÄƒm tot)
            card.querySelector('.card-header span:first-child').textContent = cardTitle;
            card.querySelector('.introspectie-entry-content-text').innerHTML = detailsContentHtml;
        }

        const feedbackContainer = card.querySelector('.ai-feedback-history-container');
        if (feedbackContainer) {
            afiseazaIstoricFeedbackIntrospectie(feedbackContainer, docData.feedbackAI_history || []);
        }
    }
    
    async function regenereazaFeedbackPentruIntrospectieCard(introspectieId) {
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.regenerate-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se genereazÄƒ..."; btn.disabled = true; }
        
        const confirmationElementId = card.dataset.type === 'fisa' ? 'fisaConfirmationMessage' : 'jurnalConfirmationMessage';
        const confirmationMsg = document.getElementById(confirmationElementId);
        if(confirmationMsg) confirmationMsg.style.display = 'none';

        try {
            const entryDocSnap = await getDoc(doc(db, "introspectii", introspectieId));
            if (!entryDocSnap.exists()) {
                if(confirmationMsg) { confirmationMsg.textContent = 'Eroare: Intrarea nu mai existÄƒ.'; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
                else { alert("Intrarea nu mai existÄƒ.");}
                return;
            }
            const entryData = { id: entryDocSnap.id, ...entryDocSnap.data() };
            const newFeedback = await genereazaFeedbackPentruIntrospectie(entryData); // Aceasta salveazÄƒ È™i Ã®n DB

            const updatedDoc = await getDoc(doc(db, "introspectii", introspectieId)); // Refetch pentru a avea ultimul istoric
            if (updatedDoc.exists() && card) {
                afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedbackAI_history || []);
            }
             const message = newFeedback && !newFeedback.error && !newFeedback.error_parsing ? "Noul feedback AI a fost generat È™i adÄƒugat!" : `Feedback AI: ${newFeedback.rawText || 'ProblemÄƒ la generare.'}`;
             if(confirmationMsg) { confirmationMsg.textContent = message; confirmationMsg.className = `confirmation-message ${newFeedback && !newFeedback.error && !newFeedback.error_parsing ? 'success' : 'error'}`; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);}
        } catch (error) {
            console.error("Eroare la regenerare feedback unificat:", error);
             if(confirmationMsg) { confirmationMsg.textContent = 'Eroare la regenerarea feedback-ului.'; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
        }
    }

    async function stergeUltimulFeedbackIntrospectie(introspectieId) {
        if (!confirm("È˜tergeÈ›i ultimul feedback AI pentru aceastÄƒ intrare?")) return;
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.delete-last-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se È™terge..."; btn.disabled = true; }

        const confirmationElementId = card.dataset.type === 'fisa' ? 'fisaConfirmationMessage' : 'jurnalConfirmationMessage';
        const confirmationMsg = document.getElementById(confirmationElementId);
        if(confirmationMsg) confirmationMsg.style.display = 'none';

        try {
            const entryDocRef = doc(db, "introspectii", introspectieId);
            const entrySnap = await getDoc(entryDocRef);
            if (!entrySnap.exists() || !entrySnap.data().feedbackAI_history?.length) {
                if(confirmationMsg) {confirmationMsg.textContent = "Nu existÄƒ feedback de È™ters."; confirmationMsg.className = 'confirmation-message warning'; confirmationMsg.style.display = 'block';}
                return;
            }
            const history = entrySnap.data().feedbackAI_history;
            history.pop();
            await updateDoc(entryDocRef, { feedbackAI_history: history });
            if(card) afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), history);
            if(confirmationMsg) {confirmationMsg.textContent = "Ultimul feedback AI È™ters."; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block';}
        } catch (err) {
            console.error("Eroare È™tergere ultim feedback:", err);
            if(confirmationMsg) {confirmationMsg.textContent = "Eroare la È™tergerea feedback-ului."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
            if(confirmationMsg) setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);
        }
    }

    async function stergeTotIstoriculFeedbackIntrospectie(introspectieId) {
        if (!confirm("Sigur È™tergeÈ›i TOT istoricul de feedback AI pentru aceastÄƒ intrare? Ireversibil.")) return;
        const card = document.querySelector(`.introspectie-card[data-id="${introspectieId}"]`);
        const btn = card?.querySelector('.delete-all-feedback-button');
        const originalText = btn ? btn.textContent : "";
        if (btn) { btn.textContent = "Se È™terge..."; btn.disabled = true; }

        const confirmationElementId = card.dataset.type === 'fisa' ? 'fisaConfirmationMessage' : 'jurnalConfirmationMessage';
        const confirmationMsg = document.getElementById(confirmationElementId);
        if(confirmationMsg) confirmationMsg.style.display = 'none';
        
        try {
            const docRef = doc(db, "introspectii", introspectieId);
            await updateDoc(docRef, { feedbackAI_history: [] }); // Sau deleteField() dacÄƒ vrem sÄƒ eliminÄƒm complet cÃ¢mpul
            if(card) afiseazaIstoricFeedbackIntrospectie(card.querySelector('.ai-feedback-history-container'), []);
            if(confirmationMsg) {confirmationMsg.textContent = "Tot istoricul feedback-ului AI a fost È™ters!"; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block';}
        } catch (error) {
            console.error("Eroare È™tergere istoric feedback:", error);
            if(confirmationMsg) {confirmationMsg.textContent = "Eroare la È™tergerea istoricului."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block';}
        } finally {
            if (btn) { btn.textContent = originalText; btn.disabled = false; }
             if(confirmationMsg) setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 7000);
        }
    }


    async function stergeIntrospectie(id, cardElement) {
        if (confirm("SunteÈ›i sigur cÄƒ doriÈ›i sÄƒ È™tergeÈ›i aceastÄƒ intrare È™i tot feedback-ul asociat? AceastÄƒ acÈ›iune este ireversibilÄƒ.")) {
            const type = cardElement.dataset.type;
            const confirmationElementId = type === 'fisa' ? 'fisaConfirmationMessage' : 'jurnalConfirmationMessage';
            const confirmationMsg = document.getElementById(confirmationElementId);
            if(confirmationMsg) confirmationMsg.style.display = 'none';

            try {
                await deleteDoc(doc(db, "introspectii", id));
                cardElement.remove();
                const container = document.getElementById("introspectiiCardContainer");
                if (container && !container.querySelector('.introspectie-card') && !container.querySelector('.no-entries-message')) {
                    const noEntriesMsgElement = document.createElement("p");
                    noEntriesMsgElement.className = "no-entries-message";
                    noEntriesMsgElement.textContent = "Nicio introspecÈ›ie. CompleteazÄƒ una pentru a Ã®ncepe!";
                    container.appendChild(noEntriesMsgElement);
                }
                 if(confirmationMsg) {confirmationMsg.textContent = "Intrarea a fost È™tearsÄƒ!"; confirmationMsg.className = 'confirmation-message success'; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 5000);}
            } catch (error) {
                console.error("Eroare la È™tergerea intrÄƒrii:", error);
                if(confirmationMsg) {confirmationMsg.textContent = "Eroare la È™tergerea intrÄƒrii."; confirmationMsg.className = 'confirmation-message error'; confirmationMsg.style.display = 'block'; setTimeout(() => { if(confirmationMsg) confirmationMsg.style.display = 'none'; }, 5000);}
            }
        }
    }

    function afiseazaIstoricFeedbackIntrospectie(containerEl, feedbackHistory) {
        containerEl.innerHTML = '';
        if (!feedbackHistory || !Array.isArray(feedbackHistory) || feedbackHistory.length === 0) {
            const noHistoryMsg = document.createElement("p");
            noHistoryMsg.textContent = "Niciun feedback AI generat pentru aceastÄƒ intrare.";
            noHistoryMsg.className = "no-feedback-message"; // ReutilizÄƒm clasa
            containerEl.appendChild(noHistoryMsg);
            return;
        }

        feedbackHistory.slice().reverse().forEach((entry, index) => {
            const itemContainer = document.createElement("div");
            itemContainer.className = "feedback-entry-card"; // ReutilizÄƒm clasa

            const timestampAndModel = document.createElement("p");
            timestampAndModel.className = "feedback-timestamp"; // ReutilizÄƒm clasa
            const modelInfo = entry.model || 'N/A';
            let promptTypeInfo = '';
            if (entry.promptTypeAtGeneration) { // Specific pentru jurnal
                promptTypeInfo = ` (Ghid: ${entry.promptTypeAtGeneration.replace(/_/g, ' ')})`;
            }

            timestampAndModel.innerHTML = `<strong>Feedback #${feedbackHistory.length - index}</strong> (${new Date(entry.timestamp).toLocaleString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })} - ${modelInfo}${promptTypeInfo})`;
            itemContainer.appendChild(timestampAndModel);

            const contentWrapper = document.createElement("div");
            contentWrapper.className = "content-ai"; // Clasa pentru formatarea Markdown

            if (entry.error) {
                const errorP = document.createElement("p");
                errorP.className = "ai-text-error"; // ReutilizÄƒm clasa
                errorP.innerHTML = (entry.rawText || "Eroare la generarea acestui feedback.").replace(/\n/g, '<br>');
                contentWrapper.appendChild(errorP);
            } else if (entry.error_parsing) { // TratÄƒm eroarea de parsare pentru fiÈ™e
                const parsingWarningP = document.createElement("p");
                parsingWarningP.style.color = "orange";
                parsingWarningP.style.fontStyle = "italic";
                parsingWarningP.textContent = "AtenÈ›ie: Unele secÈ›iuni din acest feedback AI (pentru fiÈ™Äƒ) nu au putut fi parsate corect. Se afiÈ™eazÄƒ textul brut:";
                contentWrapper.appendChild(parsingWarningP);
                const rawTextP = document.createElement("p");
                rawTextP.style.whiteSpace = "pre-wrap";
                rawTextP.textContent = entry.rawText;
                contentWrapper.appendChild(rawTextP);

            } else if (typeof entry.empatie_initiala === 'string') { // Este format nou de fiÈ™Äƒ, parsat
                 const newFormatSections = [
                    { title: "ğŸ’¬ Empatie IniÈ›ialÄƒ", key: "empatie_initiala", isList: false },
                    { title: "ğŸŒŸ Puncte Forte Observate", key: "puncte_forte", isList: false },
                    { title: "ğŸ”„ Tipare Principale", key: "tipare_principale", isList: false },
                    { title: "ğŸ”— Conexiuni Cheie", key: "conexiuni_cheie", isList: false },
                    { title: "ğŸ” Distorsiuni Identificate", key: "distorsiuni_identificate", isList: true },
                    { title: "ğŸ§  Scheme Activate", key: "scheme_activate", isList: true },
                    { title: "ğŸ­ Moduri Implicate", key: "moduri_implicate", isList: false },
                    { title: "ğŸ’ª Perspectiva Adultului SÄƒnÄƒtos", key: "perspectiva_adult_sanatos", isList: false },
                    { title: "â“ Ãntrebare FinalÄƒ de ReflecÈ›ie", key: "intrebare_finala_reflectie", isList: false },
                    { title: "ğŸ‘Ÿ Sugestie Mic Pas UrmÄƒtor", key: "sugestie_mic_pas", isList: false },
                    { title: "ğŸ’– Ãncurajare FinalÄƒ", key: "incurajare_finala", isList: false }
                ];
                newFormatSections.forEach(sectionConfig => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "feedback-section-item"; // O clasÄƒ nouÄƒ pentru stilizare individualÄƒ dacÄƒ e nevoie
                    const sectionTitleElement = document.createElement("h5"); // Sau h4/p cu strong
                    sectionTitleElement.textContent = sectionConfig.title + ":";
                    sectionDiv.appendChild(sectionTitleElement);

                    let contentText = entry[sectionConfig.key];
                    if (typeof contentText === 'string' && contentText.trim() !== "" && !contentText.startsWith("(SecÈ›iune neextrasÄƒ")) {
                         const titleWithoutEmoji = sectionConfig.title.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic}|ğŸ’¬|ğŸŒŸ|ğŸ”„|ğŸ”—|ğŸ”|ğŸ§ |ğŸ­|ğŸ’ª|â“|ğŸ‘Ÿ|ğŸ’–)\s*/gu, '').trim();
                         const patternTitleText = new RegExp(`^${titleWithoutEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im");
                         contentText = contentText.replace(patternTitleText, "").trim();

                        // AplicÄƒm Markdown simplu (bold, italic, liste)
                        let processedContent = contentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        
                        if (sectionConfig.isList && (processedContent.includes('<strong>') || processedContent.includes('<em>') || processedContent.match(/^\s*[\*-]\s+/m) )) { // VerificÄƒ dacÄƒ sunt liste
                            const listElement = document.createElement("ul");
                            const items = processedContent.split(/\s*\n\s*[\*-]\s+/) // ÃmpÄƒrÈ›im dupÄƒ newline + bullet
                                          .map(item => item.trim().replace(/^[\*-]\s+/, '')) // CurÄƒÈ›Äƒm bullet-ul iniÈ›ial
                                          .filter(item => item.length > 0);
                            
                            if(items.length === 0 && processedContent.trim().startsWith('<strong>')) { // Caz special pentru o singurÄƒ distorsiune/schemÄƒ boldatÄƒ
                                const singleItemLi = document.createElement("li");
                                singleItemLi.innerHTML = processedContent.replace(/\n/g, '<br>');
                                listElement.appendChild(singleItemLi);
                            } else {
                                items.forEach(itemText => {
                                    const listItem = document.createElement("li");
                                    listItem.innerHTML = itemText.replace(/\n/g, '<br>'); // PÄƒstrÄƒm newline-urile din interiorul unui item
                                    listElement.appendChild(listItem);
                                });
                            }
                            sectionDiv.appendChild(listElement);
                        } else {
                            const paragraphElement = document.createElement("p");
                            paragraphElement.innerHTML = processedContent.replace(/\n/g, '<br>');
                            sectionDiv.appendChild(paragraphElement);
                        }
                    } else {
                        const unavailableText = document.createElement("p");
                        unavailableText.style.fontStyle = "italic";
                        unavailableText.textContent = (contentText && contentText.startsWith("(SecÈ›iune neextrasÄƒ")) ? contentText : "Indisponibil sau secÈ›iune goalÄƒ.";
                        sectionDiv.appendChild(unavailableText);
                    }
                    contentWrapper.appendChild(sectionDiv);
                });

            } else { // Altfel, este jurnal sau format vechi/neparsat de fiÈ™Äƒ, afiÈ™Äƒm rawText formatat
                let textToProcess = entry.rawText || 'ConÈ›inut indisponibil.';
                let finalHtmlElements = [];
                const lines = textToProcess.split('\n');
                let currentParagraphContent = [];
                let inList = false;
                let currentListElement = null;

                for (const line of lines) {
                    const matchTitle = line.match(/^\s*(?:(\*\*|###|\##|\#)\s*([^#*]+)\s*(?:\1)?\s*)$/);
                    if (matchTitle && matchTitle[2] && matchTitle[2].trim().length > 0) {
                        if (currentParagraphContent.length > 0) {
                            const p = document.createElement('p'); p.className = 'ai-text-paragraph';
                            p.innerHTML = currentParagraphContent.join('<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                            finalHtmlElements.push(p); currentParagraphContent = [];
                        }
                        if (inList && currentListElement) { finalHtmlElements.push(currentListElement); inList = false; currentListElement = null; }
                        const titleMarker = matchTitle[1]; let titleLevel = (titleMarker.startsWith('#') ? Math.min(titleMarker.length, 4) : 2);
                        const titleEl = document.createElement(`h${titleLevel}`); titleEl.className = 'ai-main-section-title';
                        titleEl.textContent = matchTitle[2].trim().replace(/\*\*(.*?)\*\*/g, '$1');
                        finalHtmlElements.push(titleEl); continue;
                    }
                    const matchListItem = line.match(/^\s*([\*\-\+]|\d+\.)\s+(.*)/);
                    if (matchListItem) {
                        if (currentParagraphContent.length > 0) {
                            const p = document.createElement('p'); p.className = 'ai-text-paragraph';
                            p.innerHTML = currentParagraphContent.join('<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                            finalHtmlElements.push(p); currentParagraphContent = [];
                        }
                        const newListTypeIsOrdered = !!matchListItem[1].match(/\d+\./);
                        if (!inList || (newListTypeIsOrdered !== (currentListElement.tagName === 'OL'))) {
                            if(inList) finalHtmlElements.push(currentListElement);
                            currentListElement = document.createElement(newListTypeIsOrdered ? 'ol' : 'ul');
                            currentListElement.className = 'ai-list'; inList = true;
                        }
                        const listItem = document.createElement('li'); listItem.className = 'ai-list-item';
                        listItem.innerHTML = matchListItem[2].replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                        currentListElement.appendChild(listItem); continue;
                    }
                    if (inList && currentListElement) { finalHtmlElements.push(currentListElement); inList = false; currentListElement = null; }
                    if (line.trim() === "") {
                        if (currentParagraphContent.length > 0) {
                            const p = document.createElement('p'); p.className = 'ai-text-paragraph';
                            p.innerHTML = currentParagraphContent.join('<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                            finalHtmlElements.push(p); currentParagraphContent = [];
                        }
                    } else { currentParagraphContent.push(line); }
                }
                if (currentParagraphContent.length > 0) {
                    const p = document.createElement('p'); p.className = 'ai-text-paragraph';
                    p.innerHTML = currentParagraphContent.join('<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                    finalHtmlElements.push(p);
                }
                if (inList && currentListElement) { finalHtmlElements.push(currentListElement); }
                finalHtmlElements.forEach(el => contentWrapper.appendChild(el));
            }
            itemContainer.appendChild(contentWrapper);
            containerEl.appendChild(itemContainer);
        });
    }


    // --- FUNCÈšII PENTRU CHAT ---
    function displayChatMessage(message, role) {
        const messagesDiv = document.getElementById("chatMessages");
        if (!messagesDiv) return;
        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");
        const messageClass = role === "user" ? "user-message" : (role === "AI-error" ? "ai-message ai-error" : "ai-message");
        messageClass.split(' ').forEach(cls => messageElement.classList.add(cls));
        messageElement.style.whiteSpace = "pre-wrap";

        if (role === "AI" && message) {
            let htmlContent = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/__(.*?)__/g, '<strong>$1</strong>')
                                   .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                   .replace(/_(.*?)_/g, '<em>$1</em>')
                                   .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre style="background:#eef; padding:5px; border-radius:4px; white-space:pre-wrap; word-break:break-all;">${p1.trim()}</pre>`)
                                   .replace(/`([^`]+)`/g, '<code style="background:#eef; padding:1px 3px; border-radius:3px;">$1</code>');
            htmlContent = htmlContent.split('\n').map(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ') || trimmedLine.startsWith('+ ')) return `<li>${trimmedLine.substring(2)}</li>`;
                if (trimmedLine.match(/^\d+\.\s+/)) return `<li>${trimmedLine.replace(/^\d+\.\s+/, '')}</li>`;
                return line;
            }).join('\n');
            if (htmlContent.includes("<li>")) {
                 const listTag = /<li>[^<]*\d+\.\s*/.test(htmlContent) ? 'ol' : 'ul';
                 htmlContent = htmlContent.replace(/^(<li>[\s\S]*?<\/li>)$/gm, `<${listTag}>$1</${listTag}>`);
                 htmlContent = htmlContent.replace(/(<li>[\s\S]*?<\/li>\s*)+/gm, (match) => `<${listTag}>${match}</${listTag}>`);
            }
            messageElement.innerHTML = htmlContent.replace(/\n/g, '<br>');
        } else {
            messageElement.textContent = message;
        }
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function loadChatHistory(userId) {
        if (!userId) return [];
        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        try {
            const docSnap = await getDoc(historyDocRef);
            if (docSnap.exists() && docSnap.data().messages && Array.isArray(docSnap.data().messages)) {
                const messages = docSnap.data().messages;
                messages.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
                return messages;
            }
            return [];
        } catch (error) { console.error("Eroare Ã®ncÄƒrcare istoric chat:", error); return []; }
    }

    async function saveChatMessage(userId, messageObject) {
        if (!userId || !messageObject || typeof messageObject.content !== 'string' || messageObject.content.trim() === "") return;
        const historyDocRef = doc(db, "chatHistories", CHAT_HISTORY_DOC_ID_PREFIX + userId);
        try {
            await updateDoc(historyDocRef, { messages: arrayUnion(messageObject) }, { merge: true });
        } catch (error) {
            if (error.code === 'not-found' || error.message.includes("No document to update")) {
                 await setDoc(historyDocRef, { messages: [messageObject] });
            } else { console.error("Eroare salvare mesaj chat:", error); }
        }
    }

    async function initializeAndStartChatSession(userId) {
        const chatStatus = document.getElementById("chatStatus");
        const sendButton = document.getElementById("sendChatMessageButton");
        const messagesDiv = document.getElementById("chatMessages");

        if (sendButton) sendButton.disabled = true;
        if (chatStatus) chatStatus.textContent = "IniÈ›ializare chat AI...";
        if (messagesDiv) messagesDiv.innerHTML = '';

        if (!geminiModelChat) {
            if (chatStatus) chatStatus.textContent = "EROARE: Model AI Chat indisponibil.";
            displayChatMessage("Serviciul de chat AI nu este disponibil.", "AI-error");
            return null;
        }
        isChatInitialized = false;
        let initialContextSummary = "REZUMAT DIN INTROSPECÈšIILE ANTERIOARE (ULTIMELE 3, FÄ‚RÄ‚ DISTINCÈšIE FIÈ˜Ä‚/JURNAL):\n";
        try {
            if (userId) { // Context din ambele: fiÈ™e È™i jurnal
                const q = query(collection(db, "introspectii"), where("ownerUid", "==", userId), orderBy("timestampCreare", "desc"), limit(3));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const entryDate = data.dateAfisare || (data.timestampCreare ? new Date(data.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'N/A');
                        if (data.type === 'fisa') {
                            initialContextSummary += ` - FiÈ™Äƒ (${entryDate}): Situatia - ${(data.continut.situatie || "").substring(0, 50)}...; Ganduri - ${(data.continut.ganduri || "").substring(0,50)}...\n`;
                        } else if (data.type === 'jurnal') {
                            initialContextSummary += ` - Jurnal (${entryDate}): Titlu - ${(data.continut.titluJurnal || "FÄƒrÄƒ titlu").substring(0,50)}...; Text (primele cuvinte) - ${(data.continut.textJurnal || "").substring(0,50)}...\n`;
                        }
                    });
                } else { initialContextSummary += "Nicio introspecÈ›ie recentÄƒ gÄƒsitÄƒ.\n"; }
            }
        } catch(e) {
            console.error("Eroare Ã®ncÄƒrcare context introspecÈ›ii pentru chat:", e);
            initialContextSummary += "Eroare la Ã®ncÄƒrcarea contextului.\n";
        }

        const systemInstructionText = `# ROL PRINCIPAL È˜I PERSONA:
Tu eÈ™ti PsihoGPT (alias Dr. Janet/Damian). EÈ™ti un asistent AI avansat pentru auto-reflecÈ›ie È™i explorare psihologicÄƒ ghidatÄƒ, specializat Ã®n TCC, Terapia Schemelor, ACT, DBT È™i terapie afirmativÄƒ gay. Te adresezi utilizatorului cu "tu". Scopul tÄƒu este sÄƒ sprijini utilizatorul Ã®n dezvoltarea stimei de sine, auto-compasiunii, vindecarea copilului interior È™i gestionarea relaÈ›iilor.

# MISIUNE È˜I ABORDARE TERAPEUTICÄ‚:
AjutÄƒ utilizatorul sÄƒ exploreze gÃ¢nduri, emoÈ›ii, comportamente È™i nevoi. Ghidaj spre:
1.  ÃnÈ›elegerea Schemelor Maladaptative Timpurii.
2.  Explorarea Stilului de AtaÈ™ament.
3.  Abordarea temelor precum homofobia internalizatÄƒ (principii terapie afirmativÄƒ gay).
4.  ÃmbunÄƒtÄƒÈ›irea stimei de sine È™i autocompasiunii.
5.  Dezvoltarea limitelor sÄƒnÄƒtoase È™i asertivitÄƒÈ›ii.
6.  Identificarea tiparelor de mentalitate de victimÄƒ, cultivÃ¢nd agenÈ›ia personalÄƒ.
7.  Lucrul cu experienÈ›ele trecute È™i copilul interior.
8.  Formularea obiectivelor SMART.

# PRINCIPII DE INTERACÈšIUNE:
1.  **Empatie È™i CÄƒldurÄƒ:** Fii cald, curios, non-judicativ.
2.  **ÃntrebÄƒri Deschise:** StimuleazÄƒ reflecÈ›ia ("Ce anume te face sÄƒ crezi asta?", "Cum te-ai simÈ›it?", "Ce nevoie comunicÄƒ emoÈ›ia?").
3.  **Validare EmoÈ›ionalÄƒ:** ("ÃnÈ›eleg cÄƒ te simÈ›i aÈ™a.").
4.  **PsihoeducaÈ›ie DozatÄƒ:** ExplicÄƒ concis concepte (schemÄƒ, distorsiune) È™i Ã®ntreabÄƒ dacÄƒ rezoneazÄƒ.
5.  **Non-Directivitate ResponsabilÄƒ:** NU diagnostichezi. NU Ã®nlocuieÈ™ti terapia umanÄƒ. Condu spre soluÈ›ii proprii.
6.  **Utilizarea Contextului:** FoloseÈ™te REZUMATUL INTROSPECÈšIILOR ANTERIOARE. DACÄ‚ UTILIZATORUL TRIMITE CONÈšINUTUL UNEI FIÈ˜E SAU JURNAL SPECIFIC PENTRU DISCUÈšIE, CONCENTREAZÄ‚-TE ASUPRA ACELEIA.
7.  **Concizie È™i Claritate:** RÄƒspunsuri concise (2-5 propoziÈ›ii), paragrafe scurte.
8.  **StructurÄƒ FlexibilÄƒ:** Etapa 1 (Conectare), Etapa 2 (Lucru Central), Etapa 3 (Concluzii).
9.  **Stil Vizual:** Emoticoane (âœ¨, ğŸŒŸ, ğŸ’¡, ğŸ”, ğŸ›¡ï¸, ğŸŒ±, ğŸ³ï¸â€ğŸŒˆ, ğŸ™), *italic* pentru concepte.
10. **Check-in Meta-Terapeutic:** ("Cum È›i se pare ritmul?", "E util?").

# CUNOÈ˜TINÈšE SPECIFICE (referenÈ›ial):
Scheme YSQ-R/SMI (Deprivare EmoÈ›ionalÄƒ, Abandon, Defectivitate etc.), AtaÈ™ament ECR-R, autori (Young, Linehan, Harris, Brown, Neff, Downs, Kort).

# PRIORITATE: Empatie, validare, ghidare reflexivÄƒ. Ia Ã®n considerare istoricul conversaÈ›iei curente.

Context din ultimele introspecÈ›ii (fiÈ™e/jurnal) completate de utilizator:
${initialContextSummary}---`;
        const aiGreeting = "Salut! Sunt PsihoGPT. Cum te simÈ›i astÄƒzi È™i despre ce ai dori sÄƒ reflectÄƒm Ã®mpreunÄƒ?";
        let historyForGeminiInitialization = [];
        let loadedHistoryFromDB = await loadChatHistory(userId);
        loadedHistoryFromDB.forEach(msg => {
            historyForGeminiInitialization.push({ role: msg.role === "AI" || msg.role === "model" ? "model" : "user", parts: [{ text: msg.content || "" }] });
        });

        try {
            const chatConfig = { history: [{ role: "user", parts: [{ text: systemInstructionText }] }, ...historyForGeminiInitialization], generationConfig: { temperature: 0.75 } };
            chatSession = geminiModelChat.startChat(chatConfig);
            console.log("Sesiune chat Gemini iniÈ›ializatÄƒ. Istoric trimis:", chatConfig.history.length);
            if (chatStatus) chatStatus.textContent = "Chat pregÄƒtit.";
            if (messagesDiv) messagesDiv.innerHTML = '';
            loadedHistoryFromDB.forEach(msg => displayChatMessage(msg.content, msg.role === "model" ? "AI" : "user"));
            if (loadedHistoryFromDB.length === 0) {
                 const firstAiResponse = await chatSession.sendMessage("Salut!");
                 const firstAiText = firstAiResponse.response?.candidates?.[0]?.content?.parts?.[0]?.text || aiGreeting;
                 displayChatMessage(firstAiText, "AI");
                 await saveChatMessage(userId, {role: "model", content: firstAiText, timestamp: new Date().toISOString() });
            }
            isChatInitialized = true;
            if (sendButton) sendButton.disabled = false;
        } catch(initError) {
            console.error("Eroare iniÈ›ializare sesiune chat Gemini:", initError, initError.stack);
            if (chatStatus) chatStatus.textContent = "Eroare AI Chat.";
            displayChatMessage("ProblemÄƒ tehnicÄƒ la pornirea chat-ului.", "AI-error");
            isChatInitialized = false; chatSession = null;
            if (sendButton) sendButton.disabled = true; return null;
        }
        return chatSession;
    }

    async function handleSendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatStatus = document.getElementById("chatStatus");
        if (!chatInput || !sendButton || !chatStatus) return;
        const messageText = chatInput.value.trim();
        if (messageText === "") return;
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); window.location.href = "login.html"; return; }

        displayChatMessage(messageText, "user");
        await saveChatMessage(user.uid, { role: "user", content: messageText, timestamp: new Date().toISOString() });
        chatInput.value = ""; sendButton.disabled = true; chatStatus.textContent = "PsihoGPT analizeazÄƒ...";

        if (!chatSession || !isChatInitialized) {
            chatSession = await initializeAndStartChatSession(user.uid);
            if(!chatSession) { chatStatus.textContent = "Eroare chat."; sendButton.disabled = true; return; }
        }
        try {
            const result = await chatSession.sendMessage(messageText);
            const response = result.response;
            let aiResponseText = "Nu am putut genera un rÄƒspuns."; let isBlockedBySafety = false;
            if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                aiResponseText = response.candidates[0].content.parts[0].text;
                if (response.candidates[0].finishReason && !["STOP", "MAX_TOKENS"].includes(response.candidates[0].finishReason)) {
                    aiResponseText = `AI oprit (Motiv: ${response.candidates[0].finishReason}). Filtre siguranÈ›Äƒ?`; isBlockedBySafety = true;
                }
            } else if (response?.promptFeedback?.blockReason) {
                aiResponseText = `Mesaj/RÄƒspuns blocat (Motiv: ${response.promptFeedback.blockReason}). ReformuleazÄƒ?`; isBlockedBySafety = true;
            }
            displayChatMessage(aiResponseText, isBlockedBySafety ? "AI-error" : "AI");
            await saveChatMessage(user.uid, { role: "model", content: aiResponseText, timestamp: new Date().toISOString() });
            chatStatus.textContent = "Chat pregÄƒtit.";
        } catch (error) {
            console.error("Eroare trimitere/procesare mesaj Gemini (chat):", error, error.stack);
            chatStatus.textContent = "Eroare comunicare AI.";
            let displayError = "Eroare comunicare AI.";
            if (error.message?.toLowerCase().includes("quota")) displayError = "LimitÄƒ utilizare AI atinsÄƒ.";
            else if (error.message?.toLowerCase().includes("safety") || error.message?.toLowerCase().includes("blocked")) displayError = "Mesaj/RÄƒspuns blocat. ReformuleazÄƒ?";
            else if (error.message?.toLowerCase().includes("api key not valid")) displayError = "Cheie API invalidÄƒ.";
            displayChatMessage(displayError, "AI-error");
            isChatInitialized = false; chatSession = null;
        } finally {
            if(geminiModelChat && isChatInitialized) sendButton.disabled = false;
            else { sendButton.disabled = true; chatStatus.textContent = "Chat AI indisponibil."; }
            chatInput.focus();
        }
    }

    async function handleToggleChat() {
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); window.location.href = "login.html"; return; }
        const chatContainer = document.getElementById("chatContainer");
        const toggleButton = document.getElementById("toggleChatButton");
        const sendButton = document.getElementById("sendChatMessageButton");
        if (!chatContainer || !toggleButton) return;

        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            chatContainer.style.display = "flex"; toggleButton.innerHTML = "â–";
            if (!isChatInitialized || !chatSession) {
                const sessionOK = await initializeAndStartChatSession(user.uid);
                if (sendButton) sendButton.disabled = !sessionOK;
            } else if (sendButton) { sendButton.disabled = !geminiModelChat; }
            document.getElementById("chatInput")?.focus();
        } else {
            chatContainer.style.display = "none"; toggleButton.innerHTML = "ğŸ’¬";
        }
    }

    async function discussFisaWithChat(fisaData) { // fisaData este documentul complet din Firestore
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); window.location.href = "login.html"; return; }

        const chatContainer = document.getElementById("chatContainer");
        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            await handleToggleChat(); // Deschide chatul dacÄƒ e Ã®nchis
        }
        if (!chatSession || !isChatInitialized) {
            displayChatMessage("Eroare: Sesiunea de chat nu e pregÄƒtitÄƒ.", "AI-error"); return;
        }

        const c = fisaData.continut; // ConÈ›inutul fiÈ™ei
        let message = `Salut PsihoGPT,\n\nAÈ™ dori sÄƒ discutÄƒm despre urmÄƒtoarea fiÈ™Äƒ de monitorizare (datatÄƒ ${fisaData.dateAfisare || 'N/A'}):\n\n`;
        message += `**SituaÈ›ia:** ${c.situatie || 'N/A'}\n`;
        message += `**GÃ¢nduri automate:** ${c.ganduri || 'N/A'}\n`;
        message += `**EmoÈ›ii:** ${c.emotii || 'N/A'}\n`;
        message += `**Mod activ:** ${c.mod_activ || 'N/A'}\n`;
        message += `**Comportament:** ${c.comportament || 'N/A'}\n`;
        message += `**Nevoile profunde:** ${c.nevoi_profunde || 'N/A'}\n`;
        message += `**AjutÄƒ comportamentul?:** ${c.ajutor_comportament || 'N/A'}\n`;
        message += `**Adult SÄƒnÄƒtos (perspectivÄƒ):** ${c.adult_sanatos || 'N/A'}\n\n`;
        message += "**Analiza gÃ¢ndurilor:**\n";
        message += `  *Dovezi adevÄƒr:* ${c.dovezi_adevar || 'N/A'}\n  *Dovezi fals:* ${c.dovezi_fals || 'N/A'}\n`;
        message += `  *Expl. alt.:* ${c.explicatie_alternativa || 'N/A'}\n  *Cel mai rÄƒu:* ${c.scenariu_negativ || 'N/A'}\n`;
        message += `  *Cel mai bun:* ${c.scenariu_optimist || 'N/A'}\n  *Realist:* ${c.rezultat_realist || 'N/A'}\n`;
        message += `  *Schimbare gÃ¢ndire:* ${c.schimbare_gandire || 'N/A'}\n  *Sfat prieten:* ${c.sfat_prieten || 'N/A'}\n\n`;
        message += "**ClarificÄƒri:**\n";
        message += `  *Partea rea?:* ${c.partea_rea || 'N/A'}\n  *Responsabilitate excesivÄƒ?:* ${c.responsabilitate || 'N/A'}\n`;
        message += `  *Condamnare eveniment unic?:* ${c.condamnare || 'N/A'}\n  *Termeni extremi?:* ${c.termeni_extremi || 'N/A'}\n`;
        message += `  *Exagerare?:* ${c.exagerare || 'N/A'}\n  *AlÈ›i factori?:* ${c.factori_responsabili || 'N/A'}\n`;
        message += `  *Concluzii pripite?:* ${c.concluzii || 'N/A'}\n  *ÃntrebÄƒri fÄƒrÄƒ rÄƒspuns?:* ${c.intrebari_fara_raspuns || 'N/A'}\n`;
        message += `  *Focus pe slÄƒbiciuni?:* ${c.slabiciuni || 'N/A'}\n  *Cum ar trebui?:* ${c.cum_ar_trebui || 'N/A'}\n`;
        message += `  *PerfecÈ›ionism?:* ${c.perfectiune || 'N/A'}\n\n`;
        message += "Ce Ã®ntrebÄƒri sau reflecÈ›ii ai pentru mine pe baza acestei fiÈ™e?";

        // Trimiterea efectivÄƒ a mesajului se face prin handleSendChatMessage, dar cu textul pre-populat
        const chatInput = document.getElementById("chatInput");
        if(chatInput) {
            chatInput.value = message; // Pre-populÄƒm inputul
            handleSendChatMessage();   // ApelÄƒm funcÈ›ia de trimitere
        }
    }


    // --- FUNCÈšIE PENTRU PARTAJARE (COLLABORATION LINK) ---
    async function generateCollaborationLink() {
        const user = auth.currentUser;
        if (!user) { alert("Trebuie sÄƒ fiÈ›i autentificat."); return; }
        // Folosim aceeaÈ™i colecÈ›ie 'collaborations'
        const existingCollabQuery = query(collection(db, "collaborations"), where("owner", "==", user.uid), limit(1));
        const querySnapshot = await getDocs(existingCollabQuery);
        let pinCode;

        // ObÈ›inem URL-ul curent, dar fÄƒrÄƒ query params, pentru a construi link-ul de colaborare
        const baseUrl = `${window.location.origin}${window.location.pathname}`;

        if (!querySnapshot.empty) {
            const collabDoc = querySnapshot.docs[0];
            const collabLink = `${baseUrl}?collabId=${collabDoc.id}`;
            const existingPin = collabDoc.data().pin;
            const renew = confirm(`Ai deja un link de colaborare activ (PIN: ${existingPin}).\nLink: ${collabLink}\n\nDoreÈ™ti un PIN nou?`);
            if (renew) {
                 pinCode = prompt("Noul PIN numeric (minim 4 cifre):");
                 if (pinCode && /^\d{4,}$/.test(pinCode)) {
                    await updateDoc(doc(db, "collaborations", collabDoc.id), { pin: pinCode, updatedAt: Timestamp.fromDate(new Date()) });
                    prompt(`PIN actualizat! Link: ${collabLink}\nNoul PIN: ${pinCode}`, `Link: ${collabLink}\nPIN: ${pinCode}`);
                 } else if(pinCode !== null) { alert("PIN invalid. Vechiul PIN a fost pÄƒstrat."); }
            } else { prompt(`Link existent (PIN: ${existingPin}):\nLink È™i PIN:`, `${collabLink} (PIN: ${existingPin})`); }
            return;
        }
        pinCode = prompt("PIN numeric (minim 4 cifre) pentru noul link de colaborare:");
        if (!pinCode || !/^\d{4,}$/.test(pinCode)) { alert("PIN invalid."); return; }
        try {
            const docRef = await addDoc(collection(db, "collaborations"), { owner: user.uid, pin: pinCode, createdAt: Timestamp.fromDate(new Date()) });
            const collaborationLink = `${baseUrl}?collabId=${docRef.id}`;
            prompt(`Link generat! Distribuie link-ul È™i PIN-ul.\nLink: ${collaborationLink}\nPIN: ${pinCode}`, `Link: ${collaborationLink} (PIN: ${pinCode})`);
        } catch (error) { console.error("Eroare generare link colaborare:", error); alert("Eroare generare link."); }
    }

    </script>
    <style>
        /* Stiluri CSS Unificate È™i Adaptate */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Ubuntu', 'Roboto', 'Montserrat', sans-serif;
            margin: 0; padding: 20px; background: #f0f2f5;
            color: #333a40; line-height: 1.6; font-size: 16px;
        }

        .app-header { text-align: center; margin-bottom: 25px; }
        .app-header h1 { font-size: 2em; color: #2c3840; margin-bottom: 5px; font-weight: 500;}
        .app-header p { font-size: 1em; color: #556575; margin-top: 0;}

        .tab-navigation { display: flex; justify-content: center; margin-bottom: 25px; gap: 15px; }
        .tab-button {
            padding: 10px 25px; font-size: 1.1em; font-weight: 500;
            border: 2px solid transparent; border-bottom-color: #d1d9e2;
            background: none; color: #6c757d; cursor: pointer;
            transition: all 0.2s ease; border-radius: 8px 8px 0 0;
        }
        .tab-button:hover { color: #3b74d7; border-bottom-color: #a3b8d9; }
        .tab-button.active {
            color: #3b74d7; border-color: #3b74d7; border-bottom-color: #fff; /* SimuleazÄƒ conectarea cu containerul */
            background-color: #fff; box-shadow: 0 -2px 5px -2px rgba(0,0,0,0.1);
            position: relative; top: 1px; /* Aliniere finÄƒ */
        }

        .tab-content { display: none; } /* Se afiÈ™eazÄƒ prin JS */
        .tab-content.active { display: block; }

        .form-section-container {
            max-width: 800px; margin: 0 auto 30px auto; background: #fff; padding: 25px 30px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08); border-radius: 12px;
        }
        .form-section-container h2 { /* Titlurile formularelor (Jurnal/FiÈ™Äƒ) */
             font-size: 1.6em; margin-bottom: 15px; text-align: center; color: #334155; font-weight: 500;
        }
         .form-section-container > p:not(.confirmation-message) { /* Descrierile formularelor */
            text-align: center; margin-top: -5px; margin-bottom: 20px; font-size: 0.95em; color: #556575;
        }

        /* Stiluri pentru Formularul de FiÈ™Äƒ (preluate È™i adaptate) */
        .progress-bar {width: 100%; background-color: #e9ecef; border-radius: 25px; overflow: hidden; margin-bottom: 25px; height: 12px;}
        .progress {height: 100%; width: 0; background-color: #5c85d6; transition: width 0.4s ease;}
        .question-card {
            margin-bottom: 22px; padding: 20px; background: #fdfdff;
            border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            border: 1px solid #eef2f7;
        }
        .question-card h3 { font-weight: 500; font-size: 1.15em; margin-top: 0; margin-bottom: 10px; color: #334155; text-align: left;}
        .question-card p { font-weight: 400; font-size: 0.95em; margin-bottom: 15px; color: #475569; line-height: 1.65; text-align: left;}
        textarea { /* Stil general pentru textarea, folosit È™i de jurnal */
            width: 100%; padding: 12px 15px; font-size: 1em;
            font-family: inherit; border-radius: 6px; border: 1px solid #d1d9e2;
            resize: vertical; min-height: 70px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #fdfdff;
        }
        textarea:focus {border-color: #5c85d6; box-shadow: inset 0 1px 2px rgba(0,0,0,0.06), 0 0 0 3.5px rgba(92, 133, 214, 0.2); outline: none;}
        .form-step {display: none;}
        .form-step-active {display: block; animation: fadeInFormStep 0.5s ease-in-out;}
        @keyframes fadeInFormStep { 0% {opacity: 0; transform: translateY(12px);} 100% {opacity: 1; transform: translateY(0);} }
        .step-navigation {text-align: center; margin-top: 25px; display: flex; justify-content: space-between; gap:15px;}
        .step-navigation button, button#fisaAddButton {
            padding: 11px 22px; font-family: inherit; font-size: 1em; font-weight: 500;
            color: white; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s, transform 0.15s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .step-navigation button#fisaPrevButton { background-color: #6c757d; }
        .step-navigation button#fisaPrevButton:hover { background-color: #5a6268; transform: translateY(-1px); }
        .step-navigation button#fisaNextButton { background-color: #5c85d6; }
        .step-navigation button#fisaNextButton:hover { background-color: #4a6fb5; transform: translateY(-1px); }
        button#fisaAddButton { background-color: #28a745; display:block; width:100%; margin-top:20px; font-size: 1.05em;}
        button#fisaAddButton:hover:not(:disabled) { background-color: #218838; transform: translateY(-1px); }
        .step-navigation button:disabled, button#fisaAddButton:disabled, button#saveJournalEntryButton:disabled {
            background: #b0c4de !important; color: #707c8b !important;
            cursor: not-allowed !important; box-shadow: none !important; transform: translateY(0) !important;
        }

        /* Stiluri pentru Formularul de Jurnal (preluate È™i adaptate) */
        label { display:block; margin-bottom: 6px; font-weight: 500; color: #455058; font-size: 0.95em;}
        input#journalTitle { /* Specific pentru titlul jurnalului */
            width: 100%; padding: 12px 15px; margin-bottom: 15px; font-size: 1em;
            font-family: inherit; border-radius: 6px; border: 1px solid #d1d9e2;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #fdfdff;
        }
        input#journalTitle:focus { border-color: #5c85d6; box-shadow: 0 0 0 3.5px rgba(92, 133, 214, 0.2); outline: none;}
        textarea#journalContent { min-height: 200px; line-height: 1.65; } /* Ajustare min-height pentru jurnal */
        
        .prompt-box { /* Folosit pentru afiÈ™area ghidului activ de jurnal */
            background: #f8f9fc; border: 1px solid #e6eaf0; border-left: 4px solid #5c85d6;
            padding: 12px 15px; margin-bottom: 15px; font-size: 0.9em; border-radius: 6px;
        }
        .prompt-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .prompt-box-header strong { color: #2c3e50; font-size: 1.05em; }
        .hide-prompt-button { background: none; border: none; color: #88929e; font-size: 1.6em; font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 0.8; }
        .hide-prompt-button:hover { color: #333; }
        .prompt-content-display { /* Pentru textul ghidului */
            white-space: pre-wrap; max-height: 180px; overflow-y: auto; background-color: #ffffff;
            padding: 10px; border-radius: 4px; border: 1px solid #e9edf2;
            font-family: 'Menlo', 'Monaco', monospace; font-size:0.95em; line-height: 1.55; color: #333;
        }
        .prompt-content-display::-webkit-scrollbar { width: 5px; }
        .prompt-content-display::-webkit-scrollbar-thumb { background: #cbd2d9; border-radius:3px; }
        #reflectionPromptsContainer { margin: 15px 0 20px 0; padding: 15px; background-color: #f8f9fc; border-radius: 8px; border: 1px solid #e8ecf0; }
        #reflectionPromptsContainer p { margin-top: 0; margin-bottom: 12px; font-weight: 500; color: #4a5560; font-size: 0.9em; }
        .prompt-button-group { display: flex; flex-wrap: wrap; gap: 10px; }
        button.prompt-button {
            background-color: #e9f0ff; color: #4a69bd; border: 1px solid #d1dfff;
            padding: 7px 14px; font-size: 0.85em; font-weight: 500; border-radius: 18px;
            cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        button.prompt-button:hover { background-color: #d8e4ff; color: #3a539b; transform: translateY(-1px); }
        button#saveJournalEntryButton {
            display: block; width: 100%; margin-top: 20px; padding: 13px 20px;
            font-size: 1.05em; font-weight: 500; background: #5c85d6; color: white;
            border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 3px 7px rgba(92, 133, 214, 0.22);
        }
        button#saveJournalEntryButton:hover:not(:disabled) { background-color: #4a6fb5; transform: translateY(-1.5px); }

        /* Mesaje de confirmare/eroare (comune) */
        .confirmation-message { display: none; text-align: center; padding: 13px; border: 1px solid transparent; border-radius: 6px; margin-top: 18px; animation: fadeInConfirm 0.4s; font-weight: 500; font-size: 0.95em;}
        .confirmation-message.success { background-color: #e3f4e8; color: #1e6a39; border-color: #b3d9c0; }
        .confirmation-message.error { background-color: #fdecea; color: #b32d21; border-color: #f8c6c1; }
        .confirmation-message.warning { background-color: #fff8e1; color: #795508; border-color: #ffecb3; }
        @keyframes fadeInConfirm { 0% {opacity: 0; transform: translateY(8px);} 100% {opacity: 1; transform: translateY(0);} }

        /* Container pentru carduri È™i titlul sÄƒu */
        #cardsContainerArea h3 { /* Pentru "Istoricul IntrospecÈ›iilor" */
            color: #2c3840; text-align: center; margin-bottom: 20px; font-weight: 500;
            font-size: 1.5em; margin-top: 40px;
        }
        #collabViewTitle { /* Pentru titlul din modul colaborare */
             display: none; /* AfiÈ™at de JS */
             font-size: 1.6em; margin-bottom: 20px; text-align: center; color: #2c3840; font-weight: 500;
        }
        .card-view-unified {display: flex; flex-direction: column; gap: 22px; max-width: 800px; margin: 25px auto;}
        .response-card { /* Stil general card, va fi folosit de ambele tipuri */
            background: #ffffff; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.07);
            overflow: hidden; border: 1px solid #e4e9f0;
        }
        .response-card .card-header {
            font-weight: 500; font-size: 1.1em; cursor: pointer; background: #f9fafc;
            padding: 14px 20px; color: #334155; border-bottom: 1px solid #e4e9f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .response-card .card-header span:first-child { flex-grow: 1; margin-right: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .response-card .card-header .card-date { font-size: 0.85em; color: #64748b; white-space: nowrap; font-weight: 400;}
        .response-card .card-header::after {content: 'â–¼'; font-size: 0.75em; transition: transform 0.2s ease; color: #707c8b; margin-left: 10px;}
        .response-card.open .card-header::after {transform: rotate(180deg);}
        .response-card .card-content { max-height: 0; padding: 0 20px; overflow-y: hidden; transition: max-height 0.45s ease-in-out, padding-top 0.45s ease-in-out, padding-bottom 0.45s ease-in-out; }
        .response-card.open .card-content { max-height: 8000px; padding: 20px 20px; } /* Max-height mare */

        .introspectie-entry-details { margin-bottom: 18px; border: 1px solid #eef2f7; border-radius: 6px; background: #fdfdfe;}
        .introspectie-entry-details summary {
            cursor: pointer; padding: 10px 12px; font-weight: 500; color: #475569;
            background-color: #f8f9fa; border-radius: 6px 6px 0 0; list-style-position: inside;
        }
        .introspectie-entry-details summary:hover { background-color: #f1f3f6; }
        .introspectie-entry-details[open] summary { border-bottom: 1px solid #eef2f7; }
        .introspectie-entry-content-text { /* ConÈ›inutul fiÈ™ei sau jurnalului */
            padding: 12px; font-size: 0.95em; line-height: 1.65; color: #3e4c59;
            max-height: 450px; overflow-y: auto; white-space: pre-wrap; /* Pentru jurnal */
        }
        .introspectie-entry-content-text hr {margin: 15px 0; border: 0; border-top: 1px dashed #dde2e7;}
        .introspectie-entry-content-text h4 { font-size: 1.05em; color: #5c85d6; margin-top: 15px; margin-bottom:8px; font-weight: 500;}
        .introspectie-entry-content-text p { margin-bottom: 10px; }
        .introspectie-entry-content-text p strong { font-weight: 500; color: #1e293b; margin-right: 5px; }
        .introspectie-entry-content-text::-webkit-scrollbar { width: 5px; }
        .introspectie-entry-content-text::-webkit-scrollbar-thumb { background: #c5ced6; border-radius:3px; }
        
        .journal-entry-content-text-unified { /* Specific pentru textul jurnalului Ã®n card */
            white-space: pre-wrap; font-size: 1em; line-height: 1.7;
        }

        .response-card > .card-content > h4.ai-feedback-title {
            color: #5c85d6; font-weight: 500; margin-top: 0px;
            margin-bottom: 15px; font-size: 1.1em;
            border-bottom: 1px solid #eef2f7; padding-bottom: 8px;
        }
        .no-feedback-message { text-align: center; font-style: italic; color: #64748b; padding: 15px 0; }
        .ai-feedback-history-container { margin-top: 10px; }
        .feedback-entry-card {
            background:#fdfdff; padding: 15px; border: 1px solid #e7ecf2;
            border-left: 4px solid #5c85d6; border-radius:8px; margin-bottom:15px;
            font-size:0.95em; line-height:1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .feedback-timestamp { color:#52606f; font-size:0.8em; margin-bottom:10px; font-style: italic; }
        .feedback-section-item { margin-bottom: 12px; }
        .feedback-section-item h5 { font-size: 1em; color: #4a69bd; margin-top:0; margin-bottom: 5px; font-weight:500;}
        .feedback-section-item p, .feedback-section-item ul { margin-left: 5px; font-size: 0.95em; }
        .feedback-section-item ul { padding-left: 18px; }


        .card-actions {
            text-align: right; margin-top: 20px; padding-top: 15px;
            border-top: 1px solid #eef2f7; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-end;
        }
        .card-actions button {
            padding: 7px 13px; font-size: 0.78em; font-weight:500; border-radius: 6px;
            transition: all 0.2s; border: 1px solid transparent; cursor: pointer;
        }
        button.delete-introspectie-button { background-color:transparent; color: #c0392b; border-color: #f5c6cb;}
        button.delete-introspectie-button:hover { background-color: #c0392b; color: white; }
        button.regenerate-feedback-button { background-color:transparent; color: #276749; border-color: #a7f3d0;}
        button.regenerate-feedback-button:hover { background-color: #276749; color: white;}
        button.discuss-entry-with-chat-button { background-color:transparent; color: #4a69bd; border-color: #a3b3d9;}
        button.discuss-entry-with-chat-button:hover { background-color: #4a69bd; color: white;}
        button.delete-last-feedback-button { background-color:transparent; color: #b45309; border-color: #fcd34d;}
        button.delete-last-feedback-button:hover { background-color: #b45309; color: white;}
        button.delete-all-feedback-button { background-color:transparent; color: #9b2c2c; border-color: #fed7d7;}
        button.delete-all-feedback-button:hover { background-color: #9b2c2c; color: white;}

        .content-ai { font-size: 1em; line-height: 1.7; color: #374151; }
        .content-ai .ai-main-section-title, .content-ai h1, .content-ai h2, .content-ai h3, .content-ai h4 {
            font-weight: 600; color: #3b74d7; margin-top: 1.2em; margin-bottom: 0.6em;
            font-size: 1.05em; padding-bottom: 4px;
        }
        .content-ai .ai-main-section-title:first-child, .content-ai h1:first-child, .content-ai h2:first-child, .content-ai h3:first-child, .content-ai h4:first-child { margin-top: 0.3em; }
        .content-ai p.ai-text-paragraph { margin-bottom: 0.9em; }
        .content-ai p.ai-text-paragraph strong, .content-ai strong { font-weight: 600; color: #1f2937; }
        .content-ai p.ai-text-paragraph em, .content-ai em { font-style: italic; color: #4b5563; }
        .content-ai ul.ai-list, .content-ai ol.ai-list { margin-left: 5px; padding-left: 22px; margin-bottom: 0.9em; list-style-position: outside; }
        .content-ai .ai-list-item { margin-bottom: 0.5em; }
        .content-ai .ai-list-item::marker { color: #4a69bd; font-weight: bold; }
        .content-ai .ai-text-error {
            color: #c0392b; font-weight: 500; background-color: #fff5f5;
            padding: 10px 12px; border-radius: 4px; border: 1px solid #fecaca; border-left: 4px solid #ef4444;
            white-space: pre-wrap; font-size: 0.9em;
        }
        
        .no-entries-message, .loading-message, .error-loading-message { text-align: center; margin-top:25px; font-style: italic; color: #556575; font-size: 1.05em; padding:15px;}
        .error-loading-message { color: #c0392b; font-weight: 500;}
        .loading-message { background-color: #e9f0ff; border:1px solid #d1dfff;}


        /* Stiluri Chat (preluate È™i adaptate) */
        .chat-container {
            display: none; flex-direction: column; position: fixed; bottom: 20px; right: 20px;
            width: clamp(350px, 40vw, 450px); max-height: calc(100vh - 90px);
            background: #ffffff; border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
            z-index: 1000; padding: 0; box-sizing: border-box; overflow: hidden;
        }
        .chat-container h3 { /* Titlu Chat */
            text-align: center; color: #334155; margin: 0; padding: 16px 20px;
            font-size: 1.1em; font-weight: 500; background-color: #f8f9fc;
            border-bottom: 1px solid #e9edf2; flex-shrink: 0;
        }
        #chatMessages {
            flex-grow: 1; overflow-y: auto; padding: 18px; background: #ffffff;
            display: flex; flex-direction: column; gap: 12px;
        }
        #chatMessages::-webkit-scrollbar { width: 6px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #bfc8d3; border-radius: 10px; }
        .chat-message {
            padding: 11px 16px; border-radius: 18px; max-width: 83%;
            word-wrap: break-word; line-height: 1.55; box-shadow: 0 2px 5px rgba(0,0,0,0.06);
            font-size: 0.96em; font-weight: 400; position: relative;
        }
        .user-message { background: linear-gradient(135deg, #5c85d6 0%, #3b6cb7 100%); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 6px; }
        .ai-message { background: #f0f3f7; color: #2c3e50; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 6px; font-family: 'Ubuntu', 'Menlo', monospace; }
        .ai-message em, .ai-message i { font-family: 'Ubuntu', inherit; font-style: italic; }
        .ai-message strong, .ai-message b { font-family: 'Ubuntu', inherit; font-weight: 700; }
        .ai-message.ai-error { background-color: #ffe3e3; color: #b71c1c; border: 1px solid #ffc5c5; font-family: 'Ubuntu', sans-serif; }
        .chat-input-area {
            padding: 15px 20px; border-top: 1px solid #e9edf2; background-color: #f8f9fc;
            flex-shrink: 0; display: flex; flex-direction: column; gap: 10px;
        }
        #chatInput {
            width: 100%; padding: 11px 16px; border-radius: 10px; border: 1px solid #d9e0ea;
            resize: none; min-height: 46px; max-height: 120px; box-sizing: border-box;
            font-family: 'Ubuntu', sans-serif; font-size: 0.96em; line-height: 1.5;
            transition: border-color 0.2s, box-shadow 0.2s; background-color: #ffffff;
        }
        #chatInput:focus { border-color: #5c85d6; box-shadow: 0 0 0 3.5px rgba(92, 133, 214, 0.18); outline: none; }
        #sendChatMessageButton {
            padding: 11px 20px; width: 100%; font-family: 'Ubuntu', sans-serif;
            font-size: 1em; font-weight: 500; background-color: #5c85d6; color: white;
            border: none; border-radius: 10px; transition: background-color 0.2s, transform 0.15s ease-out;
            cursor: pointer; margin-top:0;
        }
        #sendChatMessageButton:hover:not(:disabled) { background-color: #4a6fb5; transform: translateY(-1px); }
        #sendChatMessageButton:disabled { background-color: #c3d9f0 !important; color: #7c8da3 !important; transform: translateY(0) !important;}
        #chatStatus { font-size: 0.85em; color: #6c757d; text-align: center; min-height: 1.2em; padding-bottom: 0; font-weight: 400;}
        #toggleChatButton { /* Butonul plutitor pentru chat */
            position: fixed; bottom: 25px; right: 25px; padding: 0; z-index: 1001;
            display: flex; align-items: center; justify-content: center;
            background-color: #5c85d6; color: white; border: none; border-radius: 50%;
            width: 58px; height: 58px; font-size: 26px;
            box-shadow: 0 5px 15px rgba(92, 133, 214, 0.25); cursor: pointer; transition: all 0.3s ease;
        }
        #toggleChatButton:hover { background-color: #4a6fb5; transform: scale(1.1) rotate(10deg); }

        /* Partajare Link */
        .collaboration-section { text-align:center; margin-top:30px; padding-bottom:10px; border-top: 1px solid #eef2f7; padding-top:20px;}
        #generateLinkButton { background-color:#007bff; font-size:0.9em; padding:10px 20px; color:white; border:none; border-radius:8px; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}


        @media (max-width: 820px) {
             .form-section-container, .card-view-unified {padding:20px; margin-left:15px; margin-right:15px; max-width:calc(100% - 30px);}
        }
        @media (max-width: 768px) {
            body {padding:15px; font-size: 15px;}
            .form-section-container, .card-view-unified {padding:15px; margin-left:10px; margin-right:10px; max-width:calc(100% - 20px);}
            .app-header h1 { font-size: 1.7em; }
            .tab-button { padding: 9px 18px; font-size: 1em;}
            .form-section-container h2 {font-size:1.4em;}
            #cardsContainerArea h3 {font-size: 1.3em;}
            .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.95em; padding:10px 18px;}
            .card-actions button {font-size:0.75em; padding:7px 10px;}
            .chat-container { width: calc(100% - 30px); max-height: calc(100vh - 100px); bottom: 15px; left: 15px; right: auto; }
            #toggleChatButton { width: 55px; height: 55px; font-size: 24px; bottom: 20px; right: 20px;}
        }
        @media (max-width: 480px) {
            body {padding:10px; font-size: 14px;}
            .form-section-container, .card-view-unified {padding:12px; margin-left:5px; margin-right:5px; max-width:calc(100% - 10px);}
            .app-header h1 {font-size:1.5em;}
            .tab-button { padding: 8px 12px; font-size: 0.9em;}
            .form-section-container h2 {font-size:1.3em;} #cardsContainerArea h3 {font-size: 1.2em;}
            textarea#journalContent { min-height: 150px; }
            .step-navigation button, button#fisaAddButton, button#saveJournalEntryButton {font-size:0.9em; padding:9px 15px;}
            .card-actions button {font-size:0.72em; padding:6px 8px; flex-basis: calc(50% - 4px);} /* Aproape 2 pe rÃ¢nd */
            .response-card .card-header {padding:12px 15px; flex-direction: column; align-items: flex-start; gap: 4px;}
            .response-card .card-header::after { align-self: flex-end; margin-top: -1.3em; }
            .chat-container { max-height: calc(100vh - 80px); bottom: 10px; left: 10px; width: calc(100% - 20px); }
            #toggleChatButton { width: 50px; height: 50px; font-size: 22px; bottom: 15px; right: 15px; }
        }

    </style>
</head>
<body>

    <header class="app-header">
        <h1>IntrospecÈ›ie GhidatÄƒ</h1>
        <p>Jurnal personal È™i fiÈ™e de monitorizare Ã®ntr-un singur loc.</p>
    </header>

    <nav class="tab-navigation">
        <button id="tabButtonJurnal" class="tab-button active" type="button">Jurnal Ghidat</button>
        <button id="tabButtonFisa" class="tab-button" type="button">FiÈ™Äƒ TerapeuticÄƒ</button>
    </nav>

    <main id="mainContentArea">
        <!-- ConÈ›inutul Jurnalului Ghidat -->
        <div id="jurnalFormContainer" class="tab-content active">
            <section class="form-section-container">
                <h2>Jurnal Terapeutic Personal</h2>
                <p>SpaÈ›iul tÄƒu pentru reflecÈ›ie ghidatÄƒ, auto-descoperire È™i integrare emoÈ›ionalÄƒ.</p>

                <form id="therapeuticJournalForm" onsubmit="return false;">
                    <label for="journalTitle">Titlu (OpÈ›ional):</label>
                    <input type="text" id="journalTitle" name="journalTitle" placeholder="Ex: ReflecÈ›ii despre ziua de azi...">

                    <div id="reflectionPromptsContainer" style="margin-top: 20px;">
                        <p>Puncte de start pentru reflecÈ›ie (alege un ghid):</p>
                        <div class="prompt-button-group" id="reflectionPrompts">
                            <!-- Butoanele vor fi generate de JavaScript -->
                        </div>
                    </div>

                    <div id="activeJurnalPromptBox" class="prompt-box" style="display: none;">
                        <div class="prompt-box-header">
                            <strong id="activeJurnalPromptTitle">Ghid activ:</strong>
                            <button type="button" onclick="window.hideActiveJurnalPromptManual()" class="hide-prompt-button" title="Ascunde ghidul">Ã—</button>
                        </div>
                        <div id="activeJurnalPromptContent" class="prompt-content-display"></div>
                        <p style="font-size:0.85em; text-align:right; margin-top:8px; color: #64748B;"><em>Acest ghid este pentru inspiraÈ›ie. Scrie Ã®n cÃ¢mpul de mai jos.</em></p>
                    </div>

                    <label for="journalContent" style="margin-top: 15px;">Intrarea ta Ã®n jurnal:</label>
                    <textarea id="journalContent" name="journalContent" rows="12" placeholder="Scrie liber aici sau completeazÄƒ rÄƒspunzÃ¢nd la Ã®ntrebÄƒrile din ghidul afiÈ™at..."></textarea>

                    <button type="button" id="saveJournalEntryButton">SalveazÄƒ Jurnal È™i Cere Feedback AI</button>
                </form>
                <div id="jurnalConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>

        <!-- ConÈ›inutul FiÈ™ei Terapeutice -->
        <div id="fisaFormContainer" class="tab-content">
            <section class="form-section-container">
                <h2>FiÈ™Äƒ de Monitorizare TerapeuticÄƒ</h2>
                <p>CompleteazÄƒ paÈ™ii pentru a explora Ã®n detaliu o situaÈ›ie specificÄƒ.</p>

                <div class="progress-bar">
                    <div class="progress" id="fisaProgress"></div>
                </div>

                <form id="fisaExercitiuForm" novalidate>
                    <!-- PAÈ˜II FIÈ˜EI (preluaÈ›i È™i adaptaÈ›i cu prefixul 'fisa-step-') -->
                    <div class="question-card form-step form-step-active" id="fisa-step-1">
                        <h3>Care este situaÈ›ia?</h3>
                        <p>Descrie contextul care a declanÈ™at emoÈ›iile/comportamentul.</p>
                        <textarea name="situatie" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-2">
                        <h3>Ce Ã®mi trece prin minte?</h3>
                        <p>IdentificÄƒ gÃ¢ndurile automate.</p>
                        <textarea name="ganduri" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-3">
                        <h3>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</h3>
                        <p>NoteazÄƒ emoÈ›iile È™i intensitatea lor (0-100).</p>
                        <textarea name="emotii" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-4">
                        <h3>Ce mod este activ?</h3>
                        <p>Copil vulnerabil, critic interior, adult sÄƒnÄƒtos?</p>
                        <textarea name="mod_activ" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-5">
                        <h3>Ce comportament simÈ›i cÄƒ adopÈ›i?</h3>
                        <p>Evitare, confruntare, sacrificiu?</p>
                        <textarea name="comportament" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-6">
                        <h3>Care sunt nevoile tale mai profunde?</h3>
                        <p>SiguranÈ›Äƒ, validare, acceptare?</p>
                        <textarea name="nevoi_profunde" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-7">
                        <h3>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</h3>
                        <p>ReflecteazÄƒ la eficienÈ›a reacÈ›iilor tale.</p>
                        <textarea name="ajutor_comportament" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-8">
                        <h3>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</h3>
                        <p>O abordare diferitÄƒ pentru a avea grijÄƒ de tine.</p>
                        <textarea name="adult_sanatos" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-9">
                        <h3>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</h3>
                        <p>Ce dovezi ai?</p>
                        <textarea name="dovezi_adevar" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-10">
                        <h3>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</h3>
                        <p>ExistÄƒ argumente contra?</p>
                        <textarea name="dovezi_fals" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-11">
                        <h3>ExistÄƒ o explicaÈ›ie alternativÄƒ?</h3>
                        <p>Alte interpretÄƒri posibile?</p>
                        <textarea name="explicatie_alternativa" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-12">
                        <h3>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                        <p>IdentificÄƒ fricile catastrofale.</p>
                        <textarea name="scenariu_negativ" rows="3" required></textarea>
                    </div>
                     <div class="question-card form-step" id="fisa-step-13">
                        <h3>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                        <p>ExploreazÄƒ scenariul pozitiv.</p>
                        <textarea name="scenariu_optimist" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-14">
                        <h3>Care este cel mai realist rezultat?</h3>
                        <p>DupÄƒ explorarea extremelor.</p>
                        <textarea name="rezultat_realist" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-15">
                        <h3>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</h3>
                        <p>Impactul asupra emoÈ›iilor È™i comportamentelor.</p>
                        <textarea name="schimbare_gandire" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-16">
                        <h3>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</h3>
                        <p>Perspectiva empaticÄƒ externÄƒ.</p>
                        <textarea name="sfat_prieten" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-17">
                        <h3>VÄƒd doar partea rea a lucrurilor?</h3>
                        <p>ObservÄƒ posibilele aspecte pozitive ignorate.</p>
                        <textarea name="partea_rea" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-18">
                        <h3>Ãmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</h3>
                        <p>RecunoaÈ™te limitele influenÈ›ei tale.</p>
                        <textarea name="responsabilitate" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-19">
                        <h3>MÄƒ condamn Ã®n baza unui singur eveniment?</h3>
                        <p>Un eveniment nu defineÈ™te valoarea ta.</p>
                        <textarea name="condamnare" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-20">
                        <h3>Privesc situaÈ›ia Ã®n termeni extremi?</h3>
                        <p>GÃ¢ndirea alb/negru poate distorsiona.</p>
                        <textarea name="termeni_extremi" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-21">
                        <h3>Exagerez situaÈ›ia?</h3>
                        <p>Amplifici reacÈ›iile sau impactul?</p>
                        <textarea name="exagerare" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-22">
                        <h3>ExistÄƒ È™i alÈ›i factori responsabili?</h3>
                        <p>O perspectivÄƒ completÄƒ asupra cauzelor.</p>
                        <textarea name="factori_responsabili" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-23">
                        <h3>Am sÄƒrit direct la concluzii?</h3>
                        <p>Ai suficiente dovezi?</p>
                        <textarea name="concluzii" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-24">
                        <h3>Ãmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</h3>
                        <p>Acestea pot genera anxietate.</p>
                        <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-25">
                        <h3>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</h3>
                        <p>RecunoaÈ™te È™i punctele tale forte.</p>
                        <textarea name="slabiciuni" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-26">
                        <h3>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</h3>
                        <p>Acceptarea poate reduce stresul.</p>
                        <textarea name="cum_ar_trebui" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-27">
                        <h3>MÄƒ aÈ™tept sÄƒ fiu perfect?</h3>
                        <p>PerfecÈ›ionismul poate fi frustrant.</p>
                        <textarea name="perfectiune" rows="3" required></textarea>
                    </div>
                    <div class="question-card form-step" id="fisa-step-28">
                        <h3>Completare finalizatÄƒ!</h3>
                        <p>FelicitÄƒri! ApasÄƒ butonul de mai jos pentru a salva fiÈ™a È™i a genera feedback AI.</p>
                    </div>

                    <div class="step-navigation">
                        <button type="button" id="fisaPrevButton">Ãnapoi</button>
                        <button type="button" id="fisaNextButton">Ãnainte</button>
                    </div>
                    <button type="button" id="fisaAddButton">SalveazÄƒ FiÈ™a È™i GenereazÄƒ Feedback AI</button>
                </form>
                <div id="fisaConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>
    </main>

    <section id="cardsContainerArea">
        <h3 id="introspectiiTitle">Istoricul IntrospecÈ›iilor Tale</h3>
        <h2 id="collabViewTitle" style="display:none;"></h2> <!-- Pentru titlul din modul colaborare -->
        <div class="card-view-unified" id="introspectiiCardContainer">
            <!-- Cardurile vor fi adÄƒugate aici -->
        </div>
    </section>

    <div class="collaboration-section">
        <button type="button" id="generateLinkButton">PartajeazÄƒ IntrospecÈ›iile (GenereazÄƒ Link)</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <h3>DiscutÄƒ cu PsihoGPT</h3>
        <div id="chatMessages"></div>
        <textarea id="chatInput" rows="2" placeholder="Scrie mesajul tÄƒu... Enter pentru a trimite."></textarea>
        <button id="sendChatMessageButton" disabled>Trimite Mesaj</button>
        <p id="chatStatus">Chatul AI nu este activ.</p>
    </div>
    <button id="toggleChatButton" style="display: none;">ğŸ’¬</button>

</body>
</html>