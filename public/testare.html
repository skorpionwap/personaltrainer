<!DOCTYPE html>
<html>
<head>
    <title>AplicaÈ›ie IntrospecÈ›ie - Jurnal & FiÈ™e & NotiÈ›e</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, deleteField, doc, getDoc, updateDoc, arrayUnion, query, where, setDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // --- CONFIGURARE FIREBASE & GEMINI (UNICÄ‚) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98", // ÃŽNLOCUIEÈ˜TE CU CHEIA TA
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng"; // ÃŽNLOCUIEÈ˜TE CU CHEIA TA
    const GEMINI_MODEL_NAME_FEEDBACK_FISA = "gemini-1.5-flash-latest"; // Recomandat: foloseÈ™te 'latest' sau o versiune specificÄƒ stabilÄƒ
    const GEMINI_MODEL_NAME_FEEDBACK_JURNAL = "gemini-1.5-flash-latest";
    const GEMINI_MODEL_NAME_CHAT = "gemini-1.5-flash-latest";


    let genAI, geminiModelFisaFeedback, geminiModelJurnalFeedback, geminiModelChat;

    if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            geminiModelFisaFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_FISA });
            geminiModelJurnalFeedback = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_FEEDBACK_JURNAL });
            geminiModelChat = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME_CHAT });
            console.log("SDK Gemini iniÈ›ializat. Modele:", GEMINI_MODEL_NAME_FEEDBACK_FISA, GEMINI_MODEL_NAME_FEEDBACK_JURNAL, GEMINI_MODEL_NAME_CHAT);
        } catch (e) {
            console.error("Eroare criticÄƒ la iniÈ›ializarea SDK Gemini:", e);
            alert("Eroare la iniÈ›ializarea serviciului AI. FuncÈ›ionalitatea AI va fi limitatÄƒ.");
            geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
        }
    } else {
        console.warn("Cheia API Gemini nu este configuratÄƒ. FuncÈ›ionalitatea AI va fi dezactivatÄƒ.");
        geminiModelFisaFeedback = null; geminiModelJurnalFeedback = null; geminiModelChat = null;
    }

    // --- VARIABILE GLOBALE È˜I STÄ‚RI ---
    let currentUserId = null;
    let dataAlreadyLoaded = false; // Pentru introspecÈ›ii È™i notiÈ›e
    let currentFisaStep = 1;
    let totalFisaSteps = 0;
    let selectedJurnalPrompt = null;
    const jurnalPromptsList = [
            {
                label: "ðŸŒ¡ï¸ ExploreazÄƒ o emoÈ›ie", id: "explorare_emotie",
                text: "ðŸŒ¡ï¸ *AstÄƒzi simt...*\nNumeÈ™te emoÈ›ia dominantÄƒ: ________________\n\nðŸ” *Unde o simt Ã®n corp?*\nDescrie senzaÈ›iile (tensiune, greutate, pulsaÈ›ie etc.): ________________\n\nðŸ’­ *Ce gÃ¢nduri vin cu aceastÄƒ emoÈ›ie?*\nNoteazÄƒ gÃ¢ndurile automate, chiar dacÄƒ par â€žexagerateâ€: ________________\n\nðŸ“š *ÃŽn ce context a apÄƒrut?*\nCe s-a Ã®ntÃ¢mplat exact? Ce a declanÈ™at-o? ________________\n\nðŸ’§ *Ce nevoie ar putea semnala?*\nDe ce are nevoie aceastÄƒ parte din tine? Ce lipseÈ™te? ________________\n\nðŸ’Œ *DacÄƒ aÈ™ avea compasiune pentru mine acum...*\nCe mi-aÈ™ spune? Ce gest aÈ™ face pentru mine? ________________\n"
            },
            {
                label: "ðŸ“ AnalizeazÄƒ o situaÈ›ie", id: "analiza_situatie",
                text: "SituaÈ›ia care mÄƒ preocupÄƒ este: ________________\n\nCe s-a Ã®ntÃ¢mplat exact? (Fapte): ________________\nInterpretarea mea iniÈ›ialÄƒ (GÃ¢nduri automate): ________________\nEmoÈ›iile principale: ________________\nO altÄƒ perspectivÄƒ (Reframing): ________________\nCe am Ã®nvÄƒÈ›at/pot Ã®nvÄƒÈ›a? (LecÈ›ii): ________________\n"
            },
            {
                label: "ðŸ—£ï¸ Dialog Voce CriticÄƒ", id: "dialog_voce_critica",
                text: "ðŸ—£ï¸ *Vocea mea interioarÄƒ Ã®mi spune...*\n(\"EÈ™ti slab\", \"Nu faci destul\", \"O sÄƒ fii respins\"...): ________________\n\nðŸ˜” *CÃ¢nd aud acest mesaj, mÄƒ simt...*\n(emoÈ›ii È™i senzaÈ›ii fizice): ________________\n\nðŸ§’ *AceastÄƒ voce seamÄƒnÄƒ cu...*\n(E o voce veche? un pÄƒrinte? un profesor? un fost partener?): ________________\n\nðŸ§  *Ce nevoie neÃ®mplinitÄƒ e Ã®n spatele acestui mesaj?*\n(Poate recunoaÈ™tere, protecÈ›ie, control, apartenenÈ›Äƒ?): ________________\n\nðŸ§˜ *RÄƒspunsul meu ca Adult SÄƒnÄƒtos ar fi...*\n(\"Apreciez cÄƒ vrei sÄƒ mÄƒ protejezi, dar acum aleg altceva.\"): ________________\n"
            },
            {
                label: "ðŸ’– RecunoÈ™tinÈ›Äƒ & Resurse", id: "recunostinta_resurse",
                text: "ðŸ’– *AstÄƒzi aleg sÄƒ vÄƒd ce e bun...*\nSunt recunoscÄƒtor/oare pentru:\n1. ________________\n2. ________________\n3. ________________\n\nðŸŒ± *O resursÄƒ interioarÄƒ pe care mÄƒ pot baza astÄƒzi este...*\n(ex: curaj, blÃ¢ndeÈ›e, claritate, capacitatea de a simÈ›i): ________________\n\nðŸ› *Un gest de auto-Ã®ngrijire pe care Ã®l pot face azi...*\n(chiar dacÄƒ e mic): ________________\n"
            },
            {
                label: "ðŸŒ€ Ritual ReconstrucÈ›ie InterioarÄƒ", id: "ritual_reconstructie",
                text: `ðŸ§­ MASTER TEMPLATE â€“ Scriere TerapeuticÄƒ de Integrare È™i Vindecare\nDenumire: â€žRitual de reconstrucÈ›ie interioarÄƒâ€\nScop: Eliberare, Clarificare, ConÈ›inere, ÃŽnÈ›elepciune, DirecÈ›ie\n\nI. ðŸ” INVITAÈšIE LA AUTENTICITATE\nâ€žCe parte din mine cere atenÈ›ie acum?â€\n   * Ce trÄƒiesc cu adevÄƒrat, fÄƒrÄƒ filtru, fÄƒrÄƒ poveste cosmetizatÄƒ?\n   * Ce mi-e ruÈ™ine sÄƒ simt sau sÄƒ recunosc chiar È™i Ã®n scris?\n   * Ce parte din mine se simte exclusÄƒ, neauzitÄƒ, ignoratÄƒ?\nRÄƒspuns: ________________\n\nII. ðŸŒŠ CONTAINERE EMOÈšIONALE\nâ€žCe simte corpul meu? Unde locuieÈ™te durerea?â€\n   * Unde simt emoÈ›ia Ã®n corp? Cum se manifestÄƒ? (Tensiune, Ã®nÈ›epÄƒturi, etc.)\n   * DacÄƒ ar avea o culoare, formÄƒ, texturÄƒ â€“ cum ar arÄƒta?\n   * Pot respira Ã®n acea zonÄƒ 3 minute, fÄƒrÄƒ sÄƒ fug?\nRÄƒspuns: ________________\n\nIII. ðŸ§  DECODIFICARE NARATIVÄ‚\nâ€žCe poveste Ã®mi spun? Este Ã®ntreagÄƒ?â€\n   * Ce naraÈ›iune inconÈ™tientÄƒ guverneazÄƒ trÄƒirea mea? (ex: â€žNu sunt dorit.â€)\n   * De unde vine aceastÄƒ naraÈ›iune? CÃ¢nd am mai trÄƒit ceva similar?\n   * Ce parte din mine (copil rÄƒnit, etc.) scrie aceastÄƒ poveste?\nRÄƒspuns: ________________\n\nIV. ðŸ§© INTEGRARE EXPLICATIVÄ‚\nâ€žCe Ã®nÈ›eleg nou despre mine din aceastÄƒ durere?â€\n   * Ce nevoi profunde au fost ignorate sau negate?\n   * Ce am protejat, de fapt, prin reacÈ›ia mea?\n   * Ce emoÈ›ii contradictorii coexistÄƒ Ã®n mine È™i ce spun ele?\nRÄƒspuns: ________________\n\nV. ðŸªž COMPASIUNE È˜I BLÃ‚NDEÈšE\nâ€žCum pot fi pÄƒrinte pentru mine acum?â€\n   * DacÄƒ mi-aÈ™ È›ine partea rÄƒnitÄƒ Ã®n braÈ›e, ce i-aÈ™ spune?\n   * Ce aÈ™ vrea sÄƒ aud din partea unei figuri ideale de susÈ›inere?\n   * Pot lÄƒsa iubirea, nu logica, sÄƒ conducÄƒ acest moment?\nRÄƒspuns: ________________\n\nVI. ðŸ”® RECONFIGURARE IDENTITARÄ‚\nâ€žCine sunt eu dincolo de aceastÄƒ ranÄƒ?â€\n   * Ce adevÄƒr despre mine rÄƒmÃ¢ne valabil, chiar È™i Ã®n durere?\n   * Cine devin dacÄƒ Ã®nvÄƒÈ› sÄƒ stau cu mine Ã®n acest spaÈ›iu?\n   * DacÄƒ aÈ™ fi un personaj simbolic acum, cine aÈ™ fi?\nRÄƒspuns: ________________\n\nVII. âœï¸ ACTUL SACRU DE ALEGERE\nâ€žCe aleg de azi, pentru mine?â€\n   * Ce meritÄƒ sÄƒ las sÄƒ plece?\n   * Ce Ã®mi iau ca Ã®nvÄƒÈ›ÄƒturÄƒ de Ã®ncredere Ã®n viaÈ›Äƒ?\n   * Ce ritual zilnic/mic obicei pot Ã®ncepe pentru a onora aceastÄƒ transformare?\nRÄƒspuns: ________________\n\nVIII. (OpÈ›ional) ðŸ“œ SCRISOARE-RITUAL\nScrie o scrisoare cÄƒtre... (persoana, partea din tine, situaÈ›ia):\nRÄƒspuns: ________________\n`
            }
        ];
    let chatSession = null;
    const CHAT_HISTORY_DOC_ID_PREFIX = "chatHistory_";
    let isChatInitialized = false;

    // NOI VARIABILE PENTRU SELECÈšIA MESAJELOR DIN CHAT
    let selectedChatMessages = [];
    let messageIdCounter = 0; // Pentru ID-uri unice de mesaje Ã®n UI-ul chatului

    // -----------------------------------------------------------------
    // DEFINIÈšIILE FUNCÈšIILOR (EXISTENTE È˜I NOI)
    // -----------------------------------------------------------------

    // --- FUNCÈšII TAB-URI, FIÈ˜Ä‚, JURNAL (EXISTENTE) ---
    function showTab(tabName) {
        document.getElementById('jurnalFormContainer').style.display = (tabName === 'jurnal' ? 'block' : 'none');
        document.getElementById('fisaFormContainer').style.display = (tabName === 'fisa' ? 'block' : 'none');
        document.getElementById('tabButtonJurnal').classList.toggle('active', tabName === 'jurnal');
        document.getElementById('tabButtonFisa').classList.toggle('active', tabName === 'fisa');
        document.getElementById('jurnalConfirmationMessage').style.display = 'none';
        document.getElementById('fisaConfirmationMessage').style.display = 'none';
        // Ascunde mesajele de confirmare din zona notiÈ›elor
        const notiteConfirmMsg = document.getElementById('notiteConfirmationMessage');
        if (notiteConfirmMsg) notiteConfirmMsg.style.display = 'none';
    }

    function updateFisaProgressBar() {
        const progress = document.getElementById('fisaProgress');
        if (progress && totalFisaSteps > 0) {
            progress.style.width = (currentFisaStep / totalFisaSteps) * 100 + '%';
        }
    }

    function fisaNextStep() {
        if (currentFisaStep < totalFisaSteps) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep++;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function fisaPreviousStep() {
        if (currentFisaStep > 1) {
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.remove('form-step-active');
            currentFisaStep--;
            document.getElementById(`fisa-step-${currentFisaStep}`)?.classList.add('form-step-active');
            updateFisaProgressBar();
        }
    }

    function initializeFisaFormFunctionality() {
        const formSteps = document.querySelectorAll('form#fisaExercitiuForm div.question-card.form-step');
        if (formSteps.length > 0) {
            totalFisaSteps = formSteps.length;
            formSteps.forEach((step, index) => {
                step.classList.toggle('form-step-active', index === 0);
            });
            currentFisaStep = 1;
            updateFisaProgressBar();
        } else {
            totalFisaSteps = 0;
        }
        document.getElementById("fisaNextButton")?.addEventListener("click", fisaNextStep);
        document.getElementById("fisaPrevButton")?.addEventListener("click", fisaPreviousStep);
        document.getElementById("fisaAddButton")?.addEventListener("click", salveazaIntrospectieFisa);
    }

    function toggleActiveJurnalPrompt(show, promptData = null) {
        const box = document.getElementById('activeJurnalPromptBox');
        const titleEl = document.getElementById('activeJurnalPromptTitle');
        const contentEl = document.getElementById('activeJurnalPromptContent');
        const journalTextarea = document.getElementById("journalContent");

        if (show && promptData) {
            selectedJurnalPrompt = promptData;
            if(titleEl) titleEl.textContent = `Ghid activ: ${promptData.label}`;
            if(contentEl) contentEl.textContent = promptData.text;
            if(box) box.style.display = 'block';
            if (contentEl) contentEl.scrollTop = 0;
            
            if (journalTextarea && journalTextarea.value.trim() !== "" && promptData.id !== (selectedJurnalPrompt?.previousIdForClearCheck)) {
                if (confirm("DoreÈ™ti sÄƒ È™tergi conÈ›inutul actual al jurnalului pentru a Ã®ncepe cu acest nou ghid?")) {
                   journalTextarea.value = "";
                }
            }
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = promptData.id;
        } else {
            selectedJurnalPrompt = null;
            if(box) box.style.display = 'none';
        }
    }

    window.hideActiveJurnalPromptManual = function() {
        const box = document.getElementById('activeJurnalPromptBox');
        if(box) box.style.display = 'none';
    }

    async function salveazaIntrospectieFisa() {
        const form = document.getElementById("fisaExercitiuForm");
        const confirmationMessage = document.getElementById('fisaConfirmationMessage');

        if (form && !form.checkValidity()) {
            form.reportValidity();
            const currentStepElement = form.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid:not(fieldset)');
            if (firstInvalidField) {
                firstInvalidField.focus();
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii din pasul curent Ã®nainte de a salva.");
            } else {
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii.");
            }
            return;
        }

        const continutFisa = {};
        if (form) {
            const formData = new FormData(form);
            formData.forEach((value, key) => { continutFisa[key] = value.trim(); });
        } else {
            console.error("Formularul 'fisaExercitiuForm' nu a fost gÄƒsit.");
            return;
        }

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'fisa',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutFisa
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sÄƒ fiÈ›i autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const addButton = document.getElementById("fisaAddButton");
        let originalAddButtonText = "";
        if (addButton) {
            originalAddButtonText = addButton.textContent;
            addButton.textContent = "Se salveazÄƒ È™i se genereazÄƒ...";
            addButton.disabled = true;
        }
        if (confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id;
            if (addButton) addButton.textContent = "Se genereazÄƒ AI...";

            const feedbackGenerat = await genereazaFeedbackPentruIntrospectie(introspectieData);
            
            const docSnapshot = await getDoc(docRef);
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                introspectieData.feedbackAI_history = feedbackGenerat && !feedbackGenerat.error ? [feedbackGenerat] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            if (form) {
                form.reset(); currentFisaStep = 1;
                form.querySelectorAll('.form-step').forEach(step => step.classList.remove('form-step-active'));
                const firstStepEl = document.getElementById('fisa-step-1');
                if (firstStepEl) firstStepEl.classList.add('form-step-active');
                updateFisaProgressBar();
            }

            if (confirmationMessage) {
                if (feedbackGenerat && !feedbackGenerat.error && !feedbackGenerat.error_parsing) {
                    confirmationMessage.textContent = 'FiÈ™a a fost salvatÄƒ È™i feedback-ul AI generat cu succes!';
                    confirmationMessage.className = 'confirmation-message success';
                } else if (feedbackGenerat && (feedbackGenerat.error || feedbackGenerat.error_parsing)) {
                    confirmationMessage.textContent = `FiÈ™a salvatÄƒ. Feedback AI: ${feedbackGenerat.rawText || 'ProblemÄƒ la generare/parsare.'}`;
                    confirmationMessage.className = (feedbackGenerat.rawText && feedbackGenerat.rawText.toLowerCase().includes("limit")) ? 'confirmation-message warning' : 'confirmation-message error';
                } else {
                    confirmationMessage.textContent = 'FiÈ™a salvatÄƒ, dar feedback-ul AI nu a putut fi generat/procesat.';
                    confirmationMessage.className = 'confirmation-message error';
                }
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if (confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea fiÈ™ei sau generare feedback:", error);
            if (confirmationMessage) {
                confirmationMessage.textContent = 'Eroare la salvarea fiÈ™ei. ÃŽncercaÈ›i din nou.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            if (addButton) {
                addButton.textContent = originalAddButtonText;
                addButton.disabled = false;
            }
        }
    }

    function initializeJurnalFormFunctionality() {
        const promptsContainerEl = document.getElementById("reflectionPrompts");
        const journalTextarea = document.getElementById("journalContent");
        if (!promptsContainerEl || !journalTextarea) return;

        promptsContainerEl.innerHTML = '';
        jurnalPromptsList.forEach(prompt => {
            const button = document.createElement("button");
            button.textContent = prompt.label;
            button.className = "prompt-button";
            button.type = "button";
            button.title = "AfiÈ™eazÄƒ acest ghid È™i foloseÈ™te-l ca referinÈ›Äƒ";
            button.onclick = () => {
                toggleActiveJurnalPrompt(true, prompt);
                journalTextarea.focus();
            };
            promptsContainerEl.appendChild(button);
        });
        document.getElementById("saveJournalEntryButton")?.addEventListener("click", salveazaIntrospectieJurnal);
    }

    async function salveazaIntrospectieJurnal() {
        const journalTextarea = document.getElementById("journalContent");
        const journalTitleInput = document.getElementById("journalTitle");
        const confirmationMessage = document.getElementById('jurnalConfirmationMessage');

        if (!journalTextarea || journalTextarea.value.trim() === "") {
            alert("VÄƒ rugÄƒm sÄƒ scrieÈ›i ceva Ã®n jurnal Ã®nainte de a salva.");
            return;
        }

        const tipPromptFolosit = selectedJurnalPrompt ? selectedJurnalPrompt.id : "prompt_personalizat";

        const continutJurnal = {
            titluJurnal: (journalTitleInput?.value.trim() !== "") ? journalTitleInput.value.trim() : `Intrare din ${new Date().toLocaleDateString("ro-RO")}`,
            textJurnal: journalTextarea.value,
            promptUtilizatJurnal: tipPromptFolosit
        };

        const introspectieData = {
            ownerUid: currentUserId,
            type: 'jurnal',
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            continut: continutJurnal
        };

        if (!introspectieData.ownerUid) {
            alert("Trebuie sÄƒ fiÈ›i autentificat pentru a salva datele.");
            window.location.href = "login.html"; return;
        }

        const saveButton = document.getElementById("saveJournalEntryButton");
        const originalButtonText = saveButton.textContent;
        saveButton.textContent = "Se salveazÄƒ..."; saveButton.disabled = true;
        if(confirmationMessage) confirmationMessage.style.display = 'none';

        try {
            const docRef = await addDoc(collection(db, "introspectii"), introspectieData);
            introspectieData.id = docRef.id;
            saveButton.textContent = "Se genereazÄƒ AI...";

            const parsedFeedback = await genereazaFeedbackPentruIntrospectie(introspectieData);

            const docSnapshot = await getDoc(docRef);
            if (docSnapshot.exists()) {
                afiseazaCardIntrospectie({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                introspectieData.feedbackAI_history = parsedFeedback && !parsedFeedback.error ? [parsedFeedback] : [];
                afiseazaCardIntrospectie(introspectieData);
            }

            journalTextarea.value = "";
            if (journalTitleInput) journalTitleInput.value = "";
            toggleActiveJurnalPrompt(false);
            if(selectedJurnalPrompt) selectedJurnalPrompt.previousIdForClearCheck = null;

            if(confirmationMessage) {
                confirmationMessage.textContent = parsedFeedback.error ? `Intrare salvatÄƒ. Feedback AI: ${parsedFeedback.rawText}` : 'Intrare salvatÄƒ È™i feedback AI generat!';
                confirmationMessage.className = `confirmation-message ${parsedFeedback.error ? 'error' : 'success'}`;
                confirmationMessage.style.display = 'block';
                setTimeout(() => { if(confirmationMessage) confirmationMessage.style.display = 'none'; }, 9000);
            }
        } catch (error) {
            console.error("Eroare la salvarea intrÄƒrii de jurnal sau generare feedback:", error);
            if(confirmationMessage){
                confirmationMessage.textContent = 'Eroare la salvare sau la generarea feedback-ului AI.';
                confirmationMessage.className = 'confirmation-message error';
                confirmationMessage.style.display = 'block';
            }
        } finally {
            saveButton.textContent = originalButtonText;
            saveButton.disabled = false;
        }
    }


    // --- FUNCÈšII GEMINI È˜I FEEDBACK (EXISTENTE, CU AJUSTÄ‚RI LA maxOutputTokens) ---
    async function callGeminiAPI(promptText, modelToUse, generationConfigOptions = {}) {
        if (!modelToUse) {
            console.error("Modelul Gemini specificat este invalid sau neiniÈ›ializat.");
            return "EROARE: Model AI neiniÈ›ializat. VerificÄƒ cheia API.";
        }
        try {
            // MODIFICAT: Am redus maxOutputTokens la o valoare mai rezonabilÄƒ
            const requestPayload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }],
                generationConfig: { temperature: 0.6, maxOutputTokens: 8192, ...generationConfigOptions } // Redus de la 80000
            };
            console.log(`Trimitem la Gemini (${modelToUse === geminiModelChat ? "Chat" : (modelToUse === geminiModelFisaFeedback ? "FiÈ™Äƒ" : "Jurnal") }, primele 200 caractere):`, promptText.substring(0, 200));
            
            // Pentru Chat, folosim sendMessageStream. Pentru feedback, folosim generateContent.
            if (modelToUse === geminiModelChat && chatSession) { // VerificÄƒm specific dacÄƒ e modelul de chat È™i avem o sesiune
                 // Acest bloc nu ar trebui sÄƒ fie apelat din callGeminiAPI pentru chat, chat-ul are propria sa logicÄƒ de trimitere
                 console.warn("callGeminiAPI a fost apelat pentru modelul de chat. Ar trebui folosit chatSession.sendMessageStream().");
                 // TotuÈ™i, ca fallback, dacÄƒ ajunge aici:
                 const result = await modelToUse.generateContent(requestPayload); // Solicitare unary pentru acest fallback
                 const response = result.response;
                 if (response?.candidates?.[0]?.content?.parts?.[0]?.text) return response.candidates[0].content.parts[0].text;
                 // ... restul logicii de eroare din callGeminiAPI ...
            }


            // Solicitare non-streaming pentru feedback fiÈ™e/jurnale
            const result = await modelToUse.generateContent(requestPayload);
            const response = result.response;

            if (response?.candidates?.[0]?.content?.parts?.[0]?.text) {
                if (response.candidates[0].finishReason && !["STOP", "MAX_TOKENS"].includes(response.candidates[0].finishReason)) {
                    console.warn("Gemini a oprit generarea prematur:", response.candidates[0].finishReason, response.candidates[0].safetyRatings);
                    return `EROARE Gemini: Generare opritÄƒ (Motiv: ${response.candidates[0].finishReason}). Detalii: ${JSON.stringify(response.candidates[0].safetyRatings || 'N/A')}`;
                }
                return response.candidates[0].content.parts[0].text;
            } else if (response?.promptFeedback?.blockReason) {
                console.error("Prompt blocat de Gemini:", response.promptFeedback.blockReasonDetail || response.promptFeedback.blockReason);
                 return `EROARE Gemini: Prompt blocat (Motiv: ${response.promptFeedback.blockReason}). Detalii: ${JSON.stringify(response.promptFeedback.blockReasonDetail || response.promptFeedback.safetyRatings || 'N/A')}`;
            } else {
                console.error("RÄƒspuns Gemini neaÈ™teptat sau gol:", JSON.stringify(response, null, 2));
                return "EROARE Gemini: RÄƒspuns invalid sau gol de la API.";
            }
        } catch (error) {
            console.error("Eroare detaliatÄƒ la callGeminiAPI:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare API necunoscutÄƒ"}`;
             if (error.toString().toLowerCase().includes("api key not valid") ||
                (error.message && error.message.toLowerCase().includes("permission denied")) ||
                (error.message && error.message.toLowerCase().includes("api_key_invalid")) ||
                (error.status && error.status === 403)) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validÄƒ sau nu are permisiuni.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare API Gemini a fost depÄƒÈ™itÄƒ.";
            } else if (error.message && (error.message.toLowerCase().includes("candidate.finish_reason") || error.message.toLowerCase().includes("safety") || error.message.toLowerCase().includes("blocked due to safety_settings"))) {
                errorMessage = "EROARE Gemini: Generarea opritÄƒ (motive de siguranÈ›Äƒ/conÈ›inut).";
            }  else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 let modelName = "necunoscut";
                 if (modelToUse === geminiModelFisaFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_FISA;
                 else if (modelToUse === geminiModelJurnalFeedback) modelName = GEMINI_MODEL_NAME_FEEDBACK_JURNAL;
                 else if (modelToUse === geminiModelChat) modelName = GEMINI_MODEL_NAME_CHAT;
                 errorMessage = `EROARE Gemini: Modelul ${modelName} nu a fost gÄƒsit.`;
            }
            return errorMessage;
         }
    }

    // ... (buildAdaptiveAIPromptFisa È™i buildAdaptiveAIPromptJurnal - existente, fÄƒrÄƒ modificÄƒri majore necesare acum) ...
    // ... (genereazaFeedbackPentruIntrospectie - existentÄƒ, va folosi callGeminiAPI cu maxOutputTokens redus) ...

    // --- FUNCÈšII AFIÈ˜ARE CARDURI INTROSPECÈšII (EXISTENTE) ---
    // ... (incarcaToateIntrospectiile, afiseazaIstoricFeedbackIntrospectie, afiseazaCardIntrospectie) ...
    // ... (regenereazaFeedbackPentruIntrospectieCard, stergeUltimulFeedbackIntrospectie, stergeTotIstoriculFeedbackIntrospectie, stergeIntrospectie) ...

    // --- FUNCÈšII NOI PENTRU NOTIÈšE DIN CHAT ---

    function updateChatGlobalActions() {
        const actionsDiv = document.getElementById('chatGlobalActions');
        const saveButton = document.getElementById('saveSelectedChatButton');
        const clearButton = document.getElementById('clearChatSelectionButton');

        if (!actionsDiv || !saveButton || !clearButton) return;

        if (selectedChatMessages.length > 0) {
            actionsDiv.style.display = 'flex'; // Sau 'block' dacÄƒ preferi, sau ajusteazÄƒ stilul
            saveButton.textContent = `SalveazÄƒ SelecÈ›ia (${selectedChatMessages.length})`;
            saveButton.disabled = false;
            clearButton.disabled = false;
        } else {
            actionsDiv.style.display = 'none';
            saveButton.disabled = true;
            clearButton.disabled = true;
        }
    }

    function toggleMessageSelection(messageElement, role, rawMessageContent) {
        if (!messageElement || !messageElement.dataset) return;
        const msgId = messageElement.dataset.id;
        if (!msgId) return;

        const existingIndex = selectedChatMessages.findIndex(item => item.id === msgId);

        if (existingIndex > -1) { // Deja selectat, deci deselectÄƒm
            selectedChatMessages.splice(existingIndex, 1);
            messageElement.classList.remove('selected');
        } else { // Nu e selectat, deci selectÄƒm
            selectedChatMessages.push({
                id: msgId,
                element: messageElement,
                role: role === "AI" ? "model" : (role === "user" ? "user" : "unknown"), // AsigurÄƒ rol valid
                content: rawMessageContent
            });
            messageElement.classList.add('selected');
        }
        updateChatGlobalActions();
    }
    
    async function salveazaNotitaChat(userId, dataToSave) {
        if (!userId || !dataToSave) {
            console.error("Lipsesc datele pentru salvarea notiÈ›ei.");
            alert("Eroare: Date incomplete pentru salvarea notiÈ›ei.");
            return;
        }
        const notitaDoc = {
            ownerUid: userId,
            timestampCreare: Timestamp.fromDate(new Date()),
            dateAfisare: new Date().toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            titlu: dataToSave.titlu || `NotiÈ›Äƒ din ${new Date().toLocaleDateString("ro-RO")}`,
            continut: dataToSave.continut || [], // Array de {role, text}
            tip: "chatNotita",
            timestampMesajOriginal: dataToSave.timestampMesajOriginal || new Date().toISOString()
        };

        try {
            const docRef = await addDoc(collection(db, "chatNotite"), notitaDoc);
            console.log("NotiÈ›Äƒ din chat salvatÄƒ cu ID: ", docRef.id);
            afiseazaCardChatNotita({ id: docRef.id, ...notitaDoc }); // AfiÈ™eazÄƒ imediat noua notiÈ›Äƒ
            
            // CurÄƒÈ›Äƒ selecÈ›ia dupÄƒ salvare
            const clearButton = document.getElementById('clearChatSelectionButton');
            if (clearButton) clearButton.click();
            
            const confirmationMsg = document.getElementById('notiteConfirmationMessage');
            if(confirmationMsg) {
                confirmationMsg.textContent = 'NotiÈ›a din chat a fost salvatÄƒ cu succes!';
                confirmationMsg.className = 'confirmation-message success';
                confirmationMsg.style.display = 'block';
                setTimeout(() => { confirmationMsg.style.display = 'none'; }, 5000);
            }

        } catch (error) {
            console.error("Eroare la salvarea notiÈ›ei din chat Ã®n Firestore:", error);
            alert("A apÄƒrut o eroare la salvarea notiÈ›ei.");
        }
    }

    async function incarcaChatNotite(userId) {
        const container = document.getElementById("chatNotiteCardContainer");
        if (!container || !userId) return;

        let loadingMsg = container.querySelector(".loading-message");
        if (!container.querySelector('.chat-notita-card') && !loadingMsg) { // VerificÄƒ clasa specificÄƒ notiÈ›elor
            loadingMsg = document.createElement("p");
            loadingMsg.className = "loading-message";
            loadingMsg.textContent = "Se Ã®ncarcÄƒ notiÈ›ele din chat...";
            container.appendChild(loadingMsg);
        }
        try {
            const q = query(collection(db, "chatNotite"), where("ownerUid", "==", userId), orderBy("timestampCreare", "desc"));
            const querySnapshot = await getDocs(q);
            if (loadingMsg) loadingMsg.remove();
            
            // Nu goli containerul dacÄƒ doar adaugi, dar pentru Ã®ncÄƒrcare iniÈ›ialÄƒ e ok
            // container.innerHTML = ''; // Comentat pentru a permite adÄƒugarea incrementalÄƒ la salvare

            if (querySnapshot.empty && !container.querySelector('.chat-notita-card')) {
                container.innerHTML = "<p class='no-entries-message'>Nicio notiÈ›Äƒ din chat salvatÄƒ.</p>";
            } else {
                querySnapshot.forEach((docSnap) => {
                    // VerificÄƒ dacÄƒ un card cu acest ID existÄƒ deja pentru a evita duplicarea la reÃ®ncÄƒrcÄƒri
                    if (!container.querySelector(`.chat-notita-card[data-id="${docSnap.id}"]`)) {
                        afiseazaCardChatNotita({ id: docSnap.id, ...docSnap.data() });
                    }
                });
            }
        } catch (error) {
            console.error("Eroare Ã®ncÄƒrcare notiÈ›e din chat:", error);
            if (loadingMsg) loadingMsg.remove();
            if (!container.querySelector('.chat-notita-card')) {
                 container.innerHTML = "<p class='error-loading-message'>Eroare la Ã®ncÄƒrcarea notiÈ›elor din chat.</p>";
            }
        }
    }

    function afiseazaCardChatNotita(docData) {
        const container = document.getElementById("chatNotiteCardContainer");
        if(!container) return;

        const entryDate = docData.dateAfisare || (docData.timestampCreare?.toDate ? new Date(docData.timestampCreare.toDate()).toLocaleDateString("ro-RO") : 'DatÄƒ necunoscutÄƒ');
        const cardTitle = docData.titlu || `NotiÈ›Äƒ din ${entryDate}`;

        let detailsContentHtml = "<div class='chat-notita-content-wrapper'>";
        if (Array.isArray(docData.continut)) {
            docData.continut.forEach(item => {
                const roleDisplay = item.role === 'model' ? 'PsihoGPT' : (item.role === 'user' ? 'Eu' : 'Sistem');
                const messageClass = item.role === 'model' ? 'ai-message-in-note' : (item.role === 'user' ? 'user-message-in-note' : 'system-message-in-note');
                // Folosim pre-wrap pentru a pÄƒstra formatarea newline din mesajele originale
                detailsContentHtml += `<div class="message-item-in-note ${messageClass}"><strong>${roleDisplay}:</strong><div class="message-text-in-note">${(item.text || '').replace(/\n/g, '<br>')}</div></div>`;
            });
        } else if (typeof docData.continut === 'string') { // Fallback pentru format mai vechi
             detailsContentHtml += `<p>${docData.continut.replace(/\n/g, '<br>')}</p>`;
        }
        detailsContentHtml += "</div>";

        const card = document.createElement("div");
        card.className = "response-card chat-notita-card"; // ClasÄƒ specificÄƒ
        card.setAttribute("data-id", docData.id);

        card.innerHTML = `
            <div class="card-header">
                <span>${cardTitle}</span>
                <span class="card-date">${entryDate}</span>
            </div>
            <div class="card-content">
                <details class="chat-notita-entry-details">
                    <summary>Vezi/Ascunde conÈ›inutul notiÈ›ei</summary>
                    <div class="chat-notita-entry-content-text">${detailsContentHtml}</div>
                </details>
                <div class="card-actions">
                    <button class="discuss-notita-with-chat-button" title="ContinuÄƒ discuÈ›ia despre aceastÄƒ notiÈ›Äƒ Ã®n chat">DiscutÄƒ NotiÈ›a</button>
                    <button class="delete-notita-button" title="È˜terge AceastÄƒ NotiÈ›Äƒ">È˜terge NotiÈ›a</button>
                </div>
            </div>`;

        card.querySelector('.card-header').addEventListener('click', (e) => {
            if (!e.target.closest('button') && !e.target.closest('details')) card.classList.toggle('open');
        });

        card.querySelector('.discuss-notita-with-chat-button').addEventListener('click', async (e) => {
            e.stopPropagation();
            // Datele sunt deja Ã®n docData, nu mai e nevoie de un nou fetch dacÄƒ structura e completÄƒ
            await discutaNotitaInChat(docData);
        });
        card.querySelector('.delete-notita-button').addEventListener('click', (e) => {
            e.stopPropagation();
            stergeChatNotita(docData.id, card);
        });
        
        const noEntriesMsg = container.querySelector('.no-entries-message');
        if (noEntriesMsg) noEntriesMsg.remove();

        if (container.firstChild && container.firstChild.nodeName !== 'P') {
            container.insertBefore(card, container.firstChild);
        } else {
            if (container.firstChild && container.firstChild.nodeName === 'P') container.innerHTML = '';
            container.appendChild(card);
        }
    }

    async function stergeChatNotita(notitaId, cardElement) {
        if (confirm("Sigur doriÈ›i sÄƒ È™tergeÈ›i aceastÄƒ notiÈ›Äƒ din chat?")) {
            const confirmationMsg = document.getElementById('notiteConfirmationMessage');
            if (confirmationMsg) confirmationMsg.style.display = 'none';
            try {
                await deleteDoc(doc(db, "chatNotite", notitaId));
                cardElement.remove();
                
                const container = document.getElementById("chatNotiteCardContainer");
                if (container && !container.querySelector('.chat-notita-card') && !container.querySelector('.no-entries-message')) {
                    container.innerHTML = "<p class='no-entries-message'>Nicio notiÈ›Äƒ din chat salvatÄƒ.</p>";
                }
                if (confirmationMsg) {
                    confirmationMsg.textContent = "NotiÈ›a a fost È™tearsÄƒ!";
                    confirmationMsg.className = 'confirmation-message success';
                    confirmationMsg.style.display = 'block';
                    setTimeout(() => { confirmationMsg.style.display = 'none'; }, 5000);
                }
            } catch (error) {
                console.error("Eroare la È™tergerea notiÈ›ei din chat:", error);
                 if (confirmationMsg) {
                    confirmationMsg.textContent = "Eroare la È™tergerea notiÈ›ei.";
                    confirmationMsg.className = 'confirmation-message error';
                    confirmationMsg.style.display = 'block';
                    setTimeout(() => { confirmationMsg.style.display = 'none'; }, 5000);
                }
            }
        }
    }

    async function discutaNotitaInChat(notitaData) {
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); window.location.href = "login.html"; return; }

        const chatContainer = document.getElementById("chatContainer");
        const chatInput = document.getElementById("chatInput");

        if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
            await handleToggleChat(); // Va deschide È™i iniÈ›ializa chat-ul dacÄƒ e nevoie
        }
        // O micÄƒ pauzÄƒ pentru a permite UI-ului È™i iniÈ›ializÄƒrii chat-ului sÄƒ se finalizeze
        await new Promise(resolve => setTimeout(resolve, 200));

        if (!chatSession || !isChatInitialized) {
            displayChatMessage("Eroare: Sesiunea de chat nu este pregÄƒtitÄƒ. ÃŽncercaÈ›i din nou.", "AI-error");
            console.error("Chat session not ready for discussing note.");
            return;
        }

        let mesajContext = `Salut PsihoGPT,\n\nAÈ™ dori sÄƒ reluÄƒm discuÈ›ia sau sÄƒ aprofundÄƒm urmÄƒtoarele idei dintr-o notiÈ›Äƒ pe care am salvat-o anterior${notitaData.titlu ? ' cu titlul "' + notitaData.titlu + '"' : ''}:\n\n---\n`;
        if (Array.isArray(notitaData.continut)) {
            notitaData.continut.forEach(item => {
                const prefix = item.role === 'model' ? 'Tu (PsihoGPT) ai spus' : (item.role === 'user' ? 'Eu am spus' : 'Extras');
                mesajContext += `**${prefix}:** "${item.text}"\n\n`;
            });
        } else if (notitaData.continut) {
            mesajContext += `**ConÈ›inut:** "${notitaData.continut}"\n\n`;
        }
        mesajContext += "---\n\nCe perspective sau Ã®ntrebÄƒri suplimentare ai pentru mine pornind de la acestea?";

        if (chatInput) {
            chatInput.value = mesajContext;
            chatInput.style.height = 'auto'; 
            chatInput.style.height = (chatInput.scrollHeight) + 'px'; 
            
            // SimuleazÄƒ trimiterea mesajului
            // Este important ca handleSendChatMessage sÄƒ fie pregÄƒtitÄƒ sÄƒ gestioneze un mesaj deja populat
            if (document.getElementById("sendChatMessageButton").disabled === false) {
                 handleSendChatMessage();
            } else {
                // DacÄƒ butonul e disabled, Ã®nseamnÄƒ cÄƒ AI-ul Ã®ncÄƒ "gÃ¢ndeÈ™te" la mesajul anterior.
                // AÈ™teptÄƒm puÈ›in È™i reÃ®ncercÄƒm, sau informÄƒm utilizatorul.
                console.warn("Chat-ul proceseazÄƒ un mesaj. Se aÈ™teaptÄƒ pentru a trimite contextul notiÈ›ei...");
                setTimeout(() => {
                    if (document.getElementById("sendChatMessageButton").disabled === false) {
                         handleSendChatMessage();
                    } else {
                        alert("Chat-ul este ocupat. ÃŽncercaÈ›i sÄƒ trimiteÈ›i manual contextul notiÈ›ei sau aÈ™teptaÈ›i.");
                    }
                }, 1500);
            }
        }
    }


    // --- FUNCÈšII CHAT (EXISTENTE, CU ADAPTÄ‚RI MINORE PENTRU SELECÈšIE È˜I STREAMING) ---
    function displayChatMessage(message, role, isStreamingChunk = false, targetMessageElement = null) {
        const messagesDiv = document.getElementById("chatMessages");
        if (!messagesDiv) return;

        let messageElement = targetMessageElement;

        if (!messageElement) { // CreÄƒm un nou element de mesaj
            messageElement = document.createElement("div");
            messageElement.classList.add("chat-message");
            const messageClass = role === "user" ? "user-message" : (role === "AI-error" ? "ai-message ai-error" : "ai-message");
            messageClass.split(' ').forEach(cls => messageElement.classList.add(cls));
            messageElement.style.whiteSpace = "pre-wrap"; // PÄƒstreazÄƒ newline din text

            // AdaugÄƒ ID unic È™i funcÈ›ionalitate de selecÈ›ie pentru mesaje reale
            if (role === "user" || role === "AI") {
                const uniqueMsgId = `chatmsg-${messageIdCounter++}`;
                messageElement.dataset.id = uniqueMsgId;
                messageElement.classList.add("selectable");
                let longPressTimer;

                const handlePress = (event) => {
                     if (event.target.closest('a') || event.target.closest('button')) return;
                    toggleMessageSelection(messageElement, role, messageElement.dataset.rawMessageContent); // Folosim conÈ›inutul brut stocat
                };
                 const handleLongPress = (event) => {
                     if (event.target.closest('a') || event.target.closest('button')) return;
                    toggleMessageSelection(messageElement, role, messageElement.dataset.rawMessageContent);
                };

                messageElement.addEventListener('click', handlePress);
                messageElement.addEventListener('touchstart', (e) => { longPressTimer = setTimeout(() => handleLongPress(e), 700); });
                messageElement.addEventListener('touchend', () => clearTimeout(longPressTimer));
                messageElement.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            }
            messagesDiv.appendChild(messageElement);
        }
        
        // StocheazÄƒ conÈ›inutul brut pentru a fi folosit la salvarea notiÈ›ei
        if(role === "user" || role === "AI") {
            if (!isStreamingChunk || !messageElement.dataset.rawMessageContent) {
                messageElement.dataset.rawMessageContent = message;
            } else if (isStreamingChunk) {
                messageElement.dataset.rawMessageContent += message;
            }
        }


        // FormateazÄƒ È™i afiÈ™eazÄƒ/adaugÄƒ conÈ›inutul
        let currentHTML = isStreamingChunk ? messageElement.innerHTML : "";
        let textToProcess = message; // Textul primit (chunk sau mesaj complet)

        if (role === "AI" && textToProcess) {
            // AplicÄƒ formatare Markdown pentru titluri Hx, liste, bold, italic, code
            let formattedChunk = textToProcess.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                   .replace(/__(.*?)__/g, '<strong>$1</strong>')
                                   .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                   .replace(/_(.*?)_/g, '<em>$1</em>')
                                   .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre class="code-block-chat">${p1.trim().replace(/</g, "<").replace(/>/g, ">")}</pre>`)
                                   .replace(/`([^`]+)`/g, '<code class="inline-code-chat">$1</code>');

            // Simplificat pentru afiÈ™area ca HTML (fiecare \n devine <br>)
            // Pentru liste Markdown mai complexe, ar fi necesarÄƒ o parsare mai avansatÄƒ
            currentHTML += formattedChunk.replace(/\n/g, '<br>');
            messageElement.innerHTML = currentHTML;

        } else { // Pentru user sau erori, sau dacÄƒ e text simplu
            if (isStreamingChunk) {
                 messageElement.textContent += textToProcess;
            } else {
                 messageElement.textContent = textToProcess;
            }
        }

        if (!isStreamingChunk || role === "user" || role === "AI-error") { // Scroll doar la finalul mesajului sau pentru user/eroare
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    
    async function handleSendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendChatMessageButton");
        const chatStatus = document.getElementById("chatStatus");
        if (!chatInput || !sendButton || !chatStatus) return;
        const messageText = chatInput.value.trim();
        if (messageText === "") return;
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); window.location.href = "login.html"; return; }

        displayChatMessage(messageText, "user"); // AfiÈ™eazÄƒ mesajul utilizatorului
        await saveChatMessage(user.uid, { role: "user", content: messageText, timestamp: new Date().toISOString() });
        chatInput.value = ""; chatInput.style.height = 'auto'; // Reset height
        sendButton.disabled = true; chatStatus.textContent = "PsihoGPT analizeazÄƒ...";

        if (!chatSession || !isChatInitialized) {
            chatSession = await initializeAndStartChatSession(user.uid); // AsigurÄƒ-te cÄƒ e iniÈ›ializat
            if(!chatSession) { chatStatus.textContent = "Eroare chat."; sendButton.disabled = true; return; }
        }
        
        try {
            // MODIFICAT PENTRU STREAMING
            const stream = await chatSession.sendMessageStream(messageText);
            let aiResponseText = "";
            let currentAIMessageElement = null; // PÄƒstreazÄƒ referinÈ›a la elementul de mesaj AI

            for await (const chunk of stream.stream) {
                // VerificÄƒ dacÄƒ existÄƒ erori de siguranÈ›Äƒ Ã®n chunk
                if (chunk.candidates?.[0]?.finishReason && !["STOP", "MAX_TOKENS"].includes(chunk.candidates[0].finishReason)) {
                    const safetyErrorText = `AI oprit prematur (Motiv: ${chunk.candidates[0].finishReason}). Detalii: ${JSON.stringify(chunk.candidates[0].safetyRatings || 'N/A')}`;
                    if (currentAIMessageElement) { displayChatMessage(safetyErrorText, "AI", true, currentAIMessageElement); } 
                    else { currentAIMessageElement = displayChatMessage(safetyErrorText, "AI-error");} // AfiÈ™eazÄƒ ca eroare
                    console.warn("Gemini stream stopped due to safety/other reason:", chunk.candidates[0].finishReason, chunk.candidates[0].safetyRatings);
                    break; 
                }
                 if (chunk.promptFeedback?.blockReason) {
                    const blockErrorText = `Prompt/RÄƒspuns blocat (Motiv: ${chunk.promptFeedback.blockReason}). Detalii: ${JSON.stringify(chunk.promptFeedback.blockReasonDetail || chunk.promptFeedback.safetyRatings || 'N/A')}`;
                    if (currentAIMessageElement) { displayChatMessage(blockErrorText, "AI", true, currentAIMessageElement); }
                    else { currentAIMessageElement = displayChatMessage(blockErrorText, "AI-error"); }
                    console.error("Gemini stream blocked:", chunk.promptFeedback);
                    break;
                }


                const chunkText = chunk.text(); // Metoda text() din SDK pentru a obÈ›ine textul din chunk
                if (chunkText) {
                    aiResponseText += chunkText;
                    if (!currentAIMessageElement) { // Primul chunk, creeazÄƒ elementul
                        // Trimite un string gol iniÈ›ial pentru a crea elementul, apoi adaugÄƒ primul chunk
                        currentAIMessageElement = document.createElement("div"); // Se va popula Ã®n displayChatMessage
                        displayChatMessage(chunkText, "AI", true, currentAIMessageElement);
                    } else { // Chunk-uri ulterioare, adaugÄƒ la elementul existent
                        displayChatMessage(chunkText, "AI", true, currentAIMessageElement);
                    }
                }
            }
            // DupÄƒ ce stream-ul s-a terminat
            if (aiResponseText.trim() !== "") {
                 await saveChatMessage(user.uid, { role: "model", content: aiResponseText, timestamp: new Date().toISOString() });
            } else if (!currentAIMessageElement && !aiResponseText) { // DacÄƒ nu s-a primit niciun text È™i nici eroare afiÈ™atÄƒ
                 displayChatMessage("PsihoGPT nu a oferit un rÄƒspuns de data aceasta.", "AI");
            }

            chatStatus.textContent = "Chat pregÄƒtit.";
        } catch (error) {
            console.error("Eroare trimitere/procesare mesaj Gemini (chat stream):", error, error.stack);
            chatStatus.textContent = "Eroare comunicare AI.";
            let displayError = "Eroare comunicare AI cu PsihoGPT.";
            if (error.message?.toLowerCase().includes("quota")) displayError = "LimitÄƒ utilizare AI atinsÄƒ.";
            else if (error.message?.toLowerCase().includes("safety") || error.message?.toLowerCase().includes("blocked")) displayError = "Mesajul a fost blocat din motive de siguranÈ›Äƒ. ReformulaÈ›i, vÄƒ rog.";
            else if (error.message?.toLowerCase().includes("api key not valid")) displayError = "Cheie API invalidÄƒ.";
            displayChatMessage(displayError, "AI-error");
            isChatInitialized = false; // Reset for re-initialization
            chatSession = null;
        } finally {
            if (geminiModelChat && isChatInitialized && sendButton) sendButton.disabled = false;
            else if (sendButton) { sendButton.disabled = true; if (chatStatus) chatStatus.textContent = "Chat AI indisponibil."; }
            if (chatInput) chatInput.focus();
        }
    }
    
    // ... (loadChatHistory, saveChatMessage, initializeAndStartChatSession, handleToggleChat, discussFisaWithChat - existente, handleToggleChat poate avea nevoie de o micÄƒ aÈ™teptare pentru iniÈ›ializare Ã®nainte de discutaNotitaInChat)

    // --- FUNCÈšIA PRINCIPALÄ‚ DE INTRARE (ONLOAD) ---
    window.onload = function () {
        document.getElementById('tabButtonJurnal').addEventListener('click', () => showTab('jurnal'));
        document.getElementById('tabButtonFisa').addEventListener('click', () => showTab('fisa'));
        showTab('jurnal'); // Tab default

        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            const mainContentArea = document.getElementById('mainContentArea');
            const cardsContainerArea = document.getElementById('cardsContainerArea');
            const chatNotiteArea = document.getElementById('chatNotiteArea'); // NOU
            const toggleChatBtn = document.getElementById("toggleChatButton");
            const chatContainer = document.getElementById("chatContainer");

            if (user) {
                if (mainContentArea) mainContentArea.style.display = '';
                if (cardsContainerArea) cardsContainerArea.style.display = '';
                if (chatNotiteArea) chatNotiteArea.style.display = ''; // NOU
                if (toggleChatBtn) toggleChatBtn.style.display = 'flex';
                
                console.log("Utilizator autentificat:", user.uid);
                initializeFisaFormFunctionality();
                initializeJurnalFormFunctionality();

                if (!dataAlreadyLoaded) {
                    incarcaToateIntrospectiile(user.uid);
                    incarcaChatNotite(user.uid); // NOU: ÃŽncarcÄƒ È™i notiÈ›ele
                    dataAlreadyLoaded = true;
                }
                 // IniÈ›ializeazÄƒ butoanele globale de chat (s-ar putea muta Ã®n handleToggleChat dacÄƒ vrei sÄƒ aparÄƒ doar cÃ¢nd chatul e deschis)
                document.getElementById('clearChatSelectionButton')?.addEventListener('click', () => {
                    selectedChatMessages.forEach(item => item.element.classList.remove('selected'));
                    selectedChatMessages = [];
                    updateChatGlobalActions();
                });
                document.getElementById('saveSelectedChatButton')?.addEventListener('click', async () => {
                     if (selectedChatMessages.length === 0) return;
                    const sortedSelectedMessages = [...selectedChatMessages].sort((a, b) => {
                        const position = a.element.compareDocumentPosition(b.element);
                        if (position & Node.DOCUMENT_POSITION_FOLLOWING) return -1;
                        if (position & Node.DOCUMENT_POSITION_PRECEDING) return 1;
                        return 0;
                    });
                    const titluNotita = prompt("Titlu pentru notiÈ›Äƒ (opÈ›ional):", `ReflecÈ›ie din Chat - ${new Date().toLocaleDateString("ro-RO")}`);
                    const notitaData = {
                        titlu: titluNotita || `ReflecÈ›ie din Chat (${new Date().toLocaleDateString("ro-RO")})`,
                        continut: sortedSelectedMessages.map(item => ({ role: item.role, text: item.content })),
                        timestampMesajOriginal: new Date().toISOString() // Simplificat
                    };
                    if (currentUserId) await salveazaNotitaChat(currentUserId, notitaData);
                });


            } else {
                console.log("Utilizator neautentificat, redirecÈ›ionare...");
                if (mainContentArea) mainContentArea.style.display = 'none';
                if (cardsContainerArea) cardsContainerArea.style.display = 'none';
                if (chatNotiteArea) chatNotiteArea.style.display = 'none'; // NOU
                if (toggleChatBtn) toggleChatBtn.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'none';
                isChatInitialized = false; chatSession = null; selectedChatMessages = []; updateChatGlobalActions();
                window.location.href = "login.html";
            }
        });

        document.getElementById("toggleChatButton")?.addEventListener("click", handleToggleChat);
        document.getElementById("sendChatMessageButton")?.addEventListener("click", handleSendChatMessage);
        document.getElementById("chatInput")?.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                handleSendChatMessage();
            }
        });
         document.getElementById("chatInput")?.addEventListener("input", function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    };
</script>
<style>
/* ... (TOATE STILURILE CSS EXISTENTE) ... */

/* ADAUGÄ‚ ACESTE STILURI NOI */
.chat-message.selectable {
    /* PoÈ›i adÄƒuga un cursor pointer aici dacÄƒ doreÈ™ti un indiciu mai clar */
    /* cursor: pointer; */
    transition: background-color 0.3s, border 0.3s; /* TranziÈ›ie pentru selecÈ›ie */
}
.chat-message.selectable:hover:not(.selected) {
    /* background-color: #f0f0f0; /* Un fundal subtil la hover, dacÄƒ nu e selectat */
    /* Sau un chenar subtil */
     box-shadow: 0 0 0 1px var(--color-primary-light) inset;
}
.chat-message.selected {
    background-color: var(--color-primary-light) !important;
    border: 1px solid var(--color-primary) !important;
    color: var(--color-text-dark) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.chat-message.selected.user-message {
    background: #cce5ff !important; /* Un albastru mai deschis pentru user selectat */
    border-color: var(--color-primary-dark) !important;
}
.chat-message.selected.ai-message {
    background: #e2e3e5 !important; /* Un gri È™i mai deschis pentru AI selectat */
    border-color: #b8c2cc !important;
}


#chatGlobalActions {
    display: flex; /* Schimbat din none, JS va controla vizibilitatea */
    justify-content: flex-end;
    align-items: center;
    padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
    border-bottom: 1px solid #E9ECEF;
    background-color: #fdfdfd; /* Un fundal foarte deschis */
    gap: var(--spacing-unit);
}
.chat-action-button {
    padding: calc(var(--spacing-unit)*0.75) calc(var(--spacing-unit)*1.25);
    font-size: 0.8em;
    font-weight: 500;
    border-radius: var(--border-radius-medium);
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
    border: 1px solid transparent;
}
.chat-action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
#saveSelectedChatButton {
    background-color: var(--color-primary);
    color: white;
}
#saveSelectedChatButton:hover:not(:disabled) {
    background-color: var(--color-primary-dark);
}
#clearChatSelectionButton {
    background-color: var(--color-text-light);
    color: white;
}
#clearChatSelectionButton:hover:not(:disabled) {
    background-color: #5a6268;
}

/* Stiluri pentru cardurile de notiÈ›e din chat */
.chat-notita-card .card-header {
    background: #e6f7ff; /* Un fundal distinct pentru notiÈ›e */
    color: #005f80;
}
.chat-notita-entry-details summary {
    color: #005f80;
    background-color: #f0faff;
}
.chat-notita-entry-details[open] summary {
    border-bottom-color: #cceeff;
}
.chat-notita-entry-content-text {
    background-color: #fafcff;
    padding: calc(var(--spacing-unit) * 1.5);
    max-height: 400px; /* LimiteazÄƒ Ã®nÄƒlÈ›imea conÈ›inutului notiÈ›ei */
    overflow-y: auto;
}
.chat-notita-content-wrapper .message-item-in-note {
    padding: calc(var(--spacing-unit)*0.75) var(--spacing-unit);
    margin-bottom: var(--spacing-unit);
    border-radius: var(--border-radius-medium);
    line-height: 1.5;
}
.chat-notita-content-wrapper .message-item-in-note strong { /* Rolul (Eu/PsihoGPT) */
    display: block;
    font-weight: 600;
    margin-bottom: calc(var(--spacing-unit)*0.25);
    font-size: 0.9em;
}
.chat-notita-content-wrapper .message-text-in-note {
    font-size: 0.95em;
    white-space: pre-wrap; /* PÄƒstreazÄƒ newline-urile din mesaj */
}
.user-message-in-note {
    background-color: #f0f8ff; /* AliceBlue */
    border-left: 3px solid var(--color-primary);
}
.ai-message-in-note {
    background-color: #f5f5f5; /* WhilteSmoke */
    border-left: 3px solid var(--color-secondary);
}
.system-message-in-note {
    background-color: #fffacd; /* LemonChiffon */
    border-left: 3px solid var(--color-accent);
}

#notiteConfirmationMessage { /* Similar cu celelalte mesaje de confirmare */
    display: none; text-align: center;
    padding: calc(var(--spacing-unit) * 1.5);
    border: 1px solid transparent; border-radius: var(--border-radius-medium);
    margin-top: calc(var(--spacing-unit) * 2.5);
    animation: fadeInConfirm 0.4s; font-weight: 500; font-size: 0.95em;
}
#notiteConfirmationMessage.success { background-color: var(--color-success-bg); color: var(--color-success); border-color: #A3D9B1; }
#notiteConfirmationMessage.error   { background-color: var(--color-error-bg); color: var(--color-error); border-color: #F1B9BF; }

/* Ajustare pentru input-ul de chat sÄƒ creascÄƒ */
#chatInput {
    overflow-y: auto; /* Permite scroll dacÄƒ textul e foarte lung */
    /* min-height È™i max-height sunt deja setate È™i sunt bune */
}

/* Stiluri pentru blocuri de cod Ã®n chat */
pre.code-block-chat {
    background-color: #2d2d2d; /* Fundal Ã®ntunecat pentru cod */
    color: #f8f8f2; /* Text deschis */
    padding: var(--spacing-unit);
    border-radius: var(--border-radius-small);
    overflow-x: auto; /* Scroll orizontal dacÄƒ e necesar */
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.85em;
    margin: calc(var(--spacing-unit)*0.5) 0;
    white-space: pre-wrap; /* PÄƒstreazÄƒ È™i Ã®mpacheteazÄƒ liniile */
    word-break: break-all; /* Pentru linii foarte lungi fÄƒrÄƒ spaÈ›ii */
}
code.inline-code-chat {
    background-color: #e0e0e0;
    color: #333;
    padding: 2px 4px;
    border-radius: var(--border-radius-small);
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9em;
}

</style>
</head>
<body>

    <header class="app-header">
        <h1>IntrospecÈ›ie GhidatÄƒ</h1>
        <p>Jurnal, fiÈ™e de monitorizare È™i notiÈ›e din chat.</p>
    </header>

    <nav class="tab-navigation">
        <button id="tabButtonJurnal" class="tab-button active" type="button">Jurnal Ghidat</button>
        <button id="tabButtonFisa" class="tab-button" type="button">FiÈ™Äƒ TerapeuticÄƒ</button>
    </nav>

    <main id="mainContentArea">
        <!-- ConÈ›inutul Jurnalului Ghidat -->
        <div id="jurnalFormContainer" class="tab-content active">
            <!-- ... (HTML existent pentru Jurnal) ... -->
        </div>

        <!-- ConÈ›inutul FiÈ™ei Terapeutice -->
        <div id="fisaFormContainer" class="tab-content">
            <!-- ... (HTML existent pentru FiÈ™Äƒ) ... -->
        </div>
    </main>

    <section id="cardsContainerArea">
        <h3 id="introspectiiTitle">Istoricul IntrospecÈ›iilor Tale (FiÈ™e & Jurnale)</h3>
        <div class="card-view-unified" id="introspectiiCardContainer">
            <!-- Cardurile pentru fiÈ™e È™i jurnale vor fi adÄƒugate aici -->
        </div>
    </section>

    <!-- NOUA SECÈšIUNE PENTRU NOTIÈšE DIN CHAT -->
    <section id="chatNotiteArea" style="display: none;">
        <h3 id="chatNotiteTitle">NotiÈ›e Salvate din Chat</h3>
        <div class="card-view-unified" id="chatNotiteCardContainer">
            <!-- Cardurile pentru notiÈ›e din chat vor fi adÄƒugate aici -->
        </div>
        <div id="notiteConfirmationMessage" class="confirmation-message" style="max-width: 760px; margin-left:auto; margin-right:auto;"></div>
    </section>


    <div class="chat-container" id="chatContainer" style="/* display: none; iniÈ›ial */">
        <h3>DiscutÄƒ cu PsihoGPT</h3>
        <!-- NOU: Butoane globale pentru acÈ›iuni chat -->
        <div id="chatGlobalActions" style="display: none;"> <!-- JS controleazÄƒ display -->
            <button id="saveSelectedChatButton" class="chat-action-button" disabled>SalveazÄƒ SelecÈ›ia (0)</button>
            <button id="clearChatSelectionButton" class="chat-action-button" disabled>DeselecteazÄƒ Tot</button>
        </div>
        <div id="chatMessages"></div>
        <div class="chat-input-area">
            <textarea id="chatInput" rows="1" placeholder="Scrie mesajul tÄƒu... Enter pentru a trimite."></textarea>
            <button id="sendChatMessageButton" disabled title="Trimite Mesaj"></button>
        </div>
        <p id="chatStatus">Chatul AI nu este activ.</p>
    </div>
    <button id="toggleChatButton" style="display: none;">ðŸ’¬</button>

    <!-- HTML pentru Jurnal È™i FiÈ™Äƒ (existent, neschimbat structural) -->
    <div id="jurnalFormContainer" class="tab-content active" style="display: block;">
            <section class="form-section-container">
                <h2>Jurnal Terapeutic Personal</h2>
                <p>SpaÈ›iul tÄƒu pentru reflecÈ›ie ghidatÄƒ, auto-descoperire È™i integrare emoÈ›ionalÄƒ.</p>

                <form id="therapeuticJournalForm" onsubmit="return false;">
                    <label for="journalTitle">Titlu (OpÈ›ional):</label>
                    <input type="text" id="journalTitle" name="journalTitle" placeholder="Ex: ReflecÈ›ii despre ziua de azi...">

                    <div id="reflectionPromptsContainer" style="margin-top: 20px;">
                        <p>Puncte de start pentru reflecÈ›ie (alege un ghid):</p>
                        <div class="prompt-button-group" id="reflectionPrompts">
                            <!-- Butoanele vor fi generate de JavaScript -->
                        </div>
                    </div>

                    <div id="activeJurnalPromptBox" class="prompt-box" style="display: none;">
                        <div class="prompt-box-header">
                            <strong id="activeJurnalPromptTitle">Ghid activ:</strong>
                            <button type="button" onclick="window.hideActiveJurnalPromptManual()" class="hide-prompt-button" title="Ascunde ghidul">Ã—</button>
                        </div>
                        <div id="activeJurnalPromptContent" class="prompt-content-display"></div>
                        <p style="font-size:0.85em; text-align:right; margin-top:8px; color: #64748B;"><em>Acest ghid este pentru inspiraÈ›ie. Scrie Ã®n cÃ¢mpul de mai jos.</em></p>
                    </div>

                    <label for="journalContent" style="margin-top: 15px;">Intrarea ta Ã®n jurnal:</label>
                    <textarea id="journalContent" name="journalContent" rows="12" placeholder="Scrie liber aici sau completeazÄƒ rÄƒspunzÃ¢nd la Ã®ntrebÄƒrile din ghidul afiÈ™at..."></textarea>

                    <button type="button" id="saveJournalEntryButton">SalveazÄƒ Jurnal È™i Cere Feedback AI</button>
                </form>
                <div id="jurnalConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>

        <div id="fisaFormContainer" class="tab-content" style="display: none;">
            <section class="form-section-container">
                <h2>FiÈ™Äƒ de Monitorizare TerapeuticÄƒ</h2>
                <p>CompleteazÄƒ fiecare Ã®ntrebare pentru a Ã®nÈ›elege mai bine situaÈ›iile tale. Fiecare secÈ›iune reprezintÄƒ o parte importantÄƒ a reflecÈ›iei tale. ÃŽn acest exerciÈ›iu, Ã®È›i voi ghida fiecare pas, astfel Ã®ncÃ¢t sÄƒ poÈ›i explora Ã®n profunzime gÃ¢ndurile, emoÈ›iile È™i comportamentele tale.</p>
    
                <div class="progress-bar">
                    <div class="progress" id="fisaProgress"></div>
                </div>

                <form id="fisaExercitiuForm" novalidate="">
            <div class="question-card form-step form-step-active" id="fisa-step-1">
                <h3>Care este situaÈ›ia?</h3>
                <p>Te rog sÄƒ descrii contextul care a declanÈ™at emoÈ›iile sau comportamentul tÄƒu. ÃŽncearcÄƒ sÄƒ fii cÃ¢t mai specific È™i detaliat. Aceasta poate fi o situaÈ›ie concretÄƒ din viaÈ›a de zi cu zi Ã®n care te-ai simÈ›it copleÈ™it, stresat sau Ã®ntr-o altÄƒ stare emoÈ›ionalÄƒ intensÄƒ.</p>
                <textarea name="situatie" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-2" style="display: none;">
                <h3>Ce Ã®mi trece prin minte?</h3>
                <p>ÃŽÈ›i cer sÄƒ identifici gÃ¢ndurile automate care au apÄƒrut Ã®n aceastÄƒ situaÈ›ie. Acestea sunt gÃ¢nduri rapide, involuntare, care Ã®È›i trec prin minte Ã®n momentele de stres. Ce Ã®È›i spui Ã®n acel moment? Este un gÃ¢nd critic sau Ã®ngrijorÄƒtor?</p>
                <textarea name="ganduri" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-3" style="display: none;">
                <h3>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</h3>
                <p>Te rog sÄƒ notezi emoÈ›iile pe care le simÈ›i Ã®n urma acelui gÃ¢nd. Ce simÈ›i? FricÄƒ, tristeÈ›e, furie? DÄƒ o intensitate emoÈ›iei (de la 0 la 100) pentru a vedea cÃ¢t de puternicÄƒ este.</p>
                <textarea name="emotii" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-4" style="display: none;">
                <h3>Ce mod este activ?</h3>
                <p>IdentificÄƒ modul Ã®n care te afli Ã®n aceastÄƒ situaÈ›ie. Este un mod de copil vulnerabil, critic interior, sau poate adultul sÄƒnÄƒtos? ConÈ™tientizarea modului Ã®È›i poate oferi o mai bunÄƒ Ã®nÈ›elegere a reacÈ›iilor tale.</p>
                <textarea name="mod_activ" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-5" style="display: none;">
                <h3>Ce comportament simÈ›i cÄƒ adopÈ›i?</h3>
                <p>Descrie comportamentul pe care Ã®l manifeÈ™ti Ã®n aceastÄƒ situaÈ›ie. Este un comportament de evitare, de confruntare, de sacrificiu de sine? RecunoaÈ™terea comportamentului te ajutÄƒ sÄƒ Ã®nÈ›elegi mai bine cum reacÈ›ionezi.</p>
                <textarea name="comportament" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-6" style="display: none;">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoÈ›ii È™i comportamente? Poate fi nevoia de siguranÈ›Äƒ, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta sÄƒ gÄƒseÈ™ti strategii mai sÄƒnÄƒtoase pentru a le Ã®ndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-7" style="display: none;">
                <h3>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</h3>
                <p>ReflecteazÄƒ dacÄƒ felul Ã®n care reacÈ›ionezi te ajutÄƒ cu adevÄƒrat sÄƒ Ã®È›i Ã®ndeplineÈ™ti nevoile. Poate fi util sÄƒ te gÃ¢ndeÈ™ti dacÄƒ existÄƒ alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-8" style="display: none;">
                <h3>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ar reacÈ›iona partea ta AdultÄƒ SÄƒnÄƒtoasÄƒ Ã®n aceastÄƒ situaÈ›ie. Cum ai putea sÄƒ abordezi diferit pentru a avea grijÄƒ de tine È™i de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required=""></textarea>
            </div>

            <div class="question-card form-step" id="fisa-step-9" style="display: none;">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</h3>
                <p>ExploreazÄƒ motivele pentru care crezi cÄƒ acest gÃ¢nd este adevÄƒrat. Ce dovezi ai care Ã®È›i confirmÄƒ acest lucru? De multe ori, ne bazÄƒm pe experienÈ›e trecute sau frici pentru a justifica un gÃ¢nd.</p>
                <textarea name="dovezi_adevar" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-10" style="display: none;">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</h3>
                <p>Acum, sÄƒ ne uitÄƒm la dovezile Ã®mpotriva gÃ¢ndului tÄƒu. ExistÄƒ argumente sau experienÈ›e care contrazic acest gÃ¢nd? Poate existÄƒ o altÄƒ perspectivÄƒ pe care nu ai luat-o Ã®n considerare?</p>
                <textarea name="dovezi_fals" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-11" style="display: none;">
                <h3>ExistÄƒ o explicaÈ›ie alternativÄƒ?</h3>
                <p>Uneori, existÄƒ mai multe explicaÈ›ii pentru ceea ce se Ã®ntÃ¢mplÄƒ. Ce alte interpretÄƒri ai putea avea pentru aceastÄƒ situaÈ›ie? GÃ¢ndeÈ™te-te la alte posibilitÄƒÈ›i care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-12" style="display: none;">
                <h3>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Ce este cel mai rÄƒu care ar putea avea loc Ã®n aceastÄƒ situaÈ›ie? SÄƒ identificÄƒm acele frici catastrofale care adesea ne alimenteazÄƒ gÃ¢ndurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-13" style="display: none;">
                <h3>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Pe de altÄƒ parte, care ar fi cel mai pozitiv scenariu? Uneori uitÄƒm sÄƒ ne gÃ¢ndim È™i la posibilitÄƒÈ›ile bune. Cum ar arÄƒta cel mai bun rezultat al acestei situaÈ›ii?</p>
                <textarea name="scenariu_optimist" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-14" style="display: none;">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>DupÄƒ ce am explorat extremele, ce crezi cÄƒ este cel mai probabil sÄƒ se Ã®ntÃ¢mple? Cum ar arÄƒta un rezultat realist, È›inÃ¢nd cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-15" style="display: none;">
                <h3>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</h3>
                <p>ÃŽntreabÄƒ-te cum ar fi dacÄƒ ai aborda situaÈ›ia cu un alt tip de gÃ¢ndire. Cum ar influenÈ›a asta emoÈ›iile È™i comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-16" style="display: none;">
                <h3>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ai reacÈ›iona dacÄƒ un prieten drag ar avea aceleaÈ™i gÃ¢nduri. Ce i-ai spune pentru a-l sprijini? Cum ai Ã®ncerca sÄƒ-l Ã®ncurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required=""></textarea>
            </div>

            <div class="question-card form-step" id="fisa-step-17" style="display: none;">
                <h3>VÄƒd doar partea rea a lucrurilor?</h3>
                <p>Este posibil sÄƒ fii prins Ã®ntr-un tipar negativ de gÃ¢ndire, concentrÃ¢ndu-te doar pe aspectele negative. ÃŽncearcÄƒ sÄƒ observi dacÄƒ existÄƒ È™i aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-18" style="display: none;">
                <h3>ÃŽmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</h3>
                <p>ReflecteazÄƒ dacÄƒ Ã®È›i asumi responsabilitatea pentru situaÈ›ii asupra cÄƒrora nu aveai control. Este important sÄƒ Ã®È›i dai seama de limitele influenÈ›ei tale.</p>
                <textarea name="responsabilitate" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-19" style="display: none;">
                <h3>MÄƒ condamn Ã®n baza unui singur eveniment?</h3>
                <p>ÃŽÈ›i evaluezi valoarea personalÄƒ bazÃ¢ndu-te pe un singur eveniment negativ? AminteÈ™te-È›i cÄƒ un eveniment nu defineÈ™te cine eÈ™ti Ã®n totalitate.</p>
                <textarea name="condamnare" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-20" style="display: none;">
                <h3>Privesc situaÈ›ia Ã®n termeni extremi?</h3>
                <p>VerificÄƒ dacÄƒ vezi situaÈ›ia doar Ã®n alb sau negru, fÄƒrÄƒ nuanÈ›e de gri. GÃ¢ndirea extremÄƒ poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-21" style="display: none;">
                <h3>Exagerez situaÈ›ia?</h3>
                <p>ÃŽÈ›i amplifici reacÈ›iile faÈ›Äƒ de o situaÈ›ie? ÃŽncearcÄƒ sÄƒ te gÃ¢ndeÈ™ti dacÄƒ ceea ce percepi este realist sau dacÄƒ exagerezi impactul situaÈ›iei.</p>
                <textarea name="exagerare" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-22" style="display: none;">
                <h3>ExistÄƒ È™i alÈ›i factori responsabili?</h3>
                <p>ExistÄƒ alÈ›i factori care contribuie la aceastÄƒ situaÈ›ie, pe lÃ¢ngÄƒ tine? Este important sÄƒ ai o perspectivÄƒ completÄƒ asupra cauzelor unei situaÈ›ii.</p>
                <textarea name="factori_responsabili" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-23" style="display: none;">
                <h3>Am sÄƒrit direct la concluzii?</h3>
                <p>Te-ai grÄƒbit sÄƒ ajungi la o concluzie fÄƒrÄƒ suficiente dovezi? ÃŽncearcÄƒ sÄƒ observi dacÄƒ existÄƒ alte posibilitÄƒÈ›i care ar putea explica situaÈ›ia.</p>
                <textarea name="concluzii" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-24" style="display: none;">
                <h3>ÃŽmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</h3>
                <p>Te frÄƒmÃ¢ntÄƒ Ã®ntrebÄƒri care nu au un rÄƒspuns clar sau realist? Aceste Ã®ntrebÄƒri pot fi o sursÄƒ majorÄƒ de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-25" style="display: none;">
                <h3>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</h3>
                <p>Ai tendinÈ›a sÄƒ te focalizezi doar pe slÄƒbiciuni È™i sÄƒ ignori punctele tale forte? ÃŽncearcÄƒ sÄƒ Ã®È›i recunoÈ™ti È™i punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-26" style="display: none;">
                <h3>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</h3>
                <p>Ai tendinÈ›a sÄƒ te gÃ¢ndeÈ™ti mereu la cum ar trebui sÄƒ fie lucrurile, Ã®n loc sÄƒ accepÈ›i situaÈ›ia aÈ™a cum este? Acceptarea poate reduce stresul È™i anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required=""></textarea>
            </div>
            <div class="question-card form-step" id="fisa-step-27" style="display: none;">
                <h3>MÄƒ aÈ™tept sÄƒ fiu perfect?</h3>
                <p>ÃŽÈ›i setezi standarde foarte Ã®nalte, imposibil de atins? PerfecÈ›ionismul poate fi o sursÄƒ majorÄƒ de frustrare È™i descurajare.</p>
                <textarea name="perfectiune" rows="3" required=""></textarea>
            </div>
             <div class="question-card form-step" id="fisa-step-28" style="display: none;">
                <h3>Completare finalizatÄƒ!</h3>
                <p>FelicitÄƒri pentru parcurgerea acestui exerciÈ›iu de auto-reflecÈ›ie! ApasÄƒ butonul de mai jos pentru a salva datele È™i a genera un feedback automatizat, dacÄƒ este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta sÄƒ obÈ›ii noi perspective. DacÄƒ Ã®ntÃ¢mpini probleme cu generarea (ex: erori de limitÄƒ de utilizare sau cheie API invalidÄƒ), poÈ›i Ã®ncerca din nou mai tÃ¢rziu sau contacta administratorul.</p>
            </div>
                    <div class="step-navigation">
                        <button type="button" id="fisaPrevButton">ÃŽnapoi</button>
                        <button type="button" id="fisaNextButton">ÃŽnainte</button>
                    </div>
                    <button type="button" id="fisaAddButton">SalveazÄƒ FiÈ™a È™i GenereazÄƒ Feedback AI</button>
                </form>
                <div id="fisaConfirmationMessage" class="confirmation-message"></div>
            </section>
        </div>

</body>
</html>