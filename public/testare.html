<!DOCTYPE html>
<html>
<head>
    <title>Migrare Date Introspecții</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; font-size: 1em; color: white; background-color: #007bff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; font-style: italic; }
        .log-entry { padding: 5px 0; border-bottom: 1px solid #eee; }
        .log-entry:last-child { border-bottom: none; }
        .error { color: red; font-weight: bold; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, Timestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98", // Asigură-te că e corectă
            authDomain: "personaltrainer-74ea4.firebaseapp.com",
            projectId: "personaltrainer-74ea4",
            storageBucket: "personaltrainer-74ea4.appspot.com",
            messagingSenderId: "591778567441",
            appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
            measurementId: "G-WLWNGNDK5V",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const UID_ADMIN_PENTRU_MIGRARE = "U75LwhsnQ4U2XGOLsIX22NNla292"; // <--- ÎNLOCUIEȘTE CU UID-UL TĂU REAL !!!

        const migrareBtn = document.getElementById("migrareBtn");
        const statusDiv = document.getElementById("status");
        const logDiv = document.getElementById("log");

        function logMessage(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isError) {
                entry.classList.add('error');
            }
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight; // Scroll la ultimul mesaj
            console.log(message);
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === UID_ADMIN_PENTRU_MIGRARE) {
                logMessage("Utilizator admin autentificat. Butonul de migrare este activ.");
                migrareBtn.disabled = false;
                migrareBtn.style.display = "inline-block";
            } else if (user) {
                logMessage(`Utilizator ${user.uid} autentificat, dar nu este adminul specificat pentru migrare. Butonul rămâne dezactivat.`);
                migrareBtn.disabled = true;
                migrareBtn.style.display = "none";
            } else {
                logMessage("Niciun utilizator autentificat. Te rog autentifică-te în aplicația principală cu contul de admin și apoi reîncarcă această pagină.");
                migrareBtn.disabled = true;
                migrareBtn.style.display = "none";
            }
        });

        migrareBtn.addEventListener("click", async () => {
            if (!confirm("Ești sigur că vrei să începi migrarea datelor? Această acțiune va adăuga date în colecția 'introspectii'. Asigură-te că ai făcut un backup!")) {
                logMessage("Migrare anulată de utilizator.");
                return;
            }

            migrareBtn.disabled = true;
            migrareBtn.textContent = "Migrare în curs...";
            statusDiv.textContent = "Proces de migrare început...";
            logDiv.innerHTML = ""; // Curăță log-ul anterior

            try {
                logMessage("Început migrare Fișe din 'raspunsuri'...");
                await migreazaColectie("raspunsuri", "fisa");
                logMessage("Migrare Fișe finalizată cu succes!");

                logMessage("Început migrare Jurnale din 'intrariJurnal'...");
                await migreazaColectie("intrariJurnal", "jurnal");
                logMessage("Migrare Jurnale finalizată cu succes!");

                statusDiv.textContent = "Migrarea datelor a fost finalizată cu succes!";
                logMessage("TOATĂ MIGRAREA COMPLETĂ!", false);
                alert("Migrarea datelor s-a încheiat! Verifică consola Firestore și log-ul de pe pagină.");

            } catch (e) {
                console.error("Eroare majoră în procesul de migrare:", e);
                statusDiv.textContent = `Eroare la migrare: ${e.message}. Verifică consola pentru detalii.`;
                logMessage(`EROARE MAJORĂ: ${e.message}`, true);
                alert("A apărut o eroare în timpul migrării. Verifică consola și log-ul de pe pagină.");
            } finally {
                migrareBtn.textContent = "Pornește Migrarea Datelor Vechi";
                // Nu reactivăm butonul automat pentru a preveni rulări multiple accidentale
                // migrareBtn.disabled = false; 
            }
        });

        async function migreazaColectie(numeColectieVeche, tipIntrospectieNou) {
            logMessage(`Procesare colecție: ${numeColectieVeche} ca tip: ${tipIntrospectieNou}`);
            const snapshotVechi = await getDocs(collection(db, numeColectieVeche));
            let count = 0;

            if (snapshotVechi.empty) {
                logMessage(`Colecția '${numeColectieVeche}' este goală. Nu sunt date de migrat.`);
                return;
            }

            for (const docVechi of snapshotVechi.docs) {
                const dataVeche = docVechi.data();
                const idVechi = docVechi.id;
                logMessage(`Procesare document ID: ${idVechi} din ${numeColectieVeche}`);

                let continutNou = {};
                let timestampCreareNou = dataVeche.timestampCreare || dataVeche.timestamp; // Caută în ambele câmpuri posibile
                
                // Standardizare timestampCreare
                if (timestampCreareNou && !(timestampCreareNou instanceof Timestamp)) {
                    // Dacă e string sau număr, încearcă conversia
                    if (typeof timestampCreareNou.toDate === 'function') { // Deja un Timestamp Firestore mai vechi?
                        timestampCreareNou = timestampCreareNou;
                    } else if (typeof timestampCreareNou === 'string' || typeof timestampCreareNou === 'number') {
                        const d = new Date(timestampCreareNou);
                        if (!isNaN(d.getTime())) {
                            timestampCreareNou = Timestamp.fromDate(d);
                        } else {
                            logMessage(`Timestamp invalid pentru doc ${idVechi}: ${dataVeche.timestampCreare}. Se folosește now().`, true);
                            timestampCreareNou = Timestamp.now();
                        }
                    } else {
                         logMessage(`Format timestamp necunoscut pentru doc ${idVechi}. Se folosește now().`, true);
                         timestampCreareNou = Timestamp.now();
                    }
                } else if (!timestampCreareNou) {
                     logMessage(`Timestamp lipsă pentru doc ${idVechi}. Se folosește now().`, true);
                    timestampCreareNou = Timestamp.now();
                }


                let dateAfisareNou = dataVeche.dateAfisare || dataVeche.date; // Caută 'date' pentru fișe vechi
                if (!dateAfisareNou || typeof dateAfisareNou !== 'string' || !dateAfisareNou.match(/\d{2}\.\d{2}\.\d{4}/)) {
                    dateAfisareNou = new Date(timestampCreareNou.toDate()).toLocaleDateString("ro-RO", { day: '2-digit', month: '2-digit', year: 'numeric' });
                }


                if (tipIntrospectieNou === "fisa") {
                    // Extrage câmpurile specifice fișei din rădăcina dataVeche
                    continutNou = {
                        situatie: dataVeche.situatie || "",
                        ganduri: dataVeche.ganduri || "",
                        emotii: dataVeche.emotii || "",
                        mod_activ: dataVeche.mod_activ || "",
                        comportament: dataVeche.comportament || "",
                        nevoi_profunde: dataVeche.nevoi_profunde || "",
                        ajutor_comportament: dataVeche.ajutor_comportament || "",
                        adult_sanatos: dataVeche.adult_sanatos || "",
                        dovezi_adevar: dataVeche.dovezi_adevar || "",
                        dovezi_fals: dataVeche.dovezi_fals || "",
                        explicatie_alternativa: dataVeche.explicatie_alternativa || "",
                        scenariu_negativ: dataVeche.scenariu_negativ || "",
                        scenariu_optimist: dataVeche.scenariu_optimist || "",
                        rezultat_realist: dataVeche.rezultat_realist || "",
                        schimbare_gandire: dataVeche.schimbare_gandire || "",
                        sfat_prieten: dataVeche.sfat_prieten || "",
                        partea_rea: dataVeche.partea_rea || "",
                        responsabilitate: dataVeche.responsabilitate || "",
                        condamnare: dataVeche.condamnare || "",
                        termeni_extremi: dataVeche.termeni_extremi || "",
                        exagerare: dataVeche.exagerare || "",
                        factori_responsabili: dataVeche.factori_responsabili || "",
                        concluzii: dataVeche.concluzii || "",
                        intrebari_fara_raspuns: dataVeche.intrebari_fara_raspuns || "",
                        slabiciuni: dataVeche.slabiciuni || "",
                        cum_ar_trebui: dataVeche.cum_ar_trebui || "",
                        perfectiune: dataVeche.perfectiune || ""
                    };
                } else if (tipIntrospectieNou === "jurnal") {
                    // Pentru jurnale, structura era deja în `continut` sau direct la rădăcină
                    if (dataVeche.continut && typeof dataVeche.continut === 'object') { // Structură mai nouă
                        continutNou = {
                            titluJurnal: dataVeche.continut.titluJurnal || dataVeche.titlu || `Jurnal din ${dateAfisareNou}`,
                            textJurnal: dataVeche.continut.textJurnal || dataVeche.continut.continut || dataVeche.text || "", // Caută în mai multe locuri posibile
                            promptUtilizatJurnal: dataVeche.continut.promptUtilizatJurnal || dataVeche.promptTypeUtilizat || "prompt_personalizat"
                        };
                    } else { // Structură mai veche, câmpuri la rădăcină
                         continutNou = {
                            titluJurnal: dataVeche.titlu || `Jurnal din ${dateAfisareNou}`,
                            textJurnal: dataVeche.continut || dataVeche.textJurnal || "", // `continut` era textul
                            promptUtilizatJurnal: dataVeche.promptTypeUtilizat || "prompt_personalizat"
                        };
                    }
                }

                // Gestionarea feedback-ului AI
                let feedbackIstoricNou = [];
                if (Array.isArray(dataVeche.feedbackAI_history)) {
                    feedbackIstoricNou = dataVeche.feedbackAI_history;
                } else if (Array.isArray(dataVeche.feedback_history)) { // Nume vechi
                    feedbackIstoricNou = dataVeche.feedback_history;
                } else if (dataVeche.feedbackAI_latest) { // Doar ultimul feedback
                    feedbackIstoricNou = [dataVeche.feedbackAI_latest];
                } else if (dataVeche.feedback_empatie_initiala || dataVeche.feedback_paragraf) { // Câmpuri individuale de feedback
                    const fbSingle = {
                        rawText: dataVeche.feedback_rawText || "Feedback vechi, text brut indisponibil.",
                        model: dataVeche.feedback_model || "Model necunoscut (migrat)",
                        timestamp: dataVeche.feedback_timestamp || new Date(timestampCreareNou.toDate()).toISOString(), // Folosește data creării intrării ca fallback
                        error: false,
                        error_parsing: !dataVeche.feedback_empatie_initiala, // Presupunem eroare de parsare dacă lipsește un câmp cheie
                    };
                    // Adaugă câmpurile parsate dacă există
                    if (dataVeche.feedback_empatie_initiala) fbSingle.empatie_initiala = dataVeche.feedback_empatie_initiala;
                    // ... adaugă toate celelalte câmpuri de feedback parsat (puncte_forte, etc.)
                    // Acest lucru poate fi complex dacă structura veche era foarte diferită
                    feedbackIstoricNou = [fbSingle];
                }


                const documentNou = {
                    ownerUid: dataVeche.ownerUid,
                    type: tipIntrospectieNou,
                    timestampCreare: timestampCreareNou,
                    dateAfisare: dateAfisareNou,
                    continut: continutNou,
                    feedbackAI_history: feedbackIstoricNou,
                    migratedFrom: numeColectieVeche, // Adaugă un flag pentru a ști originea
                    migratedDocIdOld: idVechi // Păstrează ID-ul vechi pentru referință, dacă e nevoie
                };

                try {
                    // Folosim ID-ul vechi pentru noul document pentru a evita duplicatele la rerulări parțiale
                    // SAU generăm ID nou dacă preferi să nu te bazezi pe ID-urile vechi (addDoc).
                    // Pentru simplitate și prevenirea duplicatelor la rerulare, voi folosi setDoc cu ID-ul vechi.
                    // ATENȚIE: Dacă ID-urile din `raspunsuri` și `intrariJurnal` s-ar putea suprapune,
                    // atunci trebuie să generezi ID-uri noi cu `addDoc`.
                    // Pentru acest script, voi presupune că nu se suprapun sau că e ok să suprascrii la rerulare dacă ID-ul e același.
                    // O abordare mai sigură ar fi să verifici dacă un document cu ID-ul `introspectii/${idVechi}` există deja.

                    // Voi folosi addDoc pentru a fi mai sigur că se creează mereu documente noi în introspectii
                    // și evităm complexitatea verificării existenței. Rularea multiplă va crea duplicate.
                    // De aceea e important să rulezi O SINGURĂ DATĂ.
                    await addDoc(collection(db, "introspectii"), documentNou);
                    logMessage(`Document ${idVechi} migrat cu succes ca ${tipIntrospectieNou}.`);
                    count++;
                } catch (e) {
                    logMessage(`EROARE la migrarea documentului ${idVechi}: ${e.message}`, true);
                    console.error(`Eroare migrare doc ${idVechi}:`, e);
                }
            }
            logMessage(`Total ${count} documente migrate din ${numeColectieVeche}.`);
        }

    </script>
</head>
<body>
    <div class="container">
        <h1>Unealtă de Migrare Date Introspecții</h1>
        <p>Acest instrument va migra datele din vechile colecții (`raspunsuri` și `intrariJurnal`) în noua colecție unificată `introspectii`.</p>
        <p><strong>Important:</strong>
            <ul>
                <li>Asigură-te că ești autentificat în aplicația principală cu contul de administrator (UID: <strong><span id="adminUidPlaceholder">UID_TAU_ADMIN</span></strong>) înainte de a rula migrarea.</li>
                <li>Acest proces trebuie rulat <strong>o singură dată</strong>. Rulările multiple pot duce la duplicate dacă nu se gestionează ID-urile.</li>
                <li>Fă un <strong>backup</strong> al datelor din Firestore înainte de a continua!</li>
            </ul>
        </p>

        <button id="migrareBtn" disabled style="display:none;">Pornește Migrarea Datelor Vechi</button>
        
        <div id="status">Așteptare autentificare admin...</div>
        <h3>Log Migrare:</h3>
        <div id="log" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
            <!-- Mesajele de log vor apărea aici -->
        </div>
    </div>
    <script type="module">
        // Scriptul de mai sus este deja de tip module, nu e nevoie de un alt tag script.
        // Totuși, pentru placeholder-ul UID-ului în HTML:
        document.getElementById("adminUidPlaceholder").textContent = UID_ADMIN_PENTRU_MIGRARE;
    </script>
</body>
</html>