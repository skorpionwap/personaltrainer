<!DOCTYPE html>
<html>
<head>
    <title>Fișă Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentStep = 1;
    let totalSteps = 0;
    let dataAlreadyLoadedForCards = false; // Flag specific pentru carduri

    window.onload = function () {
        totalSteps = document.querySelectorAll('.form-step').length;
        updateProgressBar();
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');
        
        if (!collabId) {
            populateTableAndCards(); // Populează și tabelul și cardurile pentru utilizatorul normal
        }

        // Event listeners pentru butoane formular etc.
        const nextButton = document.getElementById("nextButton");
        if (nextButton) nextButton.addEventListener("click", nextStep);
        const prevButton = document.getElementById("prevButton");
        if (prevButton) prevButton.addEventListener("click", previousStep);
        const addButton = document.getElementById("addButton");
        if (addButton) addButton.addEventListener("click", handleAddEntry);
        const generateLinkButton = document.getElementById("generateLinkButton");
        if (generateLinkButton) generateLinkButton.addEventListener("click", generateCollaborationLink);

        if (!collabId) {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    console.log("Utilizator neautentificat, redirecționare...");
                    window.location.href = "login.html";
                }
            });
        }
    };

    function nextStep() { /* ... cod neschimbat ... */ }
    function previousStep() { /* ... cod neschimbat ... */ }
    function updateProgressBar() { /* ... cod neschimbat ... */ }
    async function genereazaFeedbackAI(rowData, docId) { /* ... cod neschimbat din versiunea anterioară (Varianta 2) ... */ }
    function afiseazaIstoricFeedback(containerElement, feedbackHistory) { /* ... cod neschimbat din versiunea anterioară (Varianta 2) ... */ }

    // --- Modificări principale aici ---

    async function handleAddEntry() { // Redenumit din adaugaInTabel pentru claritate
        const form = document.getElementById("exercitiuForm");
        const formData = new FormData(form);
        const entryData = { date: new Date().toLocaleDateString() };
        formData.forEach((value, key) => { entryData[key] = value; });

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), entryData);
            entryData.id = docRef.id;
            console.log(`Intrare salvată cu ID: ${docRef.id}. Se generează feedback AI automat...`);

            const feedbackGenerat = await genereazaFeedbackAI(entryData, docRef.id);
            if (feedbackGenerat) {
                if (!entryData.feedback_history) entryData.feedback_history = [];
                entryData.feedback_history.push(feedbackGenerat);
            }

            // Adaugă la tabel și la carduri
            adaugaIntrareInTabel(entryData); 
            adaugaCard(entryData);      
            
            form.reset();
            currentStep = 1;
            // Resetare pași formular...
            const activeStep = document.querySelector('.form-step-active');
            if (activeStep) activeStep.classList.remove('form-step-active');
            const firstStep = document.getElementById('step-1');
            if(firstStep) firstStep.classList.add('form-step-active');
            updateProgressBar();


            const confirmationMessage = document.getElementById('confirmationMessage');
            confirmationMessage.textContent = 'Formularul a fost trimis și feedback-ul AI generat!';
            confirmationMessage.style.display = 'block';
            setTimeout(() => { confirmationMessage.style.display = 'none'; }, 7000);

        } catch (error) {
            console.error("Eroare la salvarea intrării sau generarea feedback-ului AI:", error);
            alert("A apărut o eroare. Vă rugăm încercați din nou.");
        }
    }

    function adaugaIntrareInTabel(rowData) {
        const tableBody = document.getElementById("tableBody");
        if (!tableBody) return;

        // Elimină rândul vechi dacă există (pentru actualizări, deși acum doar adăugăm)
        const existingRow = tableBody.querySelector(`tr[data-id="${rowData.id}"]`);
        if (existingRow) existingRow.remove();
        const existingDetailRow = tableBody.querySelector(`#details-${rowData.id}`);
        if (existingDetailRow) existingDetailRow.remove();

        const row = document.createElement("tr");
        row.setAttribute("data-id", rowData.id); // Adăugăm ID-ul pentru referință la ștergere

        row.innerHTML = `
            <td data-label="Data">${rowData.date || ''}</td>
            <td data-label="Situația">${rowData.situatie || ''}</td>
            <td data-label="Gânduri">${rowData.ganduri || ''}</td>
            <td data-label="Emoții">${rowData.emotii || ''}</td>
            <td data-label="Mod activ">${rowData.mod_activ || ''}</td>
            <td data-label="Comportament">${rowData.comportament || ''}</td>
            <td data-label="Nevoile">${rowData.nevoi_profunde || ''}</td>
            <td data-label="Ajutor comport.">${rowData.ajutor_comportament || ''}</td>
            <td data-label="Adult Sănătos">${rowData.adult_sanatos || ''}</td>
            <td><button onclick="window.toggleDetails('${rowData.id}')">Extinde</button></td>
        `;

        // Adaugă rândul la începutul tabelului
        if (tableBody.firstChild) {
            tableBody.insertBefore(row, tableBody.firstChild);
        } else {
            tableBody.appendChild(row);
        }
        

        const detailRow = document.createElement("tr");
        detailRow.id = `details-${rowData.id}`;
        detailRow.style.display = "none";
        detailRow.setAttribute("data-id", rowData.id); // Și pentru detailRow
        detailRow.innerHTML = `
            <td colspan="10">
                <div class="detail-card styled-detail-card">
                    <h4>Explorarea gândurilor și a percepțiilor (Detalii)</h4>
                    <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
                    <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
                    <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
                    <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
                    <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
                    <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
                    <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
                    <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>
                    <h4>Întrebări pentru claritate și reflecție suplimentară (Detalii)</h4>
                    <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
                    <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
                    <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
                    <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
                    <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
                    <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
                    <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
                    <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
                    <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
                    <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
                    <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
                </div>
            </td>
        `;
        // Inserează detailRow imediat după row-ul principal
        row.insertAdjacentElement('afterend', detailRow);
    }

    function adaugaCard(rowData) { // Funcția adaugaCard rămâne similară cu Varianta 2
        const cardViewContainer = document.getElementById("cardViewContainer");
        if (!cardViewContainer) return;

        // Verifică dacă un card cu acest ID există deja pentru a-l actualiza, altfel creează unul nou
        let card = cardViewContainer.querySelector(`.response-card[data-id="${rowData.id}"]`);
        
        if (card) { // Cardul există, actualizăm doar istoricul AI
            const historyContainer = card.querySelector('.ai-feedback-history-container');
            if (historyContainer) {
                afiseazaIstoricFeedback(historyContainer, rowData.feedback_history);
            }
            return; 
        }

        // Cardul nu există, îl creăm
        card = document.createElement("div");
        card.className = "response-card";
        card.setAttribute("data-id", rowData.id);
        card.innerHTML = `
            <div class="card-header"> Data: ${rowData.date || ''} - Situația: ${rowData.situatie || ''}</div>
            <div class="card-content">
              <h4>Explorarea situației și a nevoilor</h4>
              <p><strong>Care este situația?</strong> ${rowData.situatie || ''}</p>
              <p><strong>Ce îmi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
              <p><strong>Cum mă face acel gând să mă simt?</strong> ${rowData.emotii || ''}</p>
              <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
              <p><strong>Ce comportament simți că adopți?</strong> ${rowData.comportament || ''}</p>
              <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
              <p><strong>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
              <p><strong>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</strong> ${rowData.adult_sanatos || ''}</p>

              <h4>Analiza gândurilor și a percepțiilor</h4>
              <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
              <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
              <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
              <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
              <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
              <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
              <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
              <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>

              <h4>Întrebări pentru claritate și reflecție suplimentară</h4>
              <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
              <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
              <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
              <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
              <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
              <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
              <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
              <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
              <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
              <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
              <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
              
              <div class="card-actions">
                  <button class="generate-ai-feedback-button">Solicită Feedback AI</button>
                  <button class="delete-button">Șterge</button>
              </div>
              <div class="ai-feedback-history-container"></div>
            </div>
        `;
        // Attach event listeners
        card.querySelector('.card-header').addEventListener('click', () => card.classList.toggle('open'));
        card.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); handleStergeIntrare(rowData.id, card, true); });
        card.querySelector('.generate-ai-feedback-button').addEventListener('click', async (e) => {
            e.stopPropagation();
            const button = e.target;
            const originalText = button.textContent;
            button.textContent = 'Se generează...';
            button.disabled = true;
            try {
                const docSnap = await getDoc(doc(db, "raspunsuri", rowData.id));
                let currentData = rowData;
                if (docSnap.exists()) currentData = { id: docSnap.id, ...docSnap.data() };
                
                const feedbackNou = await genereazaFeedbackAI(currentData, currentData.id);
                if (!currentData.feedback_history) currentData.feedback_history = [];
                currentData.feedback_history.push(feedbackNou);
                afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), currentData.feedback_history);
            } catch (err) { console.error("Eroare generare manuală AI:", err); alert("Eroare la generare AI."); }
            finally { button.textContent = originalText; button.disabled = false; }
        });

        afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);

        if (cardViewContainer.firstChild) {
            cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
        } else {
            cardViewContainer.appendChild(card);
        }
    }
    
    async function populateTableAndCards() { // Funcție unificată pentru încărcarea inițială
        console.log("Populare tabel și carduri...");
        const tableBody = document.getElementById("tableBody");
        const cardViewContainer = document.getElementById("cardViewContainer");

        if (tableBody) tableBody.innerHTML = '';
        if (cardViewContainer) cardViewContainer.innerHTML = '';
        dataAlreadyLoadedForCards = false;

        try {
            const querySnapshot = await getDocs(collection(db, "raspunsuri"));
            const documents = [];
            querySnapshot.forEach((doc) => documents.push({ id: doc.id, ...doc.data() }));

            documents.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.split('.').reverse().join('-')) : new Date(0);
                const dateB = b.date ? new Date(b.date.split('.').reverse().join('-')) : new Date(0);
                return dateB - dateA;
            });
            
            documents.forEach(docData => {
                if (tableBody) adaugaIntrareInTabel(docData); // Adaugă în tabel
                if (cardViewContainer) adaugaCard(docData);    // Adaugă și card
            });
            dataAlreadyLoadedForCards = true;
        } catch (error) {
            console.error("Eroare la popularea datelor:", error.message);
        }
    }
    
    // Funcție de încărcare specifică pentru colaboratori (doar carduri)
    async function loadCardsForCollaborator(collabId, pin, ownerUid) {
        console.log("Încărcare carduri pentru colaborator...");
        const cardViewContainer = document.getElementById("cardViewContainer");
        if (!cardViewContainer || dataAlreadyLoadedForCards) return;
        cardViewContainer.innerHTML = '';

        try {
            // Aici ar trebui să filtrezi răspunsurile pe baza ownerUid al colaborării
            // Exemplu: const q = query(collection(db, "raspunsuri"), where("ownerUid", "==", ownerUid));
            // Pentru moment, încărcăm tot ca placeholder:
            const querySnapshot = await getDocs(collection(db, "raspunsuri")); 
            const documents = [];
            querySnapshot.forEach((doc) => {
                // Aici ar trebui să verifici dacă doc.data().ownerUid === ownerUid
                documents.push({ id: doc.id, ...doc.data() });
            });

            documents.sort((a,b) => (new Date(b.date.split('.').reverse().join('-'))) - (new Date(a.date.split('.').reverse().join('-'))));
            documents.forEach(docData => adaugaCard(docData));
            dataAlreadyLoadedForCards = true;

        } catch (error) {
            console.error("Eroare la încărcarea cardurilor pentru colaborator:", error);
        }
    }


    window.toggleDetails = function(id) {
        const detailRow = document.getElementById(`details-${id}`);
        if (detailRow) {
            detailRow.style.display = detailRow.style.display === "none" ? "table-row" : "none";
        }
    }

    async function handleStergeIntrare(id, cardElement = null, fromCard = false) {
        if (confirm("Sunteți sigur că doriți să ștergeți această înregistrare?")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                
                // Elimină din carduri
                const cardToDelete = cardElement || document.querySelector(`.response-card[data-id="${id}"]`);
                if (cardToDelete) cardToDelete.remove();
                
                // Elimină din tabel
                const tableBody = document.getElementById("tableBody");
                const rowToDelete = tableBody ? tableBody.querySelector(`tr[data-id="${id}"]`) : null;
                if (rowToDelete) rowToDelete.remove();
                const detailRowToDelete = tableBody ? tableBody.querySelector(`#details-${id}`) : null;
                if (detailRowToDelete) detailRowToDelete.remove();

                console.log(`Intrarea ${id} a fost ștearsă.`);

            } catch (error) {
                console.error("Eroare la ștergerea intrării:", error);
                alert("Eroare la ștergerea înregistrării.");
            }
        }
    }
    
    // Funcția stergeCard este înlocuită de handleStergeIntrare.
    // Dacă ai apeluri la stergeCard în altă parte, actualizează-le.
    // Funcția veche era specifică doar ștergerii cardului.

    async function generateCollaborationLink() { /* ... cod neschimbat ... */ }

    window.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded");
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (collabId) {
            console.log("Colaborator: ascundem elemente și cerem PIN.");
            // Ascunde formularul, butonul de generare link, și tabelul. Lasă vizibil cardViewContainer.
            ['exercitiuForm', 'generateLinkButton', '.form-container', '.table-container'].forEach(sel => {
                const el = document.querySelector(sel) || document.getElementById(sel);
                if (el) el.style.display = 'none';
            });
            // Afișează explicit containerul de carduri dacă a fost ascuns general
            const cardView = document.getElementById("cardViewContainer");
            if(cardView) cardView.style.display = 'flex'; // Sau 'block' depinzând de stilul tău
             const cardViewTitle = document.querySelector('h3[style*="Răspunsurile tale"]');
            if(cardViewTitle) cardViewTitle.style.display = 'block';


            const pin = prompt("Introduceți PIN pentru colaborare:");
            if (!pin) { alert("PIN necesar."); window.location.href = "login.html"; return; }
            try {
                const collabDocRef = doc(db, "collaborations", collabId);
                const collabSnapshot = await getDoc(collabDocRef);
                if (collabSnapshot.exists()) {
                    const collabData = collabSnapshot.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect. Încărcare date colaborator.");
                        // Pentru colaborator, încărcăm doar cardurile filtrate
                        loadCardsForCollaborator(collabId, pin, collabData.owner); 
                    } else { alert("PIN incorect."); window.location.href = "login.html"; }
                } else { alert("Colaborare inexistentă."); window.location.href = "login.html"; }
            } catch (error) { console.error("Eroare accesare colaborare:", error); alert("Eroare accesare colaborare."); window.location.href = "login.html"; }
        } else {
            // Utilizatorul normal - datele sunt încărcate în window.onload -> populateTableAndCards
            const tableContainer = document.querySelector(".table-container");
            if(tableContainer) tableContainer.style.display = 'block'; // Asigură-te că tabelul e vizibil pentru user normal
        }
    });
    </script>
    <style>
        /* ... STILURILE RĂMÂN ACELEAȘI CA ÎN VERSIUNEA ANTERIOARĂ (Varianta 2) ... */
        /* Asigură-te că .table-container este vizibil pentru utilizatorul normal și ascuns pentru colaborator (gestionat în JS) */
         body {
            font-family: 'Roboto', 'Montserrat', sans-serif;
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(to right, #ece9e6, #ffffff);
            color: #333;
            box-sizing: border-box; 
        }
        .form-container {
            max-width: 900px;
            margin: 20px auto; 
            background: #fff;
            padding: 30px;
            box-shadow: 0 16px 24px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 3px solid #87CEFA;
            transition: transform 0.3s ease;
        }
        .form-container:hover {
            transform: scale(1.01); 
        }
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress {
            height: 20px;
            width: 0;
            background-color: #87CEFA;
            transition: width 0.4s ease;
        }
        .question-card {
            margin-bottom: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .question-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .question-card h3 {
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 0; 
            margin-bottom: 10px;
        }
        .question-card p {
            font-weight: 300;
            font-size: 0.95em;
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }
        textarea {
            width: calc(100% - 22px); 
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
            min-height: 60px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }
        textarea:focus {
            border-color: #87CEFA;
            box-shadow: 0 2px 8px rgba(135, 206, 250, 0.5);
            outline: none; 
        }
        input[type="submit"], button { 
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: 500; 
            background: linear-gradient(to right, #87CEFA, #6bb9e7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s; 
        }
        input[type="submit"]:hover, button:hover {
            background: linear-gradient(to right, #6bb9e7, #4A90E2);
            transform: translateY(-2px); 
        }
        .form-step {
            display: none;
        }
        .form-step-active {
            display: block;
            animation: fadeIn 0.7s ease-in-out; 
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); } 
            100% { opacity: 1; transform: translateY(0); }
        }
        .step-navigation {
            text-align: center;
            margin-top: 20px;
        }
        .step-navigation button { 
            margin: 0 10px;
        }

        .table-container {
            margin: 30px auto; 
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto; 
            max-width: 900px; 
            /* display: none; /* Ascuns inițial, controlat de JS */
       }


        .card-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px; 
            margin: 30px auto; 
        }

        .response-card {
            background: #f9f9ff; 
            padding: 0; 
            border-radius: 15px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.12); 
            transition: box-shadow 0.3s ease; 
            position: relative;
            overflow: hidden; 
        }

        .response-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.18); 
        }

        .response-card .card-header {
            font-weight: 700;
            font-size: 1.1em; 
            cursor: pointer;
            background: #87CEFA;
            padding: 12px 20px; 
            color: #fff;
            text-align: left; 
            position: relative;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .response-card .card-header::after {
            content: '▼'; 
            font-size: 0.8em; 
            transition: transform 0.3s ease;
        }

        .response-card.open .card-header::after {
            transform: rotate(180deg); 
        }

        .response-card .card-content {
            max-height: 0;
            margin-top: 0; 
            padding: 0 20px; 
            background: #fff; 
            line-height: 1.6; 
            overflow: auto; 
            transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, padding-bottom 0.4s ease-out; 
        }

        .response-card.open .card-content {
            max-height: 1200px; 
            padding-top: 15px;
            padding-bottom: 15px; 
        }

        .response-card .card-content p {
            margin-bottom: 12px; 
            border-left: 3px solid #87CEFA;
            padding-left: 10px;
            background: transparent; 
            border-bottom: none; 
            padding-bottom: 0; 
        }
         .response-card .card-content p strong {
            color: #333; 
         }

        .response-card h4 {
            text-align: left; 
            color: #4A90E2;
            font-weight: bold;
            margin-top: 20px; 
            margin-bottom: 10px; 
            font-size: 1.05em; 
        }
         .response-card h4:first-child {
            margin-top: 0; 
         }

        .card-actions { 
            text-align: center;
            margin-top: 20px;
            padding-bottom: 10px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .card-actions button { 
            padding: 8px 15px;
            font-size: 0.9em;
            margin-left: 5px;
            margin-right: 5px;
            margin-top: 5px; 
        }
        .generate-ai-feedback-button { 
            background: #5cb85c; 
        }
        .generate-ai-feedback-button:hover {
            background: #4cae4c;
        }
         .delete-button { 
            background-color: #f44336 !important; 
        }
        .delete-button:hover {
            background-color: #d32f2f !important;
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); 
            border-radius: 10px;
            overflow: hidden; 
        }
        th {
            background: linear-gradient(to right, #6bb9e7, #87CEFA);
            color: white;
            text-align: left; 
            padding: 12px 15px; 
            font-size: 0.9em; 
            position: sticky;
            top: 0;
            z-index: 2;
        }
        td {
            padding: 10px 15px; 
            text-align: left;
            border-bottom: 1px solid #ddd; 
            font-size: 0.85em; 
        }
        tr:last-child td {
            border-bottom: none; 
        }
        tr:hover {
            background-color: #f5f5f5; 
        }

        .detail-card { 
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); 
            margin-top: 10px;
        }
        .styled-detail-card { 
            background: #f0f8ff; 
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 10px auto; 
            overflow: hidden;
        }
        .styled-detail-card h4 {
            text-align: center;
            color: #4A90E2;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .styled-detail-card p {
            margin-bottom: 10px;
            border-left: 3px solid #87CEFA;
            padding-left: 8px;
            background: #fff;
            border-bottom: 1px solid #eee; 
            padding-bottom: 8px;
            font-size: 0.95em; 
        }
        
        #confirmationMessage {
            display: none;
            text-align: center;
            padding: 15px;
            background-color: #d4edda; 
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin-top: 20px;
            animation: fadeIn 0.5s; 
        }

        .collaboration-section {
            text-align: center;
            margin-top: 30px;
            padding-bottom: 20px; 
        }
        .collaboration-section button { 
            background-color: #f0ad4e; 
        }
        .collaboration-section button:hover {
            background-color: #ec971f; 
        }

/* Responsive Adjustments */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    .form-container, .table-container, .card-view {
        padding: 15px;
        margin-left: 10px;
        margin-right: 10px;
        max-width: calc(100% - 20px); 
    }
    textarea {
        font-size: 14px;
        padding: 8px;
        width: calc(100% - 18px); 
    }
    .form-container > button, .step-navigation button {
        font-size: 16px;
        padding: 10px 20px;
    }
    .card-actions button {
        font-size: 0.85em; 
        padding: 7px 12px;
    }
    .question-card h3, .response-card .card-header {
        font-size: 1.05em; 
    }
    .question-card p, .response-card .card-content p, .styled-detail-card p {
        font-size: 0.9em;
    }
    .response-card .card-content {
        font-size: 0.9em;
    }
    table, th, td {
        font-size: 0.8em; 
    }
    th, td {
        padding: 8px; 
    }

    .table-container {
        overflow-x: auto; 
    }
    table {
        display: block; 
        width: 100%;
    }
    thead, tbody, tr {
        display: block;
    }
    th { 
         display: none;
    }
    tr {
        margin-bottom: 15px; 
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex; 
        flex-direction: column;
    }
    td {
        display: flex; 
        justify-content: space-between; 
        padding: 10px;
        text-align: right; 
        border-bottom: 1px solid #eee; 
        position: relative; 
    }
    td:last-child {
        border-bottom: none;
    }
    td::before {
        content: attr(data-label); 
        font-weight: bold;
        text-align: left; 
        margin-right: 10px; 
        color: #555;
        flex-shrink: 0; 
        width: 40%; 
    }
    td > *:not(button) { 
        flex-grow: 1;
        word-break: break-word;
    }
    td button { 
        width: auto;
        padding: 6px 12px;
        font-size: 0.85em;
        margin-left: auto; 
        flex-shrink: 0; 
    }
     td[colspan="10"] { 
        display: block; 
    }
    td[colspan="10"] .styled-detail-card {
        width: auto; 
    }
}

@media (max-width: 480px) {
    .form-container, .table-container, .card-view {
        padding: 10px;
        margin-left: 5px;
        margin-right: 5px;
        max-width: calc(100% - 10px);
    }
    .question-card h3, .response-card .card-header {
        font-size: 1em;
    }
    .question-card p, .response-card .card-content p, .styled-detail-card p {
        font-size: 0.85em;
    }
    textarea {
        font-size: 13px;
        padding: 6px;
        width: calc(100% - 14px);
    }
    .form-container > button, .step-navigation button {
        font-size: 14px;
        padding: 8px 15px;
    }
    .card-actions button {
        font-size: 0.8em; 
        padding: 6px 10px;
    }
    .response-card .card-header {
        padding: 10px;
    }
    .response-card .card-content {
        padding-left: 15px; 
        padding-right: 15px;
        font-size: 0.85em;
    }
    table, th, td {
        font-size: 0.75em;
    }
    td {
        padding: 8px;
        flex-direction: column; 
        align-items: flex-start; 
    }
    td::before {
        margin-right: 0;
        margin-bottom: 5px; 
        width: 100%; 
    }
    td button {
        align-self: flex-end; 
    }
}
    </style>
</head>
<body>
    <div class="form-container">
        <!-- Formularul (steps 1-28) rămâne neschimbat -->
        <h2>Fișă Monitorizare</h2>
        <p>Completează fiecare întrebare pentru a înțelege mai bine situațiile tale. Fiecare secțiune reprezintă o parte importantă a reflecției tale. În acest exercițiu, îți voi ghida fiecare pas, astfel încât să poți explora în profunzime gândurile, emoțiile și comportamentele tale.</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm">
            <!-- Secțiunea 1: Explorarea situației și a nevoilor -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situația?</h3>
                <p>Te rog să descrii contextul care a declanșat emoțiile sau comportamentul tău. Încearcă să fii cât mai specific și detaliat. Aceasta poate fi o situație concretă din viața de zi cu zi în care te-ai simțit copleșit, stresat sau într-o altă stare emoțională intensă.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce îmi trece prin minte?</h3>
                <p>Îți cer să identifici gândurile automate care au apărut în această situație. Acestea sunt gânduri rapide, involuntare, care îți trec prin minte în momentele de stres. Ce îți spui în acel moment? Este un gând critic sau îngrijorător?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mă face acel gând să mă simt?</h3>
                <p>Te rog să notezi emoțiile pe care le simți în urma acelui gând. Ce simți? Frică, tristețe, furie? Dă o intensitate emoției (de la 0 la 100) pentru a vedea cât de puternică este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>Identifică modul în care te afli în această situație. Este un mod de copil vulnerabil, critic interior, sau poate adultul sănătos? Conștientizarea modului îți poate oferi o mai bună înțelegere a reacțiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simți că adopți?</h3>
                <p>Descrie comportamentul pe care îl manifești în această situație. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoașterea comportamentului te ajută să înțelegi mai bine cum reacționezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoții și comportamente? Poate fi nevoia de siguranță, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta să găsești strategii mai sănătoase pentru a le îndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</h3>
                <p>Reflectează dacă felul în care reacționezi te ajută cu adevărat să îți îndeplinești nevoile. Poate fi util să te gândești dacă există alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</h3>
                <p>Gândește-te la cum ar reacționa partea ta Adultă Sănătoasă în această situație. Cum ai putea să abordezi diferit pentru a avea grijă de tine și de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- Secțiunea 2: Analiza gândurilor și a percepțiilor -->
            <div class="question-card form-step" id="step-9">
                <h3>Ce mă face să cred că gândul automat este adevărat?</h3>
                <p>Explorează motivele pentru care crezi că acest gând este adevărat. Ce dovezi ai care îți confirmă acest lucru? De multe ori, ne bazăm pe experiențe trecute sau frici pentru a justifica un gând.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mă face să cred că nu este adevărat?</h3>
                <p>Acum, să ne uităm la dovezile împotriva gândului tău. Există argumente sau experiențe care contrazic acest gând? Poate există o altă perspectivă pe care nu ai luat-o în considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>Există o explicație alternativă?</h3>
                <p>Uneori, există mai multe explicații pentru ceea ce se întâmplă. Ce alte interpretări ai putea avea pentru această situație? Gândește-te la alte posibilități care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rău lucru care s-ar putea întâmpla?</h3>
                <p>Ce este cel mai rău care ar putea avea loc în această situație? Să identificăm acele frici catastrofale care adesea ne alimentează gândurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea întâmpla?</h3>
                <p>Pe de altă parte, care ar fi cel mai pozitiv scenariu? Uneori uităm să ne gândim și la posibilitățile bune. Cum ar arăta cel mai bun rezultat al acestei situații?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>După ce am explorat extremele, ce crezi că este cel mai probabil să se întâmple? Cum ar arăta un rezultat realist, ținând cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</h3>
                <p>Întreabă-te cum ar fi dacă ai aborda situația cu un alt tip de gândire. Cum ar influența asta emoțiile și comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</h3>
                <p>Gândește-te la cum ai reacționa dacă un prieten drag ar avea aceleași gânduri. Ce i-ai spune pentru a-l sprijini? Cum ai încerca să-l încurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- Secțiunea 3: Întrebări pentru claritate și reflecție suplimentară -->
            <div class="question-card form-step" id="step-17">
                <h3>Văd doar partea rea a lucrurilor?</h3>
                <p>Este posibil să fii prins într-un tipar negativ de gândire, concentrându-te doar pe aspectele negative. Încearcă să observi dacă există și aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-18">
                <h3>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</h3>
                <p>Reflectează dacă îți asumi responsabilitatea pentru situații asupra cărora nu aveai control. Este important să îți dai seama de limitele influenței tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>Mă condamn în baza unui singur eveniment?</h3>
                <p>Îți evaluezi valoarea personală bazându-te pe un singur eveniment negativ? Amintește-ți că un eveniment nu definește cine ești în totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situația în termeni extremi?</h3>
                <p>Verifică dacă vezi situația doar în alb sau negru, fără nuanțe de gri. Gândirea extremă poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situația?</h3>
                <p>Îți amplifici reacțiile față de o situație? Încearcă să te gândești dacă ceea ce percepi este realist sau dacă exagerezi impactul situației.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>Există și alți factori responsabili?</h3>
                <p>Există alți factori care contribuie la această situație, pe lângă tine? Este important să ai o perspectivă completă asupra cauzelor unei situații.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sărit direct la concluzii?</h3>
                <p>Te-ai grăbit să ajungi la o concluzie fără suficiente dovezi? Încearcă să observi dacă există alte posibilități care ar putea explica situația.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-24">
                <h3>Îmi pun întrebări fără răspuns?</h3>
                <p>Te frământă întrebări care nu au un răspuns clar sau realist? Aceste întrebări pot fi o sursă majoră de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>Mă concentrez doar asupra slăbiciunilor mele?</h3>
                <p>Ai tendința să te focalizezi doar pe slăbiciuni și să ignori punctele tale forte? Încearcă să îți recunoști și punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</h3>
                <p>Ai tendința să te gândești mereu la cum ar trebui să fie lucrurile, în loc să accepți situația așa cum este? Acceptarea poate reduce stresul și anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-27">
                <h3>Mă aștept să fiu perfect?</h3>
                <p>Îți setezi standarde foarte înalte, imposibil de atins? Perfecționismul poate fi o sursă majoră de frustrare și descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-28">
                <h3>Completare finalizata!</h3>
                <p>Nu uita să salvezi datele.</p>
            </div>

            <div class="step-navigation">
                <button type="button" id="prevButton">Înapoi</button>
                <button type="button" id="nextButton">Înainte</button>
            </div>
            <button type="button" id="addButton">Salveaza datele</button>
        </form>

        <div id="confirmationMessage"></div>
        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">Generează Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">Jurnalul tău (Tabel sumar):</h3>
    <div class="table-container"> <!-- Acest container va fi afișat implicit pentru userul normal -->
        <table>
            <thead>
                <tr>
                    <th>Data</th><th>Situația</th><th>Gânduri</th><th>Emoții</th><th>Mod activ</th>
                    <th>Comportament</th><th>Nevoile</th><th>Ajutor comport.</th><th>Adult Sănătos</th><th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">Jurnalul tău (Carduri detaliate cu Feedback AI):</h3>
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile vor fi adăugate aici -->
    </div>
    <br/>
</body>
</html>