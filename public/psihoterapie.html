<!DOCTYPE html>
<html>
<head>
    <title>Fișă Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // Configurarea Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

  // --- Configurare Gemini API ---
const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng"; // ACEASTA ESTE CHEIA TA REALĂ
const GEMINI_MODEL_NAME = "gemini-2.5-flash-preview-04-17";
let genAI, geminiModel;

// Condiție simplificată: verifică doar dacă GEMINI_API_KEY are o valoare.
if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
    try {
        genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        geminiModel = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });
        console.log("SDK Gemini inițializat cu succes. Model:", GEMINI_MODEL_NAME);
    } catch (e) {
        console.error("Eroare la inițializarea SDK Gemini. Verifică validitatea cheii API și conexiunea la internet.", e);
        geminiModel = null; // Setează la null dacă inițializarea eșuează
    }
} else {
    // Acest mesaj se va afișa doar dacă GEMINI_API_KEY este un string gol sau nu e definită.
    console.warn("Cheia API pentru Gemini (GEMINI_API_KEY) este goală sau nedefinită. Feedback-ul AI prin Gemini va fi dezactivat.");
    geminiModel = null;
}


    let currentStep = 1;
    let totalSteps = 0;
    let dataAlreadyLoaded = false;

    window.onload = function () {
        totalSteps = document.querySelectorAll('.form-step').length;
        updateProgressBar();
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (!collabId) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utilizator autentificat:", user.uid);
                    if (!dataAlreadyLoaded) {
                        // Este CRUCIAL ca aceste funcții să filtreze pe user.uid
                        populateTableData(user.uid); 
                        loadTableData(user.uid);     
                        dataAlreadyLoaded = true;
                    }
                } else {
                    console.log("Utilizator neautentificat, redirecționare...");
                    window.location.href = "login.html";
                }
            });
        }

        const nextButton = document.getElementById("nextButton");
        if (nextButton) nextButton.addEventListener("click", nextStep);
        const prevButton = document.getElementById("prevButton");
        if (prevButton) prevButton.addEventListener("click", previousStep);
        const addButton = document.getElementById("addButton");
        if (addButton) addButton.addEventListener("click", salveazaRaspunsSiGenereazaFeedback);
        const generateLinkButton = document.getElementById("generateLinkButton");
        if (generateLinkButton) generateLinkButton.addEventListener("click", generateCollaborationLink);
    };

    function nextStep() { /* ... la fel ... */ 
        if (currentStep < totalSteps) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }
    function previousStep() { /* ... la fel ... */ 
        if (currentStep > 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }
    function updateProgressBar() { /* ... la fel ... */ 
        const progress = document.getElementById('progress');
        if(progress && totalSteps > 0) {
            const progressPercentage = (currentStep / totalSteps) * 100;
            progress.style.width = progressPercentage + '%';
        }
    }

    async function genereazaFeedbackCuGeminiDinFrontend(promptText, generationConfig = {}) {
        if (!geminiModel) {
            console.error("Modelul Gemini nu este inițializat.");
            return "EROARE: Configurare Gemini incorectă (cheie API).";
        }
        try {
            console.log("Trimitere prompt către Gemini (primele 100 caractere):", promptText.substring(0, 100) + "...");
            
            const requestPayload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }],
                generationConfig: {
                    temperature: 0.6, // Valoare cu care poți experimenta (0.2-0.8)
                    // maxOutputTokens: 4096, // Poți seta o limită dacă răspunsurile sunt prea lungi
                    ...generationConfig // Permite suprascrierea default-urilor dacă e necesar
                }
            };

            const result = await geminiModel.generateContent(requestPayload);
            const response = result.response;

            if (response && response.candidates && response.candidates.length > 0 && response.candidates[0].content && response.candidates[0].content.parts && response.candidates[0].content.parts.length > 0 && typeof response.candidates[0].content.parts[0].text === 'string') {
                 if (response.candidates[0].finishReason && response.candidates[0].finishReason !== "STOP" && response.candidates[0].finishReason !== "MAX_TOKENS") {
                    console.warn("Gemini a oprit generarea cu motivul:", response.candidates[0].finishReason, response.candidates[0].safetyRatings);
                    return `EROARE Gemini: Generarea a fost oprită (Motiv: ${response.candidates[0].finishReason}). Este posibil ca promptul sau răspunsul să fi declanșat filtre de siguranță. Încearcă să reformulezi.`;
                }
                return response.candidates[0].content.parts[0].text;
            } else {
                 console.error("Răspuns neașteptat sau gol de la Gemini:", JSON.stringify(response, null, 2));
                 let reason = "Răspuns invalid sau gol.";
                 if(response && response.promptFeedback && response.promptFeedback.blockReason){
                    reason = `Prompt blocat (Motiv: ${response.promptFeedback.blockReason}, Detalii: ${response.promptFeedback.blockReasonMessage || 'N/A'})`;
                 }
                 return `EROARE Gemini: ${reason}`;
            }
        } catch (error) {
            console.error("Eroare detaliată la generarea feedback-ului Gemini:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare necunoscută la API"}`;
             if (error.toString().toLowerCase().includes("api key not valid") || (error.message && error.message.toLowerCase().includes("permission denied")) || (error.message && error.message.toLowerCase().includes("api_key_invalid")) ) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validă sau nu are permisiuni. Verifică restricțiile din Google Cloud Console și cheia din cod. Asigură-te că domeniul " + window.location.hostname + " este permis.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare gratuită Gemini (RPM sau alta) a fost depășită. Încearcă mai târziu.";
            } else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 errorMessage = `EROARE Gemini: Modelul ${GEMINI_MODEL_NAME} nu a fost găsit sau nu este suportat. Verifică numele modelului.`;
            }
            return errorMessage;
        }
    }

    async function genereazaSiProceseazaFeedbackAI(rowData, docId) {
        const prompt = `
Analizează în profunzime această fișă completă de auto-reflecție. Utilizatorul a parcurs un exercițiu detaliat pentru a-și înțelege o situație specifică. Oferă feedback psihologic structurat, empatic și acționabil. Respectă cu strictețe formatul și ordinea secțiunilor de mai jos, folosind exact prefixele indicate.

**Datele Complete din Fișa de Reflecție a Utilizatorului:**

**Secțiunea 1: Explorarea Situației și a Nevoilor**
*   Care este situația?: ${rowData.situatie || 'N/A'}
*   Ce îmi trece prin minte (gânduri automate)?: ${rowData.ganduri || 'N/A'}
*   Cum mă face acel gând să mă simt (emoții)?: ${rowData.emotii || 'N/A'}
*   Ce mod este activ?: ${rowData.mod_activ || 'N/A'}
*   Ce comportament simți că adopți?: ${rowData.comportament || 'N/A'}
*   Care sunt nevoile tale mai profunde?: ${rowData.nevoi_profunde || 'N/A'}
*   Mă ajută comportamentul meu să îndeplinesc aceste nevoi?: ${rowData.ajutor_comportament || 'N/A'}
*   Cum ar gândi și cum s-ar comporta Adultul Sănătos (perspectiva utilizatorului)?: ${rowData.adult_sanatos || 'N/A'}

**Secțiunea 2: Analiza Gândurilor și a Percepțiilor**
*   Ce mă face să cred că gândul automat este adevărat?: ${rowData.dovezi_adevar || 'N/A'}
*   Ce mă face să cred că nu este adevărat?: ${rowData.dovezi_fals || 'N/A'}
*   Există o explicație alternativă?: ${rowData.explicatie_alternativa || 'N/A'}
*   Care este cel mai rău lucru care s-ar putea întâmpla?: ${rowData.scenariu_negativ || 'N/A'}
*   Care este cel mai bun lucru care s-ar putea întâmpla?: ${rowData.scenariu_optimist || 'N/A'}
*   Care este cel mai realist rezultat?: ${rowData.rezultat_realist || 'N/A'}
*   Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?: ${rowData.schimbare_gandire || 'N/A'}
*   Ce i-aș spune unui prieten dacă ar fi în aceeași situație?: ${rowData.sfat_prieten || 'N/A'}

**Secțiunea 3: Întrebări pentru Claritate și Reflecție Suplimentară**
*   Văd doar partea rea a lucrurilor?: ${rowData.partea_rea || 'N/A'}
*   Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?: ${rowData.responsabilitate || 'N/A'}
*   Mă condamn în baza unui singur eveniment?: ${rowData.condamnare || 'N/A'}
*   Privesc situația în termeni extremi (alb/negru)?: ${rowData.termeni_extremi || 'N/A'}
*   Exagerez situația?: ${rowData.exagerare || 'N/A'}
*   Există și alți factori responsabili?: ${rowData.factori_responsabili || 'N/A'}
*   Am sărit direct la concluzii?: ${rowData.concluzii || 'N/A'}
*   Îmi pun întrebări fără răspuns?: ${rowData.intrebari_fara_raspuns || 'N/A'}
*   Mă concentrez doar asupra slăbiciunilor mele?: ${rowData.slabiciuni || 'N/A'}
*   Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?: ${rowData.cum_ar_trebui || 'N/A'}
*   Mă aștept să fiu perfect?: ${rowData.perfectiune || 'N/A'}

**CERINȚE PENTRU FEEDBACK-UL AI (folosește prefixele EXACT așa cum sunt scrise):**

Feedback General:
EmpatieInițială: (1-2 propoziții empatice scurte, recunoscând efortul utilizatorului.)

Analiză Detaliată:
PuncteForteObservate: (Identifică 1-2 aspecte pozitive sau de auto-conștientizare.)
TiparePrincipale: (Descrie succint 1-3 tipare de gândire/emoționale/comportamentale centrale.)

Legătura Gând-Emoție-Comportament-Nevoie:
ConexiuniCheie: (Sintetizează legătura S-G-E-C-N bazată pe '${rowData.ganduri}', '${rowData.emotii}', '${rowData.comportament}', '${rowData.nevoi_profunde}'.)

Analiza Gândurilor Automate și Distorsiuni:
DistorsiuniIdentificate: (Identifică 2-4 distorsiuni principale. Pentru fiecare: Numele, Explicația, Exemplu din răspunsuri, Întrebare de contestare. Listează fiecare ca sub-punct precedat de '* '.)

Scheme și Moduri Cognitive:
SchemeActivate: (Identifică 1-3 scheme. Pentru fiecare: Numele, Cum se manifestă. Listează fiecare ca sub-punct precedat de '* '.)
ModuriImplicate: (Sugerează ce moduri Schema Therapy ar putea fi implicate.)

Rolul Adultului Sănătos:
PerspectivaAdultSănătos: (Comentează răspunsul utilizatorului '${rowData.adult_sanatos}'. Oferă descriere detaliată: interpretare situație, gânduri alternative, gestionare emoții, comportamente adaptative, contracarare scheme.)

Sugestii și Reflecții Finale:
ÎntrebareFinalăReflecție: (O întrebare generală puternică pentru învățare și aplicare viitoare.)
SugestieMicPas: (O sugestie concretă pentru un mic pas următor.)
ÎncurajareFinală: (1-2 propoziții de încurajare.)

Răspunde doar cu textul cerut conform structurii, fără introduceri, concluzii sau formatări suplimentare în afara celor specificate (ex: nu folosi markdown bold '**' în răspunsul tău, doar prefixele și `* ` pentru liste).`;

        let feedbackText = null;
        let modelFolosit = "N/A";

        if (geminiModel) {
            console.log("Solicitare feedback de la Gemini (prompt nou)...");
            modelFolosit = `Gemini (${GEMINI_MODEL_NAME})`;
            feedbackText = await genereazaFeedbackCuGeminiDinFrontend(prompt);
        } else {
            return { // Structură similară pentru eroare
                empatie_initiala: "Serviciul de feedback AI (Gemini) nu este configurat. Verifică cheia API.",
                model: "Configurare Gemini Eronată", timestamp: new Date().toISOString(), error: true
            };
        }

        if (!feedbackText || (typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
            return { 
                empatie_initiala: feedbackText || `Nu s-a putut obține feedback de la ${modelFolosit}.`,
                model: modelFolosit + " (Eroare API)", timestamp: new Date().toISOString(), error: true
            };
        }

        console.log("Răspuns brut de la Gemini (prompt nou):\n---\n" + feedbackText + "\n---");

        // Definirea noilor chei și prefixe pentru parsare
        const feedbackStructure = {
            empatie_initiala: /^EmpatieInițială:\s*([\s\S]*?)(?=\n(?:PuncteForteObservate:|$))/im,
            puncte_forte: /^PuncteForteObservate:\s*([\s\S]*?)(?=\n(?:TiparePrincipale:|$))/im,
            tipare_principale: /^TiparePrincipale:\s*([\s\S]*?)(?=\n(?:ConexiuniCheie:|$))/im,
            conexiuni_cheie: /^ConexiuniCheie:\s*([\s\S]*?)(?=\n(?:DistorsiuniIdentificate:|$))/im,
            distorsiuni_identificate: /^DistorsiuniIdentificate:\s*([\s\S]*?)(?=\n(?:SchemeActivate:|$))/im,
            scheme_activate: /^SchemeActivate:\s*([\s\S]*?)(?=\n(?:ModuriImplicate:|$))/im,
            moduri_implicate: /^ModuriImplicate:\s*([\s\S]*?)(?=\n(?:PerspectivaAdultSănătos:|$))/im,
            perspectiva_adult_sanatos: /^PerspectivaAdultSănătos:\s*([\s\S]*?)(?=\n(?:ÎntrebareFinalăReflecție:|$))/im,
            intrebare_finala_reflectie: /^ÎntrebareFinalăReflecție:\s*([\s\S]*?)(?=\n(?:SugestieMicPas:|$))/im,
            sugestie_mic_pas: /^SugestieMicPas:\s*([\s\S]*?)(?=\n(?:ÎncurajareFinală:|$))/im,
            incurajare_finala: /^ÎncurajareFinală:\s*([\s\S]*?$)/im,
        };
        
        const parsedFeedback = { model: modelFolosit, timestamp: new Date().toISOString() };
        let allParsingFailed = true;

        for (const key in feedbackStructure) {
            const match = feedbackText.match(feedbackStructure[key]);
            parsedFeedback[key] = match && match[1] ? match[1].trim() : `Nu s-a putut extrage '${key}'.`;
            if (parsedFeedback[key] && !parsedFeedback[key].startsWith("Nu s-a putut")) {
                allParsingFailed = false;
            }
        }
        
        if (allParsingFailed && !(typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
            console.warn("Parsarea detaliată a eșuat pentru toate secțiunile (prompt nou). Verifică formatul răspunsului AI și regex-urile.");
            // Dacă totul eșuează, pune răspunsul brut într-un câmp principal
            parsedFeedback.empatie_initiala = `Răspuns brut (parsare eșuată):\n${feedbackText.replace(/\n/g, "<br>")}`;
            parsedFeedback.error_parsing = true; // Marchează că parsarea a eșuat
        }

        if (docId) {
            const docRef = doc(db, "raspunsuri", docId);
            try {
                const updatePayload = { feedback_history: arrayUnion(parsedFeedback) };
                // Adaugă câmpurile individuale pentru cel mai recent feedback
                Object.keys(parsedFeedback).forEach(key => {
                    updatePayload[`feedback_${key}`] = parsedFeedback[key];
                });
                await updateDoc(docRef, updatePayload);
                console.log(`Feedback AI (structură nouă, ${modelFolosit}) salvat pentru docId: ${docId}`);
            } catch (updateError) {
                console.error(`Eroare la actualizarea Firestore cu feedback (structură nouă) pt doc ${docId}:`, updateError);
            }
        }
        return parsedFeedback;
    }

    async function salveazaRaspunsSiGenereazaFeedback() {
        const form = document.getElementById("exercitiuForm");
        if (!form.checkValidity()) {
            form.reportValidity();
            const currentStepElement = document.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid:not(fieldset)'); // Evită fieldset dacă ai
            if (firstInvalidField) {
                firstInvalidField.focus();
                alert("Vă rugăm completați toate câmpurile obligatorii din pasul curent.");
            } else {
                alert("Vă rugăm completați toate câmpurile obligatorii.");
            }
            return;
        }

        const formData = new FormData(form);
        const rowData = { 
            date: new Date().toLocaleDateString("ro-RO"),
            timestamp: new Date().toISOString() // Adaugă un timestamp complet la salvarea datelor
        };
        formData.forEach((value, key) => { rowData[key] = value; });

        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie să fiți autentificat."); window.location.href = "login.html"; return;
        }
        rowData.ownerUid = user.uid;

        const addButton = document.getElementById("addButton");
        const originalAddButtonText = addButton.textContent;
        addButton.textContent = "Se salvează și procesează..."; addButton.disabled = true;

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), rowData);
            rowData.id = docRef.id;
            console.log(`Răspuns salvat cu ID: ${docRef.id}. Se generează feedback AI...`);

            const feedbackGenerat = await genereazaSiProceseazaFeedbackAI(rowData, docRef.id);
            
            const docSnapshot = await getDoc(docRef); // Ia cea mai recentă versiune
            if (docSnapshot.exists()) {
                adaugaCard({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                rowData.feedback_history = feedbackGenerat && !feedbackGenerat.error ? [feedbackGenerat] : [];
                adaugaCard(rowData); // Fallback
            }
            
            form.reset(); currentStep = 1;
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('form-step-active'));
            document.getElementById('step-1').classList.add('form-step-active');
            updateProgressBar();

            const confirmationMessage = document.getElementById('confirmationMessage');
            if (feedbackGenerat && !feedbackGenerat.error && !feedbackGenerat.error_parsing && !(typeof feedbackGenerat.empatie_initiala === 'string' && feedbackGenerat.empatie_initiala.startsWith("EROARE:"))) {
                confirmationMessage.textContent = 'Formular trimis și feedback AI generat!';
                confirmationMessage.style.backgroundColor = '#d4edda'; confirmationMessage.style.color = '#155724';
            } else {
                let msg = 'Formular trimis. ';
                if (feedbackGenerat && feedbackGenerat.empatie_initiala) {
                    msg += feedbackGenerat.empatie_initiala; // Afișează eroarea din primul câmp
                } else {
                    msg += 'Problemă la generarea feedback-ului AI.';
                }
                confirmationMessage.textContent = msg;
                confirmationMessage.style.backgroundColor = '#f8d7da'; confirmationMessage.style.color = '#58151c';
            }
            confirmationMessage.style.display = 'block';
            setTimeout(() => { confirmationMessage.style.display = 'none'; }, 9000);

        } catch (error) {
            console.error("Eroare majoră în salveazaRaspunsSiGenereazaFeedback:", error);
            alert("Eroare la salvare. Încercați din nou.");
        } finally {
            addButton.textContent = originalAddButtonText; addButton.disabled = false;
        }
    }

    function afiseazaIstoricFeedback(containerElement, feedbackHistory) {
        containerElement.innerHTML = ''; 

        if (feedbackHistory && Array.isArray(feedbackHistory) && feedbackHistory.length > 0) {
            const historyTitle = document.createElement("h4");
            // ... stiluri pentru historyTitle ...
            historyTitle.style.color = "#4A90E2"; historyTitle.style.marginTop = "20px"; historyTitle.style.marginBottom = "10px";
            historyTitle.textContent = "🗂️ Istoric Feedback AI:";
            containerElement.appendChild(historyTitle);

            feedbackHistory.slice().reverse().forEach(entry => { 
                if (!entry || typeof entry !== 'object') { // Verificare suplimentară
                    console.warn("Intrare invalidă în istoricul de feedback:", entry);
                    return; 
                }
                const itemContainer = document.createElement("div");
                itemContainer.className = "feedback-entry-card";

                const timestampAndModel = document.createElement("p");
                timestampAndModel.className = "feedback-timestamp";
                timestampAndModel.innerHTML = `<strong>${new Date(entry.timestamp || Date.now()).toLocaleString("ro-RO")}</strong> (Model: ${entry.model || 'N/A'})`;
                itemContainer.appendChild(timestampAndModel);

                // Definește structura NOUĂ de afișare, corespunzătoare NOUILOR chei parsate
                const newSections = [
                    { title: "💬 Empatie Inițială", key: "empatie_initiala", isList: false },
                    { title: "🌟 Puncte Forte Observate", key: "puncte_forte", isList: false },
                    { title: "🔄 Tipare Principale", key: "tipare_principale", isList: false },
                    { title: "🔗 Conexiuni Cheie (S-G-E-C-N)", key: "conexiuni_cheie", isList: false },
                    { title: "🔍 Distorsiuni Identificate", key: "distorsiuni_identificate", isList: true, complexList: true }, // complexList pentru parsare mai detaliată dacă e cazul
                    { title: "🧠 Scheme Activate", key: "scheme_activate", isList: true },
                    { title: "🎭 Moduri Implicate", key: "moduri_implicate", isList: false }, // Poate fi și listă dacă AI-ul dă mai multe
                    { title: "💪 Perspectiva Adultului Sănătos", key: "perspectiva_adult_sanatos", isList: false },
                    { title: "❓ Întrebare Finală de Reflecție", key: "intrebare_finala_reflectie", isList: false },
                    { title: "👟 Sugestie Mic Pas Următor", key: "sugestie_mic_pas", isList: false },
                    { title: "💖 Încurajare Finală", key: "incurajare_finala", isList: false }
                ];

                newSections.forEach(sectionConfig => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "feedback-section";

                    const sectionTitleElement = document.createElement("h5");
                    sectionTitleElement.textContent = sectionConfig.title + ":";
                    sectionDiv.appendChild(sectionTitleElement);

                    let contentText = entry[`feedback_${sectionConfig.key}`] || entry[sectionConfig.key]; // Preferă câmpurile `feedback_` de la rădăcină dacă există

                    if (contentText && typeof contentText === 'string') {
                        // Eliminare prefix redundant din textul conținutului (dacă AI-ul l-a inclus)
                        const titleWithoutEmoji = sectionConfig.title.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic}|💬|🌟|🔄|🔗|🔍|🧠|🎭|💪|❓|👟|💖)\s*/gu, '').trim();
                        const patternTitleText = new RegExp(`^${titleWithoutEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im");
                        contentText = contentText.replace(patternTitleText, "").trim();
                        
                        if (sectionConfig.isList && contentText.includes('*')) {
                            const listElement = document.createElement("ul");
                            const items = contentText.split(/\s*\n?\s*\*\s+/) // Split mai robust la '*' urmat de spațiu, pe linie nouă sau nu
                                              .map(item => item.trim().replace(/^\s*-\s*/, '')) 
                                              .filter(item => item.length > 0);
                            if (items.length === 0 && contentText.startsWith("*")) { // Cazul cu un singur item *
                                items.push(contentText.substring(1).trim().replace(/^\s*-\s*/, ''));
                            }
                            
                            items.forEach(itemText => {
                                const listItem = document.createElement("li");
                                // Dacă este `complexList` pentru Distorsiuni, fiecare item ar putea avea substructură
                                // Momentan, doar afișăm textul itemului.
                                listItem.innerHTML = itemText.replace(/\n/g, '<br>');
                                listElement.appendChild(listItem);
                            });
                            sectionDiv.appendChild(listElement);
                        } else {
                            const paragraphElement = document.createElement("p");
                            paragraphElement.innerHTML = contentText.replace(/\n/g, '<br>') || '<i>Indisponibil</i>';
                            sectionDiv.appendChild(paragraphElement);
                        }
                    } else if (typeof contentText === 'string' && contentText === "") {
                        // Afișează un mesaj specific dacă textul este gol, dar nu "Indisponibil"
                        const emptyTextP = document.createElement("p");
                        emptyTextP.style.fontStyle = "italic";
                        emptyTextP.textContent = "(Secțiune goală sau necompletată de AI)";
                        sectionDiv.appendChild(emptyTextP);
                    }
                    else {
                        const unavailableText = document.createElement("p");
                        unavailableText.style.fontStyle = "italic";
                        unavailableText.textContent = "Indisponibil sau format necunoscut";
                        sectionDiv.appendChild(unavailableText);
                    }
                    itemContainer.appendChild(sectionDiv);
                });
                containerElement.appendChild(itemContainer);
            });
        }
    }

   function adaugaCard(rowData) { /* ... Adaptat pentru noile chei de feedback dacă e necesar la afișarea primară a feedback-ului, deși afiseazaIstoricFeedback face treaba principală ... */ 
        const cardViewContainer = document.getElementById("cardViewContainer");
        let card = cardViewContainer.querySelector(`.response-card[data-id="${rowData.id}"]`);

        if (card) {
            console.log("Cardul există, se actualizează istoricul AI:", rowData.id);
            afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);
            return;
        }

        card = document.createElement("div");
        card.className = "response-card";
        card.setAttribute("data-id", rowData.id);
        // ... (restul conținutului cardului cu datele utilizatorului rămâne la fel) ...
          card.innerHTML = `
        <div class="card-header"> Data: ${rowData.date || ''} - Situația: ${(rowData.situatie || '').substring(0,60)}...</div>
        <div class="card-content">
          <h4>Explorarea situației și a nevoilor</h4>
          <p><strong>Care este situația?</strong> ${rowData.situatie || ''}</p>
          <p><strong>Ce îmi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
          <p><strong>Cum mă face acel gând să mă simt?</strong> ${rowData.emotii || ''}</p>
          <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
          <p><strong>Ce comportament simți că adopți?</strong> ${rowData.comportament || ''}</p>
          <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
          <p><strong>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
          <p><strong>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</strong> ${rowData.adult_sanatos || ''}</p>

          <h4>Analiza gândurilor și a percepțiilor</h4>
          <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
          <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
          <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
          <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
          <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
          <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
          <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
          <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>

          <h4>Întrebări pentru claritate și reflecție suplimentară</h4>
          <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
          <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
          <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
          <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
          <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
          <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
          <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
          <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
          <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
          <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
          <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
          
          <div class="card-actions">
              <button class="generate-ai-feedback-button">Regenerează Feedback AI</button>
              <button class="delete-button">Șterge Înregistrarea</button>
          </div>
          <div class="ai-feedback-history-container">
          </div>
        </div>
      `;

        card.querySelector('.card-header').addEventListener('click', () => card.classList.toggle('open'));
        card.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); stergeCard(rowData.id, card); });

        const regenButton = card.querySelector('.generate-ai-feedback-button');
        if (regenButton) {
            regenButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                const button = e.target; 
                const originalText = button.textContent;
                button.textContent = 'Se generează...'; button.disabled = true;
                try {
                    const currentDoc = await getDoc(doc(db, "raspunsuri", rowData.id));
                    if (currentDoc.exists()) {
                        await genereazaSiProceseazaFeedbackAI({id: currentDoc.id, ...currentDoc.data()}, currentDoc.id);
                        const updatedDoc = await getDoc(doc(db, "raspunsuri", currentDoc.id)); // Recitește pentru a obține cel mai nou istoric
                        if (updatedDoc.exists()) {
                            afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedback_history);
                        }
                    }
                } catch (err) { console.error("Eroare regenerare AI:", err); alert("Eroare regenerare feedback."); }
                finally { button.textContent = originalText; button.disabled = false; }
            });
        }
        afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);
        if (cardViewContainer.firstChild) cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
        else cardViewContainer.appendChild(card);
   }


    async function loadTableData(userId, collabIdForLoad = null, ownerIdForCollabView = null) { /* ... la fel, asigură filtrarea pe ownerUid ... */
         if (!userId && !ownerIdForCollabView) {
            console.warn("loadTableData apelat fără userId sau ownerIdForCollabView.");
            return;
        }
        if (collabIdForLoad && dataAlreadyLoaded) { console.log("Colaborare deja încărcată."); return; }
        
        console.log("Încărcare carduri Firestore...");
        const cardViewContainer = document.getElementById("cardViewContainer");
        cardViewContainer.innerHTML = '';

        try {
            let q;
            if (ownerIdForCollabView) {
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", ownerIdForCollabView));
            } else {
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", userId));
            }

            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; font-style:italic;">Nicio fișă găsită.</p>';
                if(collabIdForLoad) dataAlreadyLoaded = true;
                return;
            }
            
            const documents = [];
            querySnapshot.forEach((doc) => documents.push({ id: doc.id, ...doc.data() }));
            documents.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0) ); // Sortează după timestamp complet
            
            documents.forEach(docData => adaugaCard(docData));
            if (collabIdForLoad) dataAlreadyLoaded = true; 
        } catch (error) {
            console.error("Eroare loadTableData:", error.message, error.stack);
            cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; color:red;">Eroare încărcare date.</p>';
        }
    }
    async function populateTableData(userId) { /* ... la fel, asigură filtrarea ... */ 
        console.log("populateTableData (tabel) rulează pentru:", userId, "Consideră eliminarea dacă nu se folosește tabelul.");
    }
    window.toggleDetails = function(id) { /* ... la fel ... */ 
         const detailRow = document.getElementById(`details-${id}`);
        if (detailRow) {
            detailRow.style.display = detailRow.style.display === "none" ? "table-row" : "none";
        }
    }
    async function stergeCard(id, cardElement) { /* ... la fel ... */ 
        if (confirm("Sigur ștergi această înregistrare? Ireversibil!")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                cardElement.remove();
                console.log(`Înregistrare ${id} ștearsă.`);
            } catch (error) { console.error("Eroare ștergere:", error); alert("Eroare ștergere.");}
        }
    }
    async function generateCollaborationLink() { /* ... la fel ... */
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesară."); return; }
        const q = query(collection(db, "collaborations"), where("owner", "==", user.uid));
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            const collabDoc = snapshot.docs[0];
            prompt(`Link existent (PIN: ${collabDoc.data().pin}):`, `${location.origin}${location.pathname}?collabId=${collabDoc.id} (PIN: ${collabDoc.data().pin})`);
            return;
        }
        const pin = prompt("PIN numeric (minim 4 cifre) pentru link colaborare:");
        if (!pin || !/^\d{4,}$/.test(pin)) { alert("PIN invalid."); return; }
        try {
            const ref = await addDoc(collection(db, "collaborations"), { owner: user.uid, pin, createdAt: new Date() });
            prompt(`Link generat! Distribuie cu PIN:\nLink: ${location.origin}${location.pathname}?collabId=${ref.id}\nPIN: ${pin}`, `Link: ${location.origin}${location.pathname}?collabId=${ref.id} (PIN: ${pin})`);
        } catch (e) { console.error("Eroare generare link:", e); alert("Eroare generare link."); }
    }

    window.addEventListener('DOMContentLoaded', async () => { /* ... la fel, asigură filtrarea pt collabData.owner ... */
        console.log("DOMContentLoaded - verifică colaborare");
        const params = new URLSearchParams(location.search);
        const collabId = params.get('collabId');
        if (collabId) {
            dataAlreadyLoaded = false; 
            document.body.classList.add("collab-view");
            ['exercitiuForm', 'generateLinkButton', '.form-container', '.table-container'].forEach(s => {
                const el = document.querySelector(s) || document.getElementById(s);
                if (el) el.style.display = 'none';
            });
            const pin = prompt("PIN colaborare:");
            if (!pin) { alert("PIN necesar."); location.href = "login.html"; return; }
            try {
                const collabRef = doc(db, "collaborations", collabId);
                const collabSnap = await getDoc(collabRef);
                if (collabSnap.exists()) {
                    const collabData = collabSnap.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect, încarc date pentru owner:", collabData.owner);
                        document.title = "Vizualizare Fișă Colaborare";
                        const mainH = document.querySelector('.form-container h2');
                        if(mainH) mainH.textContent = "Fișă Colaborare (Citire)";
                        else { // Adaugă un titlu dacă nu există cel din form-container
                            const pageTitle = document.createElement('h2');
                            pageTitle.textContent = "Vizualizare Fișă Colaborare";
                            pageTitle.style.textAlign = 'center';
                            document.body.insertBefore(pageTitle, document.querySelector('.card-view'));
                        }
                        loadTableData(null, collabId, collabData.owner); 
                    } else { alert("PIN incorect."); location.href = "login.html"; }
                } else { alert("Colaborare invalidă."); location.href = "login.html"; }
            } catch (e) { console.error("Eroare colaborare:", e); alert("Eroare accesare colaborare."); location.href = "login.html"; }
        }
    });
    </script>
    <style>
        /* ... TOATE STILURILE TALE CSS COMPLETE AICI ... */
        body {font-family: 'Roboto', 'Montserrat', sans-serif; margin: 0; padding: 20px; background: linear-gradient(to right, #ece9e6, #ffffff); color: #333; box-sizing: border-box;}
        .form-container {max-width: 900px; margin: 20px auto; background: #fff; padding: 30px; box-shadow: 0 16px 24px rgba(0,0,0,0.2); border-radius: 15px; border: 3px solid #87CEFA; transition: transform 0.3s ease;}
        .form-container:hover {transform: scale(1.01);}
        .progress-bar {width: 100%; background-color: #f3f3f3; border-radius: 25px; overflow: hidden; margin-bottom: 20px;}
        .progress {height: 20px; width: 0; background-color: #87CEFA; transition: width 0.4s ease;}
        .question-card {margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s;}
        .question-card:hover {box-shadow: 0 6px 15px rgba(0,0,0,0.15);}
        .question-card h3 {font-weight: 700; font-size: 1.2em; margin-top: 0; margin-bottom: 10px;}
        .question-card p {font-weight: 300; font-size: 0.95em; margin-bottom: 15px; color: #555; line-height: 1.6;}
        textarea {width: calc(100% - 22px); padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; resize: vertical; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: border-color 0.3s;}
        textarea:focus {border-color: #87CEFA; box-shadow: 0 2px 8px rgba(135,206,250,0.5); outline: none;}
        input[type="submit"], button {margin-top: 20px; padding: 12px 25px; font-size: 18px; font-weight: 500; background: linear-gradient(to right, #87CEFA, #6bb9e7); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.2s;}
        input[type="submit"]:hover, button:hover {background: linear-gradient(to right, #6bb9e7, #4A90E2); transform: translateY(-2px);}
        .form-step {display: none;}
        .form-step-active {display: block; animation: fadeIn 0.7s ease-in-out;}
        @keyframes fadeIn { 0% {opacity: 0; transform: translateY(10px);} 100% {opacity: 1; transform: translateY(0);} }
        .step-navigation {text-align: center; margin-top: 20px;}
        .step-navigation button {margin: 0 10px;}
        .table-container {margin:30px auto; padding:20px; background:#fff; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); overflow-x:auto; max-width:900px;}
        .card-view {display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 30px auto;}
        .response-card {background: #f9f9ff; padding: 0; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); transition: box-shadow 0.3s ease; position: relative; overflow: hidden;}
        .response-card:hover {box-shadow: 0 10px 20px rgba(0,0,0,0.18);}
        .response-card .card-header {font-weight: 700; font-size: 1.1em; cursor: pointer; background: #87CEFA; padding: 12px 20px; color: #fff; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center;}
        .response-card .card-header::after {content: '▼'; font-size: 0.8em; transition: transform 0.3s ease;}
        .response-card.open .card-header::after {transform: rotate(180deg);}
        .response-card .card-content {max-height: 0; margin-top: 0; padding: 0 20px; background: #fff; line-height: 1.6; overflow: auto; transition: max-height 0.5s ease-out, padding-top 0.5s ease-out, padding-bottom 0.5s ease-out;}
        .response-card.open .card-content {max-height: 3000px; /* Mărit și mai mult */ padding-top: 15px; padding-bottom: 15px;}
        .response-card .card-content p {margin-bottom: 12px; border-left: 3px solid #87CEFA; padding-left: 10px;}
        .response-card .card-content p strong {color: #333;}
        .response-card h4 {text-align: left; color: #4A90E2; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 1.05em;}
        .response-card h4:first-child {margin-top: 0;}
        .card-actions {text-align: center; margin-top: 20px; padding-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .card-actions button {padding: 8px 15px; font-size: 0.9em; margin: 5px;}
        .generate-ai-feedback-button {background: #5cb85c;}
        .generate-ai-feedback-button:hover {background: #4cae4c;}
        .delete-button {background-color: #f44336 !important;}
        .delete-button:hover {background-color: #d32f2f !important;}
        #confirmationMessage {display:none; text-align:center; padding:15px; background-color:#d4edda; color:#155724; border:1px solid #c3e6cb; border-radius:5px; margin-top:20px; animation:fadeIn 0.5s;}
        .collaboration-section {text-align:center; margin-top:30px; padding-bottom:20px;}
        .collaboration-section button {background-color:#f0ad4e;}
        .collaboration-section button:hover {background-color:#ec971f;}
        .feedback-entry-card {background:#eef6ff; padding:15px; border-left:4px solid #4A90E2; border-radius:5px; margin-bottom:15px; font-size:0.95em; line-height:1.6;}
        .feedback-timestamp {color:#555; font-size:0.9em; margin-bottom:12px;}
        .feedback-section {margin-bottom:12px;}
        .feedback-section h5 {font-size:1em; font-weight:bold; color:#2c5282; margin-top:0; margin-bottom:6px;}
        .feedback-section p, .feedback-section ul {margin-top:0; margin-bottom:8px; color:#1e293b;}
        .feedback-section ul {padding-left:25px; list-style-position:outside; list-style-type:disc;}
        .feedback-section li {margin-bottom:4px;}

        /* Responsive - Adaugă aici toate regulile @media din versiunea ta anterioară funcțională */
         @media (max-width: 768px) {
            body {padding:10px;}
            .form-container, .table-container, .card-view {padding:15px; margin-left:10px; margin-right:10px; max-width:calc(100% - 20px);}
            textarea {font-size:14px; padding:8px; width:calc(100% - 18px);}
            .form-container > button, .step-navigation button {font-size:16px; padding:10px 20px;}
            .card-actions button {font-size:0.85em; padding:7px 12px;}
            .question-card h3, .response-card .card-header {font-size:1.05em;}
            .question-card p, .response-card .card-content p {font-size:0.9em;}
            .table-container {overflow-x:auto;}
            table {display:block; width:100%;} thead, tbody, tr {display:block;}
            th {display:none;}
            tr {margin-bottom:15px; border:1px solid #ddd; border-radius:5px; display:flex; flex-direction:column;}
            td {display:flex; justify-content:space-between; padding:10px; text-align:right; border-bottom:1px solid #eee; position:relative;}
            td:last-child {border-bottom:none;}
            td::before {content:attr(data-label); font-weight:bold; text-align:left; margin-right:10px; color:#555; flex-shrink:0; width:auto; padding-right: 10px;}
            td > *:not(button) {flex-grow:1; word-break:break-word; text-align:left;}
            td button {width:auto; padding:6px 12px; font-size:0.85em; margin-left:auto; flex-shrink:0;}
            td[colspan="10"] {display:block;}
        }
        @media (max-width: 480px) {
            .form-container, .table-container, .card-view {padding:10px; margin-left:5px; margin-right:5px; max-width:calc(100% - 10px);}
            .question-card h3, .response-card .card-header {font-size:1em;}
            .question-card p, .response-card .card-content p {font-size:0.85em;}
            textarea {font-size:13px; padding:6px; width:calc(100% - 14px);}
            .form-container > button, .step-navigation button {font-size:14px; padding:8px 15px;}
            .card-actions button {font-size:0.8em; padding:6px 10px;}
            .response-card .card-header {padding:10px;}
            .response-card .card-content {padding-left:15px; padding-right:15px; font-size:0.85em;}
            td {flex-direction:column; align-items:flex-start;}
            td::before {width:100%; margin-bottom:5px; margin-right: 0;}
            td button {align-self:flex-end;}
        }

    </style>
</head>
<body>

    <div class="form-container">
        <h2>Fișă Monitorizare</h2>
        <p>Completează fiecare întrebare pentru a înțelege mai bine situațiile tale. Fiecare secțiune reprezintă o parte importantă a reflecției tale. În acest exercițiu, îți voi ghida fiecare pas, astfel încât să poți explora în profunzime gândurile, emoțiile și comportamentele tale.</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm" novalidate>
            <!-- PASUL 1 -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situația?</h3>
                <p>Te rog să descrii contextul care a declanșat emoțiile sau comportamentul tău. Încearcă să fii cât mai specific și detaliat. Aceasta poate fi o situație concretă din viața de zi cu zi în care te-ai simțit copleșit, stresat sau într-o altă stare emoțională intensă.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce îmi trece prin minte?</h3>
                <p>Îți cer să identifici gândurile automate care au apărut în această situație. Acestea sunt gânduri rapide, involuntare, care îți trec prin minte în momentele de stres. Ce îți spui în acel moment? Este un gând critic sau îngrijorător?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mă face acel gând să mă simt?</h3>
                <p>Te rog să notezi emoțiile pe care le simți în urma acelui gând. Ce simți? Frică, tristețe, furie? Dă o intensitate emoției (de la 0 la 100) pentru a vedea cât de puternică este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>Identifică modul în care te afli în această situație. Este un mod de copil vulnerabil, critic interior, sau poate adultul sănătos? Conștientizarea modului îți poate oferi o mai bună înțelegere a reacțiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simți că adopți?</h3>
                <p>Descrie comportamentul pe care îl manifești în această situație. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoașterea comportamentului te ajută să înțelegi mai bine cum reacționezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoții și comportamente? Poate fi nevoia de siguranță, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta să găsești strategii mai sănătoase pentru a le îndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</h3>
                <p>Reflectează dacă felul în care reacționezi te ajută cu adevărat să îți îndeplinești nevoile. Poate fi util să te gândești dacă există alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</h3>
                <p>Gândește-te la cum ar reacționa partea ta Adultă Sănătoasă în această situație. Cum ai putea să abordezi diferit pentru a avea grijă de tine și de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- PASUL 2 -->
            <div class="question-card form-step" id="step-9">
                <h3>Ce mă face să cred că gândul automat este adevărat?</h3>
                <p>Explorează motivele pentru care crezi că acest gând este adevărat. Ce dovezi ai care îți confirmă acest lucru? De multe ori, ne bazăm pe experiențe trecute sau frici pentru a justifica un gând.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mă face să cred că nu este adevărat?</h3>
                <p>Acum, să ne uităm la dovezile împotriva gândului tău. Există argumente sau experiențe care contrazic acest gând? Poate există o altă perspectivă pe care nu ai luat-o în considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>Există o explicație alternativă?</h3>
                <p>Uneori, există mai multe explicații pentru ceea ce se întâmplă. Ce alte interpretări ai putea avea pentru această situație? Gândește-te la alte posibilități care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rău lucru care s-ar putea întâmpla?</h3>
                <p>Ce este cel mai rău care ar putea avea loc în această situație? Să identificăm acele frici catastrofale care adesea ne alimentează gândurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea întâmpla?</h3>
                <p>Pe de altă parte, care ar fi cel mai pozitiv scenariu? Uneori uităm să ne gândim și la posibilitățile bune. Cum ar arăta cel mai bun rezultat al acestei situații?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>După ce am explorat extremele, ce crezi că este cel mai probabil să se întâmple? Cum ar arăta un rezultat realist, ținând cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</h3>
                <p>Întreabă-te cum ar fi dacă ai aborda situația cu un alt tip de gândire. Cum ar influența asta emoțiile și comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</h3>
                <p>Gândește-te la cum ai reacționa dacă un prieten drag ar avea aceleași gânduri. Ce i-ai spune pentru a-l sprijini? Cum ai încerca să-l încurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- PASUL 3 -->
            <div class="question-card form-step" id="step-17">
                <h3>Văd doar partea rea a lucrurilor?</h3>
                <p>Este posibil să fii prins într-un tipar negativ de gândire, concentrându-te doar pe aspectele negative. Încearcă să observi dacă există și aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-18">
                <h3>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</h3>
                <p>Reflectează dacă îți asumi responsabilitatea pentru situații asupra cărora nu aveai control. Este important să îți dai seama de limitele influenței tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>Mă condamn în baza unui singur eveniment?</h3>
                <p>Îți evaluezi valoarea personală bazându-te pe un singur eveniment negativ? Amintește-ți că un eveniment nu definește cine ești în totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situația în termeni extremi?</h3>
                <p>Verifică dacă vezi situația doar în alb sau negru, fără nuanțe de gri. Gândirea extremă poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situația?</h3>
                <p>Îți amplifici reacțiile față de o situație? Încearcă să te gândești dacă ceea ce percepi este realist sau dacă exagerezi impactul situației.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>Există și alți factori responsabili?</h3>
                <p>Există alți factori care contribuie la această situație, pe lângă tine? Este important să ai o perspectivă completă asupra cauzelor unei situații.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sărit direct la concluzii?</h3>
                <p>Te-ai grăbit să ajungi la o concluzie fără suficiente dovezi? Încearcă să observi dacă există alte posibilități care ar putea explica situația.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-24">
                <h3>Îmi pun întrebări fără răspuns?</h3>
                <p>Te frământă întrebări care nu au un răspuns clar sau realist? Aceste întrebări pot fi o sursă majoră de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>Mă concentrez doar asupra slăbiciunilor mele?</h3>
                <p>Ai tendința să te focalizezi doar pe slăbiciuni și să ignori punctele tale forte? Încearcă să îți recunoști și punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</h3>
                <p>Ai tendința să te gândești mereu la cum ar trebui să fie lucrurile, în loc să accepți situația așa cum este? Acceptarea poate reduce stresul și anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-27">
                <h3>Mă aștept să fiu perfect?</h3>
                <p>Îți setezi standarde foarte înalte, imposibil de atins? Perfecționismul poate fi o sursă majoră de frustrare și descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-28">
                <h3>Completare finalizată!</h3>
                <p>Felicitări pentru parcurgerea acestui exercițiu de auto-reflecție! Apasă butonul de mai jos pentru a salva datele și a genera un feedback automatizat, dacă este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta să obții noi perspective. Dacă întâmpini probleme cu generarea (ex: erori de limită de utilizare), poți încerca din nou mai târziu.</p>
            </div>

            <div class="step-navigation">
                <button type="button" id="prevButton">Înapoi</button>
                <button type="button" id="nextButton">Înainte</button>
            </div>
            <button type="button" id="addButton">Salvează și Generează Feedback AI</button>
        </form>

        <div id="confirmationMessage">
            <!-- Mesajul va fi setat de JavaScript -->
        </div>

        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">Generează Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">Răspunsurile Tale și Istoricul Feedback-ului AI:</h3>
    
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile cu răspunsuri și feedback AI vor fi adăugate aici de JavaScript -->
    </div>
    
    <div class="table-container" style="display: none;"> <!-- Ascuns implicit -->
        <table>
            <thead>
                <tr>
                    <th>Data</th><th>Situația</th><th>Gânduri</th><th>Emoții</th><th>Mod activ</th>
                    <th>Comportament</th><th>Nevoile</th><th>Ajutor comport.</th><th>Adult Sănătos</th><th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <br/>
</body>
</html>