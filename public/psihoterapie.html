<!DOCTYPE html>
<html>
<head>
    <title>Fișă Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // Configurarea Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98", // Înlocuiește cu cheia ta reală dacă e diferită
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    // Inițializare Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

  // --- Configurare Gemini API ---
const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng"; // ACEASTA ESTE CHEIA TA REALĂ
const GEMINI_MODEL_NAME = "gemini-2.5-flash-preview-04-17";
let genAI, geminiModel;

// Condiție simplificată: verifică doar dacă GEMINI_API_KEY are o valoare.
if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
    try {
        genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        geminiModel = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });
        console.log("SDK Gemini inițializat cu succes. Model:", GEMINI_MODEL_NAME);
    } catch (e) {
        console.error("Eroare la inițializarea SDK Gemini. Verifică validitatea cheii API și conexiunea la internet.", e);
        geminiModel = null; // Setează la null dacă inițializarea eșuează
    }
} else {
    // Acest mesaj se va afișa doar dacă GEMINI_API_KEY este un string gol sau nu e definită.
    console.warn("Cheia API pentru Gemini (GEMINI_API_KEY) este goală sau nedefinită. Feedback-ul AI prin Gemini va fi dezactivat.");
    geminiModel = null;
}


    let currentStep = 1;
    let totalSteps = 0;
    let dataAlreadyLoaded = false; // Pentru a controla încărcarea inițială a datelor

    window.onload = function () {
        totalSteps = document.querySelectorAll('.form-step').length;
        updateProgressBar();
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (!collabId) { // Doar pentru utilizatorul normal, nu pentru colaborator
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utilizator autentificat:", user.uid);
                    if (!dataAlreadyLoaded) {
                        // TREBUIE SĂ FILTREZI DATELE AICI PENTRU `user.uid`
                        populateTableData(user.uid); // Asigură-te că această funcție filtrează pe userId
                        loadTableData(user.uid);     // Asigură-te că această funcție filtrează pe userId
                        dataAlreadyLoaded = true;
                    }
                } else {
                    console.log("Utilizator neautentificat, redirecționare...");
                    window.location.href = "login.html";
                }
            });
        }
        // Logica pentru collabId este în DOMContentLoaded

        const nextButton = document.getElementById("nextButton");
        if (nextButton) nextButton.addEventListener("click", nextStep);

        const prevButton = document.getElementById("prevButton");
        if (prevButton) prevButton.addEventListener("click", previousStep);

        const addButton = document.getElementById("addButton");
        if (addButton) addButton.addEventListener("click", salveazaRaspunsSiGenereazaFeedback); // Nume schimbat

        const generateLinkButton = document.getElementById("generateLinkButton");
        if (generateLinkButton) generateLinkButton.addEventListener("click", generateCollaborationLink);
    };

    function nextStep() {
        if (currentStep < totalSteps) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function updateProgressBar() {
        const progress = document.getElementById('progress');
        if(progress && totalSteps > 0) {
            const progressPercentage = (currentStep / totalSteps) * 100;
            progress.style.width = progressPercentage + '%';
        }
    }

    async function genereazaFeedbackCuGeminiDinFrontend(promptText) {
        if (!geminiModel) {
            console.error("Modelul Gemini nu este inițializat. Verifică cheia API.");
            return "EROARE: Configurare Gemini incorectă. Verifică dacă ai introdus corect cheia API în cod.";
        }
        try {
            console.log("Trimitere prompt către Gemini (primele 100 caractere):", promptText.substring(0, 100) + "...");
            const result = await geminiModel.generateContent(promptText);
            const response = result.response;
            if (!response || typeof response.text !== 'function') {
                 console.error("Răspuns neașteptat de la Gemini (nu conține text()):", response);
                 return `EROARE Gemini: Răspuns invalid de la API.`;
            }
            const text = response.text();
            return text;
        } catch (error) {
            console.error("Eroare detaliată la generarea feedback-ului Gemini:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare necunoscută la API"}`;
             if (error.toString().toLowerCase().includes("api key not valid") || (error.message && error.message.toLowerCase().includes("permission denied")) || (error.message && error.message.toLowerCase().includes("api_key_invalid")) ) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validă sau nu are permisiuni. Verifică restricțiile din Google Cloud Console (HTTP Referrers, API Restrictions pentru Generative Language API) și cheia din cod. Asigură-te că domeniul " + window.location.hostname + " este permis.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare gratuită Gemini (RPM sau alta) a fost depășită. Încearcă mai târziu.";
            } else if (error.message && error.message.toLowerCase().includes("candidate.finish_reason")){ // Include și alte finish reasons
                errorMessage = "EROARE Gemini: Generarea a fost oprită (posibil din motive de siguranță, conținut, sau alte restricții ale modelului). Încearcă un prompt diferit.";
            }  else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 errorMessage = `EROARE Gemini: Modelul ${GEMINI_MODEL_NAME} nu a fost găsit sau nu este suportat. Verifică numele modelului.`;
            }
            return errorMessage;
        }
    }

    async function genereazaSiProceseazaFeedbackAI(rowData, docId) {
      const prompt = `
Analizează în profunzime această fișă completă de auto-reflecție. Utilizatorul a parcurs un exercițiu detaliat pentru a-și înțelege o situație specifică. Oferă feedback psihologic structurat, empatic și acționabil. Respectă cu strictețe formatul și ordinea secțiunilor de mai jos, folosind exact prefixele indicate.

**Datele Complete din Fișa de Reflecție a Utilizatorului:**

**Secțiunea 1: Explorarea Situației și a Nevoilor**
*   Care este situația?: ${rowData.situatie || 'N/A'}
*   Ce îmi trece prin minte (gânduri automate)?: ${rowData.ganduri || 'N/A'}
*   Cum mă face acel gând să mă simt (emoții)?: ${rowData.emotii || 'N/A'}
*   Ce mod este activ?: ${rowData.mod_activ || 'N/A'}
*   Ce comportament simți că adopți?: ${rowData.comportament || 'N/A'}
*   Care sunt nevoile tale mai profunde?: ${rowData.nevoi_profunde || 'N/A'}
*   Mă ajută comportamentul meu să îndeplinesc aceste nevoi?: ${rowData.ajutor_comportament || 'N/A'}
*   Cum ar gândi și cum s-ar comporta Adultul Sănătos (perspectiva utilizatorului)?: ${rowData.adult_sanatos || 'N/A'}

**Secțiunea 2: Analiza Gândurilor și a Percepțiilor**
*   Ce mă face să cred că gândul automat este adevărat?: ${rowData.dovezi_adevar || 'N/A'}
*   Ce mă face să cred că nu este adevărat?: ${rowData.dovezi_fals || 'N/A'}
*   Există o explicație alternativă?: ${rowData.explicatie_alternativa || 'N/A'}
*   Care este cel mai rău lucru care s-ar putea întâmpla?: ${rowData.scenariu_negativ || 'N/A'}
*   Care este cel mai bun lucru care s-ar putea întâmpla?: ${rowData.scenariu_optimist || 'N/A'}
*   Care este cel mai realist rezultat?: ${rowData.rezultat_realist || 'N/A'}
*   Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?: ${rowData.schimbare_gandire || 'N/A'}
*   Ce i-aș spune unui prieten dacă ar fi în aceeași situație?: ${rowData.sfat_prieten || 'N/A'}

**Secțiunea 3: Întrebări pentru Claritate și Reflecție Suplimentară**
*   Văd doar partea rea a lucrurilor?: ${rowData.partea_rea || 'N/A'}
*   Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?: ${rowData.responsabilitate || 'N/A'}
*   Mă condamn în baza unui singur eveniment?: ${rowData.condamnare || 'N/A'}
*   Privesc situația în termeni extremi (alb/negru)?: ${rowData.termeni_extremi || 'N/A'}
*   Exagerez situația?: ${rowData.exagerare || 'N/A'}
*   Există și alți factori responsabili?: ${rowData.factori_responsabili || 'N/A'}
*   Am sărit direct la concluzii?: ${rowData.concluzii || 'N/A'}
*   Îmi pun întrebări fără răspuns?: ${rowData.intrebari_fara_raspuns || 'N/A'}
*   Mă concentrez doar asupra slăbiciunilor mele?: ${rowData.slabiciuni || 'N/A'}
*   Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?: ${rowData.cum_ar_trebui || 'N/A'}
*   Mă aștept să fiu perfect?: ${rowData.perfectiune || 'N/A'}

**CERINȚE PENTRU FEEDBACK-UL AI (folosește prefixele EXACT așa cum sunt scrise):**

Feedback General:
EmpatieInițială: (1-2 propoziții empatice scurte, recunoscând efortul utilizatorului.)

Analiză Detaliată:
PuncteForteObservate: (Identifică 1-2 aspecte pozitive sau de auto-conștientizare.)
TiparePrincipale: (Descrie succint 1-3 tipare de gândire/emoționale/comportamentale centrale.)

Legătura Gând-Emoție-Comportament-Nevoie:
ConexiuniCheie: (Sintetizează legătura S-G-E-C-N bazată pe '${rowData.ganduri}', '${rowData.emotii}', '${rowData.comportament}', '${rowData.nevoi_profunde}'.)

Analiza Gândurilor Automate și Distorsiuni:
DistorsiuniIdentificate: (Identifică 2-4 distorsiuni principale. Pentru fiecare: Numele, Explicația, Exemplu din răspunsuri, Întrebare de contestare. Listează fiecare ca sub-punct precedat de '* '.)

Scheme și Moduri Cognitive:
SchemeActivate: (Identifică 1-3 scheme. Pentru fiecare: Numele, Cum se manifestă. Listează fiecare ca sub-punct precedat de '* '.)
ModuriImplicate: (Sugerează ce moduri Schema Therapy ar putea fi implicate.)

Rolul Adultului Sănătos:
PerspectivaAdultSănătos: (Comentează răspunsul utilizatorului '${rowData.adult_sanatos}'. Oferă descriere detaliată: interpretare situație, gânduri alternative, gestionare emoții, comportamente adaptative, contracarare scheme.)

Sugestii și Reflecții Finale:
ÎntrebareFinalăReflecție: (O întrebare generală puternică pentru învățare și aplicare viitoare.)
SugestieMicPas: (O sugestie concretă pentru un mic pas următor.)
ÎncurajareFinală: (1-2 propoziții de încurajare.)

Răspunde doar cu textul cerut conform structurii, fără introduceri, concluzii sau formatări suplimentare în afara celor specificate).`;

      let feedbackText = null;
      let modelFolosit = "N/A";

      if (geminiModel) {
        console.log("Solicitare feedback de la Gemini...");
        modelFolosit = `Gemini (${GEMINI_MODEL_NAME})`;
        feedbackText = await genereazaFeedbackCuGeminiDinFrontend(prompt);
      } else {
        console.warn("Gemini nu este configurat. Nu se poate genera feedback AI.");
        return {
            paragraf: "Serviciul de feedback AI (Gemini) nu este configurat corect. Verifică cheia API.",
            intrebare: "", recomandare: "", distorsiuni: "", scheme: "", adult_sanatos_eval: "",
            model: "Configurare Eronată", timestamp: new Date().toISOString()
        };
      }

      if (!feedbackText || (typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
        console.warn(`Eroare de la ${modelFolosit}:`, feedbackText);
        return {
            paragraf: feedbackText || `Nu s-a putut obține feedback de la ${modelFolosit}.`,
            intrebare: "", recomandare: "", distorsiuni: "", scheme: "", adult_sanatos_eval: "",
            model: modelFolosit + " (Eroare API)", timestamp: new Date().toISOString()
        };
      }

      console.log("Răspuns brut de la Gemini:\n---\n" + feedbackText + "\n---");

      const parsedFeedback = {
          paragraf: feedbackText.match(/^Paragraf:\s*([\s\S]*?)(?=\n(?:Întrebare:|Recomandare:|Distorsiuni:|Scheme:|Adult Sănătos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'Paragraf'.",
          intrebare: feedbackText.match(/^Întrebare:\s*([\s\S]*?)(?=\n(?:Recomandare:|Distorsiuni:|Scheme:|Adult Sănătos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'Întrebare'.",
          recomandare: feedbackText.match(/^Recomandare:\s*([\s\S]*?)(?=\n(?:Distorsiuni:|Scheme:|Adult Sănătos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'Recomandare'.",
          distorsiuni: feedbackText.match(/^Distorsiuni:\s*([\s\S]*?)(?=\n(?:Scheme:|Adult Sănătos:|$))/im)?.[1]?.trim() || "Nu s-au putut extrage 'Distorsiuni'.",
          scheme: feedbackText.match(/^Scheme:\s*([\s\S]*?)(?=\n(?:Adult Sănătos:|$))/im)?.[1]?.trim() || "Nu s-au putut extrage 'Scheme'.",
          adult_sanatos_eval: feedbackText.match(/^Adult Sănătos:\s*([\s\S]*?$)/im)?.[1]?.trim() || "Nu s-a putut extrage 'Adult Sănătos'.",
          model: modelFolosit,
          timestamp: new Date().toISOString()
      };
      
      let allParsingFailed = ["paragraf", "intrebare", "recomandare", "distorsiuni", "scheme", "adult_sanatos_eval"]
                             .every(key => parsedFeedback[key]?.startsWith("Nu s-a putut"));
      
      if (allParsingFailed && !(typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
          console.warn("Parsarea detaliată a eșuat pentru toate câmpurile. Formatul răspunsului AI nu corespunde. Răspunsul brut va fi plasat în secțiunea 'Paragraf'.");
          parsedFeedback.paragraf = `Răspuns brut de la ${modelFolosit} (parsare eșuată):\n${feedbackText.replace(/\n/g, "<br>")}`;
          parsedFeedback.intrebare = ""; parsedFeedback.recomandare = ""; parsedFeedback.distorsiuni = ""; parsedFeedback.scheme = ""; parsedFeedback.adult_sanatos_eval = "";
      }

      if (docId) {
          const docRef = doc(db, "raspunsuri", docId);
          try {
              await updateDoc(docRef, {
                  feedback_history: arrayUnion(parsedFeedback),
                  feedback_paragraf: parsedFeedback.paragraf,
                  feedback_intrebare: parsedFeedback.intrebare,
                  feedback_recomandare: parsedFeedback.recomandare,
                  feedback_distorsiuni: parsedFeedback.distorsiuni,
                  feedback_scheme: parsedFeedback.scheme,
                  feedback_adult_eval: parsedFeedback.adult_sanatos_eval,
                  feedback_model: parsedFeedback.model
              });
              console.log(`Feedback AI (${modelFolosit}) salvat pentru docId: ${docId}`);
          } catch (updateError) {
              console.error(`Eroare la actualizarea documentului ${docId} cu feedback AI:`, updateError);
          }
      }
      return parsedFeedback;
    }

    async function salveazaRaspunsSiGenereazaFeedback() {
        const form = document.getElementById("exercitiuForm");
        if (!form.checkValidity()) {
            form.reportValidity();
            // Găsește primul câmp invalid din pasul curent și dă-i focus
            const currentStepElement = document.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid');
            if (firstInvalidField) {
                firstInvalidField.focus();
                 alert("Vă rugăm completați toate câmpurile obligatorii din pasul curent înainte de a continua.");
            } else {
                 alert("Vă rugăm completați toate câmpurile obligatorii.");
            }
            return;
        }

        const formData = new FormData(form);
        const rowData = { date: new Date().toLocaleDateString("ro-RO") };
        formData.forEach((value, key) => { rowData[key] = value; });

        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie să fiți autentificat pentru a salva datele.");
            window.location.href = "login.html";
            return;
        }
        rowData.ownerUid = user.uid;

        const addButton = document.getElementById("addButton");
        const originalAddButtonText = addButton.textContent;
        addButton.textContent = "Se salvează și se generează...";
        addButton.disabled = true;

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), rowData);
            rowData.id = docRef.id;
            console.log(`Răspuns salvat cu ID: ${docRef.id}. Se generează feedback AI automat...`);

            const feedbackGenerat = await genereazaSiProceseazaFeedbackAI(rowData, docRef.id);
            
            const docSnapshot = await getDoc(docRef);
            if (docSnapshot.exists()) {
                adaugaCard({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                rowData.feedback_history = feedbackGenerat ? [feedbackGenerat] : [];
                adaugaCard(rowData);
            }
            
            form.reset();
            currentStep = 1;
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('form-step-active'));
            document.getElementById('step-1').classList.add('form-step-active');
            updateProgressBar();

            const confirmationMessage = document.getElementById('confirmationMessage');
            if (feedbackGenerat && !(typeof feedbackGenerat.paragraf === 'string' && feedbackGenerat.paragraf.startsWith("EROARE:")) && feedbackGenerat.model !== "Configurare Eronată" && feedbackGenerat.model !== "Configurare Gemini Eronată") {
                confirmationMessage.textContent = 'Formularul a fost trimis și feedback-ul AI generat! Îl puteți vedea în cardul de mai jos.';
                confirmationMessage.style.backgroundColor = '#d4edda'; 
                confirmationMessage.style.color = '#155724';
            } else {
                 confirmationMessage.textContent = `Formularul a fost trimis. ${feedbackGenerat ? feedbackGenerat.paragraf : 'A apărut o problemă la generarea feedback-ului AI.'}`;
                 confirmationMessage.style.backgroundColor = (feedbackGenerat && feedbackGenerat.paragraf && feedbackGenerat.paragraf.includes("depășită")) ? '#fff3cd' : '#f8d7da';
                 confirmationMessage.style.color = (feedbackGenerat && feedbackGenerat.paragraf && feedbackGenerat.paragraf.includes("depășită")) ? '#664d03' : '#58151c';
            }
            confirmationMessage.style.display = 'block';
            setTimeout(() => {
                confirmationMessage.style.display = 'none';
                confirmationMessage.style.backgroundColor = '#d4edda';
                confirmationMessage.style.color = '#155724';
            }, 9000);

        } catch (error) {
            console.error("Eroare la salvarea în Firestore sau generarea feedback-ului AI:", error);
            alert("A apărut o eroare la salvare. Vă rugăm încercați din nou.");
        } finally {
            addButton.textContent = originalAddButtonText;
            addButton.disabled = false;
        }
    }

    function afiseazaIstoricFeedback(containerElement, feedbackHistory) {
        containerElement.innerHTML = ''; 

        if (feedbackHistory && Array.isArray(feedbackHistory) && feedbackHistory.length > 0) {
            const historyTitle = document.createElement("h4");
            historyTitle.style.color = "#4A90E2";
            historyTitle.style.marginTop = "20px";
            historyTitle.style.marginBottom = "10px";
            historyTitle.textContent = "🗂️ Istoric Feedback AI:";
            containerElement.appendChild(historyTitle);

            feedbackHistory.slice().reverse().forEach(entry => { 
                const itemContainer = document.createElement("div");
                itemContainer.className = "feedback-entry-card";

                const timestampAndModel = document.createElement("p");
                timestampAndModel.className = "feedback-timestamp";
                timestampAndModel.innerHTML = `<strong>${new Date(entry.timestamp).toLocaleString("ro-RO")}</strong> (Model: ${entry.model || 'N/A'})`;
                itemContainer.appendChild(timestampAndModel);

                const sections = [
                    { title: "✍️ Paragraf Empatic", key: "paragraf", isList: false },
                    { title: "❓ Întrebare de Reflecție", key: "intrebare", isList: false },
                    { title: "🛠️ Recomandare Terapeutică", key: "recomandare", isList: false },
                    { title: "🔍 Distorsiuni Cognitive", key: "distorsiuni", isList: true },
                    { title: "🧠 Scheme Cognitive", key: "scheme", isList: true },
                    { title: "🧍‍♂️ Evaluare Adult Sănătos", key: "adult_sanatos_eval", isList: false }
                ];

                sections.forEach(sectionConfig => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "feedback-section";

                    const sectionTitleElement = document.createElement("h5");
                    sectionTitleElement.textContent = sectionConfig.title + ":";
                    sectionDiv.appendChild(sectionTitleElement);

                    let contentText = entry[sectionConfig.key];

                    if (contentText && typeof contentText === 'string') {
                        const titleWithoutEmoji = sectionConfig.title.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic})\s*/gu, '').trim();
                        const patternTitleText = new RegExp(`^${titleWithoutEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im");
                        contentText = contentText.replace(patternTitleText, "").trim();
                        const patternKeyText = new RegExp(`^${sectionConfig.key.replace(/_/g, " ")}:?\\s*`, "im");
                        contentText = contentText.replace(patternKeyText, "").trim();


                        if (sectionConfig.isList && contentText.includes('*')) {
                            const listElement = document.createElement("ul");
                            const items = contentText.split(/\s*\*\s*/)
                                              .map(item => item.trim().replace(/^\s*-\s*/, '')) // Elimină și '-' de la începutul itemului de listă
                                              .filter(item => item.length > 0);
                            items.forEach(itemText => {
                                const listItem = document.createElement("li");
                                listItem.innerHTML = itemText.replace(/\n/g, '<br>');
                                listElement.appendChild(listItem);
                            });
                            sectionDiv.appendChild(listElement);
                        } else {
                            const paragraphElement = document.createElement("p");
                            paragraphElement.innerHTML = contentText.replace(/\n/g, '<br>') || '<i>Indisponibil</i>';
                            sectionDiv.appendChild(paragraphElement);
                        }
                    } else {
                        const unavailableText = document.createElement("p");
                        unavailableText.style.fontStyle = "italic";
                        unavailableText.textContent = "Indisponibil";
                        sectionDiv.appendChild(unavailableText);
                    }
                    itemContainer.appendChild(sectionDiv);
                });
                containerElement.appendChild(itemContainer);
            });
        }
    }

   function adaugaCard(rowData) {
      const cardViewContainer = document.getElementById("cardViewContainer");
      let card = cardViewContainer.querySelector(`.response-card[data-id="${rowData.id}"]`);

      if (card) {
           console.log("Cardul există deja, se actualizează istoricul AI:", rowData.id);
           const historyContainer = card.querySelector('.ai-feedback-history-container');
           if (historyContainer) {
                afiseazaIstoricFeedback(historyContainer, rowData.feedback_history);
           }
           // S-ar putea să vrei să actualizezi și header-ul dacă data/situația s-ar schimba,
           // dar în fluxul actual, odată creat, conținutul principal al răspunsului nu se schimbă.
           return;
      }

      card = document.createElement("div");
      card.className = "response-card";
      card.setAttribute("data-id", rowData.id);
      card.innerHTML = `
        <div class="card-header"> Data: ${rowData.date || ''} - Situația: ${(rowData.situatie || '').substring(0,60)}...</div>
        <div class="card-content">
          <h4>Explorarea situației și a nevoilor</h4>
          <p><strong>Care este situația?</strong> ${rowData.situatie || ''}</p>
          <p><strong>Ce îmi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
          <p><strong>Cum mă face acel gând să mă simt?</strong> ${rowData.emotii || ''}</p>
          <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
          <p><strong>Ce comportament simți că adopți?</strong> ${rowData.comportament || ''}</p>
          <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
          <p><strong>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
          <p><strong>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</strong> ${rowData.adult_sanatos || ''}</p>

          <h4>Analiza gândurilor și a percepțiilor</h4>
          <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
          <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
          <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
          <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
          <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
          <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
          <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
          <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>

          <h4>Întrebări pentru claritate și reflecție suplimentară</h4>
          <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
          <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
          <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
          <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
          <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
          <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
          <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
          <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
          <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
          <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
          <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
          
          <div class="card-actions">
              <button class="generate-ai-feedback-button">Regenerează Feedback AI</button>
              <button class="delete-button">Șterge Înregistrarea</button>
          </div>
          <div class="ai-feedback-history-container">
          </div>
        </div>
      `;

      card.querySelector('.card-header').addEventListener('click', () => {
        card.classList.toggle('open');
      });

      card.querySelector('.delete-button').addEventListener('click', (event) => {
        event.stopPropagation();
        stergeCard(rowData.id, card);
      });

      const generateManualButton = card.querySelector('.generate-ai-feedback-button');
      if (generateManualButton) {
            generateManualButton.addEventListener('click', async (event) => {
                event.stopPropagation();
                const button = event.target;
                const originalButtonText = button.textContent;
                button.textContent = 'Se generează...';
                button.disabled = true;
                
                try {
                    console.log(`Regenerare manuală feedback AI pentru card: ${rowData.id}`);
                    const docSnapshot = await getDoc(doc(db, "raspunsuri", rowData.id));
                    let currentCardData;
                    if (docSnapshot.exists()) {
                        currentCardData = { id: docSnapshot.id, ...docSnapshot.data() };
                    } else {
                        currentCardData = rowData;
                    }
                    await genereazaSiProceseazaFeedbackAI(currentCardData, currentCardData.id);
                    const updatedDoc = await getDoc(doc(db, "raspunsuri", currentCardData.id));
                    if (updatedDoc.exists()) {
                       afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedback_history);
                    }
                } catch (error) {
                    console.error("Eroare la regenerarea manuală a feedback-ului AI:", error);
                    alert("A apărut o eroare la regenerarea feedback-ului AI.");
                } finally {
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            });
        }
    
      afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);

      // Inserează cardurile noi la început
      if (cardViewContainer.firstChild) {
          cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
      } else {
          cardViewContainer.appendChild(card);
      }
    }

    async function loadTableData(userId, collabIdForLoad = null, ownerIdForCollabView = null) {
        // Funcția de încărcare carduri - ESENȚIAL: filtrează pe userId sau ownerIdForCollabView
        if (!userId && !ownerIdForCollabView) {
            console.warn("loadTableData apelat fără userId sau ownerIdForCollabView. Nu se încarcă date.");
            return;
        }

        // Control pentru a nu reîncărca inutil dacă datele sunt deja pentru colaborator
        if (collabIdForLoad && dataAlreadyLoaded) {
            console.log("Cardurile pentru colaborator deja încărcate.");
            return;
        }
        
        console.log("Încărcare/Reîncărcare carduri din Firestore...");
        const cardViewContainer = document.getElementById("cardViewContainer");
        cardViewContainer.innerHTML = ''; // Golește întotdeauna la (re)încărcare

        try {
            let q;
            if (ownerIdForCollabView) { // Pentru colaborator
                console.log(`Filtrare colaborare pentru owner: ${ownerIdForCollabView}`);
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", ownerIdForCollabView));
            } else { // Pentru utilizatorul logat
                console.log(`Filtrare pentru utilizator logat: ${userId}`);
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", userId));
            }

            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                console.log("Nicio înregistrare găsită pentru filtrele aplicate.");
                 // Poți afișa un mesaj utilizatorului în cardViewContainer
                cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; font-style:italic;">Nicio fișă de monitorizare găsită.</p>';
                if(collabIdForLoad) dataAlreadyLoaded = true; // Marchează ca încărcat chiar dacă e gol
                return;
            }
            
            const documents = [];
            querySnapshot.forEach((doc) => {
                documents.push({ id: doc.id, ...doc.data() });
            });

            documents.sort((a, b) => {
                // Sortare mai robustă: folosim timestamp-ul salvat dacă există, altfel data
                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : (a.date ? new Date(a.date.split('.').reverse().join('-')).getTime() : 0);
                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : (b.date ? new Date(b.date.split('.').reverse().join('-')).getTime() : 0);
                return timeB - timeA; // Descrescător (cel mai nou primul)
            });
            
            documents.forEach(docData => {
                adaugaCard(docData);
            });

            if (collabIdForLoad) dataAlreadyLoaded = true; 
            // dataAlreadyLoaded pentru utilizatorul normal se setează în onAuthStateChanged

        } catch (error) {
            console.error("Eroare la încărcarea cardurilor din Firestore:", error.message, error.stack);
            cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; color:red;">A apărut o eroare la încărcarea datelor.</p>';
        }
    }

    async function populateTableData(userId) {
        // Această funcție este pentru tabelul ascuns. Dacă nu-l mai folosești, o poți elimina.
        // Asigură-te că filtrează pe `userId` dacă o păstrezi.
        const tableBody = document.getElementById("tableBody");
        if (!tableBody || !userId) return;
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('collabId')) return; // Nu pentru colaboratori

        // ... restul logicii populateTableData (cu query(collection(db, "raspunsuri"), where("ownerUid", "==", userId))) ...
        console.log("Funcția populateTableData (tabel) a fost apelată. Consideră eliminarea ei dacă tabelul nu este utilizat.");
    }

    window.toggleDetails = function(id) { /* ... cod neschimbat ... */ }

    async function stergeCard(id, cardElement) { /* ... cod existent, ar trebui să funcționeze ... */
        if (confirm("Sunteți sigur că doriți să ștergeți această înregistrare și tot feedback-ul asociat? Această acțiune este ireversibilă.")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                cardElement.remove();
                console.log(`Înregistrarea ${id} a fost ștearsă.`);
            } catch (error) {
                console.error("Eroare la ștergerea din Firestore:", error);
                alert("Eroare la ștergerea înregistrării.");
            }
        }
    }

    async function generateCollaborationLink() {
        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie să fiți autentificat pentru a genera un link de colaborare.");
            return;
        }
        // Caută dacă există deja un link activ pentru acest utilizator
        const existingCollabQuery = query(collection(db, "collaborations"), where("owner", "==", user.uid));
        const querySnapshot = await getDocs(existingCollabQuery);

        if (!querySnapshot.empty) {
            const collabDoc = querySnapshot.docs[0];
            const collaborationLink = `${window.location.origin}${window.location.pathname}?collabId=${collabDoc.id}`;
            prompt(`Ai deja un link de colaborare activ (PIN: ${collabDoc.data().pin}). Îl poți redistribui:\nLink și PIN:`, `${collaborationLink} (PIN: ${collabDoc.data().pin})`);
            return;
        }

        const pinCode = prompt("Introduceți un cod PIN numeric (minim 4 cifre) pentru noul link de colaborare:");
        if (!pinCode || !/^\d{4,}$/.test(pinCode)) { // Verifică dacă e numeric și are minim 4 cifre
            alert("Cod PIN invalid. Trebuie să fie numeric și să conțină cel puțin 4 cifre.");
            return;
        }
        try {
            const docRef = await addDoc(collection(db, "collaborations"), { 
                owner: user.uid, 
                pin: pinCode, 
                createdAt: new Date() 
            });
            const collaborationLink = `${window.location.origin}${window.location.pathname}?collabId=${docRef.id}`;
            prompt(`Link de colaborare generat! Distribuie acest link ÎMPREUNĂ cu codul PIN.\nLink: ${collaborationLink}\nPIN: ${pinCode}`, `Link: ${collaborationLink} (PIN: ${pinCode})`);
        } catch (error) {
            console.error("Eroare la generarea link-ului de colaborare:", error);
            alert("A apărut o eroare la generarea linkului.");
        }
    }

    window.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded - Verifică colaboratorul");
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (collabId) {
            dataAlreadyLoaded = false; // Important pentru colaborator
            document.body.classList.add("collab-view"); // Clasă pentru a ascunde/modifica elemente via CSS dacă e nevoie
            ['exercitiuForm', 'generateLinkButton', '.form-container', '.table-container'].forEach(sel => {
                const el = document.querySelector(sel) || document.getElementById(sel);
                if (el) el.style.display = 'none';
            });
            
            const pin = prompt("Introduceți PIN pentru colaborare:");
            if (!pin) {
                alert("PIN necesar."); window.location.href = "login.html"; return;
            }
            try {
                const collabDocRef = doc(db, "collaborations", collabId);
                const collabSnapshot = await getDoc(collabDocRef);
                if (collabSnapshot.exists()) {
                    const collabData = collabSnapshot.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect. Încărcare date colaborator pentru owner:", collabData.owner);
                        // Modifică titlul principal al paginii
                        document.title = "Vizualizare Fișă Colaborare - Psiho";
                        const mainHeading = document.querySelector('body > h2, body > .form-container h2'); // Găsește un titlu existent sau adaptează
                        if (mainHeading) mainHeading.textContent = "Fișă de Colaborare";

                        // Șterge conținutul .card-view înainte de a-l popula specific
                        const cardView = document.getElementById('cardViewContainer');
                        if(cardView) cardView.innerHTML = ''; 

                        // Important: Pasează ownerId la loadTableData
                        loadTableData(null, collabId, collabData.owner); 
                    } else {
                        alert("PIN incorect."); window.location.href = "login.html";
                    }
                } else {
                    alert("Colaborare inexistentă."); window.location.href = "login.html";
                }
            } catch (error) {
                console.error("Eroare accesare colaborare:", error);
                alert("Eroare accesare colaborare."); window.location.href = "login.html";
            }
        }
        // Pentru utilizatorul normal, onAuthStateChanged se ocupă de încărcarea datelor
    });
    </script>
    <style>
        /* ... TOATE STILURILE TALE CSS EXISTENTE (inclusiv responsive, .feedback-section, etc.) ... */
        body {font-family: 'Roboto', 'Montserrat', sans-serif; margin: 0; padding: 20px; background: linear-gradient(to right, #ece9e6, #ffffff); color: #333; box-sizing: border-box;}
        .form-container {max-width: 900px; margin: 20px auto; background: #fff; padding: 30px; box-shadow: 0 16px 24px rgba(0,0,0,0.2); border-radius: 15px; border: 3px solid #87CEFA; transition: transform 0.3s ease;}
        .form-container:hover {transform: scale(1.01);}
        .progress-bar {width: 100%; background-color: #f3f3f3; border-radius: 25px; overflow: hidden; margin-bottom: 20px;}
        .progress {height: 20px; width: 0; background-color: #87CEFA; transition: width 0.4s ease;}
        .question-card {margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s;}
        .question-card:hover {box-shadow: 0 6px 15px rgba(0,0,0,0.15);}
        .question-card h3 {font-weight: 700; font-size: 1.2em; margin-top: 0; margin-bottom: 10px;}
        .question-card p {font-weight: 300; font-size: 0.95em; margin-bottom: 15px; color: #555; line-height: 1.6;}
        textarea {width: calc(100% - 22px); padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; resize: vertical; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: border-color 0.3s;}
        textarea:focus {border-color: #87CEFA; box-shadow: 0 2px 8px rgba(135,206,250,0.5); outline: none;}
        input[type="submit"], button {margin-top: 20px; padding: 12px 25px; font-size: 18px; font-weight: 500; background: linear-gradient(to right, #87CEFA, #6bb9e7); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.2s;}
        input[type="submit"]:hover, button:hover {background: linear-gradient(to right, #6bb9e7, #4A90E2); transform: translateY(-2px);}
        .form-step {display: none;}
        .form-step-active {display: block; animation: fadeIn 0.7s ease-in-out;}
        @keyframes fadeIn { 0% {opacity: 0; transform: translateY(10px);} 100% {opacity: 1; transform: translateY(0);} }
        .step-navigation {text-align: center; margin-top: 20px;}
        .step-navigation button {margin: 0 10px;}
        .table-container {margin:30px auto; padding:20px; background:#fff; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); overflow-x:auto; max-width:900px;}
        .card-view {display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 30px auto;}
        .response-card {background: #f9f9ff; padding: 0; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); transition: box-shadow 0.3s ease; position: relative; overflow: hidden;}
        .response-card:hover {box-shadow: 0 10px 20px rgba(0,0,0,0.18);}
        .response-card .card-header {font-weight: 700; font-size: 1.1em; cursor: pointer; background: #87CEFA; padding: 12px 20px; color: #fff; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center;}
        .response-card .card-header::after {content: '▼'; font-size: 0.8em; transition: transform 0.3s ease;}
        .response-card.open .card-header::after {transform: rotate(180deg);}
        .response-card .card-content {max-height: 0; margin-top: 0; padding: 0 20px; background: #fff; line-height: 1.6; overflow: auto; transition: max-height 0.5s ease-out, padding-top 0.5s ease-out, padding-bottom 0.5s ease-out;} /* Timp tranzitie mărit */
        .response-card.open .card-content {max-height: 2000px; /* Mărit substanțial */ padding-top: 15px; padding-bottom: 15px;}
        .response-card .card-content p {margin-bottom: 12px; border-left: 3px solid #87CEFA; padding-left: 10px;}
        .response-card .card-content p strong {color: #333;}
        .response-card h4 {text-align: left; color: #4A90E2; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 1.05em;}
        .response-card h4:first-child {margin-top: 0;}
        .card-actions {text-align: center; margin-top: 20px; padding-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .card-actions button {padding: 8px 15px; font-size: 0.9em; margin: 5px;}
        .generate-ai-feedback-button {background: #5cb85c;}
        .generate-ai-feedback-button:hover {background: #4cae4c;}
        .delete-button {background-color: #f44336 !important;}
        .delete-button:hover {background-color: #d32f2f !important;}
        #confirmationMessage {display:none; text-align:center; padding:15px; background-color:#d4edda; color:#155724; border:1px solid #c3e6cb; border-radius:5px; margin-top:20px; animation:fadeIn 0.5s;}
        .collaboration-section {text-align:center; margin-top:30px; padding-bottom:20px;}
        .collaboration-section button {background-color:#f0ad4e;}
        .collaboration-section button:hover {background-color:#ec971f;}
        .feedback-entry-card {background:#eef6ff; padding:15px; border-left:4px solid #4A90E2; border-radius:5px; margin-bottom:15px; font-size:0.95em; line-height:1.6;}
        .feedback-timestamp {color:#555; font-size:0.9em; margin-bottom:12px;}
        .feedback-section {margin-bottom:12px;}
        .feedback-section h5 {font-size:1em; font-weight:bold; color:#2c5282; margin-top:0; margin-bottom:6px;}
        .feedback-section p, .feedback-section ul {margin-top:0; margin-bottom:8px; color:#1e293b;}
        .feedback-section ul {padding-left:25px; list-style-position:outside; list-style-type:disc;}
        .feedback-section li {margin-bottom:4px;}

        /* Responsive - ASIGURĂ-TE CĂ INCLUZI TOATE REGULILE TALE RESPONSIVE COMPLETE AICI */
        @media (max-width: 768px) {
            body {padding:10px;}
            .form-container, .table-container, .card-view {padding:15px; margin-left:10px; margin-right:10px; max-width:calc(100% - 20px);}
            textarea {font-size:14px; padding:8px; width:calc(100% - 18px);}
            .form-container > button, .step-navigation button {font-size:16px; padding:10px 20px;}
            .card-actions button {font-size:0.85em; padding:7px 12px;}
            .question-card h3, .response-card .card-header {font-size:1.05em;}
            .question-card p, .response-card .card-content p {font-size:0.9em;}
            /* Reguli specifice tabelului pentru mobil */
            .table-container {overflow-x:auto;}
            table {display:block; width:100%;}
            thead, tbody, tr {display:block;}
            th {display:none;} /* Ascunde header-ul tabelului original */
            tr {margin-bottom:15px; border:1px solid #ddd; border-radius:5px; display:flex; flex-direction:column;}
            td {display:flex; justify-content:space-between; padding:10px; text-align:right; border-bottom:1px solid #eee; position:relative;}
            td:last-child {border-bottom:none;}
            td::before {content:attr(data-label); font-weight:bold; text-align:left; margin-right:10px; color:#555; flex-shrink:0; width:auto; padding-right: 10px;} /* Lățime auto, flex-shrink previne micșorarea */
            td > *:not(button) {flex-grow:1; word-break:break-word; text-align:left;} /* Conținutul să ocupe spațiul rămas și să se alinieze la stânga */
            td button {width:auto; padding:6px 12px; font-size:0.85em; margin-left:auto; flex-shrink:0;}
            td[colspan="10"] {display:block;}
        }
        @media (max-width: 480px) {
            .form-container, .table-container, .card-view {padding:10px; margin-left:5px; margin-right:5px; max-width:calc(100% - 10px);}
            .question-card h3, .response-card .card-header {font-size:1em;}
            .question-card p, .response-card .card-content p {font-size:0.85em;}
            textarea {font-size:13px; padding:6px; width:calc(100% - 14px);}
            .form-container > button, .step-navigation button {font-size:14px; padding:8px 15px;}
            .card-actions button {font-size:0.8em; padding:6px 10px;}
            .response-card .card-header {padding:10px;}
            .response-card .card-content {padding-left:15px; padding-right:15px; font-size:0.85em;}
            td {flex-direction:column; align-items:flex-start;} /* Label deasupra valorii */
            td::before {width:100%; margin-bottom:5px; margin-right: 0;}
            td button {align-self:flex-end;}
        }
    </style>
</head>
<body>

    <div class="form-container">
        <h2>Fișă Monitorizare</h2>
        <p>Completează fiecare întrebare pentru a înțelege mai bine situațiile tale. Fiecare secțiune reprezintă o parte importantă a reflecției tale. În acest exercițiu, îți voi ghida fiecare pas, astfel încât să poți explora în profunzime gândurile, emoțiile și comportamentele tale.</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm" novalidate>
            <!-- PASUL 1 -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situația?</h3>
                <p>Te rog să descrii contextul care a declanșat emoțiile sau comportamentul tău. Încearcă să fii cât mai specific și detaliat. Aceasta poate fi o situație concretă din viața de zi cu zi în care te-ai simțit copleșit, stresat sau într-o altă stare emoțională intensă.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce îmi trece prin minte?</h3>
                <p>Îți cer să identifici gândurile automate care au apărut în această situație. Acestea sunt gânduri rapide, involuntare, care îți trec prin minte în momentele de stres. Ce îți spui în acel moment? Este un gând critic sau îngrijorător?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mă face acel gând să mă simt?</h3>
                <p>Te rog să notezi emoțiile pe care le simți în urma acelui gând. Ce simți? Frică, tristețe, furie? Dă o intensitate emoției (de la 0 la 100) pentru a vedea cât de puternică este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>Identifică modul în care te afli în această situație. Este un mod de copil vulnerabil, critic interior, sau poate adultul sănătos? Conștientizarea modului îți poate oferi o mai bună înțelegere a reacțiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simți că adopți?</h3>
                <p>Descrie comportamentul pe care îl manifești în această situație. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoașterea comportamentului te ajută să înțelegi mai bine cum reacționezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoții și comportamente? Poate fi nevoia de siguranță, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta să găsești strategii mai sănătoase pentru a le îndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</h3>
                <p>Reflectează dacă felul în care reacționezi te ajută cu adevărat să îți îndeplinești nevoile. Poate fi util să te gândești dacă există alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</h3>
                <p>Gândește-te la cum ar reacționa partea ta Adultă Sănătoasă în această situație. Cum ai putea să abordezi diferit pentru a avea grijă de tine și de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- PASUL 2 -->
            <div class="question-card form-step" id="step-9">
                <h3>Ce mă face să cred că gândul automat este adevărat?</h3>
                <p>Explorează motivele pentru care crezi că acest gând este adevărat. Ce dovezi ai care îți confirmă acest lucru? De multe ori, ne bazăm pe experiențe trecute sau frici pentru a justifica un gând.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mă face să cred că nu este adevărat?</h3>
                <p>Acum, să ne uităm la dovezile împotriva gândului tău. Există argumente sau experiențe care contrazic acest gând? Poate există o altă perspectivă pe care nu ai luat-o în considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>Există o explicație alternativă?</h3>
                <p>Uneori, există mai multe explicații pentru ceea ce se întâmplă. Ce alte interpretări ai putea avea pentru această situație? Gândește-te la alte posibilități care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rău lucru care s-ar putea întâmpla?</h3>
                <p>Ce este cel mai rău care ar putea avea loc în această situație? Să identificăm acele frici catastrofale care adesea ne alimentează gândurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea întâmpla?</h3>
                <p>Pe de altă parte, care ar fi cel mai pozitiv scenariu? Uneori uităm să ne gândim și la posibilitățile bune. Cum ar arăta cel mai bun rezultat al acestei situații?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>După ce am explorat extremele, ce crezi că este cel mai probabil să se întâmple? Cum ar arăta un rezultat realist, ținând cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</h3>
                <p>Întreabă-te cum ar fi dacă ai aborda situația cu un alt tip de gândire. Cum ar influența asta emoțiile și comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</h3>
                <p>Gândește-te la cum ai reacționa dacă un prieten drag ar avea aceleași gânduri. Ce i-ai spune pentru a-l sprijini? Cum ai încerca să-l încurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- PASUL 3 -->
            <div class="question-card form-step" id="step-17">
                <h3>Văd doar partea rea a lucrurilor?</h3>
                <p>Este posibil să fii prins într-un tipar negativ de gândire, concentrându-te doar pe aspectele negative. Încearcă să observi dacă există și aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-18">
                <h3>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</h3>
                <p>Reflectează dacă îți asumi responsabilitatea pentru situații asupra cărora nu aveai control. Este important să îți dai seama de limitele influenței tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>Mă condamn în baza unui singur eveniment?</h3>
                <p>Îți evaluezi valoarea personală bazându-te pe un singur eveniment negativ? Amintește-ți că un eveniment nu definește cine ești în totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situația în termeni extremi?</h3>
                <p>Verifică dacă vezi situația doar în alb sau negru, fără nuanțe de gri. Gândirea extremă poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situația?</h3>
                <p>Îți amplifici reacțiile față de o situație? Încearcă să te gândești dacă ceea ce percepi este realist sau dacă exagerezi impactul situației.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>Există și alți factori responsabili?</h3>
                <p>Există alți factori care contribuie la această situație, pe lângă tine? Este important să ai o perspectivă completă asupra cauzelor unei situații.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sărit direct la concluzii?</h3>
                <p>Te-ai grăbit să ajungi la o concluzie fără suficiente dovezi? Încearcă să observi dacă există alte posibilități care ar putea explica situația.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-24">
                <h3>Îmi pun întrebări fără răspuns?</h3>
                <p>Te frământă întrebări care nu au un răspuns clar sau realist? Aceste întrebări pot fi o sursă majoră de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>Mă concentrez doar asupra slăbiciunilor mele?</h3>
                <p>Ai tendința să te focalizezi doar pe slăbiciuni și să ignori punctele tale forte? Încearcă să îți recunoști și punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</h3>
                <p>Ai tendința să te gândești mereu la cum ar trebui să fie lucrurile, în loc să accepți situația așa cum este? Acceptarea poate reduce stresul și anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-27">
                <h3>Mă aștept să fiu perfect?</h3>
                <p>Îți setezi standarde foarte înalte, imposibil de atins? Perfecționismul poate fi o sursă majoră de frustrare și descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-28">
                <h3>Completare finalizată!</h3>
                <p>Felicitări pentru parcurgerea acestui exercițiu de auto-reflecție! Apasă butonul de mai jos pentru a salva datele și a genera un feedback automatizat, dacă este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta să obții noi perspective. Dacă întâmpini probleme cu generarea (ex: erori de limită de utilizare), poți încerca din nou mai târziu.</p>
            </div>

            <div class="step-navigation">
                <button type="button" id="prevButton">Înapoi</button>
                <button type="button" id="nextButton">Înainte</button>
            </div>
            <button type="button" id="addButton">Salvează și Generează Feedback AI</button>
        </form>

        <div id="confirmationMessage">
            <!-- Mesajul va fi setat de JavaScript -->
        </div>

        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">Generează Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">Răspunsurile Tale și Istoricul Feedback-ului AI:</h3>
    
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile cu răspunsuri și feedback AI vor fi adăugate aici de JavaScript -->
    </div>
    
    <div class="table-container" style="display: none;"> <!-- Ascuns implicit -->
        <table>
            <thead>
                <tr>
                    <th>Data</th><th>Situația</th><th>Gânduri</th><th>Emoții</th><th>Mod activ</th>
                    <th>Comportament</th><th>Nevoile</th><th>Ajutor comport.</th><th>Adult Sănătos</th><th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <br/>
</body>
</html>