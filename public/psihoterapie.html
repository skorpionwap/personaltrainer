<!DOCTYPE html>
<html>
<head>
    <title>FiÈ™Äƒ Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // Configurarea Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

  // --- Configurare Gemini API ---
const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng"; // ACEASTA ESTE CHEIA TA REALÄ‚
const GEMINI_MODEL_NAME = "gemini-2.5-flash-preview-04-17";
let genAI, geminiModel;

// CondiÈ›ie simplificatÄƒ: verificÄƒ doar dacÄƒ GEMINI_API_KEY are o valoare.
if (GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "") {
    try {
        genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        geminiModel = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });
        console.log("SDK Gemini iniÈ›ializat cu succes. Model:", GEMINI_MODEL_NAME);
    } catch (e) {
        console.error("Eroare la iniÈ›ializarea SDK Gemini. VerificÄƒ validitatea cheii API È™i conexiunea la internet.", e);
        geminiModel = null; // SeteazÄƒ la null dacÄƒ iniÈ›ializarea eÈ™ueazÄƒ
    }
} else {
    // Acest mesaj se va afiÈ™a doar dacÄƒ GEMINI_API_KEY este un string gol sau nu e definitÄƒ.
    console.warn("Cheia API pentru Gemini (GEMINI_API_KEY) este goalÄƒ sau nedefinitÄƒ. Feedback-ul AI prin Gemini va fi dezactivat.");
    geminiModel = null;
}


    let currentStep = 1;
    let totalSteps = 0;
    let dataAlreadyLoaded = false;

    window.onload = function () {
        totalSteps = document.querySelectorAll('.form-step').length;
        updateProgressBar();
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (!collabId) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utilizator autentificat:", user.uid);
                    if (!dataAlreadyLoaded) {
                        // Este CRUCIAL ca aceste funcÈ›ii sÄƒ filtreze pe user.uid
                        populateTableData(user.uid); 
                        loadTableData(user.uid);     
                        dataAlreadyLoaded = true;
                    }
                } else {
                    console.log("Utilizator neautentificat, redirecÈ›ionare...");
                    window.location.href = "login.html";
                }
            });
        }

        const nextButton = document.getElementById("nextButton");
        if (nextButton) nextButton.addEventListener("click", nextStep);
        const prevButton = document.getElementById("prevButton");
        if (prevButton) prevButton.addEventListener("click", previousStep);
        const addButton = document.getElementById("addButton");
        if (addButton) addButton.addEventListener("click", salveazaRaspunsSiGenereazaFeedback);
        const generateLinkButton = document.getElementById("generateLinkButton");
        if (generateLinkButton) generateLinkButton.addEventListener("click", generateCollaborationLink);
    };

    function nextStep() { /* ... la fel ... */ 
        if (currentStep < totalSteps) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }
    function previousStep() { /* ... la fel ... */ 
        if (currentStep > 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }
    function updateProgressBar() { /* ... la fel ... */ 
        const progress = document.getElementById('progress');
        if(progress && totalSteps > 0) {
            const progressPercentage = (currentStep / totalSteps) * 100;
            progress.style.width = progressPercentage + '%';
        }
    }

    async function genereazaFeedbackCuGeminiDinFrontend(promptText, generationConfig = {}) {
        if (!geminiModel) {
            console.error("Modelul Gemini nu este iniÈ›ializat.");
            return "EROARE: Configurare Gemini incorectÄƒ (cheie API).";
        }
        try {
            console.log("Trimitere prompt cÄƒtre Gemini (primele 100 caractere):", promptText.substring(0, 100) + "...");
            
            const requestPayload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }],
                generationConfig: {
                    temperature: 0.6, // Valoare cu care poÈ›i experimenta (0.2-0.8)
                    // maxOutputTokens: 4096, // PoÈ›i seta o limitÄƒ dacÄƒ rÄƒspunsurile sunt prea lungi
                    ...generationConfig // Permite suprascrierea default-urilor dacÄƒ e necesar
                }
            };

            const result = await geminiModel.generateContent(requestPayload);
            const response = result.response;

            if (response && response.candidates && response.candidates.length > 0 && response.candidates[0].content && response.candidates[0].content.parts && response.candidates[0].content.parts.length > 0 && typeof response.candidates[0].content.parts[0].text === 'string') {
                 if (response.candidates[0].finishReason && response.candidates[0].finishReason !== "STOP" && response.candidates[0].finishReason !== "MAX_TOKENS") {
                    console.warn("Gemini a oprit generarea cu motivul:", response.candidates[0].finishReason, response.candidates[0].safetyRatings);
                    return `EROARE Gemini: Generarea a fost opritÄƒ (Motiv: ${response.candidates[0].finishReason}). Este posibil ca promptul sau rÄƒspunsul sÄƒ fi declanÈ™at filtre de siguranÈ›Äƒ. ÃncearcÄƒ sÄƒ reformulezi.`;
                }
                return response.candidates[0].content.parts[0].text;
            } else {
                 console.error("RÄƒspuns neaÈ™teptat sau gol de la Gemini:", JSON.stringify(response, null, 2));
                 let reason = "RÄƒspuns invalid sau gol.";
                 if(response && response.promptFeedback && response.promptFeedback.blockReason){
                    reason = `Prompt blocat (Motiv: ${response.promptFeedback.blockReason}, Detalii: ${response.promptFeedback.blockReasonMessage || 'N/A'})`;
                 }
                 return `EROARE Gemini: ${reason}`;
            }
        } catch (error) {
            console.error("Eroare detaliatÄƒ la generarea feedback-ului Gemini:", error, error.stack);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare necunoscutÄƒ la API"}`;
             if (error.toString().toLowerCase().includes("api key not valid") || (error.message && error.message.toLowerCase().includes("permission denied")) || (error.message && error.message.toLowerCase().includes("api_key_invalid")) ) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validÄƒ sau nu are permisiuni. VerificÄƒ restricÈ›iile din Google Cloud Console È™i cheia din cod. AsigurÄƒ-te cÄƒ domeniul " + window.location.hostname + " este permis.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) || (error.toString().toLowerCase().includes("resource has been exhausted")) )) {
                errorMessage = "EROARE: Limita de utilizare gratuitÄƒ Gemini (RPM sau alta) a fost depÄƒÈ™itÄƒ. ÃncearcÄƒ mai tÃ¢rziu.";
            } else if (error.toString().toLowerCase().includes("404") && error.toString().toLowerCase().includes("model not found")) {
                 errorMessage = `EROARE Gemini: Modelul ${GEMINI_MODEL_NAME} nu a fost gÄƒsit sau nu este suportat. VerificÄƒ numele modelului.`;
            }
            return errorMessage;
        }
    }

    async function genereazaSiProceseazaFeedbackAI(rowData, docId) {
        const prompt = `
AnalizeazÄƒ Ã®n profunzime aceastÄƒ fiÈ™Äƒ completÄƒ de auto-reflecÈ›ie. Utilizatorul a parcurs un exerciÈ›iu detaliat pentru a-È™i Ã®nÈ›elege o situaÈ›ie specificÄƒ. OferÄƒ feedback psihologic structurat, empatic È™i acÈ›ionabil. RespectÄƒ cu stricteÈ›e formatul È™i ordinea secÈ›iunilor de mai jos, folosind exact prefixele indicate.

**Datele Complete din FiÈ™a de ReflecÈ›ie a Utilizatorului:**

**SecÈ›iunea 1: Explorarea SituaÈ›iei È™i a Nevoilor**
*   Care este situaÈ›ia?: ${rowData.situatie || 'N/A'}
*   Ce Ã®mi trece prin minte (gÃ¢nduri automate)?: ${rowData.ganduri || 'N/A'}
*   Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt (emoÈ›ii)?: ${rowData.emotii || 'N/A'}
*   Ce mod este activ?: ${rowData.mod_activ || 'N/A'}
*   Ce comportament simÈ›i cÄƒ adopÈ›i?: ${rowData.comportament || 'N/A'}
*   Care sunt nevoile tale mai profunde?: ${rowData.nevoi_profunde || 'N/A'}
*   MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?: ${rowData.ajutor_comportament || 'N/A'}
*   Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos (perspectiva utilizatorului)?: ${rowData.adult_sanatos || 'N/A'}

**SecÈ›iunea 2: Analiza GÃ¢ndurilor È™i a PercepÈ›iilor**
*   Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?: ${rowData.dovezi_adevar || 'N/A'}
*   Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?: ${rowData.dovezi_fals || 'N/A'}
*   ExistÄƒ o explicaÈ›ie alternativÄƒ?: ${rowData.explicatie_alternativa || 'N/A'}
*   Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?: ${rowData.scenariu_negativ || 'N/A'}
*   Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?: ${rowData.scenariu_optimist || 'N/A'}
*   Care este cel mai realist rezultat?: ${rowData.rezultat_realist || 'N/A'}
*   Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?: ${rowData.schimbare_gandire || 'N/A'}
*   Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?: ${rowData.sfat_prieten || 'N/A'}

**SecÈ›iunea 3: ÃntrebÄƒri pentru Claritate È™i ReflecÈ›ie SuplimentarÄƒ**
*   VÄƒd doar partea rea a lucrurilor?: ${rowData.partea_rea || 'N/A'}
*   Ãmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?: ${rowData.responsabilitate || 'N/A'}
*   MÄƒ condamn Ã®n baza unui singur eveniment?: ${rowData.condamnare || 'N/A'}
*   Privesc situaÈ›ia Ã®n termeni extremi (alb/negru)?: ${rowData.termeni_extremi || 'N/A'}
*   Exagerez situaÈ›ia?: ${rowData.exagerare || 'N/A'}
*   ExistÄƒ È™i alÈ›i factori responsabili?: ${rowData.factori_responsabili || 'N/A'}
*   Am sÄƒrit direct la concluzii?: ${rowData.concluzii || 'N/A'}
*   Ãmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?: ${rowData.intrebari_fara_raspuns || 'N/A'}
*   MÄƒ concentrez doar asupra slÄƒbiciunilor mele?: ${rowData.slabiciuni || 'N/A'}
*   MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?: ${rowData.cum_ar_trebui || 'N/A'}
*   MÄƒ aÈ™tept sÄƒ fiu perfect?: ${rowData.perfectiune || 'N/A'}

**CERINÈšE PENTRU FEEDBACK-UL AI (foloseÈ™te prefixele EXACT aÈ™a cum sunt scrise):**

Feedback General:
EmpatieIniÈ›ialÄƒ: (1-2 propoziÈ›ii empatice scurte, recunoscÃ¢nd efortul utilizatorului.)

AnalizÄƒ DetaliatÄƒ:
PuncteForteObservate: (IdentificÄƒ 1-2 aspecte pozitive sau de auto-conÈ™tientizare.)
TiparePrincipale: (Descrie succint 1-3 tipare de gÃ¢ndire/emoÈ›ionale/comportamentale centrale.)

LegÄƒtura GÃ¢nd-EmoÈ›ie-Comportament-Nevoie:
ConexiuniCheie: (SintetizeazÄƒ legÄƒtura S-G-E-C-N bazatÄƒ pe '${rowData.ganduri}', '${rowData.emotii}', '${rowData.comportament}', '${rowData.nevoi_profunde}'.)

Analiza GÃ¢ndurilor Automate È™i Distorsiuni:
DistorsiuniIdentificate: (IdentificÄƒ 2-4 distorsiuni principale. Pentru fiecare: Numele, ExplicaÈ›ia, Exemplu din rÄƒspunsuri, Ãntrebare de contestare. ListeazÄƒ fiecare ca sub-punct precedat de '* '.)

Scheme È™i Moduri Cognitive:
SchemeActivate: (IdentificÄƒ 1-3 scheme. Pentru fiecare: Numele, Cum se manifestÄƒ. ListeazÄƒ fiecare ca sub-punct precedat de '* '.)
ModuriImplicate: (SugereazÄƒ ce moduri Schema Therapy ar putea fi implicate.)

Rolul Adultului SÄƒnÄƒtos:
PerspectivaAdultSÄƒnÄƒtos: (ComenteazÄƒ rÄƒspunsul utilizatorului '${rowData.adult_sanatos}'. OferÄƒ descriere detaliatÄƒ: interpretare situaÈ›ie, gÃ¢nduri alternative, gestionare emoÈ›ii, comportamente adaptative, contracarare scheme.)

Sugestii È™i ReflecÈ›ii Finale:
ÃntrebareFinalÄƒReflecÈ›ie: (O Ã®ntrebare generalÄƒ puternicÄƒ pentru Ã®nvÄƒÈ›are È™i aplicare viitoare.)
SugestieMicPas: (O sugestie concretÄƒ pentru un mic pas urmÄƒtor.)
ÃncurajareFinalÄƒ: (1-2 propoziÈ›ii de Ã®ncurajare.)

RÄƒspunde doar cu textul cerut conform structurii, fÄƒrÄƒ introduceri, concluzii sau formatÄƒri suplimentare Ã®n afara celor specificate (ex: nu folosi markdown bold '**' Ã®n rÄƒspunsul tÄƒu, doar prefixele È™i `* ` pentru liste).`;

        let feedbackText = null;
        let modelFolosit = "N/A";

        if (geminiModel) {
            console.log("Solicitare feedback de la Gemini (prompt nou)...");
            modelFolosit = `Gemini (${GEMINI_MODEL_NAME})`;
            feedbackText = await genereazaFeedbackCuGeminiDinFrontend(prompt);
        } else {
            return { // StructurÄƒ similarÄƒ pentru eroare
                empatie_initiala: "Serviciul de feedback AI (Gemini) nu este configurat. VerificÄƒ cheia API.",
                model: "Configurare Gemini EronatÄƒ", timestamp: new Date().toISOString(), error: true
            };
        }

        if (!feedbackText || (typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
            return { 
                empatie_initiala: feedbackText || `Nu s-a putut obÈ›ine feedback de la ${modelFolosit}.`,
                model: modelFolosit + " (Eroare API)", timestamp: new Date().toISOString(), error: true
            };
        }

        console.log("RÄƒspuns brut de la Gemini (prompt nou):\n---\n" + feedbackText + "\n---");

        // Definirea noilor chei È™i prefixe pentru parsare
        const feedbackStructure = {
            empatie_initiala: /^EmpatieIniÈ›ialÄƒ:\s*([\s\S]*?)(?=\n(?:PuncteForteObservate:|$))/im,
            puncte_forte: /^PuncteForteObservate:\s*([\s\S]*?)(?=\n(?:TiparePrincipale:|$))/im,
            tipare_principale: /^TiparePrincipale:\s*([\s\S]*?)(?=\n(?:ConexiuniCheie:|$))/im,
            conexiuni_cheie: /^ConexiuniCheie:\s*([\s\S]*?)(?=\n(?:DistorsiuniIdentificate:|$))/im,
            distorsiuni_identificate: /^DistorsiuniIdentificate:\s*([\s\S]*?)(?=\n(?:SchemeActivate:|$))/im,
            scheme_activate: /^SchemeActivate:\s*([\s\S]*?)(?=\n(?:ModuriImplicate:|$))/im,
            moduri_implicate: /^ModuriImplicate:\s*([\s\S]*?)(?=\n(?:PerspectivaAdultSÄƒnÄƒtos:|$))/im,
            perspectiva_adult_sanatos: /^PerspectivaAdultSÄƒnÄƒtos:\s*([\s\S]*?)(?=\n(?:ÃntrebareFinalÄƒReflecÈ›ie:|$))/im,
            intrebare_finala_reflectie: /^ÃntrebareFinalÄƒReflecÈ›ie:\s*([\s\S]*?)(?=\n(?:SugestieMicPas:|$))/im,
            sugestie_mic_pas: /^SugestieMicPas:\s*([\s\S]*?)(?=\n(?:ÃncurajareFinalÄƒ:|$))/im,
            incurajare_finala: /^ÃncurajareFinalÄƒ:\s*([\s\S]*?$)/im,
        };
        
        const parsedFeedback = { model: modelFolosit, timestamp: new Date().toISOString() };
        let allParsingFailed = true;

        for (const key in feedbackStructure) {
            const match = feedbackText.match(feedbackStructure[key]);
            parsedFeedback[key] = match && match[1] ? match[1].trim() : `Nu s-a putut extrage '${key}'.`;
            if (parsedFeedback[key] && !parsedFeedback[key].startsWith("Nu s-a putut")) {
                allParsingFailed = false;
            }
        }
        
        if (allParsingFailed && !(typeof feedbackText === 'string' && feedbackText.startsWith("EROARE:"))) {
            console.warn("Parsarea detaliatÄƒ a eÈ™uat pentru toate secÈ›iunile (prompt nou). VerificÄƒ formatul rÄƒspunsului AI È™i regex-urile.");
            // DacÄƒ totul eÈ™ueazÄƒ, pune rÄƒspunsul brut Ã®ntr-un cÃ¢mp principal
            parsedFeedback.empatie_initiala = `RÄƒspuns brut (parsare eÈ™uatÄƒ):\n${feedbackText.replace(/\n/g, "<br>")}`;
            parsedFeedback.error_parsing = true; // MarcheazÄƒ cÄƒ parsarea a eÈ™uat
        }

        if (docId) {
            const docRef = doc(db, "raspunsuri", docId);
            try {
                const updatePayload = { feedback_history: arrayUnion(parsedFeedback) };
                // AdaugÄƒ cÃ¢mpurile individuale pentru cel mai recent feedback
                Object.keys(parsedFeedback).forEach(key => {
                    updatePayload[`feedback_${key}`] = parsedFeedback[key];
                });
                await updateDoc(docRef, updatePayload);
                console.log(`Feedback AI (structurÄƒ nouÄƒ, ${modelFolosit}) salvat pentru docId: ${docId}`);
            } catch (updateError) {
                console.error(`Eroare la actualizarea Firestore cu feedback (structurÄƒ nouÄƒ) pt doc ${docId}:`, updateError);
            }
        }
        return parsedFeedback;
    }

    async function salveazaRaspunsSiGenereazaFeedback() {
        const form = document.getElementById("exercitiuForm");
        if (!form.checkValidity()) {
            form.reportValidity();
            const currentStepElement = document.querySelector('.form-step-active');
            const firstInvalidField = currentStepElement?.querySelector(':invalid:not(fieldset)'); // EvitÄƒ fieldset dacÄƒ ai
            if (firstInvalidField) {
                firstInvalidField.focus();
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii din pasul curent.");
            } else {
                alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile obligatorii.");
            }
            return;
        }

        const formData = new FormData(form);
        const rowData = { 
            date: new Date().toLocaleDateString("ro-RO"),
            timestamp: new Date().toISOString() // AdaugÄƒ un timestamp complet la salvarea datelor
        };
        formData.forEach((value, key) => { rowData[key] = value; });

        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie sÄƒ fiÈ›i autentificat."); window.location.href = "login.html"; return;
        }
        rowData.ownerUid = user.uid;

        const addButton = document.getElementById("addButton");
        const originalAddButtonText = addButton.textContent;
        addButton.textContent = "Se salveazÄƒ È™i proceseazÄƒ..."; addButton.disabled = true;

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), rowData);
            rowData.id = docRef.id;
            console.log(`RÄƒspuns salvat cu ID: ${docRef.id}. Se genereazÄƒ feedback AI...`);

            const feedbackGenerat = await genereazaSiProceseazaFeedbackAI(rowData, docRef.id);
            
            const docSnapshot = await getDoc(docRef); // Ia cea mai recentÄƒ versiune
            if (docSnapshot.exists()) {
                adaugaCard({ id: docSnapshot.id, ...docSnapshot.data() });
            } else {
                rowData.feedback_history = feedbackGenerat && !feedbackGenerat.error ? [feedbackGenerat] : [];
                adaugaCard(rowData); // Fallback
            }
            
            form.reset(); currentStep = 1;
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('form-step-active'));
            document.getElementById('step-1').classList.add('form-step-active');
            updateProgressBar();

            const confirmationMessage = document.getElementById('confirmationMessage');
            if (feedbackGenerat && !feedbackGenerat.error && !feedbackGenerat.error_parsing && !(typeof feedbackGenerat.empatie_initiala === 'string' && feedbackGenerat.empatie_initiala.startsWith("EROARE:"))) {
                confirmationMessage.textContent = 'Formular trimis È™i feedback AI generat!';
                confirmationMessage.style.backgroundColor = '#d4edda'; confirmationMessage.style.color = '#155724';
            } else {
                let msg = 'Formular trimis. ';
                if (feedbackGenerat && feedbackGenerat.empatie_initiala) {
                    msg += feedbackGenerat.empatie_initiala; // AfiÈ™eazÄƒ eroarea din primul cÃ¢mp
                } else {
                    msg += 'ProblemÄƒ la generarea feedback-ului AI.';
                }
                confirmationMessage.textContent = msg;
                confirmationMessage.style.backgroundColor = '#f8d7da'; confirmationMessage.style.color = '#58151c';
            }
            confirmationMessage.style.display = 'block';
            setTimeout(() => { confirmationMessage.style.display = 'none'; }, 9000);

        } catch (error) {
            console.error("Eroare majorÄƒ Ã®n salveazaRaspunsSiGenereazaFeedback:", error);
            alert("Eroare la salvare. ÃncercaÈ›i din nou.");
        } finally {
            addButton.textContent = originalAddButtonText; addButton.disabled = false;
        }
    }

    function afiseazaIstoricFeedback(containerElement, feedbackHistory) {
        containerElement.innerHTML = ''; 

        if (feedbackHistory && Array.isArray(feedbackHistory) && feedbackHistory.length > 0) {
            const historyTitle = document.createElement("h4");
            // ... stiluri pentru historyTitle ...
            historyTitle.style.color = "#4A90E2"; historyTitle.style.marginTop = "20px"; historyTitle.style.marginBottom = "10px";
            historyTitle.textContent = "ğŸ—‚ï¸ Istoric Feedback AI:";
            containerElement.appendChild(historyTitle);

            feedbackHistory.slice().reverse().forEach(entry => { 
                if (!entry || typeof entry !== 'object') { // Verificare suplimentarÄƒ
                    console.warn("Intrare invalidÄƒ Ã®n istoricul de feedback:", entry);
                    return; 
                }
                const itemContainer = document.createElement("div");
                itemContainer.className = "feedback-entry-card";

                const timestampAndModel = document.createElement("p");
                timestampAndModel.className = "feedback-timestamp";
                timestampAndModel.innerHTML = `<strong>${new Date(entry.timestamp || Date.now()).toLocaleString("ro-RO")}</strong> (Model: ${entry.model || 'N/A'})`;
                itemContainer.appendChild(timestampAndModel);

                // DefineÈ™te structura NOUÄ‚ de afiÈ™are, corespunzÄƒtoare NOUILOR chei parsate
                const newSections = [
                    { title: "ğŸ’¬ Empatie IniÈ›ialÄƒ", key: "empatie_initiala", isList: false },
                    { title: "ğŸŒŸ Puncte Forte Observate", key: "puncte_forte", isList: false },
                    { title: "ğŸ”„ Tipare Principale", key: "tipare_principale", isList: false },
                    { title: "ğŸ”— Conexiuni Cheie (S-G-E-C-N)", key: "conexiuni_cheie", isList: false },
                    { title: "ğŸ” Distorsiuni Identificate", key: "distorsiuni_identificate", isList: true, complexList: true }, // complexList pentru parsare mai detaliatÄƒ dacÄƒ e cazul
                    { title: "ğŸ§  Scheme Activate", key: "scheme_activate", isList: true },
                    { title: "ğŸ­ Moduri Implicate", key: "moduri_implicate", isList: false }, // Poate fi È™i listÄƒ dacÄƒ AI-ul dÄƒ mai multe
                    { title: "ğŸ’ª Perspectiva Adultului SÄƒnÄƒtos", key: "perspectiva_adult_sanatos", isList: false },
                    { title: "â“ Ãntrebare FinalÄƒ de ReflecÈ›ie", key: "intrebare_finala_reflectie", isList: false },
                    { title: "ğŸ‘Ÿ Sugestie Mic Pas UrmÄƒtor", key: "sugestie_mic_pas", isList: false },
                    { title: "ğŸ’– Ãncurajare FinalÄƒ", key: "incurajare_finala", isList: false }
                ];

                newSections.forEach(sectionConfig => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "feedback-section";

                    const sectionTitleElement = document.createElement("h5");
                    sectionTitleElement.textContent = sectionConfig.title + ":";
                    sectionDiv.appendChild(sectionTitleElement);

                    let contentText = entry[`feedback_${sectionConfig.key}`] || entry[sectionConfig.key]; // PreferÄƒ cÃ¢mpurile `feedback_` de la rÄƒdÄƒcinÄƒ dacÄƒ existÄƒ

                    if (contentText && typeof contentText === 'string') {
                        // Eliminare prefix redundant din textul conÈ›inutului (dacÄƒ AI-ul l-a inclus)
                        const titleWithoutEmoji = sectionConfig.title.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic}|ğŸ’¬|ğŸŒŸ|ğŸ”„|ğŸ”—|ğŸ”|ğŸ§ |ğŸ­|ğŸ’ª|â“|ğŸ‘Ÿ|ğŸ’–)\s*/gu, '').trim();
                        const patternTitleText = new RegExp(`^${titleWithoutEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im");
                        contentText = contentText.replace(patternTitleText, "").trim();
                        
                        if (sectionConfig.isList && contentText.includes('*')) {
                            const listElement = document.createElement("ul");
                            const items = contentText.split(/\s*\n?\s*\*\s+/) // Split mai robust la '*' urmat de spaÈ›iu, pe linie nouÄƒ sau nu
                                              .map(item => item.trim().replace(/^\s*-\s*/, '')) 
                                              .filter(item => item.length > 0);
                            if (items.length === 0 && contentText.startsWith("*")) { // Cazul cu un singur item *
                                items.push(contentText.substring(1).trim().replace(/^\s*-\s*/, ''));
                            }
                            
                            items.forEach(itemText => {
                                const listItem = document.createElement("li");
                                // DacÄƒ este `complexList` pentru Distorsiuni, fiecare item ar putea avea substructurÄƒ
                                // Momentan, doar afiÈ™Äƒm textul itemului.
                                listItem.innerHTML = itemText.replace(/\n/g, '<br>');
                                listElement.appendChild(listItem);
                            });
                            sectionDiv.appendChild(listElement);
                        } else {
                            const paragraphElement = document.createElement("p");
                            paragraphElement.innerHTML = contentText.replace(/\n/g, '<br>') || '<i>Indisponibil</i>';
                            sectionDiv.appendChild(paragraphElement);
                        }
                    } else if (typeof contentText === 'string' && contentText === "") {
                        // AfiÈ™eazÄƒ un mesaj specific dacÄƒ textul este gol, dar nu "Indisponibil"
                        const emptyTextP = document.createElement("p");
                        emptyTextP.style.fontStyle = "italic";
                        emptyTextP.textContent = "(SecÈ›iune goalÄƒ sau necompletatÄƒ de AI)";
                        sectionDiv.appendChild(emptyTextP);
                    }
                    else {
                        const unavailableText = document.createElement("p");
                        unavailableText.style.fontStyle = "italic";
                        unavailableText.textContent = "Indisponibil sau format necunoscut";
                        sectionDiv.appendChild(unavailableText);
                    }
                    itemContainer.appendChild(sectionDiv);
                });
                containerElement.appendChild(itemContainer);
            });
        }
    }

   function adaugaCard(rowData) { /* ... Adaptat pentru noile chei de feedback dacÄƒ e necesar la afiÈ™area primarÄƒ a feedback-ului, deÈ™i afiseazaIstoricFeedback face treaba principalÄƒ ... */ 
        const cardViewContainer = document.getElementById("cardViewContainer");
        let card = cardViewContainer.querySelector(`.response-card[data-id="${rowData.id}"]`);

        if (card) {
            console.log("Cardul existÄƒ, se actualizeazÄƒ istoricul AI:", rowData.id);
            afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);
            return;
        }

        card = document.createElement("div");
        card.className = "response-card";
        card.setAttribute("data-id", rowData.id);
        // ... (restul conÈ›inutului cardului cu datele utilizatorului rÄƒmÃ¢ne la fel) ...
          card.innerHTML = `
        <div class="card-header"> Data: ${rowData.date || ''} - SituaÈ›ia: ${(rowData.situatie || '').substring(0,60)}...</div>
        <div class="card-content">
          <h4>Explorarea situaÈ›iei È™i a nevoilor</h4>
          <p><strong>Care este situaÈ›ia?</strong> ${rowData.situatie || ''}</p>
          <p><strong>Ce Ã®mi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
          <p><strong>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</strong> ${rowData.emotii || ''}</p>
          <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
          <p><strong>Ce comportament simÈ›i cÄƒ adopÈ›i?</strong> ${rowData.comportament || ''}</p>
          <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
          <p><strong>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
          <p><strong>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</strong> ${rowData.adult_sanatos || ''}</p>

          <h4>Analiza gÃ¢ndurilor È™i a percepÈ›iilor</h4>
          <p><strong>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</strong> ${rowData.dovezi_adevar || ''}</p>
          <p><strong>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</strong> ${rowData.dovezi_fals || ''}</p>
          <p><strong>ExistÄƒ o explicaÈ›ie alternativÄƒ?</strong> ${rowData.explicatie_alternativa || ''}</p>
          <p><strong>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</strong> ${rowData.scenariu_negativ || ''}</p>
          <p><strong>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</strong> ${rowData.scenariu_optimist || ''}</p>
          <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
          <p><strong>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</strong> ${rowData.schimbare_gandire || ''}</p>
          <p><strong>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</strong> ${rowData.sfat_prieten || ''}</p>

          <h4>ÃntrebÄƒri pentru claritate È™i reflecÈ›ie suplimentarÄƒ</h4>
          <p><strong>VÄƒd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
          <p><strong>Ãmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
          <p><strong>MÄƒ condamn Ã®n baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
          <p><strong>Privesc situaÈ›ia Ã®n termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
          <p><strong>Exagerez situaÈ›ia?</strong> ${rowData.exagerare || ''}</p>
          <p><strong>ExistÄƒ È™i alÈ›i factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
          <p><strong>Am sÄƒrit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
          <p><strong>Ãmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
          <p><strong>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
          <p><strong>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
          <p><strong>MÄƒ aÈ™tept sÄƒ fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
          
          <div class="card-actions">
              <button class="generate-ai-feedback-button">RegenereazÄƒ Feedback AI</button>
              <button class="delete-button">È˜terge Ãnregistrarea</button>
          </div>
          <div class="ai-feedback-history-container">
          </div>
        </div>
      `;

        card.querySelector('.card-header').addEventListener('click', () => card.classList.toggle('open'));
        card.querySelector('.delete-button').addEventListener('click', (e) => { e.stopPropagation(); stergeCard(rowData.id, card); });

        const regenButton = card.querySelector('.generate-ai-feedback-button');
        if (regenButton) {
            regenButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                const button = e.target; 
                const originalText = button.textContent;
                button.textContent = 'Se genereazÄƒ...'; button.disabled = true;
                try {
                    const currentDoc = await getDoc(doc(db, "raspunsuri", rowData.id));
                    if (currentDoc.exists()) {
                        await genereazaSiProceseazaFeedbackAI({id: currentDoc.id, ...currentDoc.data()}, currentDoc.id);
                        const updatedDoc = await getDoc(doc(db, "raspunsuri", currentDoc.id)); // ReciteÈ™te pentru a obÈ›ine cel mai nou istoric
                        if (updatedDoc.exists()) {
                            afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedback_history);
                        }
                    }
                } catch (err) { console.error("Eroare regenerare AI:", err); alert("Eroare regenerare feedback."); }
                finally { button.textContent = originalText; button.disabled = false; }
            });
        }
        afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);
        if (cardViewContainer.firstChild) cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
        else cardViewContainer.appendChild(card);
   }


    async function loadTableData(userId, collabIdForLoad = null, ownerIdForCollabView = null) { /* ... la fel, asigurÄƒ filtrarea pe ownerUid ... */
         if (!userId && !ownerIdForCollabView) {
            console.warn("loadTableData apelat fÄƒrÄƒ userId sau ownerIdForCollabView.");
            return;
        }
        if (collabIdForLoad && dataAlreadyLoaded) { console.log("Colaborare deja Ã®ncÄƒrcatÄƒ."); return; }
        
        console.log("ÃncÄƒrcare carduri Firestore...");
        const cardViewContainer = document.getElementById("cardViewContainer");
        cardViewContainer.innerHTML = '';

        try {
            let q;
            if (ownerIdForCollabView) {
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", ownerIdForCollabView));
            } else {
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", userId));
            }

            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; font-style:italic;">Nicio fiÈ™Äƒ gÄƒsitÄƒ.</p>';
                if(collabIdForLoad) dataAlreadyLoaded = true;
                return;
            }
            
            const documents = [];
            querySnapshot.forEach((doc) => documents.push({ id: doc.id, ...doc.data() }));
            documents.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0) ); // SorteazÄƒ dupÄƒ timestamp complet
            
            documents.forEach(docData => adaugaCard(docData));
            if (collabIdForLoad) dataAlreadyLoaded = true; 
        } catch (error) {
            console.error("Eroare loadTableData:", error.message, error.stack);
            cardViewContainer.innerHTML = '<p style="text-align:center; margin-top:20px; color:red;">Eroare Ã®ncÄƒrcare date.</p>';
        }
    }
    async function populateTableData(userId) { /* ... la fel, asigurÄƒ filtrarea ... */ 
        console.log("populateTableData (tabel) ruleazÄƒ pentru:", userId, "ConsiderÄƒ eliminarea dacÄƒ nu se foloseÈ™te tabelul.");
    }
    window.toggleDetails = function(id) { /* ... la fel ... */ 
         const detailRow = document.getElementById(`details-${id}`);
        if (detailRow) {
            detailRow.style.display = detailRow.style.display === "none" ? "table-row" : "none";
        }
    }
    async function stergeCard(id, cardElement) { /* ... la fel ... */ 
        if (confirm("Sigur È™tergi aceastÄƒ Ã®nregistrare? Ireversibil!")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                cardElement.remove();
                console.log(`Ãnregistrare ${id} È™tearsÄƒ.`);
            } catch (error) { console.error("Eroare È™tergere:", error); alert("Eroare È™tergere.");}
        }
    }
    async function generateCollaborationLink() { /* ... la fel ... */
        const user = auth.currentUser;
        if (!user) { alert("Autentificare necesarÄƒ."); return; }
        const q = query(collection(db, "collaborations"), where("owner", "==", user.uid));
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            const collabDoc = snapshot.docs[0];
            prompt(`Link existent (PIN: ${collabDoc.data().pin}):`, `${location.origin}${location.pathname}?collabId=${collabDoc.id} (PIN: ${collabDoc.data().pin})`);
            return;
        }
        const pin = prompt("PIN numeric (minim 4 cifre) pentru link colaborare:");
        if (!pin || !/^\d{4,}$/.test(pin)) { alert("PIN invalid."); return; }
        try {
            const ref = await addDoc(collection(db, "collaborations"), { owner: user.uid, pin, createdAt: new Date() });
            prompt(`Link generat! Distribuie cu PIN:\nLink: ${location.origin}${location.pathname}?collabId=${ref.id}\nPIN: ${pin}`, `Link: ${location.origin}${location.pathname}?collabId=${ref.id} (PIN: ${pin})`);
        } catch (e) { console.error("Eroare generare link:", e); alert("Eroare generare link."); }
    }

    window.addEventListener('DOMContentLoaded', async () => { /* ... la fel, asigurÄƒ filtrarea pt collabData.owner ... */
        console.log("DOMContentLoaded - verificÄƒ colaborare");
        const params = new URLSearchParams(location.search);
        const collabId = params.get('collabId');
        if (collabId) {
            dataAlreadyLoaded = false; 
            document.body.classList.add("collab-view");
            ['exercitiuForm', 'generateLinkButton', '.form-container', '.table-container'].forEach(s => {
                const el = document.querySelector(s) || document.getElementById(s);
                if (el) el.style.display = 'none';
            });
            const pin = prompt("PIN colaborare:");
            if (!pin) { alert("PIN necesar."); location.href = "login.html"; return; }
            try {
                const collabRef = doc(db, "collaborations", collabId);
                const collabSnap = await getDoc(collabRef);
                if (collabSnap.exists()) {
                    const collabData = collabSnap.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect, Ã®ncarc date pentru owner:", collabData.owner);
                        document.title = "Vizualizare FiÈ™Äƒ Colaborare";
                        const mainH = document.querySelector('.form-container h2');
                        if(mainH) mainH.textContent = "FiÈ™Äƒ Colaborare (Citire)";
                        else { // AdaugÄƒ un titlu dacÄƒ nu existÄƒ cel din form-container
                            const pageTitle = document.createElement('h2');
                            pageTitle.textContent = "Vizualizare FiÈ™Äƒ Colaborare";
                            pageTitle.style.textAlign = 'center';
                            document.body.insertBefore(pageTitle, document.querySelector('.card-view'));
                        }
                        loadTableData(null, collabId, collabData.owner); 
                    } else { alert("PIN incorect."); location.href = "login.html"; }
                } else { alert("Colaborare invalidÄƒ."); location.href = "login.html"; }
            } catch (e) { console.error("Eroare colaborare:", e); alert("Eroare accesare colaborare."); location.href = "login.html"; }
        }
    });
    </script>
    <style>
        /* ... TOATE STILURILE TALE CSS COMPLETE AICI ... */
        body {font-family: 'Roboto', 'Montserrat', sans-serif; margin: 0; padding: 20px; background: linear-gradient(to right, #ece9e6, #ffffff); color: #333; box-sizing: border-box;}
        .form-container {max-width: 900px; margin: 20px auto; background: #fff; padding: 30px; box-shadow: 0 16px 24px rgba(0,0,0,0.2); border-radius: 15px; border: 3px solid #87CEFA; transition: transform 0.3s ease;}
        .form-container:hover {transform: scale(1.01);}
        .progress-bar {width: 100%; background-color: #f3f3f3; border-radius: 25px; overflow: hidden; margin-bottom: 20px;}
        .progress {height: 20px; width: 0; background-color: #87CEFA; transition: width 0.4s ease;}
        .question-card {margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s;}
        .question-card:hover {box-shadow: 0 6px 15px rgba(0,0,0,0.15);}
        .question-card h3 {font-weight: 700; font-size: 1.2em; margin-top: 0; margin-bottom: 10px;}
        .question-card p {font-weight: 300; font-size: 0.95em; margin-bottom: 15px; color: #555; line-height: 1.6;}
        textarea {width: calc(100% - 22px); padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; resize: vertical; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: border-color 0.3s;}
        textarea:focus {border-color: #87CEFA; box-shadow: 0 2px 8px rgba(135,206,250,0.5); outline: none;}
        input[type="submit"], button {margin-top: 20px; padding: 12px 25px; font-size: 18px; font-weight: 500; background: linear-gradient(to right, #87CEFA, #6bb9e7); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.2s;}
        input[type="submit"]:hover, button:hover {background: linear-gradient(to right, #6bb9e7, #4A90E2); transform: translateY(-2px);}
        .form-step {display: none;}
        .form-step-active {display: block; animation: fadeIn 0.7s ease-in-out;}
        @keyframes fadeIn { 0% {opacity: 0; transform: translateY(10px);} 100% {opacity: 1; transform: translateY(0);} }
        .step-navigation {text-align: center; margin-top: 20px;}
        .step-navigation button {margin: 0 10px;}
        .table-container {margin:30px auto; padding:20px; background:#fff; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); overflow-x:auto; max-width:900px;}
        .card-view {display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 30px auto;}
        .response-card {background: #f9f9ff; padding: 0; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); transition: box-shadow 0.3s ease; position: relative; overflow: hidden;}
        .response-card:hover {box-shadow: 0 10px 20px rgba(0,0,0,0.18);}
        .response-card .card-header {font-weight: 700; font-size: 1.1em; cursor: pointer; background: #87CEFA; padding: 12px 20px; color: #fff; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center;}
        .response-card .card-header::after {content: 'â–¼'; font-size: 0.8em; transition: transform 0.3s ease;}
        .response-card.open .card-header::after {transform: rotate(180deg);}
        .response-card .card-content {max-height: 0; margin-top: 0; padding: 0 20px; background: #fff; line-height: 1.6; overflow: auto; transition: max-height 0.5s ease-out, padding-top 0.5s ease-out, padding-bottom 0.5s ease-out;}
        .response-card.open .card-content {max-height: 3000px; /* MÄƒrit È™i mai mult */ padding-top: 15px; padding-bottom: 15px;}
        .response-card .card-content p {margin-bottom: 12px; border-left: 3px solid #87CEFA; padding-left: 10px;}
        .response-card .card-content p strong {color: #333;}
        .response-card h4 {text-align: left; color: #4A90E2; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 1.05em;}
        .response-card h4:first-child {margin-top: 0;}
        .card-actions {text-align: center; margin-top: 20px; padding-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px;}
        .card-actions button {padding: 8px 15px; font-size: 0.9em; margin: 5px;}
        .generate-ai-feedback-button {background: #5cb85c;}
        .generate-ai-feedback-button:hover {background: #4cae4c;}
        .delete-button {background-color: #f44336 !important;}
        .delete-button:hover {background-color: #d32f2f !important;}
        #confirmationMessage {display:none; text-align:center; padding:15px; background-color:#d4edda; color:#155724; border:1px solid #c3e6cb; border-radius:5px; margin-top:20px; animation:fadeIn 0.5s;}
        .collaboration-section {text-align:center; margin-top:30px; padding-bottom:20px;}
        .collaboration-section button {background-color:#f0ad4e;}
        .collaboration-section button:hover {background-color:#ec971f;}
        .feedback-entry-card {background:#eef6ff; padding:15px; border-left:4px solid #4A90E2; border-radius:5px; margin-bottom:15px; font-size:0.95em; line-height:1.6;}
        .feedback-timestamp {color:#555; font-size:0.9em; margin-bottom:12px;}
        .feedback-section {margin-bottom:12px;}
        .feedback-section h5 {font-size:1em; font-weight:bold; color:#2c5282; margin-top:0; margin-bottom:6px;}
        .feedback-section p, .feedback-section ul {margin-top:0; margin-bottom:8px; color:#1e293b;}
        .feedback-section ul {padding-left:25px; list-style-position:outside; list-style-type:disc;}
        .feedback-section li {margin-bottom:4px;}

        /* Responsive - AdaugÄƒ aici toate regulile @media din versiunea ta anterioarÄƒ funcÈ›ionalÄƒ */
         @media (max-width: 768px) {
            body {padding:10px;}
            .form-container, .table-container, .card-view {padding:15px; margin-left:10px; margin-right:10px; max-width:calc(100% - 20px);}
            textarea {font-size:14px; padding:8px; width:calc(100% - 18px);}
            .form-container > button, .step-navigation button {font-size:16px; padding:10px 20px;}
            .card-actions button {font-size:0.85em; padding:7px 12px;}
            .question-card h3, .response-card .card-header {font-size:1.05em;}
            .question-card p, .response-card .card-content p {font-size:0.9em;}
            .table-container {overflow-x:auto;}
            table {display:block; width:100%;} thead, tbody, tr {display:block;}
            th {display:none;}
            tr {margin-bottom:15px; border:1px solid #ddd; border-radius:5px; display:flex; flex-direction:column;}
            td {display:flex; justify-content:space-between; padding:10px; text-align:right; border-bottom:1px solid #eee; position:relative;}
            td:last-child {border-bottom:none;}
            td::before {content:attr(data-label); font-weight:bold; text-align:left; margin-right:10px; color:#555; flex-shrink:0; width:auto; padding-right: 10px;}
            td > *:not(button) {flex-grow:1; word-break:break-word; text-align:left;}
            td button {width:auto; padding:6px 12px; font-size:0.85em; margin-left:auto; flex-shrink:0;}
            td[colspan="10"] {display:block;}
        }
        @media (max-width: 480px) {
            .form-container, .table-container, .card-view {padding:10px; margin-left:5px; margin-right:5px; max-width:calc(100% - 10px);}
            .question-card h3, .response-card .card-header {font-size:1em;}
            .question-card p, .response-card .card-content p {font-size:0.85em;}
            textarea {font-size:13px; padding:6px; width:calc(100% - 14px);}
            .form-container > button, .step-navigation button {font-size:14px; padding:8px 15px;}
            .card-actions button {font-size:0.8em; padding:6px 10px;}
            .response-card .card-header {padding:10px;}
            .response-card .card-content {padding-left:15px; padding-right:15px; font-size:0.85em;}
            td {flex-direction:column; align-items:flex-start;}
            td::before {width:100%; margin-bottom:5px; margin-right: 0;}
            td button {align-self:flex-end;}
        }

    </style>
</head>
<body>

    <div class="form-container">
        <h2>FiÈ™Äƒ Monitorizare</h2>
        <p>CompleteazÄƒ fiecare Ã®ntrebare pentru a Ã®nÈ›elege mai bine situaÈ›iile tale. Fiecare secÈ›iune reprezintÄƒ o parte importantÄƒ a reflecÈ›iei tale. Ãn acest exerciÈ›iu, Ã®È›i voi ghida fiecare pas, astfel Ã®ncÃ¢t sÄƒ poÈ›i explora Ã®n profunzime gÃ¢ndurile, emoÈ›iile È™i comportamentele tale.</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm" novalidate>
            <!-- PASUL 1 -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situaÈ›ia?</h3>
                <p>Te rog sÄƒ descrii contextul care a declanÈ™at emoÈ›iile sau comportamentul tÄƒu. ÃncearcÄƒ sÄƒ fii cÃ¢t mai specific È™i detaliat. Aceasta poate fi o situaÈ›ie concretÄƒ din viaÈ›a de zi cu zi Ã®n care te-ai simÈ›it copleÈ™it, stresat sau Ã®ntr-o altÄƒ stare emoÈ›ionalÄƒ intensÄƒ.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce Ã®mi trece prin minte?</h3>
                <p>ÃÈ›i cer sÄƒ identifici gÃ¢ndurile automate care au apÄƒrut Ã®n aceastÄƒ situaÈ›ie. Acestea sunt gÃ¢nduri rapide, involuntare, care Ã®È›i trec prin minte Ã®n momentele de stres. Ce Ã®È›i spui Ã®n acel moment? Este un gÃ¢nd critic sau Ã®ngrijorÄƒtor?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</h3>
                <p>Te rog sÄƒ notezi emoÈ›iile pe care le simÈ›i Ã®n urma acelui gÃ¢nd. Ce simÈ›i? FricÄƒ, tristeÈ›e, furie? DÄƒ o intensitate emoÈ›iei (de la 0 la 100) pentru a vedea cÃ¢t de puternicÄƒ este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>IdentificÄƒ modul Ã®n care te afli Ã®n aceastÄƒ situaÈ›ie. Este un mod de copil vulnerabil, critic interior, sau poate adultul sÄƒnÄƒtos? ConÈ™tientizarea modului Ã®È›i poate oferi o mai bunÄƒ Ã®nÈ›elegere a reacÈ›iilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simÈ›i cÄƒ adopÈ›i?</h3>
                <p>Descrie comportamentul pe care Ã®l manifeÈ™ti Ã®n aceastÄƒ situaÈ›ie. Este un comportament de evitare, de confruntare, de sacrificiu de sine? RecunoaÈ™terea comportamentului te ajutÄƒ sÄƒ Ã®nÈ›elegi mai bine cum reacÈ›ionezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoÈ›ii È™i comportamente? Poate fi nevoia de siguranÈ›Äƒ, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta sÄƒ gÄƒseÈ™ti strategii mai sÄƒnÄƒtoase pentru a le Ã®ndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</h3>
                <p>ReflecteazÄƒ dacÄƒ felul Ã®n care reacÈ›ionezi te ajutÄƒ cu adevÄƒrat sÄƒ Ã®È›i Ã®ndeplineÈ™ti nevoile. Poate fi util sÄƒ te gÃ¢ndeÈ™ti dacÄƒ existÄƒ alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ar reacÈ›iona partea ta AdultÄƒ SÄƒnÄƒtoasÄƒ Ã®n aceastÄƒ situaÈ›ie. Cum ai putea sÄƒ abordezi diferit pentru a avea grijÄƒ de tine È™i de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- PASUL 2 -->
            <div class="question-card form-step" id="step-9">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</h3>
                <p>ExploreazÄƒ motivele pentru care crezi cÄƒ acest gÃ¢nd este adevÄƒrat. Ce dovezi ai care Ã®È›i confirmÄƒ acest lucru? De multe ori, ne bazÄƒm pe experienÈ›e trecute sau frici pentru a justifica un gÃ¢nd.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</h3>
                <p>Acum, sÄƒ ne uitÄƒm la dovezile Ã®mpotriva gÃ¢ndului tÄƒu. ExistÄƒ argumente sau experienÈ›e care contrazic acest gÃ¢nd? Poate existÄƒ o altÄƒ perspectivÄƒ pe care nu ai luat-o Ã®n considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>ExistÄƒ o explicaÈ›ie alternativÄƒ?</h3>
                <p>Uneori, existÄƒ mai multe explicaÈ›ii pentru ceea ce se Ã®ntÃ¢mplÄƒ. Ce alte interpretÄƒri ai putea avea pentru aceastÄƒ situaÈ›ie? GÃ¢ndeÈ™te-te la alte posibilitÄƒÈ›i care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Ce este cel mai rÄƒu care ar putea avea loc Ã®n aceastÄƒ situaÈ›ie? SÄƒ identificÄƒm acele frici catastrofale care adesea ne alimenteazÄƒ gÃ¢ndurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Pe de altÄƒ parte, care ar fi cel mai pozitiv scenariu? Uneori uitÄƒm sÄƒ ne gÃ¢ndim È™i la posibilitÄƒÈ›ile bune. Cum ar arÄƒta cel mai bun rezultat al acestei situaÈ›ii?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>DupÄƒ ce am explorat extremele, ce crezi cÄƒ este cel mai probabil sÄƒ se Ã®ntÃ¢mple? Cum ar arÄƒta un rezultat realist, È›inÃ¢nd cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</h3>
                <p>ÃntreabÄƒ-te cum ar fi dacÄƒ ai aborda situaÈ›ia cu un alt tip de gÃ¢ndire. Cum ar influenÈ›a asta emoÈ›iile È™i comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ai reacÈ›iona dacÄƒ un prieten drag ar avea aceleaÈ™i gÃ¢nduri. Ce i-ai spune pentru a-l sprijini? Cum ai Ã®ncerca sÄƒ-l Ã®ncurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- PASUL 3 -->
            <div class="question-card form-step" id="step-17">
                <h3>VÄƒd doar partea rea a lucrurilor?</h3>
                <p>Este posibil sÄƒ fii prins Ã®ntr-un tipar negativ de gÃ¢ndire, concentrÃ¢ndu-te doar pe aspectele negative. ÃncearcÄƒ sÄƒ observi dacÄƒ existÄƒ È™i aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-18">
                <h3>Ãmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</h3>
                <p>ReflecteazÄƒ dacÄƒ Ã®È›i asumi responsabilitatea pentru situaÈ›ii asupra cÄƒrora nu aveai control. Este important sÄƒ Ã®È›i dai seama de limitele influenÈ›ei tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>MÄƒ condamn Ã®n baza unui singur eveniment?</h3>
                <p>ÃÈ›i evaluezi valoarea personalÄƒ bazÃ¢ndu-te pe un singur eveniment negativ? AminteÈ™te-È›i cÄƒ un eveniment nu defineÈ™te cine eÈ™ti Ã®n totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situaÈ›ia Ã®n termeni extremi?</h3>
                <p>VerificÄƒ dacÄƒ vezi situaÈ›ia doar Ã®n alb sau negru, fÄƒrÄƒ nuanÈ›e de gri. GÃ¢ndirea extremÄƒ poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situaÈ›ia?</h3>
                <p>ÃÈ›i amplifici reacÈ›iile faÈ›Äƒ de o situaÈ›ie? ÃncearcÄƒ sÄƒ te gÃ¢ndeÈ™ti dacÄƒ ceea ce percepi este realist sau dacÄƒ exagerezi impactul situaÈ›iei.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>ExistÄƒ È™i alÈ›i factori responsabili?</h3>
                <p>ExistÄƒ alÈ›i factori care contribuie la aceastÄƒ situaÈ›ie, pe lÃ¢ngÄƒ tine? Este important sÄƒ ai o perspectivÄƒ completÄƒ asupra cauzelor unei situaÈ›ii.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sÄƒrit direct la concluzii?</h3>
                <p>Te-ai grÄƒbit sÄƒ ajungi la o concluzie fÄƒrÄƒ suficiente dovezi? ÃncearcÄƒ sÄƒ observi dacÄƒ existÄƒ alte posibilitÄƒÈ›i care ar putea explica situaÈ›ia.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-24">
                <h3>Ãmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</h3>
                <p>Te frÄƒmÃ¢ntÄƒ Ã®ntrebÄƒri care nu au un rÄƒspuns clar sau realist? Aceste Ã®ntrebÄƒri pot fi o sursÄƒ majorÄƒ de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</h3>
                <p>Ai tendinÈ›a sÄƒ te focalizezi doar pe slÄƒbiciuni È™i sÄƒ ignori punctele tale forte? ÃncearcÄƒ sÄƒ Ã®È›i recunoÈ™ti È™i punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</h3>
                <p>Ai tendinÈ›a sÄƒ te gÃ¢ndeÈ™ti mereu la cum ar trebui sÄƒ fie lucrurile, Ã®n loc sÄƒ accepÈ›i situaÈ›ia aÈ™a cum este? Acceptarea poate reduce stresul È™i anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-27">
                <h3>MÄƒ aÈ™tept sÄƒ fiu perfect?</h3>
                <p>ÃÈ›i setezi standarde foarte Ã®nalte, imposibil de atins? PerfecÈ›ionismul poate fi o sursÄƒ majorÄƒ de frustrare È™i descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-28">
                <h3>Completare finalizatÄƒ!</h3>
                <p>FelicitÄƒri pentru parcurgerea acestui exerciÈ›iu de auto-reflecÈ›ie! ApasÄƒ butonul de mai jos pentru a salva datele È™i a genera un feedback automatizat, dacÄƒ este disponibil.</p>
                <p>Feedback-ul AI te poate ajuta sÄƒ obÈ›ii noi perspective. DacÄƒ Ã®ntÃ¢mpini probleme cu generarea (ex: erori de limitÄƒ de utilizare), poÈ›i Ã®ncerca din nou mai tÃ¢rziu.</p>
            </div>

            <div class="step-navigation">
                <button type="button" id="prevButton">Ãnapoi</button>
                <button type="button" id="nextButton">Ãnainte</button>
            </div>
            <button type="button" id="addButton">SalveazÄƒ È™i GenereazÄƒ Feedback AI</button>
        </form>

        <div id="confirmationMessage">
            <!-- Mesajul va fi setat de JavaScript -->
        </div>

        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">GenereazÄƒ Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">RÄƒspunsurile Tale È™i Istoricul Feedback-ului AI:</h3>
    
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile cu rÄƒspunsuri È™i feedback AI vor fi adÄƒugate aici de JavaScript -->
    </div>
    
    <div class="table-container" style="display: none;"> <!-- Ascuns implicit -->
        <table>
            <thead>
                <tr>
                    <th>Data</th><th>SituaÈ›ia</th><th>GÃ¢nduri</th><th>EmoÈ›ii</th><th>Mod activ</th>
                    <th>Comportament</th><th>Nevoile</th><th>Ajutor comport.</th><th>Adult SÄƒnÄƒtos</th><th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <br/>
</body>
</html>