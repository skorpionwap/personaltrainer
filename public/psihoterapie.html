<!DOCTYPE html>
<html>
<head>
    <title>FiÈ™Äƒ Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"; // Import pentru Gemini SDK

    // Configurarea Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98", // ÃŽnlocuieÈ™te cu cheia ta realÄƒ dacÄƒ e diferitÄƒ
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    // IniÈ›ializare Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Configurare Gemini API (Folosit direct Ã®n frontend) ---
    // !! ATENÈšIE MAXIMÄ‚: AsigurÄƒ-te cÄƒ ai RESTRICÈšII puternice pe aceastÄƒ cheie Ã®n Google Cloud Console.
    const GEMINI_API_KEY = "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng"; // <--- ÃŽNLOCUIEÈ˜TE ASTA CU CHEIA TA REALÄ‚!
    const GEMINI_MODEL_NAME = "gemini-1.5-flash-latest"; // Sau gemini-pro
    let genAI, geminiModel;

    if (GEMINI_API_KEY && GEMINI_API_KEY !== "AIzaSyAlm63krfJxBu1QR5ZmvA0rcGUnjm17sng") {
        try {
            genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            geminiModel = genAI.getGenerativeModel({ model: GEMINI_MODEL_NAME });
            console.log("SDK Gemini iniÈ›ializat cu modelul:", GEMINI_MODEL_NAME);
        } catch (e) {
            console.error("Eroare la iniÈ›ializarea SDK Gemini:", e);
            geminiModel = null; // AsigurÄƒ-te cÄƒ e null dacÄƒ iniÈ›ializarea eÈ™ueazÄƒ
        }
    } else {
        console.warn("Cheia API pentru Gemini nu este configuratÄƒ. Feedback-ul AI prin Gemini va fi dezactivat.");
        geminiModel = null;
    }
    // --- SfÃ¢rÈ™it Configurare Gemini API ---

    let currentStep = 1;
    let totalSteps = 0;
    let dataAlreadyLoaded = false;


    window.onload = function () {
        totalSteps = document.querySelectorAll('.form-step').length;
        updateProgressBar();
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        // Logica de autentificare È™i Ã®ncÄƒrcare date
        if (collabId) {
            // Gestionarea vizualizÄƒrii colaboratorului se face Ã®n listener-ul DOMContentLoaded
        } else {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Utilizator autentificat:", user.uid);
                    // DacÄƒ utilizatorul este autentificat, Ã®ncÄƒrcÄƒm datele lui
                    if (!dataAlreadyLoaded) { // AdÄƒugat pentru a evita reÃ®ncÄƒrcÄƒri multiple
                        populateTableData(user.uid); // Pentru tabel (dacÄƒ se foloseÈ™te)
                        loadTableData(user.uid);     // Pentru carduri
                        dataAlreadyLoaded = true;
                    }
                } else {
                    console.log("Utilizator neautentificat, redirecÈ›ionare...");
                    window.location.href = "login.html";
                }
            });
        }


        const nextButton = document.getElementById("nextButton");
        if (nextButton) nextButton.addEventListener("click", nextStep);

        const prevButton = document.getElementById("prevButton");
        if (prevButton) prevButton.addEventListener("click", previousStep);

        const addButton = document.getElementById("addButton");
        if (addButton) addButton.addEventListener("click", salveazaRaspunsSiGenereazaFeedback);

        const generateLinkButton = document.getElementById("generateLinkButton");
        if (generateLinkButton) generateLinkButton.addEventListener("click", generateCollaborationLink);

    };

    function nextStep() {
        if (currentStep < totalSteps) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function updateProgressBar() {
        const progress = document.getElementById('progress');
        if(progress && totalSteps > 0) { // Adaugat totalSteps > 0
            const progressPercentage = (currentStep / totalSteps) * 100;
            progress.style.width = progressPercentage + '%';
        }
    }

    async function genereazaFeedbackCuGeminiDinFrontend(promptText) {
        if (!geminiModel) {
            console.error("Modelul Gemini nu este iniÈ›ializat. VerificÄƒ cheia API.");
            return "EROARE: Configurare Gemini incorectÄƒ. VerificÄƒ dacÄƒ ai introdus corect cheia API Ã®n cod.";
        }
        try {
            console.log("Trimitere prompt cÄƒtre Gemini:", promptText.substring(0, 100) + "..."); // LogheazÄƒ o parte din prompt
            const result = await geminiModel.generateContent(promptText);
            const response = result.response;
            if (!response || typeof response.text !== 'function') {
                 console.error("RÄƒspuns neaÈ™teptat de la Gemini (nu conÈ›ine text()):", response);
                 return `EROARE Gemini: RÄƒspuns invalid de la API (status ${response?.status || 'necunoscut'}).`;
            }
            const text = response.text();
            return text;
        } catch (error) {
            console.error("Eroare detaliatÄƒ la generarea feedback-ului Gemini:", error);
            let errorMessage = `EROARE Gemini: ${error.message || "Eroare necunoscutÄƒ la comunicarea cu API-ul"}`;
            if (error.message && error.message.toLowerCase().includes("api key not valid")) {
                 errorMessage = "EROARE: Cheia API Gemini nu este validÄƒ sau nu are permisiuni. VerificÄƒ restricÈ›iile din Google Cloud Console (HTTP Referrers, API Restrictions pentru Generative Language API) È™i cheia din cod.";
            } else if (error.message && (error.message.toLowerCase().includes("quota") || (error.status && error.status === 429) )) {
                errorMessage = "EROARE: Limita de utilizare gratuitÄƒ Gemini a fost depÄƒÈ™itÄƒ. ÃŽncearcÄƒ mai tÃ¢rziu.";
            } else if (error.message && error.message.toLowerCase().includes("candidate.finish_reason")){
                errorMessage = "EROARE Gemini: Generarea a fost opritÄƒ din motive de siguranÈ›Äƒ sau alte restricÈ›ii ale modelului.";
            }
            return errorMessage;
        }
    }

    async function genereazaSiProceseazaFeedbackAI(rowData, docId) {
      const prompt = `
AnalizeazÄƒ aceastÄƒ fiÈ™Äƒ de auto-reflecÈ›ie È™i oferÄƒ feedback psihologic structurat. RespectÄƒ cu stricteÈ›e formatul È™i ordinea secÈ›iunilor de mai jos, folosind exact prefixele indicate (ex. "Paragraf:", "ÃŽntrebare:").
1. Paragraf empatic. (ÃŽncepe cu "Paragraf:")
2. O Ã®ntrebare de reflecÈ›ie. (ÃŽncepe cu "ÃŽntrebare:")
3. O recomandare terapeuticÄƒ (CBT, DBT sau mindfulness). (ÃŽncepe cu "Recomandare:")
4. IdentificÄƒ posibile distorsiuni cognitive (ex: suprageneralizare, personalizare). ListeazÄƒ fiecare distorsiune pe un rÃ¢nd nou, precedatÄƒ de '* '. (ÃŽncepe cu "Distorsiuni:")
5. IdentificÄƒ posibile scheme si moduri cognitive implicate, conform schema therapy. ListeazÄƒ fiecare schemÄƒ pe un rÃ¢nd nou, precedatÄƒ de '* '. (ÃŽncepe cu "Scheme:")
6. EvalueazÄƒ dacÄƒ Adultul SÄƒnÄƒtos este prezent È™i cum ar putea fi activat mai mult. (ÃŽncepe cu "Adult SÄƒnÄƒtos:")

Datele introduse de utilizator sunt urmÄƒtoarele:
SituaÈ›ie: ${rowData.situatie  || 'N/A'}
GÃ¢nduri: ${rowData.ganduri || 'N/A'}
EmoÈ›ii: ${rowData.emotii || 'N/A'}
Comportament: ${rowData.comportament || 'N/A'}
Cum ar acÈ›iona Adultul SÄƒnÄƒtos (menÈ›ionat de utilizator): ${rowData.adult_sanatos || 'N/A'}

Te rog sÄƒ rÄƒspunzi doar cu textul cerut conform structurii, fÄƒrÄƒ introduceri sau concluzii suplimentare.`;

      let feedbackText = null;
      let modelFolosit = "N/A";

      if (geminiModel) {
        console.log("Solicitare feedback de la Gemini...");
        modelFolosit = `Gemini (${GEMINI_MODEL_NAME})`;
        feedbackText = await genereazaFeedbackCuGeminiDinFrontend(prompt);
      } else {
        console.warn("Gemini nu este configurat (cheia API lipseÈ™te sau este incorectÄƒ). Nu se poate genera feedback AI.");
        return {
            paragraf: "Serviciul de feedback AI (Gemini) nu este configurat corect. VerificÄƒ cheia API Ã®n codul sursÄƒ.",
            intrebare: "", recomandare: "", distorsiuni: "", scheme: "", adult_sanatos_eval: "",
            model: "Configurare Gemini EronatÄƒ", timestamp: new Date().toISOString()
        };
      }

      if (!feedbackText || feedbackText.startsWith("EROARE:")) {
        console.warn(`Eroare de la ${modelFolosit}:`, feedbackText);
        return {
            paragraf: feedbackText || `Nu s-a putut obÈ›ine feedback de la ${modelFolosit}.`,
            intrebare: "", recomandare: "", distorsiuni: "", scheme: "", adult_sanatos_eval: "",
            model: modelFolosit + " (Eroare API)", timestamp: new Date().toISOString()
        };
      }

      console.log("RÄƒspuns brut de la Gemini:\n---\n" + feedbackText + "\n---");

      const parsedFeedback = {
          paragraf: feedbackText.match(/^Paragraf:\s*([\s\S]*?)(?=\n(?:ÃŽntrebare:|Recomandare:|Distorsiuni:|Scheme:|Adult SÄƒnÄƒtos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'Paragraf'.",
          intrebare: feedbackText.match(/^ÃŽntrebare:\s*([\s\S]*?)(?=\n(?:Recomandare:|Distorsiuni:|Scheme:|Adult SÄƒnÄƒtos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'ÃŽntrebare'.",
          recomandare: feedbackText.match(/^Recomandare:\s*([\s\S]*?)(?=\n(?:Distorsiuni:|Scheme:|Adult SÄƒnÄƒtos:|$))/im)?.[1]?.trim() || "Nu s-a putut extrage 'Recomandare'.",
          distorsiuni: feedbackText.match(/^Distorsiuni:\s*([\s\S]*?)(?=\n(?:Scheme:|Adult SÄƒnÄƒtos:|$))/im)?.[1]?.trim() || "Nu s-au putut extrage 'Distorsiuni'.",
          scheme: feedbackText.match(/^Scheme:\s*([\s\S]*?)(?=\n(?:Adult SÄƒnÄƒtos:|$))/im)?.[1]?.trim() || "Nu s-au putut extrage 'Scheme'.",
          adult_sanatos_eval: feedbackText.match(/^Adult SÄƒnÄƒtos:\s*([\s\S]*?$)/im)?.[1]?.trim() || "Nu s-a putut extrage 'Adult SÄƒnÄƒtos'.",
          model: modelFolosit,
          timestamp: new Date().toISOString()
      };
      
      // Verificare suplimentarÄƒ dacÄƒ toate cÃ¢mpurile parsate sunt mesaje de eroare de la parsare
        let allParsingFailed = true;
        for (const key in parsedFeedback) {
            if (key !== "model" && key !== "timestamp" && typeof parsedFeedback[key] === 'string' && !parsedFeedback[key].startsWith("Nu s-a putut")) {
                allParsingFailed = false;
                break;
            }
        }
        if (allParsingFailed && !feedbackText.startsWith("EROARE:")) {
             console.warn("Parsarea detaliatÄƒ a eÈ™uat pentru toate cÃ¢mpurile. Este posibil ca formatul rÄƒspunsului de la AI sÄƒ nu corespundÄƒ aÈ™teptÄƒrilor. VerificÄƒ promptul È™i regex-urile.");
             // Opcional: poÈ›i afiÈ™a tot textul Ã®ntr-un singur cÃ¢mp dacÄƒ parsarea eÈ™ueazÄƒ complet
             // parsedFeedback.paragraf = `RÄƒspuns neparsat de la ${modelFolosit}:\n${feedbackText.replace(/\n\n/g, "\n").replace(/\n/g, "<br>")}`;
        }


      if (docId) {
          const docRef = doc(db, "raspunsuri", docId);
          try {
              await updateDoc(docRef, {
                  feedback_history: arrayUnion(parsedFeedback),
                  feedback_paragraf: parsedFeedback.paragraf,
                  feedback_intrebare: parsedFeedback.intrebare,
                  feedback_recomandare: parsedFeedback.recomandare,
                  feedback_distorsiuni: parsedFeedback.distorsiuni,
                  feedback_scheme: parsedFeedback.scheme,
                  feedback_adult_eval: parsedFeedback.adult_sanatos_eval,
                  feedback_model: parsedFeedback.model
              });
              console.log(`Feedback AI (${modelFolosit}) salvat pentru docId: ${docId}`);
          } catch (updateError) {
              console.error(`Eroare la actualizarea documentului ${docId} cu feedback AI:`, updateError);
          }
      }
      return parsedFeedback;
    }

    async function salveazaRaspunsSiGenereazaFeedback() { // Am redenumit adaugaInTabel
        const form = document.getElementById("exercitiuForm");
        if (!form.checkValidity()) { // Validare HTML5 de bazÄƒ
            form.reportValidity();
            alert("VÄƒ rugÄƒm completaÈ›i toate cÃ¢mpurile marcate ca obligatorii din pasul curent.");
            return;
        }

        const formData = new FormData(form);
        const rowData = { date: new Date().toLocaleDateString("ro-RO") }; // Formatare data RO
        formData.forEach((value, key) => { rowData[key] = value; });

        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie sÄƒ fiÈ›i autentificat pentru a salva datele.");
            window.location.href = "login.html"; // RedirecÈ›ioneazÄƒ dacÄƒ nu e autentificat
            return;
        }
        rowData.ownerUid = user.uid;

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), rowData);
            rowData.id = docRef.id;
            console.log(`RÄƒspuns salvat cu ID: ${docRef.id}. Se genereazÄƒ feedback AI automat...`);

            const feedbackGenerat = await genereazaSiProceseazaFeedbackAI(rowData, docRef.id);
            
            const docSnapshot = await getDoc(docRef); // Recitim pentru a avea cel mai nou istoric
            if (docSnapshot.exists()) {
                adaugaCard({ id: docSnapshot.id, ...docSnapshot.data() });
            } else { // PuÈ›in probabil, dar ca fallback
                rowData.feedback_history = feedbackGenerat ? [feedbackGenerat] : [];
                adaugaCard(rowData);
            }
            
            form.reset();
            currentStep = 1;
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('form-step-active'));
            document.getElementById('step-1').classList.add('form-step-active');
            updateProgressBar();

            const confirmationMessage = document.getElementById('confirmationMessage');
            if (feedbackGenerat && !feedbackGenerat.paragraf.startsWith("EROARE:") && !feedbackGenerat.paragraf.startsWith("Serviciul") && !feedbackGenerat.paragraf.startsWith("Configurare Gemini EronatÄƒ")) {
                confirmationMessage.textContent = 'Formularul a fost trimis È™i feedback-ul AI generat! ÃŽl puteÈ›i vedea Ã®n cardul de mai jos.';
                confirmationMessage.style.backgroundColor = '#d4edda'; 
                confirmationMessage.style.color = '#155724';
            } else if (feedbackGenerat && feedbackGenerat.paragraf && feedbackGenerat.paragraf.includes("depÄƒÈ™itÄƒ")) { // CautÄƒ cuvÃ¢ntul cheie
                 confirmationMessage.textContent = 'Formularul a fost trimis. Feedback-ul AI nu a putut fi generat din cauza depÄƒÈ™irii limitei de utilizare. VÄƒ rugÄƒm Ã®ncercaÈ›i mai tÃ¢rziu.';
                 confirmationMessage.style.backgroundColor = '#fff3cd';
                 confirmationMessage.style.color = '#664d03';
            } else {
                 confirmationMessage.textContent = `Formularul a fost trimis. ProblemÄƒ la generarea feedback-ului AI: ${feedbackGenerat ? feedbackGenerat.paragraf : 'Eroare necunoscutÄƒ'}`;
                 confirmationMessage.style.backgroundColor = '#f8d7da';
                 confirmationMessage.style.color = '#58151c';
            }
            confirmationMessage.style.display = 'block';
            setTimeout(() => {
                confirmationMessage.style.display = 'none';
                confirmationMessage.style.backgroundColor = '#d4edda'; // Reset default
                confirmationMessage.style.color = '#155724';
            }, 9000);

        } catch (error) {
            console.error("Eroare la salvarea Ã®n Firestore sau generarea feedback-ului AI:", error);
            alert("A apÄƒrut o eroare la salvare. VÄƒ rugÄƒm Ã®ncercaÈ›i din nou.");
        }
    }

    function afiseazaIstoricFeedback(containerElement, feedbackHistory) {
        containerElement.innerHTML = ''; 

        if (feedbackHistory && Array.isArray(feedbackHistory) && feedbackHistory.length > 0) {
            const historyTitle = document.createElement("h4");
            historyTitle.style.color = "#4A90E2";
            historyTitle.style.marginTop = "20px";
            historyTitle.style.marginBottom = "10px";
            historyTitle.textContent = "ðŸ—‚ï¸ Istoric Feedback AI:";
            containerElement.appendChild(historyTitle);

            feedbackHistory.slice().reverse().forEach(entry => { 
                const itemContainer = document.createElement("div");
                itemContainer.className = "feedback-entry-card"; // AdaugÄƒ o clasÄƒ pentru stilizare centralizatÄƒ

                const timestampAndModel = document.createElement("p");
                timestampAndModel.className = "feedback-timestamp";
                timestampAndModel.innerHTML = `<strong>${new Date(entry.timestamp).toLocaleString("ro-RO")}</strong> (Model: ${entry.model || 'N/A'})`;
                itemContainer.appendChild(timestampAndModel);

                const sections = [
                    { title: "âœï¸ Paragraf Empatic", key: "paragraf", isList: false },
                    { title: "â“ ÃŽntrebare de ReflecÈ›ie", key: "intrebare", isList: false },
                    { title: "ðŸ› ï¸ Recomandare TerapeuticÄƒ", key: "recomandare", isList: false },
                    { title: "ðŸ” Distorsiuni Cognitive", key: "distorsiuni", isList: true },
                    { title: "ðŸ§  Scheme Cognitive", key: "scheme", isList: true },
                    { title: "ðŸ§â€â™‚ï¸ Evaluare Adult SÄƒnÄƒtos", key: "adult_sanatos_eval", isList: false }
                ];

                sections.forEach(sectionConfig => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "feedback-section";

                    const sectionTitleElement = document.createElement("h5");
                    sectionTitleElement.textContent = sectionConfig.title + ":";
                    sectionDiv.appendChild(sectionTitleElement);

                    let contentText = entry[sectionConfig.key];

                    if (contentText && typeof contentText === 'string') {
                        const titleWithoutEmoji = sectionConfig.title.replace(/(\p{Emoji_Presentation}|\p{Extended_Pictographic})\s*/gu, '').trim();
                        const redundantTitlePatternGeneric = new RegExp(`^${titleWithoutEmoji.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}:?\\s*`, "im");
                        contentText = contentText.replace(redundantTitlePatternGeneric, "").trim();
                        const redundantKeyPattern = new RegExp(`^${sectionConfig.key.replace("_", " ")}:?\\s*`, "im");
                        contentText = contentText.replace(redundantKeyPattern, "").trim();

                        if (sectionConfig.isList && contentText.includes('*')) {
                            const listElement = document.createElement("ul");
                            const items = contentText.split(/\s*\*\s*/)
                                              .map(item => item.trim())
                                              .filter(item => item.length > 0);
                            items.forEach(itemText => {
                                const listItem = document.createElement("li");
                                listItem.innerHTML = itemText.replace(/\n/g, '<br>');
                                listElement.appendChild(listItem);
                            });
                            sectionDiv.appendChild(listElement);
                        } else {
                            const paragraphElement = document.createElement("p");
                            paragraphElement.innerHTML = contentText.replace(/\n/g, '<br>') || '<i>Indisponibil</i>';
                            sectionDiv.appendChild(paragraphElement);
                        }
                    } else {
                        const unavailableText = document.createElement("p");
                        unavailableText.style.fontStyle = "italic";
                        unavailableText.textContent = "Indisponibil";
                        sectionDiv.appendChild(unavailableText);
                    }
                    itemContainer.appendChild(sectionDiv);
                });
                containerElement.appendChild(itemContainer);
            });
        } else {
            // Nu afiÈ™Äƒm "Niciun feedback" dacÄƒ containerul e gol iniÈ›ial,
            // doar dacÄƒ feedbackHistory e un array gol explicit dupÄƒ o Ã®ncercare.
            // DacÄƒ `feedbackHistory` e undefined, nu afiÈ™Äƒm nimic aici (card nou, fÄƒrÄƒ istoric Ã®ncÄƒ).
        }
    }

   function adaugaCard(rowData) {
      const cardViewContainer = document.getElementById("cardViewContainer");
      // VerificÄƒ dacÄƒ un card cu acest ID existÄƒ deja pentru a evita duplicate la reÃ®ncÄƒrcÄƒri
      const existingCard = cardViewContainer.querySelector(`.response-card[data-id="${rowData.id}"]`);
      if (existingCard) {
           // OpÈ›ional: actualizeazÄƒ istoricul cardului existent dacÄƒ e cazul,
           // deÈ™i acest flux ar trebui sÄƒ creeze cardul o singurÄƒ datÄƒ la Ã®nceput
           // sau la adÄƒugarea unui nou rÄƒspuns.
           console.log("Cardul existÄƒ deja, se actualizeazÄƒ istoricul AI:", rowData.id);
           const historyContainer = existingCard.querySelector('.ai-feedback-history-container');
           if (historyContainer) {
                afiseazaIstoricFeedback(historyContainer, rowData.feedback_history);
           }
           return; // Nu recreÄƒm tot cardul
      }


      const card = document.createElement("div");
      card.className = "response-card";
      card.setAttribute("data-id", rowData.id);
      card.innerHTML = `
        <div class="card-header"> Data: ${rowData.date || ''} - SituaÈ›ia: ${rowData.situatie.substring(0,50) || ''}...</div>
        <div class="card-content">
          <h4>Explorarea situaÈ›iei È™i a nevoilor</h4>
          <p><strong>Care este situaÈ›ia?</strong> ${rowData.situatie || ''}</p>
          <p><strong>Ce Ã®mi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
          <p><strong>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</strong> ${rowData.emotii || ''}</p>
          <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
          <p><strong>Ce comportament simÈ›i cÄƒ adopÈ›i?</strong> ${rowData.comportament || ''}</p>
          <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
          <p><strong>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
          <p><strong>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</strong> ${rowData.adult_sanatos || ''}</p>

          <h4>Analiza gÃ¢ndurilor È™i a percepÈ›iilor</h4>
          <p><strong>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</strong> ${rowData.dovezi_adevar || ''}</p>
          <p><strong>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</strong> ${rowData.dovezi_fals || ''}</p>
          <p><strong>ExistÄƒ o explicaÈ›ie alternativÄƒ?</strong> ${rowData.explicatie_alternativa || ''}</p>
          <p><strong>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</strong> ${rowData.scenariu_negativ || ''}</p>
          <p><strong>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</strong> ${rowData.scenariu_optimist || ''}</p>
          <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
          <p><strong>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</strong> ${rowData.schimbare_gandire || ''}</p>
          <p><strong>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</strong> ${rowData.sfat_prieten || ''}</p>

          <h4>ÃŽntrebÄƒri pentru claritate È™i reflecÈ›ie suplimentarÄƒ</h4>
          <p><strong>VÄƒd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
          <p><strong>ÃŽmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
          <p><strong>MÄƒ condamn Ã®n baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
          <p><strong>Privesc situaÈ›ia Ã®n termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
          <p><strong>Exagerez situaÈ›ia?</strong> ${rowData.exagerare || ''}</p>
          <p><strong>ExistÄƒ È™i alÈ›i factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
          <p><strong>Am sÄƒrit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
          <p><strong>ÃŽmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
          <p><strong>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
          <p><strong>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
          <p><strong>MÄƒ aÈ™tept sÄƒ fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
          
          <div class="card-actions">
              <button class="generate-ai-feedback-button">RegenereazÄƒ Feedback AI</button>
              <button class="delete-button">È˜terge ÃŽnregistrarea</button>
          </div>
          <div class="ai-feedback-history-container">
              <!-- Istoricul AI va fi adÄƒugat aici -->
          </div>
        </div>
      `;

      card.querySelector('.card-header').addEventListener('click', () => {
        card.classList.toggle('open');
      });

      card.querySelector('.delete-button').addEventListener('click', (event) => {
        event.stopPropagation();
        stergeCard(rowData.id, card);
      });

      const generateManualButton = card.querySelector('.generate-ai-feedback-button');
      if (generateManualButton) {
            generateManualButton.addEventListener('click', async (event) => {
                event.stopPropagation(); // Nu propaga click-ul la header-ul cardului
                const button = event.target;
                const originalButtonText = button.textContent;
                button.textContent = 'Se genereazÄƒ...';
                button.disabled = true;
                
                try {
                    console.log(`Regenerare manualÄƒ feedback AI pentru card: ${rowData.id}`);
                    const docSnapshot = await getDoc(doc(db, "raspunsuri", rowData.id)); // Ia ultimele date
                    let currentCardData;
                    if (docSnapshot.exists()) {
                        currentCardData = { id: docSnapshot.id, ...docSnapshot.data() };
                    } else {
                        console.warn("Documentul nu a fost gÄƒsit. Folosim datele locale pentru regenerare.");
                        currentCardData = rowData;
                    }

                    await genereazaSiProceseazaFeedbackAI(currentCardData, currentCardData.id);
                    
                    const updatedDoc = await getDoc(doc(db, "raspunsuri", currentCardData.id));
                    if (updatedDoc.exists()) {
                       afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), updatedDoc.data().feedback_history);
                    }
                } catch (error) {
                    console.error("Eroare la regenerarea manualÄƒ a feedback-ului AI:", error);
                    alert("A apÄƒrut o eroare la regenerarea feedback-ului AI.");
                } finally {
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            });
        }
    
      afiseazaIstoricFeedback(card.querySelector('.ai-feedback-history-container'), rowData.feedback_history);

      if (cardViewContainer.firstChild) {
          cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
      } else {
          cardViewContainer.appendChild(card);
      }
    }

    async function loadTableData(userId, collabIdForLoad = null, ownerIdForCollab = null) {
        if (collabIdForLoad && dataAlreadyLoaded) { // Specific pentru colaborator
            console.log("Datele colaboratorului deja Ã®ncÄƒrcate Ã®n carduri.");
            return;
        }
        
        const cardViewContainer = document.getElementById("cardViewContainer");
        if (cardViewContainer.innerHTML !== '' && !collabIdForLoad && dataAlreadyLoaded) {
            // Pentru utilizatorul normal, dacÄƒ datele sunt deja Ã®ncÄƒrcate, nu le reÃ®ncÄƒrca la fiecare schimbare de stare auth minorÄƒ
            console.log("Cardurile pentru utilizator sunt deja Ã®ncÄƒrcate.");
            // return; // ComenteazÄƒ return dacÄƒ vrei sÄƒ reÃ®mprospÄƒtezi la fiecare onAuthStateChanged (poate fi util)
        }
        
        console.log("ÃŽncÄƒrcare date din Firestore pentru carduri...");
        cardViewContainer.innerHTML = ''; // GoleÈ™te Ã®nainte de a repopula

        try {
            let q;
            if (collabIdForLoad && ownerIdForCollab) {
                console.log(`ÃŽncÄƒrcare date pentru colaborare, owner ID: ${ownerIdForCollab}`);
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", ownerIdForCollab));
            } else if (userId) {
                console.log(`ÃŽncÄƒrcare date pentru utilizatorul: ${userId}`);
                q = query(collection(db, "raspunsuri"), where("ownerUid", "==", userId));
            } else {
                console.warn("Niciun userId sau ownerIdForCollab furnizat pentru loadTableData. Nu se Ã®ncarcÄƒ date.");
                return; // Nu Ã®ncÄƒrca nimic dacÄƒ nu e clar pentru cine
            }

            const querySnapshot = await getDocs(q);
            const documents = [];
            querySnapshot.forEach((doc) => {
                documents.push({ id: doc.id, ...doc.data() });
            });

            documents.sort((a, b) => {
                const dateA = a.date ? new Date(a.date.split('.').reverse().join('-') + "T" + (a.timestamp ? new Date(a.timestamp).toTimeString().split(" ")[0] : "00:00:00")) : new Date(0);
                const dateB = b.date ? new Date(b.date.split('.').reverse().join('-') + "T" + (b.timestamp ? new Date(b.timestamp).toTimeString().split(" ")[0] : "00:00:00")) : new Date(0);
                // Pentru o sortare mai robustÄƒ dacÄƒ ai timestamp complet Ã®n Firestore (de la Date())
                // const timeA = a.firestoreTimestamp ? a.firestoreTimestamp.toDate() : dateA;
                // const timeB = b.firestoreTimestamp ? b.firestoreTimestamp.toDate() : dateB;
                // return timeB - timeA;
                return dateB - dateA; // Sortare descrescÄƒtoare
            });
            
            documents.forEach(docData => {
                adaugaCard(docData);
            });

            if (collabIdForLoad) dataAlreadyLoaded = true; // Specific pentru scenariul de colaborare
            // Pentru utilizatorul normal, dataAlreadyLoaded este gestionat Ã®n onAuthStateChanged

        } catch (error) {
            console.error("Eroare la Ã®ncÄƒrcarea cardurilor din Firestore:", error.message, error.stack);
        }
    }

    async function populateTableData(userId) { // Doar pentru utilizatorul curent, nu pentru colaborare
        // ConsiderÄƒ eliminarea completÄƒ a acestei funcÈ›ii dacÄƒ tabelul nu mai este necesar
        // sau integreaz-o mai bine cu `loadTableData` pentru a evita dubla interogare.
        // Pentru moment, o las cu filtrare, dar este redundantÄƒ dacÄƒ cardurile sunt afiÈ™ate.
        const urlParams = new URLSearchParams(window.location.search);
        const collabIdFromUrl = urlParams.get('collabId');
        if (collabIdFromUrl) { // Tabelul nu e pentru colaboratori
            console.log("Tabelul nu se populeazÄƒ pentru vizualizarea de colaborator.");
            return;
        }

        const tableBody = document.getElementById("tableBody");
        if (!tableBody || !userId) return;
        tableBody.innerHTML = "";

        try {
            const q = query(collection(db, "raspunsuri"), where("ownerUid", "==", userId));
            const querySnapshot = await getDocs(q);
            const docsData = [];
            querySnapshot.forEach(doc => docsData.push({id: doc.id, ...doc.data()}));

            // ... restul logicii de sortare È™i populare tabel (dacÄƒ este Ã®ncÄƒ necesarÄƒ) ...
            console.log("Tabelul a fost populat (dacÄƒ este vizibil).");

        } catch (error) {
            console.error("Eroare la Ã®ncÄƒrcarea Ã®n tabel din Firestore:", error.message);
        }
    }

    window.toggleDetails = function(id) { /* ... cod neschimbat ... */ }

    async function stergeCard(id, cardElement) {
        if (confirm("SunteÈ›i sigur cÄƒ doriÈ›i sÄƒ È™tergeÈ›i aceastÄƒ Ã®nregistrare È™i tot feedback-ul asociat? AceastÄƒ acÈ›iune este ireversibilÄƒ.")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                cardElement.remove();
                console.log(`ÃŽnregistrarea ${id} a fost È™tearsÄƒ.`);
                // ReÃ®mprospÄƒteazÄƒ È™i tabelul dacÄƒ este vizibil È™i relevant
                // populateTableData(auth.currentUser?.uid); // Depinde dacÄƒ vrei asta
            } catch (error) {
                console.error("Eroare la È™tergerea din Firestore:", error);
                alert("Eroare la È™tergerea Ã®nregistrÄƒrii.");
            }
        }
    }

    async function generateCollaborationLink() { /* ... cod neschimbat (asigurÄƒ-te cÄƒ salvezi `ownerUid`) ... */ }

    window.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded - verificÄƒ vizualizarea colaboratorului.");
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (collabId) {
            console.log("Mod colaborare detectat. ID Colaborare:", collabId);
            dataAlreadyLoaded = false; // ReseteazÄƒ pentru colaborator
            // Ascunde elementele care nu sunt pentru colaborator
            ['exercitiuForm', 'generateLinkButton', '.form-container', '.table-container'].forEach(sel => {
                const el = document.querySelector(sel) || document.getElementById(sel);
                if (el) el.style.display = 'none';
            });
            
            const pin = prompt("IntroduceÈ›i codul PIN pentru a accesa aceastÄƒ fiÈ™Äƒ de colaborare:");
            if (!pin) {
                alert("Cod PIN necesar pentru vizualizare.");
                window.location.href = "login.html"; // Sau o paginÄƒ de eroare
                return;
            }

            try {
                const collabDocRef = doc(db, "collaborations", collabId);
                const collabSnapshot = await getDoc(collabDocRef);

                if (collabSnapshot.exists()) {
                    const collabData = collabSnapshot.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect. Se Ã®ncarcÄƒ datele pentru owner:", collabData.owner);
                        // AfiÈ™eazÄƒ un mesaj sau un header specific pentru colaborator
                        const collabHeader = document.createElement('h2');
                        collabHeader.textContent = "Vizualizare FiÈ™Äƒ Colaborare";
                        collabHeader.style.textAlign = "center";
                        collabHeader.style.marginTop = "20px";
                        document.body.insertBefore(collabHeader, document.querySelector('.card-view')); // AdaugÄƒ Ã®nainte de carduri

                        loadTableData(null, collabId, collabData.owner); // ÃŽncarcÄƒ cardurile pentru owner-ul specificat
                    } else {
                        alert("PIN incorect.");
                        window.location.href = "login.html";
                    }
                } else {
                    alert("Link de colaborare invalid sau expirat.");
                    window.location.href = "login.html";
                }
            } catch (error) {
                console.error("Eroare la accesarea datelor de colaborare:", error);
                alert("A apÄƒrut o eroare la accesarea fiÈ™ei. VÄƒ rugÄƒm Ã®ncercaÈ›i mai tÃ¢rziu.");
                window.location.href = "login.html";
            }
        }
        // Logica pentru utilizatorul normal (non-collab) este gestionatÄƒ Ã®n onAuthStateChanged
    });
    </script>
    <style>
        /* ... STILURILE TALE EXISTENTE (INCLUSIV .feedback-section, etc.) ... */
        body {
            font-family: 'Roboto', 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(to right, #ece9e6, #ffffff);
            color: #333;
            box-sizing: border-box;
        }
        .form-container {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 16px 24px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 3px solid #87CEFA;
            transition: transform 0.3s ease;
        }
        .form-container:hover {
            transform: scale(1.01);
        }
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress {
            height: 20px;
            width: 0;
            background-color: #87CEFA;
            transition: width 0.4s ease;
        }
        .question-card {
            margin-bottom: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .question-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .question-card h3 {
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .question-card p {
            font-weight: 300;
            font-size: 0.95em;
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }
        textarea {
            width: calc(100% - 22px);
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
            min-height: 60px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }
        textarea:focus {
            border-color: #87CEFA;
            box-shadow: 0 2px 8px rgba(135, 206, 250, 0.5);
            outline: none;
        }
        input[type="submit"], button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: 500;
            background: linear-gradient(to right, #87CEFA, #6bb9e7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        input[type="submit"]:hover, button:hover {
            background: linear-gradient(to right, #6bb9e7, #4A90E2);
            transform: translateY(-2px);
        }
        .form-step { display: none; }
        .form-step-active { display: block; animation: fadeIn 0.7s ease-in-out; }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .step-navigation { text-align: center; margin-top: 20px; }
        .step-navigation button { margin: 0 10px; }
        .table-container { /* ... stiluri tabel dacÄƒ e folosit ... */ }
        .card-view { display: flex; flex-direction: column; gap: 20px; max-width: 900px; margin: 30px auto; }
        .response-card { background: #f9f9ff; padding: 0; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.12); transition: box-shadow 0.3s ease; position: relative; overflow: hidden; }
        .response-card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.18); }
        .response-card .card-header { font-weight: 700; font-size: 1.1em; cursor: pointer; background: #87CEFA; padding: 12px 20px; color: #fff; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .response-card .card-header::after { content: 'â–¼'; font-size: 0.8em; transition: transform 0.3s ease; }
        .response-card.open .card-header::after { transform: rotate(180deg); }
        .response-card .card-content { max-height: 0; margin-top: 0; padding: 0 20px; background: #fff; line-height: 1.6; overflow: auto; transition: max-height 0.4s ease-out, padding-top 0.4s ease-out, padding-bottom 0.4s ease-out; }
        .response-card.open .card-content { max-height: 1500px; /* MÄƒrit pentru mai mult conÈ›inut */ padding-top: 15px; padding-bottom: 15px; }
        .response-card .card-content p { margin-bottom: 12px; border-left: 3px solid #87CEFA; padding-left: 10px; }
        .response-card .card-content p strong { color: #333; }
        .response-card h4 { text-align: left; color: #4A90E2; font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 1.05em; }
        .response-card h4:first-child { margin-top: 0; }
        .card-actions { text-align: center; margin-top: 20px; padding-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .card-actions button { padding: 8px 15px; font-size: 0.9em; margin: 5px; }
        .generate-ai-feedback-button { background: #5cb85c; }
        .generate-ai-feedback-button:hover { background: #4cae4c; }
        .delete-button { background-color: #f44336 !important; }
        .delete-button:hover { background-color: #d32f2f !important; }
        #confirmationMessage { display: none; text-align: center; padding: 15px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px; margin-top: 20px; animation: fadeIn 0.5s; }
        .collaboration-section { text-align: center; margin-top: 30px; padding-bottom: 20px; }
        .collaboration-section button { background-color: #f0ad4e; }
        .collaboration-section button:hover { background-color: #ec971f; }

        /* Stiluri pentru cardul de feedback istoric */
        .feedback-entry-card {
            background: #eef6ff;
            padding: 15px;
            border-left: 4px solid #4A90E2;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .feedback-timestamp {
            color: #555;
            font-size: 0.9em;
            margin-bottom: 12px;
        }
        .feedback-section {
            margin-bottom: 12px;
        }
        .feedback-section h5 {
            font-size: 1em;
            font-weight: bold;
            color: #2c5282; /* O nuanÈ›Äƒ de albastru-gri Ã®nchis */
            margin-top: 0;
            margin-bottom: 6px;
        }
        .feedback-section p,
        .feedback-section ul {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1e293b;
        }
        .feedback-section ul {
            padding-left: 25px;
            list-style-position: outside;
            list-style-type: disc;
        }
        .feedback-section li {
            margin-bottom: 4px;
        }

        /* Responsive adjustments */
        /* ... Include aici TOATE regulile tale @media ... */
        @media (max-width: 768px) { /* Exemplu, copiazÄƒ toate stilurile tale responsive */
            body { padding: 10px; }
            .form-container, .card-view { padding: 15px; margin-left: 10px; margin-right: 10px; max-width: calc(100% - 20px);  }
            /* ... continuÄƒ cu restul ... */
        }

    </style>
</head>
<body>

    <div class="form-container">
        <h2>FiÈ™Äƒ Monitorizare</h2>
        <p>CompleteazÄƒ fiecare Ã®ntrebare pentru a Ã®nÈ›elege mai bine situaÈ›iile tale...</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm" novalidate> <!-- AdÄƒugat novalidate pentru a controla validarea prin JS dacÄƒ e cazul -->
            <!-- Pasul 1: Explorarea situaÈ›iei È™i a nevoilor -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situaÈ›ia?</h3>
                <p>Descrie contextul care a declanÈ™at emoÈ›iile sau comportamentul...</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce Ã®mi trece prin minte?</h3>
                <p>IdentificÄƒ gÃ¢ndurile automate...</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mÄƒ face acel gÃ¢nd sÄƒ mÄƒ simt?</h3>
                <p>NoteazÄƒ emoÈ›iile pe care le simÈ›i...</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>IdentificÄƒ modul Ã®n care te afli...</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simÈ›i cÄƒ adopÈ›i?</h3>
                <p>Descrie comportamentul pe care Ã®l manifeÈ™ti...</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoÈ›ii È™i comportamente? ...</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>MÄƒ ajutÄƒ comportamentul meu sÄƒ Ã®ndeplinesc aceste nevoi?</h3>
                <p>ReflecteazÄƒ dacÄƒ felul Ã®n care reacÈ›ionezi te ajutÄƒ...</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gÃ¢ndi È™i cum s-ar comporta Adultul SÄƒnÄƒtos?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ar reacÈ›iona partea ta AdultÄƒ SÄƒnÄƒtoasÄƒ...</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- Pasul 2: Analiza gÃ¢ndurilor È™i a percepÈ›iilor -->
             <div class="question-card form-step" id="step-9">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ gÃ¢ndul automat este adevÄƒrat?</h3>
                <p>ExploreazÄƒ motivele pentru care crezi cÄƒ acest gÃ¢nd este adevÄƒrat...</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mÄƒ face sÄƒ cred cÄƒ nu este adevÄƒrat?</h3>
                <p>Acum, sÄƒ ne uitÄƒm la dovezile Ã®mpotriva gÃ¢ndului tÄƒu...</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>ExistÄƒ o explicaÈ›ie alternativÄƒ?</h3>
                <p>Uneori, existÄƒ mai multe explicaÈ›ii pentru ceea ce se Ã®ntÃ¢mplÄƒ...</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rÄƒu lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Ce este cel mai rÄƒu care ar putea avea loc Ã®n aceastÄƒ situaÈ›ie?...</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea Ã®ntÃ¢mpla?</h3>
                <p>Pe de altÄƒ parte, care ar fi cel mai pozitiv scenariu?...</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>DupÄƒ ce am explorat extremele, ce crezi cÄƒ este cel mai probabil sÄƒ se Ã®ntÃ¢mple?...</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar Ã®ntÃ¢mpla dacÄƒ mi-aÈ™ schimba modul de gÃ¢ndire?</h3>
                <p>ÃŽntreabÄƒ-te cum ar fi dacÄƒ ai aborda situaÈ›ia cu un alt tip de gÃ¢ndire...</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aÈ™ spune unui prieten dacÄƒ ar fi Ã®n aceeaÈ™i situaÈ›ie?</h3>
                <p>GÃ¢ndeÈ™te-te la cum ai reacÈ›iona dacÄƒ un prieten drag ar avea aceleaÈ™i gÃ¢nduri...</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- Pasul 3: ÃŽntrebÄƒri pentru claritate È™i reflecÈ›ie suplimentarÄƒ -->
            <div class="question-card form-step" id="step-17">
                <h3>VÄƒd doar partea rea a lucrurilor?</h3>
                <p>Este posibil sÄƒ fii prins Ã®ntr-un tipar negativ de gÃ¢ndire...</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-18">
                <h3>ÃŽmi asum responsabilitatea pentru lucruri care nu au stat Ã®n puterea mea?</h3>
                <p>ReflecteazÄƒ dacÄƒ Ã®È›i asumi responsabilitatea pentru situaÈ›ii...</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>MÄƒ condamn Ã®n baza unui singur eveniment?</h3>
                <p>ÃŽÈ›i evaluezi valoarea personalÄƒ bazÃ¢ndu-te pe un singur eveniment negativ?...</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situaÈ›ia Ã®n termeni extremi?</h3>
                <p>VerificÄƒ dacÄƒ vezi situaÈ›ia doar Ã®n alb sau negru...</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situaÈ›ia?</h3>
                <p>ÃŽÈ›i amplifici reacÈ›iile faÈ›Äƒ de o situaÈ›ie?...</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>ExistÄƒ È™i alÈ›i factori responsabili?</h3>
                <p>ExistÄƒ alÈ›i factori care contribuie la aceastÄƒ situaÈ›ie...</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sÄƒrit direct la concluzii?</h3>
                <p>Te-ai grÄƒbit sÄƒ ajungi la o concluzie fÄƒrÄƒ suficiente dovezi?...</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-24">
                <h3>ÃŽmi pun Ã®ntrebÄƒri fÄƒrÄƒ rÄƒspuns?</h3>
                <p>Te frÄƒmÃ¢ntÄƒ Ã®ntrebÄƒri care nu au un rÄƒspuns clar sau realist?...</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>MÄƒ concentrez doar asupra slÄƒbiciunilor mele?</h3>
                <p>Ai tendinÈ›a sÄƒ te focalizezi doar pe slÄƒbiciuni...</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>MÄƒ zbat prea mult gÃ¢ndind la cum ar trebui sÄƒ fie lucrurile?</h3>
                <p>Ai tendinÈ›a sÄƒ te gÃ¢ndeÈ™ti mereu la cum ar trebui sÄƒ fie lucrurile...</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
             <div class="question-card form-step" id="step-27">
                <h3>MÄƒ aÈ™tept sÄƒ fiu perfect?</h3>
                <p>ÃŽÈ›i setezi standarde foarte Ã®nalte, imposibil de atins?...</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-28">
                <h3>Completare finalizatÄƒ!</h3>
                <p>FelicitÄƒri pentru parcurgerea acestui exerciÈ›iu de auto-reflecÈ›ie! Nu uita sÄƒ salvezi datele apÄƒsÃ¢nd butonul de mai jos.</p>
                <p>Feedback-ul AI te poate ajuta sÄƒ obÈ›ii noi perspective. DacÄƒ Ã®ntÃ¢mpini probleme cu generarea feedback-ului (ex: erori de limitÄƒ), poÈ›i Ã®ncerca din nou mai tÃ¢rziu.</p>
            </div>

            <div class="step-navigation">
                <button type="button" id="prevButton">ÃŽnapoi</button>
                <button type="button" id="nextButton">ÃŽnainte</button>
            </div>
            <button type="button" id="addButton">SalveazÄƒ È™i GenereazÄƒ Feedback AI</button>
        </form>

        <div id="confirmationMessage">
            <!-- Mesajul va fi setat de JavaScript -->
        </div>

        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">GenereazÄƒ Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">RÄƒspunsurile Tale È™i Istoricul Feedback-ului AI:</h3>
    
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile cu rÄƒspunsuri È™i feedback AI vor fi adÄƒugate aici de JavaScript -->
    </div>
    
    <div class="table-container" style="display: none;"> <!-- Ascuns implicit, Ã®l poÈ›i activa dacÄƒ e necesar -->
        <table>
            <thead>
                <tr>
                    <th>Data</th><th>SituaÈ›ia</th><th>GÃ¢nduri</th><th>EmoÈ›ii</th><th>Mod activ</th>
                    <th>Comportament</th><th>Nevoile</th><th>Ajutor comport.</th><th>Adult SÄƒnÄƒtos</th><th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <br/>
    
</body>
</html>