<!DOCTYPE html>
<html>
<head>
    <title>Fișă Monitorizare - Psiho</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    // AM MODIFICAT AICI: Adăugat updateDoc și arrayUnion și am combinat importurile pentru Firestore
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, updateDoc, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Configurarea Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBn2bojEoV4_icF4fVVKFdJN1YjDhtlG98",
        authDomain: "personaltrainer-74ea4.firebaseapp.com",
        projectId: "personaltrainer-74ea4",
        storageBucket: "personaltrainer-74ea4.appspot.com",
        messagingSenderId: "591778567441",
        appId: "1:591778567441:web:bbaeac19a3fb0f190668b0",
        measurementId: "G-WLWNGNDK5V",
    };

    // Inițializare Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentStep = 1;
    let totalSteps = 0;

    window.onload = function () {
    totalSteps = document.querySelectorAll('.form-step').length;
    updateProgressBar();
    const urlParams = new URLSearchParams(window.location.search);
    const collabId = urlParams.get('collabId');
    
    if (!collabId) {
        populateTableData();
    }

    const nextButton = document.getElementById("nextButton");
    if (nextButton) {
        nextButton.addEventListener("click", nextStep);
    }

    const prevButton = document.getElementById("prevButton");
    if (prevButton) {
        prevButton.addEventListener("click", previousStep);
    }

    const addButton = document.getElementById("addButton");
    if (addButton) {
        addButton.addEventListener("click", adaugaInTabel);
    }

    const generateLinkButton = document.getElementById("generateLinkButton");
    if (generateLinkButton) {
        generateLinkButton.addEventListener("click", generateCollaborationLink);
    }

    if (!collabId) {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Utilizator autentificat:", user.uid);
            } else {
                console.log("Utilizator neautentificat");
                window.location.href = "login.html";
            }
        });
    }
};

    function nextStep() {
        if (currentStep < totalSteps) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            document.getElementById(`step-${currentStep}`).classList.remove('form-step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.add('form-step-active');
            updateProgressBar();
        }
    }

    function updateProgressBar() {
        const progress = document.getElementById('progress');
        const progressPercentage = (currentStep / totalSteps) * 100;
        progress.style.width = progressPercentage + '%';
    }

    // Funcția genereazaFeedbackAI este deja prezentă și corect implementată în fișierul original
    // Ne asigurăm că este aici și că folosește updateDoc și arrayUnion (importate mai sus)
    async function genereazaFeedbackAI(rowData, docId = null) {
      const prompt = `
Analizează această fișă de auto-reflecție și oferă feedback psihologic structurat:
1. ✍️ Un paragraf empatic.
2. ❓ O întrebare de reflecție.
3. 🛠️ O recomandare terapeutică (CBT, DBT sau mindfulness).
4. 🔍 Identifică posibile distorsiuni cognitive (ex: suprageneralizare, personalizare).
5. 🧠 Identifică posibile scheme si moduri cognitive implicate, conform schema therapy (ex: eșec, neajutorare, neacceptare, defectivitate, abandon, deprivare).
6. 🧍‍♂️ Evaluează dacă Adultul Sănătos este prezent și cum ar putea fi activat mai mult.

Date:
Situație: ${rowData.situatie}
Gânduri: ${rowData.ganduri}
Emoții: ${rowData.emotii}
Comportament: ${rowData.comportament}
Adult sănătos: ${rowData.adult_sanatos}

Format răspuns:
Paragraf: ...
Întrebare: ...
Recomandare: ...
Distorsiuni: ...
Scheme: ...
Adult Sănătos: ...`;

      const models = [
        { name: "mistralai/mistral-7b-instruct:free", label: "Mistral" },
        { name: "deepseek-ai/deepseek-chat:free", label: "DeepSeek" }
      ];

      // Folosim cheia API deja prezentă în fișierul original
      const openRouterApiKey = "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";

      for (const model of models) {
        try {
          const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${openRouterApiKey}`, // Am folosit variabila pentru cheie
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: model.name,
              messages: [{ role: "user", content: prompt }],
              temperature: 0.7
            })
          });

          const data = await response.json();
          if (data.choices && data.choices.length > 0 && data.choices[0].message) {
            const content = data.choices[0].message.content.trim();

            const feedback = {
              paragraf: content.match(/Paragraf:\s*(.+?)\n/i)?.[1] || "Nu s-a putut extrage paragraful.",
              intrebare: content.match(/Întrebare:\s*(.+?)\n/i)?.[1] || "Nu s-a putut extrage întrebarea.",
              recomandare: content.match(/Recomandare:\s*(.+?)\n/i)?.[1] || "Nu s-a putut extrage recomandarea.",
              distorsiuni: content.match(/Distorsiuni:\s*(.+?)\n/i)?.[1] || "Nu s-au putut extrage distorsiunile.",
              scheme: content.match(/Scheme:\s*(.+?)\n/i)?.[1] || "Nu s-au putut extrage schemele.",
              adult_sanatos_eval: content.match(/Adult Sănătos:\s*(.+)$/i)?.[1] || "Nu s-a putut extrage evaluarea Adultului Sănătos.",
              model: model.label,
              timestamp: new Date().toISOString()
            };

            if (docId) {
              const docRef = doc(db, "raspunsuri", docId);
              await updateDoc(docRef, {
                feedback_history: arrayUnion(feedback), // arrayUnion este acum importat
                // Se salvează și ultimul feedback în câmpuri separate, conform codului original
                feedback_paragraf: feedback.paragraf,
                feedback_intrebare: feedback.intrebare,
                feedback_recomandare: feedback.recomandare,
                feedback_distorsiuni: feedback.distorsiuni,
                feedback_scheme: feedback.scheme,
                feedback_adult_eval: feedback.adult_sanatos_eval,
                feedback_model: feedback.model
              });
              console.log(`Feedback AI de la ${model.label} salvat pentru docId: ${docId}`);
            }
            return feedback; // Returnează primul feedback reușit
          } else {
             console.warn(`Răspuns neașteptat de la modelul ${model.label}:`, data);
          }
        } catch (error) {
          console.warn(`Modelul ${model.label} a eșuat sau a returnat un format neașteptat:`, error);
        }
      }

      console.log("Toate modelele AI au eșuat sau nu au returnat feedback valid.");
      return { // Feedback de fallback
        paragraf: "Feedback indisponibil momentan din cauza unei erori la procesare.",
        intrebare: "",
        recomandare: "",
        distorsiuni: "",
        scheme: "",
        adult_sanatos_eval: "",
        model: "N/A",
        timestamp: new Date().toISOString()
      };
    }

    // AM MODIFICAT AICI: adaugareInTabel apelează genereazaFeedbackAI
    async function adaugaInTabel() {
        const form = document.getElementById("exercitiuForm");
        const formData = new FormData(form);
        const rowData = { date: new Date().toLocaleDateString() };

        formData.forEach((value, key) => {
            rowData[key] = value;
        });

        try {
            const docRef = await addDoc(collection(db, "raspunsuri"), rowData);
            rowData.id = docRef.id; // Salvăm id-ul generat
            console.log(`Răspuns salvat cu ID: ${docRef.id}. Se generează feedback AI...`);

            // Generează și salvează feedback-ul AI
            const feedbackGenerat = await genereazaFeedbackAI(rowData, docRef.id);
            
            // Adaugă feedback-ul generat la rowData.feedback_history pentru afișare imediată în card
            // Funcția genereazaFeedbackAI deja salvează în Firestore folosind arrayUnion.
            // Aici doar actualizăm obiectul local rowData pentru ca adaugaCard să-l afișeze imediat.
            if (feedbackGenerat) { // feedbackGenerat va exista mereu, chiar și cel de fallback
                if (!rowData.feedback_history) {
                    rowData.feedback_history = [];
                }
                rowData.feedback_history.push(feedbackGenerat); // Adăugăm la istoric pentru afișarea imediată
            }

            adaugaCard(rowData); // rowData acum conține id-ul și feedback-ul AI în feedback_history
            
            form.reset();
            currentStep = 1;
            // Găsește elementul activ curent și elimină clasa, apoi adaugă la primul pas
            const activeStep = document.querySelector('.form-step-active');
            if (activeStep) {
                activeStep.classList.remove('form-step-active');
            }
            document.getElementById('step-1').classList.add('form-step-active');
            updateProgressBar();

            document.getElementById('confirmationMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('confirmationMessage').style.display = 'none';
            }, 5000);
        } catch (error) {
            console.error("Eroare la salvarea în Firestore sau generarea feedback-ului AI:", error);
            // Afișează un mesaj de eroare utilizatorului, dacă este cazul
            alert("A apărut o eroare la salvarea datelor sau generarea feedback-ului. Vă rugăm încercați din nou.");
        }
    }

   // AM MODIFICAT AICI: în adaugaCard, feedback_history este iterat în ordine inversă (cel mai nou primul)
   function adaugaCard(rowData) {
      const existingCard = document.querySelector(`[data-id="${rowData.id}"]`);
      if (existingCard) { // Dacă există deja, posibil actualizăm doar conținutul dacă e necesar
          // Pentru simplitate, dacă există, nu facem nimic (previne duplicatele la reîncărcări simple)
          // Dacă ar trebui actualizat, ar fi nevoie de o logică mai complexă aici.
          return;
      }

      const cardViewContainer = document.getElementById("cardViewContainer");
      const card = document.createElement("div");
      card.className = "response-card";
      card.setAttribute("data-id", rowData.id);
      card.innerHTML = `
        <div class="card-header"> Data: ${rowData.date || ''} - Situația: ${rowData.situatie || ''}</div>
        <div class="card-content">
          <h4>Explorarea situației și a nevoilor</h4>
          <p><strong>Care este situația?</strong> ${rowData.situatie || ''}</p>
          <p><strong>Ce îmi trece prin minte?</strong> ${rowData.ganduri || ''}</p>
          <p><strong>Cum mă face acel gând să mă simt?</strong> ${rowData.emotii || ''}</p>
          <p><strong>Ce mod este activ?</strong> ${rowData.mod_activ || ''}</p>
          <p><strong>Ce comportament simți că adopți?</strong> ${rowData.comportament || ''}</p>
          <p><strong>Care sunt nevoile tale mai profunde?</strong> ${rowData.nevoi_profunde || ''}</p>
          <p><strong>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</strong> ${rowData.ajutor_comportament || ''}</p>
          <p><strong>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</strong> ${rowData.adult_sanatos || ''}</p>

          <h4>Analiza gândurilor și a percepțiilor</h4>
          <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
          <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
          <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
          <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
          <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
          <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
          <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
          <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>

          <h4>Întrebări pentru claritate și reflecție suplimentară</h4>
          <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
          <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
          <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
          <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
          <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
          <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
          <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
          <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
          <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
          <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
          <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
          <button class="delete-button">Șterge</button>
        </div>
      `;

      card.querySelector('.card-header').addEventListener('click', () => {
        card.classList.toggle('open');
      });
      card.querySelector('.delete-button').addEventListener('click', (event) => {
        event.stopPropagation(); // Previne declanșarea toggle-ului cardului
        stergeCard(rowData.id, card);
      });

      // Secțiunea pentru afișarea istoricului de feedback AI (deja existentă în HTML-ul original)
      if (rowData.feedback_history && Array.isArray(rowData.feedback_history) && rowData.feedback_history.length > 0) {
        const historyDiv = document.createElement("div");
        historyDiv.innerHTML = `<h4 style="color: #4A90E2; margin-top:15px;">🗂️ Istoric Feedback AI:</h4>`;
        // Modificat aici pentru a afișa cel mai nou feedback primul
        rowData.feedback_history.slice().reverse().forEach(entry => {
          const item = document.createElement("div");
          item.style.marginBottom = "10px";
          // Stilul este deja în <p>, dar putem adăuga și aici dacă e necesar
          item.innerHTML = `
            <p style="background: #eef6ff; padding: 10px; border-left: 4px solid #4A90E2; border-radius: 5px; margin-bottom: 5px;">
              <strong>${new Date(entry.timestamp).toLocaleString()}</strong> (Model: ${entry.model || 'N/A'})<br>
              ✍️ ${entry.paragraf || '<i>Indisponibil</i>'}<br>
              ❓ ${entry.intrebare || '<i>Indisponibil</i>'}<br>
              🛠️ ${entry.recomandare || '<i>Indisponibil</i>'}<br>
              🔍 <strong>Distorsiuni:</strong> ${entry.distorsiuni || '<i>Indisponibil</i>'}<br>
              🧠 <strong>Scheme:</strong> ${entry.scheme || '<i>Indisponibil</i>'}<br>
              🧍‍♂️ <strong>Adult Sănătos:</strong> ${entry.adult_sanatos_eval || '<i>Indisponibil</i>'}
            </p>
          `;
          historyDiv.appendChild(item);
        });
        card.querySelector(".card-content").appendChild(historyDiv);
      }

      // Adaugă cardul la începutul containerului pentru a vedea cel mai nou răspuns primul
      if (cardViewContainer.firstChild) {
          cardViewContainer.insertBefore(card, cardViewContainer.firstChild);
      } else {
          cardViewContainer.appendChild(card);
      }
    }

    let dataAlreadyLoaded = false; 

    async function loadTableData(collabId, pin) {
    if (dataAlreadyLoaded && collabId) { // Pentru colaborator, prevenim reîncărcarea multiplă
        console.log("Datele colaboratorului au fost deja încărcate.");
        return;
    }

    console.log("Încărcare date din Firestore...");
    
    try {
        // Pentru colaborator, ar trebui să existe o logică specifică de filtrare a datelor,
        // dar funcția existentă nu o implementează. Momentan, va încărca toate răspunsurile.
        // Acest aspect ar necesita o revizuire a logicii de colaborare dacă datele trebuie filtrate per colaborare.
        const querySnapshot = await getDocs(collection(db, "raspunsuri"));

        const cardViewContainer = document.getElementById("cardViewContainer");
        cardViewContainer.innerHTML = ''; // Curăță cardurile existente înainte de a le reîncărca

        const documents = [];
        querySnapshot.forEach((doc) => {
            documents.push({ id: doc.id, ...doc.data() });
        });

        // Sortează documentele descrescător după dată (cel mai nou primul)
        documents.sort((a, b) => {
            const dateA = new Date(a.date.split('.').reverse().join('-')); // Format DD.MM.YYYY to YYYY-MM-DD
            const dateB = new Date(b.date.split('.').reverse().join('-'));
            return dateB - dateA; // Descending
        });
        
        documents.forEach(rowData => {
            adaugaCard(rowData);
        });

        if (collabId) dataAlreadyLoaded = true; // Marcăm că datele au fost încărcate pentru colaborator
    } catch (error) {
        console.error("Eroare la încărcarea din Firestore:", error.message);
    }
}

async function populateTableData(collabIdForLoad, pinForLoad) { // Am redenumit parametrii pentru a evita confuzia
        // Dacă este colaborator, lăsăm loadTableData să se ocupe de afișarea cardurilor
        // populateTableData este mai mult pentru vizualizarea tabelară, care este ascunsă implicit
        // și poate fi eliminată sau adaptată dacă nu mai este relevantă.
        // Momentan, o las să încarce datele în tabel, deși cardurile sunt prioritare.

        // Verificăm dacă e un colaborator și dacă datele au fost deja încărcate de loadTableData specific pentru colaborare
        const urlParams = new URLSearchParams(window.location.search);
        const collabIdFromUrl = urlParams.get('collabId');
        if (collabIdFromUrl && dataAlreadyLoaded) {
            console.log("Datele pentru colaborator sunt deja afișate în carduri, tabelul nu se populează separat.");
            return;
        }


        try {
            const querySnapshot = await getDocs(collection(db, "raspunsuri"));
            const tableBody = document.getElementById("tableBody");
            if (!tableBody) return; // Ieșim dacă tabelul nu există (poate fi eliminat din HTML)
            tableBody.innerHTML = "";

            const docsData = [];
            querySnapshot.forEach(doc => docsData.push({id: doc.id, ...doc.data()}));

            // Sortează documentele descrescător după dată (cel mai nou primul)
             docsData.sort((a, b) => {
                // Asumăm că a.date și b.date sunt stringuri în format 'DD.MM.YYYY'
                // Convertim în format comparabil (YYYYMMDD sau obiect Date)
                const datePartsA = a.date.split('.');
                const dateA = new Date(`${datePartsA[2]}-${datePartsA[1]}-${datePartsA[0]}`);
                const datePartsB = b.date.split('.');
                const dateB = new Date(`${datePartsB[2]}-${datePartsB[1]}-${datePartsB[0]}`);
                return dateB - dateA; // Pentru sortare descrescătoare
            });


            docsData.forEach((data) => {
                const rowData = data; // deja e data()
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td data-label="Data">${rowData.date || ''}</td>
                    <td data-label="Situația">${rowData.situatie || ''}</td>
                    <td data-label="Gânduri">${rowData.ganduri || ''}</td>
                    <td data-label="Emoții">${rowData.emotii || ''}</td>
                    <td data-label="Mod activ">${rowData.mod_activ || ''}</td>
                    <td data-label="Comportament">${rowData.comportament || ''}</td>
                    <td data-label="Nevoile">${rowData.nevoi_profunde || ''}</td>
                    <td data-label="Ajutor comport.">${rowData.ajutor_comportament || ''}</td>
                    <td data-label="Adult Sănătos">${rowData.adult_sanatos || ''}</td>
                    <td><button onclick="window.toggleDetails('${data.id}')">Extinde</button></td>
                `;
                tableBody.appendChild(row);

                const detailRow = document.createElement("tr");
                detailRow.id = `details-${data.id}`;
                detailRow.style.display = "none";
                detailRow.innerHTML = `
                    <td colspan="10">
                        <div class="detail-card styled-detail-card">
                            <h4>Explorarea gândurilor și a percepțiilor</h4>
                            <p><strong>Ce mă face să cred că gândul automat este adevărat?</strong> ${rowData.dovezi_adevar || ''}</p>
                            <p><strong>Ce mă face să cred că nu este adevărat?</strong> ${rowData.dovezi_fals || ''}</p>
                            <p><strong>Există o explicație alternativă?</strong> ${rowData.explicatie_alternativa || ''}</p>
                            <p><strong>Care este cel mai rău lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_negativ || ''}</p>
                            <p><strong>Care este cel mai bun lucru care s-ar putea întâmpla?</strong> ${rowData.scenariu_optimist || ''}</p>
                            <p><strong>Care este cel mai realist rezultat?</strong> ${rowData.rezultat_realist || ''}</p>
                            <p><strong>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</strong> ${rowData.schimbare_gandire || ''}</p>
                            <p><strong>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</strong> ${rowData.sfat_prieten || ''}</p>
                            <h4>Întrebări pentru claritate și reflecție suplimentară</h4>
                            <p><strong>Văd doar partea rea a lucrurilor?</strong> ${rowData.partea_rea || ''}</p>
                            <p><strong>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</strong> ${rowData.responsabilitate || ''}</p>
                            <p><strong>Mă condamn în baza unui singur eveniment?</strong> ${rowData.condamnare || ''}</p>
                            <p><strong>Privesc situația în termeni extremi?</strong> ${rowData.termeni_extremi || ''}</p>
                            <p><strong>Exagerez situația?</strong> ${rowData.exagerare || ''}</p>
                            <p><strong>Există și alți factori responsabili?</strong> ${rowData.factori_responsabili || ''}</p>
                            <p><strong>Am sărit direct la concluzii?</strong> ${rowData.concluzii || ''}</p>
                            <p><strong>Îmi pun întrebări fără răspuns?</strong> ${rowData.intrebari_fara_raspuns || ''}</p>
                            <p><strong>Mă concentrez doar asupra slăbiciunilor mele?</strong> ${rowData.slabiciuni || ''}</p>
                            <p><strong>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</strong> ${rowData.cum_ar_trebui || ''}</p>
                            <p><strong>Mă aștept să fiu perfect?</strong> ${rowData.perfectiune || ''}</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(detailRow);
            });
            // Cardurile sunt încărcate de loadTableData, care e apelat din DOMContentLoaded pentru colaboratori
            // sau din window.onload pentru utilizatorul normal.
            // Asigurăm consistența prin apelarea loadTableData pentru încărcarea cardurilor.
            if (!collabIdFromUrl) { // Dacă nu e colaborator, încărcăm și cardurile.
                 loadTableData();
            }

        } catch (error) {
            console.error("Eroare la încărcarea în tabel din Firestore:", error.message);
        }
    }

    window.toggleDetails = function(id) {
        const detailRow = document.getElementById(`details-${id}`);
        if (detailRow.style.display === "none") {
            detailRow.style.display = "table-row";
        } else {
            detailRow.style.display = "none";
        }
    }

    async function stergeCard(id, cardElement) {
        if (confirm("Sunteți sigur că doriți să ștergeți această înregistrare?")) {
            try {
                await deleteDoc(doc(db, "raspunsuri", id));
                cardElement.remove();
                // Reîmprospătează și tabelul dacă este vizibil și relevant
                populateTableData(); 
            } catch (error) {
                console.error("Eroare la ștergerea din Firestore:", error);
                alert("Eroare la ștergerea înregistrării.");
            }
        }
    }

    async function generateCollaborationLink() {
        const user = auth.currentUser;
        if (!user) {
            alert("Trebuie să fiți autentificat pentru a genera un link de colaborare.");
            return;
        }

        const existingCollabQuery = query(
            collection(db, "collaborations"),
            where("owner", "==", user.uid)
        );

        const querySnapshot = await getDocs(existingCollabQuery);
        if (!querySnapshot.empty) {
            const collabDoc = querySnapshot.docs[0];
            const collaborationLink = `${window.location.origin}${window.location.pathname}?collabId=${collabDoc.id}`;
            prompt(`Link de colaborare existent (PIN: ${collabDoc.data().pin}). Distribuiți acest link și codul PIN pentru acces:`, collaborationLink);
            return;
        }

        const pinCode = prompt("Introduceți un cod PIN (minim 4 cifre) pentru acces:");
        if (!pinCode || pinCode.length < 4) {
            alert("Cod PIN invalid. Trebuie să aibă minim 4 cifre.");
            return;
        }

        const collaborationData = {
            owner: user.uid,
            pin: pinCode,
            createdAt: new Date(),
        };

        try {
            const docRef = await addDoc(collection(db, "collaborations"), collaborationData);
            const collaborationLink = `${window.location.origin}${window.location.pathname}?collabId=${docRef.id}`;
            prompt(`Link de colaborare generat (PIN: ${pinCode}). Distribuiți acest link și codul PIN pentru acces:`, collaborationLink);
        } catch (error) {
            console.error("Eroare la generarea link-ului de colaborare:", error);
        }
    }

    window.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded a fost apelat");
        const urlParams = new URLSearchParams(window.location.search);
        const collabId = urlParams.get('collabId');

        if (collabId) {
            console.log("Este un colaborator. Ascundem formularul și butonul de generare link.");
            const formElement = document.getElementById("exercitiuForm");
            const generateLinkButton = document.getElementById("generateLinkButton");
            const topSection = document.querySelector('.form-container'); 
            const tableContainer = document.querySelector('.table-container'); // Ascundem și tabelul pentru colaborator

            if (formElement) formElement.style.display = 'none';
            if (generateLinkButton) generateLinkButton.style.display = 'none';
            if (topSection) topSection.style.display = 'none'; 
            if (tableContainer) tableContainer.style.display = 'none'; // Colaboratorul vede doar carduri

            const pin = prompt("Introduceți codul PIN pentru accesul la colaborare:");
            if (!pin) {
                alert("Cod PIN necesar pentru accesul la colaborare.");
                window.location.href = "login.html"; // Sau o altă pagină relevantă
                return;
            }

            try {
                console.log("Încerc să accesez documentul de colaborare.");
                const collabDocRef = doc(db, "collaborations", collabId);
                const collabSnapshot = await getDoc(collabDocRef);

                if (collabSnapshot.exists()) {
                    const collabData = collabSnapshot.data();
                    if (collabData.pin === pin) {
                        console.log("PIN corect. Încărcăm datele colaboratorului.");
                        if (!dataAlreadyLoaded) {
                           loadTableData(collabId, pin); // Va încărca datele și le va afișa în carduri
                        }
                    } else {
                        alert("Cod PIN incorect.");
                        window.location.href = "login.html";
                    }
                } else {
                    alert("Colaborare inexistentă.");
                    window.location.href = "login.html";
                }
            } catch (error) {
                console.error("Eroare la accesarea colaborării:", error);
                alert("Eroare la accesarea colaborării.");
                window.location.href = "login.html";
            }
        } else {
            // Utilizator normal (nu colaborator)
            // Datele sunt încărcate în window.onload -> populateTableData -> loadTableData
        }
    });
    </script>
    <style>
        body {
            font-family: 'Roboto', 'Montserrat', sans-serif;
            margin: 0; /* Reset margin */
            padding: 20px; /* Add padding to body */
            background: linear-gradient(to right, #ece9e6, #ffffff);
            color: #333;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .form-container {
            max-width: 900px;
            margin: 20px auto; /* Add margin auto for centering and top/bottom margin */
            background: #fff;
            padding: 30px;
            box-shadow: 0 16px 24px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 3px solid #87CEFA;
            transition: transform 0.3s ease;
        }
        .form-container:hover {
            transform: scale(1.01); /* Subtle hover effect */
        }
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress {
            height: 20px;
            width: 0;
            background-color: #87CEFA;
            transition: width 0.4s ease;
        }
        .question-card {
            margin-bottom: 20px;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .question-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .question-card h3 {
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 0; /* Reset margin-top for h3 */
            margin-bottom: 10px;
        }
        .question-card p {
            font-weight: 300;
            font-size: 0.95em;
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }
        textarea {
            width: calc(100% - 22px); /* Adjusted for padding and border */
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
            min-height: 60px; /* Minimum height */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }
        textarea:focus {
            border-color: #87CEFA;
            box-shadow: 0 2px 8px rgba(135, 206, 250, 0.5);
            outline: none; /* Remove default outline */
        }
        input[type="submit"], button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: 500; /* Medium weight for buttons */
            background: linear-gradient(to right, #87CEFA, #6bb9e7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s; /* Smoother transform */
        }
        input[type="submit"]:hover, button:hover {
            background: linear-gradient(to right, #6bb9e7, #4A90E2);
            transform: translateY(-2px); /* More subtle lift */
        }
        .form-step {
            display: none;
        }
        .form-step-active {
            display: block;
            animation: fadeIn 0.7s ease-in-out; /* Slightly faster fadeIn */
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); } /* Add slight vertical motion */
            100% { opacity: 1; transform: translateY(0); }
        }
        .step-navigation {
            text-align: center;
            margin-top: 20px;
        }
        .step-navigation button {
            margin: 0 10px;
        }

        .table-container {
            margin: 30px auto; /* Centered with margin */
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            /* height: 600px; /* Comentat pentru a permite conținutului să definească înălțimea */
            overflow-x: auto; /* Scroll orizontal dacă tabelul e prea lat */
            max-width: 900px; /* Max width similar to form container */
       }


        .card-view {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 900px; /* Consistent max-width */
            margin: 30px auto; /* Centered with margin */
        }

        .response-card {
            background: #f9f9ff; /* Light lavender background */
            padding: 20px; /* Adjusted padding */
            border-radius: 15px; /* Slightly smaller radius */
            box-shadow: 0 8px 16px rgba(0,0,0,0.12); /* Softer shadow */
            /* width: calc(80% - 10px); /* Removed fixed width, let max-width of parent handle */
            transition: box-shadow 0.3s ease; /* Smooth transition for hover */
            margin-bottom: 0; /* Removed default margin bottom from individual cards */
            position: relative;
            overflow: hidden; /* Ensures content respects border-radius */
        }

        .response-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.18); /* Enhanced shadow on hover */
        }

        .response-card .card-header {
            font-weight: 700;
            font-size: 1.1em; /* Slightly larger header font */
            cursor: pointer;
            background: #87CEFA;
            padding: 12px 15px; /* Adjusted padding */
            border-radius: 10px 10px 0 0; /* Rounded top corners */
            color: #fff;
            text-align: left; /* Align text to left for better readability */
            position: relative;
            display: flex; /* For icon alignment */
            justify-content: space-between; /* Space for icon */
            align-items: center; /* Center items vertically */
        }

        .response-card .card-header::after {
            content: '▼'; /* Chevron down */
            font-size: 0.8em; /* Smaller icon */
            transition: transform 0.3s ease;
        }

        .response-card.open .card-header::after {
            transform: rotate(180deg); /* Rotate chevron up */
        }

        .response-card .card-content {
            max-height: 0;
            margin-top: 0; /* No margin top */
            padding: 0 15px; /* Padding left/right when closed */
            background: #fff; /* White background for content */
            border: 1px solid #e0e0e0; /* Light border for content area */
            border-top: none; /* No top border as header has bottom */
            border-radius: 0 0 10px 10px; /* Rounded bottom corners */
            line-height: 1.6; /* Improved line height */
            overflow: auto; /* Scroll for overflowing content */
            transition: max-height 0.4s ease-out, padding 0.4s ease-out; /* Smoother transition */
        }

        .response-card.open .card-content {
            max-height: 1000px; /* Generous max-height */
            padding: 15px; /* Full padding when open */
        }

        .response-card .card-content p {
            margin-bottom: 12px; /* Consistent paragraph spacing */
            border-left: 3px solid #87CEFA;
            padding-left: 10px;
            background: transparent; /* Transparent background, inherits from .card-content */
            border-bottom: none; /* Removed bottom border per paragraph */
            padding-bottom: 0; /* Removed bottom padding per paragraph */
        }
         .response-card .card-content p strong {
            color: #333; /* Darker color for strong text */
         }

        .response-card h4 {
            text-align: left; /* Align subheadings to left */
            color: #4A90E2;
            font-weight: bold;
            margin-top: 20px; /* Space above subheading */
            margin-bottom: 10px; /* Space below subheading */
            font-size: 1.05em; /* Slightly smaller h4 */
        }
         .response-card h4:first-child {
            margin-top: 0; /* No margin top for the first h4 */
         }


        .response-card button.delete-button { /* Specific selector for delete button in card */
            display: block;
            margin: 15px auto 5px; /* Adjusted margin */
            padding: 8px 18px; /* Smaller padding */
            font-size: 0.9em; /* Smaller font */
            background-color: #f44336; /* Red for delete */
        }
        .response-card button.delete-button:hover {
            background-color: #d32f2f; /* Darker red on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            border-radius: 10px;
            overflow: hidden; /* For border-radius on table */
        }
        th {
            background: linear-gradient(to right, #6bb9e7, #87CEFA);
            color: white;
            text-align: left; /* Align header text to left */
            padding: 12px 15px; /* Adjusted padding */
            font-size: 0.9em; /* Smaller font for table headers */
            position: sticky;
            top: 0;
            z-index: 2;
        }
        td {
            padding: 10px 15px; /* Adjusted padding */
            text-align: left;
            border-bottom: 1px solid #ddd; /* Only bottom border for rows */
            font-size: 0.85em; /* Smaller font for table data */
        }
        tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }
        tr:hover {
            background-color: #f5f5f5; /* Hover effect for table rows */
        }

        .detail-card { /* This class seems to be for table row expansion */
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px; /* Smaller radius */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); /* Inset shadow */
            margin-top: 10px;
        }
        .styled-detail-card { /* This seems to be a duplicate or specific version of detail-card */
            background: #f0f8ff; /* Alice blue for detail card */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            /* width: calc(80% - 10px); /* Removed fixed width */
            margin: 10px auto; /* Centered with margin */
            overflow: hidden;
        }
        .styled-detail-card h4 {
            text-align: center;
            color: #4A90E2;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .styled-detail-card p {
            margin-bottom: 10px;
            border-left: 3px solid #87CEFA;
            padding-left: 8px;
            background: #fff;
            border-bottom: 1px solid #eee; /* Lighter border */
            padding-bottom: 8px;
            font-size: 0.95em; /* Consistent font size */
        }
        
        #confirmationMessage {
            display: none;
            text-align: center;
            padding: 15px;
            background-color: #d4edda; /* Green for success */
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin-top: 20px;
            animation: fadeIn 0.5s; /* Fade in animation */
        }

        .collaboration-section {
            text-align: center;
            margin-top: 30px;
            padding-bottom: 20px; /* Add some padding at the bottom */
        }
        .collaboration-section button {
            background-color: #5cb85c; /* Green for generate link */
        }
        .collaboration-section button:hover {
            background-color: #4cae4c; /* Darker green on hover */
        }

/* Responsive Adjustments */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    .form-container, .table-container, .card-view {
        padding: 15px;
        margin-left: 10px;
        margin-right: 10px;
        max-width: calc(100% - 20px); /* Ensure it fits within viewport padding */
    }
    textarea {
        font-size: 14px;
        padding: 8px;
        width: calc(100% - 18px); /* Adjusted for padding and border */
    }
    input[type="submit"], button, .response-card button.delete-button {
        font-size: 16px;
        padding: 10px 20px;
    }
    .question-card h3, .response-card .card-header {
        font-size: 1.05em; /* Adjusted font size */
    }
    .question-card p, .response-card .card-content p, .styled-detail-card p {
        font-size: 0.9em;
    }
    .response-card {
        /* width: 100%; /* Full width on smaller screens */
        /* margin: 10px auto; /* Centered */
    }
    .response-card .card-content {
        font-size: 0.9em;
    }
    table, th, td {
        font-size: 0.8em; /* Further reduce font for small tables */
    }
    th, td {
        padding: 8px; /* Reduced padding */
    }

    /* Table specific responsive behavior */
    .table-container {
        overflow-x: auto; /* Ensure table can scroll horizontally */
    }
    table {
        display: block; /* Allows horizontal scrolling */
        width: 100%;
    }
    thead, tbody, tr {
        display: block;
    }
    th { /* Hide table headers, use data-label on td */
         display: none;
    }
    tr {
        margin-bottom: 15px; /* Space between "rows" */
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex; /* Use flex for better control */
        flex-direction: column;
    }
    td {
        display: flex; /* Use flex for label and value */
        justify-content: space-between; /* Align label and value */
        padding: 10px;
        text-align: right; /* Value to the right */
        border-bottom: 1px solid #eee; /* Separator line */
        position: relative; /* For pseudo-element */
    }
    td:last-child {
        border-bottom: none;
    }
    td::before {
        content: attr(data-label); /* Use data-label for header text */
        font-weight: bold;
        text-align: left; /* Label to the left */
        margin-right: 10px; /* Space between label and value */
        color: #555;
    }
    td button { /* Ensure button in td is styled well */
        width: auto;
        padding: 6px 12px;
        font-size: 0.85em;
        margin-left: auto; /* Push button to the right if it's the only content */
    }
     td[colspan="10"] { /* For detail rows */
        display: block; /* Revert to block for colspan */
    }
    td[colspan="10"] .styled-detail-card {
        width: auto; /* Let it fill the td */
    }
}

@media (max-width: 480px) {
    .form-container, .table-container, .card-view {
        padding: 10px;
        margin-left: 5px;
        margin-right: 5px;
        max-width: calc(100% - 10px);
    }
    .question-card h3, .response-card .card-header {
        font-size: 1em;
    }
    .question-card p, .response-card .card-content p, .styled-detail-card p {
        font-size: 0.85em;
    }
    textarea {
        font-size: 13px;
        padding: 6px;
        width: calc(100% - 14px);
    }
    input[type="submit"], button, .response-card button.delete-button {
        font-size: 14px;
        padding: 8px 15px;
    }
    .response-card .card-header {
        padding: 10px;
    }
    .response-card .card-content {
        padding: 10px;
        font-size: 0.85em;
    }
    table, th, td {
        font-size: 0.75em;
    }
    td {
        padding: 8px;
    }
    td::before {
        margin-right: 5px; /* Less space on very small screens */
    }
}
    </style>
</head>
<body>

    <div class="form-container">
        <h2>Fișă Monitorizare</h2>
        <p>Completează fiecare întrebare pentru a înțelege mai bine situațiile tale. Fiecare secțiune reprezintă o parte importantă a reflecției tale. În acest exercițiu, îți voi ghida fiecare pas, astfel încât să poți explora în profunzime gândurile, emoțiile și comportamentele tale.</p>
    
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
    
        <form id="exercitiuForm">
            <!-- Secțiunea 1: Explorarea situației și a nevoilor -->
            <div class="question-card form-step form-step-active" id="step-1">
                <h3>Care este situația?</h3>
                <p>Te rog să descrii contextul care a declanșat emoțiile sau comportamentul tău. Încearcă să fii cât mai specific și detaliat. Aceasta poate fi o situație concretă din viața de zi cu zi în care te-ai simțit copleșit, stresat sau într-o altă stare emoțională intensă.</p>
                <textarea name="situatie" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-2">
                <h3>Ce îmi trece prin minte?</h3>
                <p>Îți cer să identifici gândurile automate care au apărut în această situație. Acestea sunt gânduri rapide, involuntare, care îți trec prin minte în momentele de stres. Ce îți spui în acel moment? Este un gând critic sau îngrijorător?</p>
                <textarea name="ganduri" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-3">
                <h3>Cum mă face acel gând să mă simt?</h3>
                <p>Te rog să notezi emoțiile pe care le simți în urma acelui gând. Ce simți? Frică, tristețe, furie? Dă o intensitate emoției (de la 0 la 100) pentru a vedea cât de puternică este.</p>
                <textarea name="emotii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-4">
                <h3>Ce mod este activ?</h3>
                <p>Identifică modul în care te afli în această situație. Este un mod de copil vulnerabil, critic interior, sau poate adultul sănătos? Conștientizarea modului îți poate oferi o mai bună înțelegere a reacțiilor tale.</p>
                <textarea name="mod_activ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-5">
                <h3>Ce comportament simți că adopți?</h3>
                <p>Descrie comportamentul pe care îl manifești în această situație. Este un comportament de evitare, de confruntare, de sacrificiu de sine? Recunoașterea comportamentului te ajută să înțelegi mai bine cum reacționezi.</p>
                <textarea name="comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-6">
                <h3>Care sunt nevoile tale mai profunde?</h3>
                <p>Ce nevoi stau la baza acestor emoții și comportamente? Poate fi nevoia de siguranță, de validare, de acceptare? Identificarea acestor nevoi te poate ajuta să găsești strategii mai sănătoase pentru a le îndeplini.</p>
                <textarea name="nevoi_profunde" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-7">
                <h3>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</h3>
                <p>Reflectează dacă felul în care reacționezi te ajută cu adevărat să îți îndeplinești nevoile. Poate fi util să te gândești dacă există alternative mai eficiente.</p>
                <textarea name="ajutor_comportament" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-8">
                <h3>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</h3>
                <p>Gândește-te la cum ar reacționa partea ta Adultă Sănătoasă în această situație. Cum ai putea să abordezi diferit pentru a avea grijă de tine și de nevoile tale?</p>
                <textarea name="adult_sanatos" rows="3" required></textarea>
            </div>

            <!-- Secțiunea 2: Analiza gândurilor și a percepțiilor -->
            <div class="question-card form-step" id="step-9">
                <h3>Ce mă face să cred că gândul automat este adevărat?</h3>
                <p>Explorează motivele pentru care crezi că acest gând este adevărat. Ce dovezi ai care îți confirmă acest lucru? De multe ori, ne bazăm pe experiențe trecute sau frici pentru a justifica un gând.</p>
                <textarea name="dovezi_adevar" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-10">
                <h3>Ce mă face să cred că nu este adevărat?</h3>
                <p>Acum, să ne uităm la dovezile împotriva gândului tău. Există argumente sau experiențe care contrazic acest gând? Poate există o altă perspectivă pe care nu ai luat-o în considerare?</p>
                <textarea name="dovezi_fals" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-11">
                <h3>Există o explicație alternativă?</h3>
                <p>Uneori, există mai multe explicații pentru ceea ce se întâmplă. Ce alte interpretări ai putea avea pentru această situație? Gândește-te la alte posibilități care ar putea explica contextul.</p>
                <textarea name="explicatie_alternativa" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-12">
                <h3>Care este cel mai rău lucru care s-ar putea întâmpla?</h3>
                <p>Ce este cel mai rău care ar putea avea loc în această situație? Să identificăm acele frici catastrofale care adesea ne alimentează gândurile negative.</p>
                <textarea name="scenariu_negativ" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-13">
                <h3>Care este cel mai bun lucru care s-ar putea întâmpla?</h3>
                <p>Pe de altă parte, care ar fi cel mai pozitiv scenariu? Uneori uităm să ne gândim și la posibilitățile bune. Cum ar arăta cel mai bun rezultat al acestei situații?</p>
                <textarea name="scenariu_optimist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-14">
                <h3>Care este cel mai realist rezultat?</h3>
                <p>După ce am explorat extremele, ce crezi că este cel mai probabil să se întâmple? Cum ar arăta un rezultat realist, ținând cont de toate perspectivele?</p>
                <textarea name="rezultat_realist" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-15">
                <h3>Ce s-ar întâmpla dacă mi-aș schimba modul de gândire?</h3>
                <p>Întreabă-te cum ar fi dacă ai aborda situația cu un alt tip de gândire. Cum ar influența asta emoțiile și comportamentele tale?</p>
                <textarea name="schimbare_gandire" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-16">
                <h3>Ce i-aș spune unui prieten dacă ar fi în aceeași situație?</h3>
                <p>Gândește-te la cum ai reacționa dacă un prieten drag ar avea aceleași gânduri. Ce i-ai spune pentru a-l sprijini? Cum ai încerca să-l încurajezi?</p>
                <textarea name="sfat_prieten" rows="3" required></textarea>
            </div>

            <!-- Secțiunea 3: Întrebări pentru claritate și reflecție suplimentară -->
            <div class="question-card form-step" id="step-17">
                <h3>Văd doar partea rea a lucrurilor?</h3>
                <p>Este posibil să fii prins într-un tipar negativ de gândire, concentrându-te doar pe aspectele negative. Încearcă să observi dacă există și aspecte pozitive pe care le-ai ignorat.</p>
                <textarea name="partea_rea" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-18">
                <h3>Îmi asum responsabilitatea pentru lucruri care nu au stat în puterea mea?</h3>
                <p>Reflectează dacă îți asumi responsabilitatea pentru situații asupra cărora nu aveai control. Este important să îți dai seama de limitele influenței tale.</p>
                <textarea name="responsabilitate" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-19">
                <h3>Mă condamn în baza unui singur eveniment?</h3>
                <p>Îți evaluezi valoarea personală bazându-te pe un singur eveniment negativ? Amintește-ți că un eveniment nu definește cine ești în totalitate.</p>
                <textarea name="condamnare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-20">
                <h3>Privesc situația în termeni extremi?</h3>
                <p>Verifică dacă vezi situația doar în alb sau negru, fără nuanțe de gri. Gândirea extremă poate distorsiona realitatea.</p>
                <textarea name="termeni_extremi" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-21">
                <h3>Exagerez situația?</h3>
                <p>Îți amplifici reacțiile față de o situație? Încearcă să te gândești dacă ceea ce percepi este realist sau dacă exagerezi impactul situației.</p>
                <textarea name="exagerare" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-22">
                <h3>Există și alți factori responsabili?</h3>
                <p>Există alți factori care contribuie la această situație, pe lângă tine? Este important să ai o perspectivă completă asupra cauzelor unei situații.</p>
                <textarea name="factori_responsabili" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-23">
                <h3>Am sărit direct la concluzii?</h3>
                <p>Te-ai grăbit să ajungi la o concluzie fără suficiente dovezi? Încearcă să observi dacă există alte posibilități care ar putea explica situația.</p>
                <textarea name="concluzii" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-24">
                <h3>Îmi pun întrebări fără răspuns?</h3>
                <p>Te frământă întrebări care nu au un răspuns clar sau realist? Aceste întrebări pot fi o sursă majoră de anxietate.</p>
                <textarea name="intrebari_fara_raspuns" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-25">
                <h3>Mă concentrez doar asupra slăbiciunilor mele?</h3>
                <p>Ai tendința să te focalizezi doar pe slăbiciuni și să ignori punctele tale forte? Încearcă să îți recunoști și punctele pozitive.</p>
                <textarea name="slabiciuni" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-26">
                <h3>Mă zbat prea mult gândind la cum ar trebui să fie lucrurile?</h3>
                <p>Ai tendința să te gândești mereu la cum ar trebui să fie lucrurile, în loc să accepți situația așa cum este? Acceptarea poate reduce stresul și anxietatea.</p>
                <textarea name="cum_ar_trebui" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-27">
                <h3>Mă aștept să fiu perfect?</h3>
                <p>Îți setezi standarde foarte înalte, imposibil de atins? Perfecționismul poate fi o sursă majoră de frustrare și descurajare.</p>
                <textarea name="perfectiune" rows="3" required></textarea>
            </div>
            <div class="question-card form-step" id="step-28">
                <h3>Completare finalizata!</h3>
                <p>Nu uita să salvezi datele.</p>
            </div>
            <div class="step-navigation">
                <button type="button" id="prevButton">Înapoi</button>
                <button type="button" id="nextButton">Înainte</button>
            </div>
            <button type="button" id="addButton">Salveaza datele</button>
        </form>

        <div id="confirmationMessage">
            Formularul a fost trimis cu succes! Feedback-ul AI este în curs de generare.
        </div>

        <div class="collaboration-section">
            <button type="button" id="generateLinkButton">Generează Link de Colaborare</button>
        </div>
    </div>
    
    <h3 style="text-align: center; margin-top: 40px; margin-bottom: 10px; color: #333; font-weight: 500;">Răspunsurile tale și Feedback AI:</h3>
    
    <div class="card-view" id="cardViewContainer">
        <!-- Cardurile cu răspunsuri și feedback AI vor fi adăugate aici de JavaScript -->
    </div>
    
    <!-- Tabelul este păstrat, dar poate fi considerat secundar față de vizualizarea cardurilor -->
    <div class="table-container" style="display: none;"> <!-- Ascuns implicit, poate fi eliminat dacă nu se dorește -->
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Care este situația?</th>
                    <th>Ce îmi trece prin minte?</th>
                    <th>Cum mă face acel gând să mă simt?</th>
                    <th>Ce mod este activ?</th>
                    <th>Ce comportament simți că adopți?</th>
                    <th>Care sunt nevoile tale mai profunde?</th>
                    <th>Mă ajută comportamentul meu să îndeplinesc aceste nevoi?</th>
                    <th>Cum ar gândi și cum s-ar comporta Adultul Sănătos?</th>
                    <th>Detalii</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <br/>
    
</body>
</html>